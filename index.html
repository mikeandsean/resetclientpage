<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RESET Tracker - Single Page</title>
  <style>
    :root {
      /* Color Palette & Variables */
      --bg-main: #F4F7FC;       /* Soft background */
      --bg-card: #FFFFFF;       /* Card background */
      --border-color: #E2E8F0;  /* Light gray border */
      --text-primary: #2D3748;  /* Dark grayish blue */
      --text-secondary: #4A5568;/* Medium gray */
      --text-light: #718096;    /* Lighter gray */
      --primary-blue: #4A90E2;  /* Accent color for buttons */
      --primary-blue-dark: #357ABD;
      --success-green: #48BB78; /* For progress bars */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
      --radius: 6px;
      --spacing-unit: 1rem;
    }

    /* Basic Resets */
    * { box-sizing: border-box; }
    body {
      margin: 0 auto;
      max-width: 850px;
      background: var(--bg-main);
      font-family: sans-serif;
      color: var(--text-primary);
      padding: var(--spacing-unit);
      line-height: 1.4;
    }

    h1, h2, h3 {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    h1 { margin-top: 1rem; font-size: 1.8rem; }
    h2 {
      font-size: 1.3rem;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.3rem;
    }
    h3 {
      margin-top: 1.2rem;
      margin-bottom: 0.4rem;
      color: var(--primary-blue);
      font-size: 1.15rem;
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 0.45em 0.8em;
      margin: 0.3em 0.3em 0.3em 0;
      border: 1px solid var(--border-color);
      background-color: #fff;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s ease;
    }
    .btn:hover {
      background-color: #f2f2f2;
    }
    .btn-primary {
      background-color: var(--primary-blue);
      color: #fff;
      border-color: var(--primary-blue);
    }
    .btn-primary:hover {
      background-color: var(--primary-blue-dark);
      border-color: var(--primary-blue-dark);
    }

    /* Controls Bar */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0;
      align-items: center;
    }
    .controls > div {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .controls label {
      font-weight: bold;
      margin-right: 0.2rem;
      color: var(--text-secondary);
    }
    select, input[type="date"], input[type="text"], textarea {
      font-size: 1em;
      padding: 0.3em 0.45em;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background: #fff;
    }
    select:focus, input[type="text"]:focus, textarea:focus {
      outline: 2px solid rgba(74,144,226,0.3);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      background-color: #fff;
      box-shadow: var(--shadow-sm);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    th, td {
      border: none;
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem;
      text-align: left;
      vertical-align: middle;
      font-size: 0.95em;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-size: 0.8em;
    }
    tr:last-child td { border-bottom: none; }
    tr.completed-task td:not(:last-child) {
      text-decoration: line-through;
      color: var(--text-light);
    }

    /* Reflection Section */
    textarea {
      width: 100%;
      min-height: 60px;
      margin-top: 0.2rem;
    }

    /* Progress Bars */
    .progress-bar-container {
      width: 100%;
      background-color: #eee;
      border-radius: var(--radius);
      overflow: hidden;
      margin: 0.3rem 0 1rem 0;
    }
    .progress-bar {
      height: 20px;
      background: var(--success-green);
      color: #fff;
      text-align: center;
      font-weight: 600;
      line-height: 20px;
      transition: width 0.3s;
      border-radius: var(--radius) 0 0 var(--radius);
    }
    .blue-bar {
      background: var(--primary-blue);
    }

    /* Image Gallery */
    #imageGallery {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }
    #imageGallery h3 { margin-top: 0; }
    .gallery-item {
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.3rem;
    }
    .gallery-item:last-child { border-bottom: none; }
    .gallery-item img {
      max-height: 60px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .gallery-item img:hover { transform: scale(1.05); }
    .gallery-item .title { font-weight: 600; }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 2rem 1rem;
      overflow-y: auto;
    }
    .modal-content {
      background: var(--bg-card);
      margin: 2rem auto;
      padding: 1.5rem;
      max-width: 700px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    .modal-header { margin-bottom: 1rem; }
    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-weight: 600;
    }
    .modal-close, [data-close] {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      border: none;
      background: var(--accent-red, #E53E3E);
      color: #fff;
      font-weight: bold;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .day-plan, .weekly-day-section {
      margin-bottom: 1rem;
      padding: 0.8rem;
      background: #fdfdfd;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius);
    }
    .day-plan h4, .weekly-day-section h4 {
      margin-top: 0; margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-size: 1em;
    }

    /* Hide Google Calendar & Tasks if we want them GONE -> We literally won't include them in HTML */

    /* Media Queries */
    @media (max-width: 600px) {
      body { margin:0 auto; padding: 0.5rem;}
      h1 { font-size: 1.4rem; }
      .controls { flex-direction: column; }
      .controls > div { gap: 0.2rem; }
      table, th, td { font-size: 0.85em; }
      .modal-content { margin: 1rem auto; padding: 1rem;}
    }
  </style>
</head>
<body>

<h1>RESET Tracker - Single Page</h1>

<div class="controls">
  <div>
    <label>Client:</label>
    <select id="clientSelect"></select>
    <button class="btn" id="addClientBtn">+ Add Client</button>
  </div>
  <div>
    <label>Date:</label>
    <input type="date" id="datePicker" />
  </div>
  <button class="btn" id="clearTasksBtn">Clear Tasks</button>
  <button class="btn" id="reportBtn">View Report</button>
  <button class="btn" id="multiDayBtn">Multi-Day</button>
  <button class="btn" id="weeklyBtn">Weekly</button>
  <button class="btn" id="imageBtn">Images</button>
  <button class="btn" id="exportBtn">Export</button>
</div>

<!-- New Client Form -->
<div id="newClientForm" style="display:none; margin: 0.5rem 0; padding: 0.7rem; background:#f7fcff; border:1px solid var(--border-color); border-radius:var(--radius);">
  <label style="font-weight:600; margin-right:0.5rem;">New Client Name:</label>
  <input type="text" id="newClientName" placeholder="e.g. John" style="width:180px; margin-right:0.5rem;" />
  <button class="btn btn-primary" id="saveClientBtn">Save</button>
  <button class="btn" id="cancelClientBtn">Cancel</button>
</div>

<!-- Big Goal & Links -->
<div style="margin-bottom:1rem; background:#fff; padding:0.8rem; border:1px solid var(--border-color); border-radius:var(--radius); box-shadow: var(--shadow-sm);">
  <div style="margin-bottom:0.5rem;">
    <label style="font-weight:600; margin-right:0.3rem;">Big Goal:</label>
    <input type="text" id="bigGoalInput" placeholder="e.g. Get into Yale" style="width:200px; margin-right:1rem;" />
    <label style="font-weight:600; margin-right:0.3rem;">Canvas:</label>
    <input type="text" id="canvasLinkInput" style="width:150px; margin-right:1rem;" />
    <label style="font-weight:600; margin-right:0.3rem;">Classroom:</label>
    <input type="text" id="classroomLinkInput" style="width:150px;" />
    <button class="btn btn-primary" id="saveClientInfoBtn" style="margin-top:0.5rem;">Save Info</button>
  </div>
  <div id="bigGoalDisplay" style="margin:0.3rem 0; font-weight:bold; color:var(--primary-blue);"></div>
  <div>
    <a href="#" id="canvasLinkAnchor" target="_blank" style="margin-right:1rem; display:none; font-weight:600;">Open Canvas</a>
    <a href="#" id="classroomLinkAnchor" target="_blank" style="display:none; font-weight:600;">Open Classroom</a>
  </div>
</div>

<!-- Reflection Section -->
<h2>Daily Reflection</h2>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Day Rating (1â€“5):</label>
  <select id="dayRatingSelect" style="margin-left:0.5rem;">
    <option value="0">--</option>
    <option value="1">1</option><option value="2">2</option>
    <option value="3">3</option><option value="4">4</option>
    <option value="5">5</option>
  </select>
</div>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Reflection Notes:</label><br/>
  <textarea id="dayNotes" rows="3" placeholder="Notes for the day..."></textarea>
</div>

<!-- Add New Task -->
<h2>Add New Task</h2>
<div style="margin-bottom:0.5rem;">
  <label style="font-weight:600;">Time:</label>
  <select id="timeSelect"></select>
  <label style="font-weight:600; margin-left:1rem;">Duration:</label>
  <select id="durationSelect">
    <option value="5 min">5 min</option>
    <option value="10 min">10 min</option>
    <option value="15 min">15 min</option>
    <option value="30 min" selected>30 min</option>
    <option value="45 min">45 min</option>
    <option value="1 hour">1 hour</option>
    <option value="90 min">90 min</option>
    <option value="2 hours">2 hours</option>
  </select>
</div>
<div style="margin-bottom:0.8rem;">
  <label style="font-weight:600;">Activity:</label>
  <input type="text" id="activityInput" style="width:50%;" placeholder="e.g. Work on math..." />
</div>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Search:</label>
  <input type="text" id="taskSearch" style="width:35%;" placeholder="Filter tasks below..." />
</div>
<button class="btn btn-primary" id="addTaskBtn">Add Task</button>

<!-- Task Table -->
<table style="margin-top:1rem;">
  <thead>
    <tr>
      <th style="width:18%;">Time & Duration</th>
      <th style="width:37%;">Activity</th>
      <th style="width:8%;">Done?</th>
      <th style="width:12%;">Rating</th>
      <th style="width:25%;">Actions</th>
    </tr>
  </thead>
  <tbody id="taskTable">
    <tr><td colspan="5" style="text-align:center; color:#666;">(No tasks yet)</td></tr>
  </tbody>
</table>

<!-- Image Gallery -->
<div id="imageGallery"></div>

<!-- Progress Dashboard -->
<h2>Progress Dashboard</h2>
<p><strong>Task Completion:</strong> <span id="completionRate">-</span></p>
<div class="progress-bar-container">
  <div id="completionBar" class="progress-bar" style="width:0%">0%</div>
</div>

<p><strong>Average Task Rating (this day):</strong> <span id="averageTaskRating">-</span></p>
<hr style="margin:1rem 0;"/>
<p><strong>Day Rating (this day):</strong> <span id="displayDayRating">-</span></p>
<p><strong>Avg Day Rating (up to this date):</strong> <span id="avgDayRatingUpToDate">-</span></p>
<div class="progress-bar-container">
  <div id="avgRatingBar" class="progress-bar blue-bar" style="width:0%">0/5</div>
</div>

<!-- FOOTER -->
<div style="margin-top:2rem; color:var(--text-light); font-size:0.9em; border-top:1px solid var(--border-color); padding-top:1rem; text-align:center;">
  <p>Data is stored locally in your browser's <code>localStorage</code>. No server or external DB needed.</p>
</div>

<!-- 1) MULTI-DAY PLANNER MODAL -->
<div id="multiDayModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="multiDayModal">X</button>
    <div class="modal-header">
      <h3>Multi-Day Task Planner</h3>
    </div>
    <p>Create tasks for multiple upcoming days at once.</p>
    <div id="multiDaysContainer"></div>
    <button class="btn" id="addAnotherDayBtn">Add Another Day</button>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveMultiDayBtn">Save All</button>
      <button class="btn" data-close="multiDayModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 2) WEEKLY PLANNER MODAL -->
<div id="weeklyModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="weeklyModal">X</button>
    <div class="modal-header">
      <h3>Weekly Planner</h3>
    </div>
    <p>Set recurring tasks for each weekday.</p>
    <div id="weeklyContainer"></div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveWeeklyBtn">Save Weekly</button>
      <button class="btn" data-close="weeklyModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 3) IMAGES MODAL -->
<div id="imageModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="imageModal">X</button>
    <div class="modal-header">
      <h3>Add Image / Screenshot</h3>
    </div>
    <div>
      <input type="file" id="imageFileInput" accept="image/*" />
      <p style="color:var(--text-light); font-size:0.9em;">Or paste a screenshot (Ctrl+V).</p>
    </div>
    <img id="imagePreview" src="" alt="preview" style="display:none; max-width:100%; max-height:200px; margin:0.5rem 0; border:1px solid #ccc;" />
    <div>
      <label style="font-weight:600;">Title:</label><br/>
      <input type="text" id="imageTitle" style="width:80%;" placeholder="Optional title">
    </div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveImageBtn">Save Image</button>
      <button class="btn" data-close="imageModal">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
/***************************************************************
  SINGLE-PAGE RESET TRACKER (NO GOOGLE CALENDAR/TASKS SECTIONS)
***************************************************************/

let allData = {};
const STORAGE_KEY = "multiClientDateData_SinglePage";

/* DOM elements */
const clientSelect       = document.getElementById("clientSelect");
const addClientBtn       = document.getElementById("addClientBtn");
const newClientForm      = document.getElementById("newClientForm");
const newClientName      = document.getElementById("newClientName");
const saveClientBtn      = document.getElementById("saveClientBtn");
const cancelClientBtn    = document.getElementById("cancelClientBtn");

const bigGoalInput       = document.getElementById("bigGoalInput");
const canvasLinkInput    = document.getElementById("canvasLinkInput");
const classroomLinkInput = document.getElementById("classroomLinkInput");
const saveClientInfoBtn  = document.getElementById("saveClientInfoBtn");
const bigGoalDisplay     = document.getElementById("bigGoalDisplay");
const canvasLinkAnchor   = document.getElementById("canvasLinkAnchor");
const classroomLinkAnchor= document.getElementById("classroomLinkAnchor");

const datePicker         = document.getElementById("datePicker");
const clearTasksBtn      = document.getElementById("clearTasksBtn");
const reportBtn          = document.getElementById("reportBtn");
const multiDayBtn        = document.getElementById("multiDayBtn");
const weeklyBtn          = document.getElementById("weeklyBtn");
const imageBtn           = document.getElementById("imageBtn");
const exportBtn          = document.getElementById("exportBtn");

const dayRatingSelect    = document.getElementById("dayRatingSelect");
const dayNotesTextarea   = document.getElementById("dayNotes");

const timeSelect         = document.getElementById("timeSelect");
const durationSelect     = document.getElementById("durationSelect");
const activityInput      = document.getElementById("activityInput");
const taskSearch         = document.getElementById("taskSearch");
const addTaskBtn         = document.getElementById("addTaskBtn");
const taskTable          = document.getElementById("taskTable");

const completionRateEl   = document.getElementById("completionRate");
const completionBarEl    = document.getElementById("completionBar");
const averageTaskRatingEl= document.getElementById("averageTaskRating");
const displayDayRatingEl = document.getElementById("displayDayRating");
const avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate");
const avgRatingBarEl     = document.getElementById("avgRatingBar");

const imageGallery       = document.getElementById("imageGallery");

/* Multi-day modal */
const multiDayModal      = document.getElementById("multiDayModal");
const multiDaysContainer = document.getElementById("multiDaysContainer");
const addAnotherDayBtn   = document.getElementById("addAnotherDayBtn");
const saveMultiDayBtn    = document.getElementById("saveMultiDayBtn");

/* Weekly modal */
const weeklyModal        = document.getElementById("weeklyModal");
const weeklyContainer    = document.getElementById("weeklyContainer");
const saveWeeklyBtn      = document.getElementById("saveWeeklyBtn");

/* Image modal */
const imageModal         = document.getElementById("imageModal");
const imageFileInput     = document.getElementById("imageFileInput");
const imagePreview       = document.getElementById("imagePreview");
const imageTitleInput    = document.getElementById("imageTitle");
const saveImageBtn       = document.getElementById("saveImageBtn");

let currentClient=null;
let currentDate=null;

window.addEventListener("load", ()=>{
  /* Load from localStorage */
  loadFromStorage();

  buildTimeSelect(timeSelect);

  buildClientDropdown();

  // default date = today
  const todayStr = new Date().toISOString().split("T")[0];
  datePicker.value = todayStr;
  currentDate = todayStr;

  if (Object.keys(allData).length>0) {
    currentClient = Object.keys(allData).sort()[0];
    clientSelect.value = currentClient;
    loadClientDate(currentClient, currentDate);
  }

  /* Events */
  clientSelect.addEventListener("change", onClientOrDateChange);
  datePicker.addEventListener("change", onClientOrDateChange);

  addClientBtn.addEventListener("click",()=>{
    newClientForm.style.display="block";
    newClientName.value="";
    newClientName.focus();
  });
  cancelClientBtn.addEventListener("click",()=>newClientForm.style.display="none");
  saveClientBtn.addEventListener("click", saveNewClient);

  saveClientInfoBtn.addEventListener("click", saveClientInfo);

  addTaskBtn.addEventListener("click", addNewTask);
  clearTasksBtn.addEventListener("click", clearDailyTasks);
  reportBtn.addEventListener("click", generateReport);
  multiDayBtn.addEventListener("click", ()=> openModal("multiDayModal"));
  weeklyBtn.addEventListener("click", ()=> openModal("weeklyModal"));
  imageBtn.addEventListener("click", ()=> openModal("imageModal"));

  exportBtn.addEventListener("click", exportData);

  dayRatingSelect.addEventListener("change", onDayRatingChange);
  dayNotesTextarea.addEventListener("input", onDayNotesChange);

  taskSearch.addEventListener("input", filterTasks);

  // multi-day
  addAnotherDayBtn.addEventListener("click", addMultiDayBlock);
  saveMultiDayBtn.addEventListener("click", saveMultiDayPlan);

  // weekly
  saveWeeklyBtn.addEventListener("click", saveWeeklyPlan);

  // images
  imageFileInput.addEventListener("change", handleImageFileChange);
  imageModal.addEventListener("paste", handleImagePaste);
  saveImageBtn.addEventListener("click", saveImage);

  // close modals
  document.querySelectorAll("[data-close], .modal-close").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const id= btn.dataset.close;
      if (id) closeModal(id);
      else btn.parentElement.parentElement.style.display="none";
    });
  });

  // build weekly content now
  buildWeeklyContent();

  // add default multi-day block (hidden unless user opens modal)
  addMultiDayBlock();

  // keyboard shortcuts
  document.addEventListener("keydown",(e)=>{
    // ignore if typing in input/textarea/select
    const tag=e.target.tagName;
    if(["INPUT","TEXTAREA","SELECT"].includes(tag)) {
      if(e.key==="Escape"){
        closeModal("multiDayModal");
        closeModal("weeklyModal");
        closeModal("imageModal");
      }
      return;
    }
    // alt+a => add
    if(e.altKey && e.key==="a"){ e.preventDefault();
      if(activityInput.value.trim()!==""){ addNewTask();}
      else activityInput.focus();
    }
    // alt+d => toggle last
    if(e.altKey && e.key==="d"){ e.preventDefault();
      const lastRow= taskTable.querySelector("tr:last-child");
      if(lastRow){
        const chk=lastRow.querySelector("input[type='checkbox']");
        if(chk){
          chk.checked=!chk.checked;
          chk.dispatchEvent(new Event("change"));
        }
      }
    }
    // alt+s => sort
    if(e.altKey && e.key==="s"){ e.preventDefault();
      sortDailyTasks();
    }
    // escape => close modals
    if(e.key==="Escape"){
      closeModal("multiDayModal");
      closeModal("weeklyModal");
      closeModal("imageModal");
    }
  });
});

/* LOAD/SAVE */
function loadFromStorage() {
  const str= localStorage.getItem(STORAGE_KEY);
  if(str){
    try {
      allData= JSON.parse(str);
      if(!allData||typeof allData!=="object") allData={};
    } catch(e){
      allData={};
    }
  } else { allData={}; }
}
function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
  } catch(e){
    if(e.name==="QuotaExceededError"){
      alert("Storage limit exceeded!");
    }
  }
}

/* BUILD CLIENT DROPDOWN */
function buildClientDropdown() {
  clientSelect.innerHTML="";
  const names= Object.keys(allData).sort();
  if(!names.length){
    const opt=document.createElement("option");
    opt.value=""; opt.textContent="--No Clients--";
    clientSelect.appendChild(opt);
    clientSelect.disabled=true;
    return;
  }
  clientSelect.disabled=false;
  names.forEach(n=>{
    const opt=document.createElement("option");
    opt.value=n; opt.textContent=n;
    clientSelect.appendChild(opt);
  });
}

/* ADD CLIENT */
function saveNewClient() {
  const name= newClientName.value.trim();
  if(!name){ alert("Enter name"); return;}
  if(allData[name]) { alert("Client exists."); return;}
  allData[name]={
    bigGoal:"",
    links:{canvas:"", classroom:""},
    weeklyTasks:{
      monday:[], tuesday:[], wednesday:[], thursday:[],
      friday:[], saturday:[], sunday:[]
    },
    images:[]
  };
  saveToStorage();
  buildClientDropdown();
  clientSelect.value=name;
  currentClient=name;
  loadClientDate(name, currentDate);
  newClientForm.style.display="none";
}

/* CLIENT/DATE CHANGE */
function onClientOrDateChange() {
  currentClient= clientSelect.value;
  currentDate= datePicker.value;
  loadClientDate(currentClient, currentDate);
}

/* LOAD CLIENT+DATE */
function loadClientDate(cli, dt){
  if(!cli||!dt) return;
  if(!allData[cli]) {
    allData[cli]={
      bigGoal:"",
      links:{canvas:"", classroom:""},
      weeklyTasks:{
        monday:[],tuesday:[],wednesday:[],thursday:[],
        friday:[],saturday:[],sunday:[]
      },
      images:[]
    };
  }
  if(!allData[cli][dt]) {
    allData[cli][dt]={
      dayRating:"0",
      dayNotes:"",
      tasks:[],
      weeklyDone:{}
    };
  }
  renderClientInfo(cli);
  renderReflection(cli, dt);
  renderTaskTable(cli, dt);
  renderImageGallery(cli);
  updateProgress(cli, dt);
}

/* CLIENT INFO */
function renderClientInfo(cli) {
  const cd= allData[cli];
  bigGoalInput.value= cd.bigGoal||"";
  bigGoalDisplay.textContent= cd.bigGoal||"(No big goal set)";
  canvasLinkInput.value= cd.links?.canvas||"";
  classroomLinkInput.value= cd.links?.classroom||"";

  if(cd.links?.canvas) {
    canvasLinkAnchor.href=cd.links.canvas;
    canvasLinkAnchor.style.display="inline-block";
  } else {canvasLinkAnchor.style.display="none";}
  if(cd.links?.classroom){
    classroomLinkAnchor.href= cd.links.classroom;
    classroomLinkAnchor.style.display="inline-block";
  } else {classroomLinkAnchor.style.display="none";}
}
function saveClientInfo() {
  if(!currentClient)return;
  const cd= allData[currentClient];
  cd.bigGoal= bigGoalInput.value.trim();
  if(!cd.links) cd.links={};
  cd.links.canvas= canvasLinkInput.value.trim();
  cd.links.classroom= classroomLinkInput.value.trim();
  saveToStorage();
  renderClientInfo(currentClient);
  alert("Client info saved!");
}

/* REFLECTION */
function renderReflection(cli, dt) {
  const rec= allData[cli][dt];
  dayRatingSelect.value= rec.dayRating||"0";
  dayNotesTextarea.value= rec.dayNotes||"";
}
function onDayRatingChange() {
  if(!currentClient||!currentDate)return;
  const rec= allData[currentClient][currentDate];
  if(!rec)return;
  rec.dayRating= dayRatingSelect.value;
  saveToStorage();
  updateProgress(currentClient, currentDate);
}
function onDayNotesChange() {
  if(!currentClient||!currentDate)return;
  const rec= allData[currentClient][currentDate];
  if(!rec)return;
  rec.dayNotes= dayNotesTextarea.value;
  saveToStorage();
}

/* TIME SELECT */
function buildTimeSelect(sel) {
  sel.innerHTML="";
  for(let hour=5; hour<24; hour++){
    for(let min=0; min<60; min+=15){
      const d=new Date();
      d.setHours(hour,min);
      const label= d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12:true});
      const opt= document.createElement("option");
      opt.value=label; opt.textContent=label;
      sel.appendChild(opt);
    }
  }
  // add common
  const sep= document.createElement("option");
  sep.disabled=true; sep.textContent="-----";
  sel.appendChild(sep);
  const cTimes= ["Before School","During Study Hall","During Lunch",
   "Right After School","Before Dinner","After Dinner","Before Bed"];
  cTimes.forEach(t=>{
    const o=document.createElement("option");
    o.value=t; o.textContent=t;
    sel.appendChild(o);
  });
  // default 3:00 PM if present
  if(Array.from(sel.options).some(o=>o.value==="3:00 PM")) {
    sel.value="3:00 PM";
  }
}

/* DAILY TASKS */
function renderTaskTable(cli, dt) {
  taskTable.innerHTML="";
  const rec= allData[cli][dt];
  if(!rec) {
    taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks yet)</td></tr>`;
    return;
  }
  const daily= rec.tasks||[];
  const wd= getWeekday(dt);
  const wList= allData[cli].weeklyTasks[wd]||[];
  const wDone= rec.weeklyDone||{};
  const merged=[];
  daily.forEach(t=> merged.push({...t,_type:"daily"}));
  wList.forEach(wt=> merged.push({...wt, completed:!!wDone[wt.id], rating:"0", _type:"weekly"}));
  merged.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
  if(!merged.length) {
    taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks yet)</td></tr>`;
    return;
  }
  merged.forEach(t=> addTaskRow(t, rec));
}
function addTaskRow(tObj, dayRec) {
  const row= taskTable.insertRow();
  if(tObj.completed) row.classList.add("completed-task");

  // time
  const cTime=row.insertCell(0);
  cTime.innerHTML= tObj.time;
  if(tObj.duration){
    cTime.innerHTML+= `<br><small>(${tObj.duration})</small>`;
  }
  if(tObj._type==="weekly") {
    cTime.innerHTML+= `<br><small style="color:#09f;font-weight:bold;">(Weekly)</small>`;
  }

  // activity
  const cAct=row.insertCell(1);
  cAct.textContent=tObj.activity;

  // done
  const cDone=row.insertCell(2);
  const chk=document.createElement("input");
  chk.type="checkbox";
  chk.checked= tObj.completed;
  chk.addEventListener("change",()=>{
    row.classList.toggle("completed-task", chk.checked);
    if(tObj._type==="daily"){
      const idx= dayRec.tasks.indexOf(tObj);
      if(idx>-1) dayRec.tasks[idx].completed= chk.checked;
    } else {
      if(!dayRec.weeklyDone) dayRec.weeklyDone={};
      dayRec.weeklyDone[tObj.id]= chk.checked;
    }
    saveToStorage();
    updateProgress(currentClient, currentDate);
  });
  cDone.appendChild(chk);

  // rating
  const cRate=row.insertCell(3);
  if(tObj._type==="daily") {
    const sel= document.createElement("select");
    for(let i=0;i<=5;i++){
      const o=document.createElement("option");
      o.value=i; o.text= (i===0?"--":i.toString());
      sel.appendChild(o);
    }
    sel.value=tObj.rating||"0";
    sel.addEventListener("change",()=>{
      tObj.rating=sel.value;
      saveToStorage();
      updateProgress(currentClient, currentDate);
    });
    cRate.appendChild(sel);
  } else {
    cRate.textContent="--";
    cRate.style.color="#999";
  }

  // actions
  const cActn=row.insertCell(4);
  if(tObj._type==="daily") {
    const rm=document.createElement("button");
    rm.classList.add("btn");
    rm.textContent="X";
    rm.addEventListener("click",()=>{
      if(confirm(`Remove "${tObj.activity}"?`)){
        const idx= dayRec.tasks.indexOf(tObj);
        if(idx>-1){
          dayRec.tasks.splice(idx,1);
          saveToStorage();
          row.remove();
          updateProgress(currentClient, currentDate);
          if(!taskTable.rows.length){
            taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks yet)</td></tr>`;
          }
        }
      }
    });
    cActn.appendChild(rm);
  } else {
    cActn.innerHTML=`<small style="color:#666;">(Edit in Weekly Plan)</small>`;
  }
}

function addNewTask() {
  if(!currentClient||!currentDate) return;
  const timeVal= timeSelect.value;
  const durVal= durationSelect.value;
  const actVal= activityInput.value.trim();
  if(!actVal){ alert("Enter an activity"); return;}
  const rec= allData[currentClient][currentDate];
  if(!rec.tasks) rec.tasks=[];
  rec.tasks.push({
    time: timeVal,
    duration: durVal,
    activity: actVal,
    completed:false,
    rating:"0"
  });
  saveToStorage();
  renderTaskTable(currentClient, currentDate);
  updateProgress(currentClient, currentDate);
  activityInput.value="";
  sortDailyTasks();
}
function sortDailyTasks() {
  if(!currentClient||!currentDate)return;
  const rec= allData[currentClient][currentDate];
  rec.tasks.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
  saveToStorage();
  renderTaskTable(currentClient, currentDate);
}
function filterTasks() {
  const txt= taskSearch.value.toLowerCase();
  const rows= taskTable.querySelectorAll("tr");
  rows.forEach(r=>{
    if(!r.cells[1])return;
    const timeStr= r.cells[0].textContent.toLowerCase();
    const actStr= r.cells[1].textContent.toLowerCase();
    r.style.display= (timeStr.includes(txt)||actStr.includes(txt))?"":"none";
  });
}
function clearDailyTasks() {
  if(!currentClient||!currentDate) return;
  if(confirm("Clear all daily tasks? (Weekly remain)")){
    const rec= allData[currentClient][currentDate];
    if(!rec)return;
    rec.tasks=[];
    saveToStorage();
    renderTaskTable(currentClient, currentDate);
    updateProgress(currentClient, currentDate);
  }
}

/* PROGRESS */
function updateProgress(cli, dt){
  const rec= allData[cli][dt];
  if(!rec){
    completionRateEl.textContent="-";
    completionBarEl.style.width="0%";
    completionBarEl.textContent="0%";
    averageTaskRatingEl.textContent="-";
    displayDayRatingEl.textContent="--";
    avgDayRatingUpToDateEl.textContent="--";
    avgRatingBarEl.style.width="0%";
    avgRatingBarEl.textContent="0/5";
    return;
  }
  const daily= rec.tasks||[];
  const wd= getWeekday(dt);
  const wList= allData[cli].weeklyTasks[wd]||[];
  const wDone= rec.weeklyDone||{};
  const dailyDone= daily.filter(t=>t.completed).length;
  const weeklyDone= wList.filter(w=> wDone[w.id]).length;
  const totalDone= dailyDone+weeklyDone;
  const total= daily.length+ wList.length;
  if(!total){
    completionRateEl.textContent="-";
    completionBarEl.style.width="0%";
    completionBarEl.textContent="0%";
    averageTaskRatingEl.textContent="-";
  } else {
    const pct= Math.round((totalDone/total)*100);
    completionRateEl.textContent=`${pct}% (${totalDone}/${total})`;
    completionBarEl.style.width=`${pct}%`;
    completionBarEl.textContent=`${pct}%`;

    const rated= daily.filter(t=> t.rating!=="0");
    if(rated.length){
      const sum= rated.reduce((acc,t)=> acc+parseInt(t.rating,10),0);
      const avg= sum/rated.length;
      averageTaskRatingEl.textContent= avg.toFixed(1)+"/5";
    } else {
      averageTaskRatingEl.textContent="No rated tasks";
    }
  }
  // day rating
  if(rec.dayRating && rec.dayRating!=="0") {
    displayDayRatingEl.textContent= rec.dayRating+"/5";
  } else {
    displayDayRatingEl.textContent="--";
  }

  // avg day rating up to date
  const allDates= Object.keys(allData[cli]).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)&&k<=dt).sort();
  let sumDR=0, cntDR=0;
  allDates.forEach(d=>{
    const dr2= allData[cli][d].dayRating;
    if(dr2 && dr2!=="0"){
      sumDR+= parseInt(dr2,10);
      cntDR++;
    }
  });
  if(cntDR>0){
    const avgdr= sumDR/cntDR;
    avgDayRatingUpToDateEl.textContent= avgdr.toFixed(1)+"/5";
    const p= (avgdr/5)*100;
    avgRatingBarEl.style.width=`${p}%`;
    avgRatingBarEl.textContent= avgdr.toFixed(1)+"/5";
  } else {
    avgDayRatingUpToDateEl.textContent="No day ratings";
    avgRatingBarEl.style.width="0%";
    avgRatingBarEl.textContent="0/5";
  }
}

/* MULTI-DAY */
function openModal(id){
  document.getElementById(id).style.display="block";
}
function closeModal(id){
  document.getElementById(id).style.display="none";
}
function addMultiDayBlock() {
  const index= multiDaysContainer.querySelectorAll(".day-plan").length;
  const baseDate= new Date(currentDate+"T12:00:00");
  baseDate.setDate(baseDate.getDate()+index);
  const ds= baseDate.toISOString().split("T")[0];

  const div= document.createElement("div");
  div.classList.add("day-plan");
  div.dataset.date= ds;

  const h4= document.createElement("h4");
  h4.textContent=`Day ${index+1}: ${formatDate(ds)}`;
  div.appendChild(h4);

  const timeSel= document.createElement("select");
  buildTimeSelect(timeSel);
  const durSel= document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(val=>{
    const o=document.createElement("option");
    o.value=val; o.textContent=val;
    durSel.appendChild(o);
  });
  durSel.value="30 min";
  div.appendChild(timeSel);
  div.appendChild(durSel);

  const lab= document.createElement("label");
  lab.style.display="block";
  lab.style.marginTop="0.5rem";
  lab.textContent="Activity:";
  div.appendChild(lab);
  const act=document.createElement("input");
  act.type="text";
  act.style.width="100%";
  div.appendChild(act);

  const addBtn= document.createElement("button");
  addBtn.classList.add("btn");
  addBtn.style.marginTop="0.5rem";
  addBtn.textContent="+ Task for this day";
  addBtn.addEventListener("click",()=>{
    const sep=document.createElement("hr");
    div.appendChild(sep);
    const newTime= timeSel.cloneNode(true);
    const newDur= durSel.cloneNode(true);
    const newLab= lab.cloneNode(true);
    const newAct= act.cloneNode(true);
    div.appendChild(newTime);
    div.appendChild(newDur);
    div.appendChild(newLab);
    div.appendChild(newAct);
  });
  div.appendChild(addBtn);

  multiDaysContainer.appendChild(div);
}
function saveMultiDayPlan() {
  const blocks= multiDaysContainer.querySelectorAll(".day-plan");
  let tasksAdded=0;
  blocks.forEach(block=>{
    const ds= block.dataset.date;
    if(!allData[currentClient][ds]){
      allData[currentClient][ds]={dayRating:"0", dayNotes:"", tasks:[], weeklyDone:{}};
    }
    const rec= allData[currentClient][ds];
    // gather sets of timeSel,durSel, then next input
    const selects= block.querySelectorAll("select");
    const inputs= block.querySelectorAll("input[type='text']");
    for(let i=0; i<inputs.length; i++){
      const actVal= inputs[i].value.trim();
      if(!actVal) continue;
      const timeIdx= i*2;
      const durIdx= i*2+1;
      const timeVal= selects[timeIdx]?.value||"3:00 PM";
      const durVal= selects[durIdx]?.value||"30 min";
      rec.tasks.push({
        time: timeVal,
        duration: durVal,
        activity: actVal,
        completed:false,
        rating:"0"
      });
      tasksAdded++;
    }
  });
  saveToStorage();
  loadClientDate(currentClient, currentDate);
  closeModal("multiDayModal");
  alert(`Multi-day tasks saved! ${tasksAdded} tasks added.`);
}

/* WEEKLY */
function buildWeeklyContent() {
  if(!currentClient)return;
  weeklyContainer.innerHTML="";
  const wData= allData[currentClient].weeklyTasks;
  const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  days.forEach(d=>{
    const sec=document.createElement("div");
    sec.classList.add("weekly-day-section");
    const hd=document.createElement("h4");
    hd.textContent= d[0].toUpperCase()+d.slice(1);
    sec.appendChild(hd);

    const tasksDiv= document.createElement("div");
    (wData[d]||[]).forEach(task=>{
      const row=document.createElement("div");
      row.style.display="flex";
      row.style.gap="0.5rem";
      row.style.marginBottom="0.3rem";
      const sp=document.createElement("span");
      sp.textContent=`[${task.time}] ${task.activity} (${task.duration})`;
      row.appendChild(sp);
      const rm=document.createElement("button");
      rm.classList.add("btn");
      rm.textContent="X";
      rm.addEventListener("click",()=>{
        const idx= wData[d].indexOf(task);
        if(idx>-1){
          wData[d].splice(idx,1);
          saveToStorage();
          buildWeeklyContent();
        }
      });
      row.appendChild(rm);
      tasksDiv.appendChild(row);
    });
    sec.appendChild(tasksDiv);

    const addRow=document.createElement("div");
    addRow.style.display="flex";
    addRow.style.gap="0.3rem";
    addRow.style.marginTop="0.3rem";

    const timeSel= document.createElement("select");
    buildTimeSelect(timeSel);
    const durSel= document.createElement("select");
    ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(val=>{
      const o=document.createElement("option");
      o.value=val; o.textContent=val;
      durSel.appendChild(o);
    });
    durSel.value="30 min";

    const inp= document.createElement("input");
    inp.type="text";
    inp.placeholder="Activity...";

    const plus=document.createElement("button");
    plus.classList.add("btn","btn-primary");
    plus.textContent="+";
    plus.addEventListener("click",()=>{
      const v= inp.value.trim();
      if(!v){ alert("Enter activity"); return;}
      const newId=`wt_${Date.now()}_${Math.floor(Math.random()*999)}`;
      wData[d].push({
        id:newId,
        time: timeSel.value,
        duration: durSel.value,
        activity: v
      });
      wData[d].sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
      saveToStorage();
      buildWeeklyContent();
    });

    addRow.appendChild(timeSel);
    addRow.appendChild(durSel);
    addRow.appendChild(inp);
    addRow.appendChild(plus);

    sec.appendChild(addRow);

    weeklyContainer.appendChild(sec);
  });
}
function saveWeeklyPlan() {
  closeModal("weeklyModal");
  loadClientDate(currentClient, currentDate);
  alert("Weekly updated!");
}

/* IMAGES */
function renderImageGallery(cli){
  imageGallery.innerHTML="";
  if(!cli)return;
  const arr= allData[cli].images||[];
  if(!arr.length){
    imageGallery.innerHTML=`<p style="color:#666;">(No images yet)</p>`;
    return;
  }
  const h3=document.createElement("h3");
  h3.textContent="Image Gallery";
  imageGallery.appendChild(h3);
  arr.forEach((imgObj, idx)=>{
    const div=document.createElement("div");
    div.classList.add("gallery-item");
    const span=document.createElement("span");
    span.classList.add("title");
    span.textContent= imgObj.title+" ";
    div.appendChild(span);

    const im=document.createElement("img");
    im.src=imgObj.dataUrl;
    im.addEventListener("click",()=>{
      const w= window.open("","_blank");
      w.document.write(`<title>${imgObj.title}</title><img src="${imgObj.dataUrl}" style="max-width:100%;"/>`);
      w.document.close();
    });
    div.appendChild(im);

    const rmBtn=document.createElement("button");
    rmBtn.classList.add("btn");
    rmBtn.textContent="X";
    rmBtn.addEventListener("click",()=>{
      if(confirm(`Remove image "${imgObj.title}"?`)) {
        arr.splice(idx,1);
        saveToStorage();
        renderImageGallery(cli);
      }
    });
    div.appendChild(rmBtn);

    imageGallery.appendChild(div);
  });
}
function handleImageFileChange(e){
  const file= e.target.files[0];
  if(!file)return;
  const r=new FileReader();
  r.onload=(evt)=>{
    imagePreview.src= evt.target.result;
    imagePreview.style.display="block";
  };
  r.readAsDataURL(file);
}
function handleImagePaste(e){
  const items= e.clipboardData?.items||[];
  for(let i=0;i<items.length;i++){
    if(items[i].type.indexOf("image")===0){
      const f= items[i].getAsFile();
      if(f){
        const r=new FileReader();
        r.onload=(ev)=>{
          imagePreview.src= ev.target.result;
          imagePreview.style.display="block";
        };
        r.readAsDataURL(f);
      }
    }
  }
}
function saveImage(){
  if(!imagePreview.src){
    alert("No image to save");
    return;
  }
  if(!currentClient) {alert("No client selected");return;}
  const title= imageTitleInput.value.trim()||"(Untitled)";
  allData[currentClient].images.push({
    title,
    dataUrl:imagePreview.src
  });
  saveToStorage();
  closeModal("imageModal");
  imageFileInput.value="";
  imagePreview.style.display="none";
  imagePreview.src="";
  imageTitleInput.value="";
  renderImageGallery(currentClient);
}

/* REPORT */
function generateReport(){
  if(!currentClient) {alert("No client selected"); return;}
  const cliData= allData[currentClient];
  let html=`
  <html><head><meta charset="UTF-8"/>
  <title>RESET Tracker - ${escapeHtml(currentClient)}</title>
  <style>
    body { font-family: sans-serif; margin:20px; line-height:1.5; }
    h1,h2,h3 { margin-bottom:0.4rem; }
    h1{font-size:1.6rem; color:#4A90E2;}
    table { width:100%; border-collapse:collapse; margin-bottom:1rem; }
    table,th,td { border:1px solid #aaa; }
    th,td { padding:6px; text-align:left; vertical-align:top; }
    th { background:#f2f2f2; }
    .notes { background:#eef; padding:6px; border:1px solid #ccc; margin:0.5rem 0;}
    .weekly {color:#09f; font-style:italic;}
    .gallery-img { max-width:200px; margin:0.5rem; border:1px solid #ccc;}
  </style>
  </head><body>
  <h1>RESET Tracker Report for ${escapeHtml(currentClient)}</h1>
  <p><em>Generated on ${new Date().toLocaleString()}</em></p>

  <h2>Big Goal</h2>
  <p>${escapeHtml(cliData.bigGoal||"(Not set)")}</p>

  <h2>Weekly Tasks</h2>
  `;
  const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  days.forEach(d=>{
    const arr= cliData.weeklyTasks[d]||[];
    if(arr.length) {
      html+= `<h3>${escapeHtml(d)}</h3><ul>`;
      arr.forEach(t=>{
        html+= `<li>[${escapeHtml(t.time)}] ${escapeHtml(t.activity)} (${escapeHtml(t.duration)})</li>`;
      });
      html+= `</ul>`;
    }
  });

  // images
  const imgs= cliData.images||[];
  if(imgs.length>0){
    html+= `<h2>Images</h2>`;
    imgs.forEach(img=>{
      html+= `<div><strong>${escapeHtml(img.title)}</strong><br/>
        <img class="gallery-img" src="${img.dataUrl}" alt="img"/>
      </div>`;
    });
  }

  // daily
  const dateKeys= Object.keys(cliData).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
  if(!dateKeys.length){
    html+= `<h2>Daily Records</h2><p>(No daily records)</p>`;
  } else {
    html+= `<h2>Daily Records</h2>`;
    dateKeys.forEach(d=>{
      const rec= cliData[d];
      if(!rec)return;
      html+= `<h3>${d} (Rating: ${rec.dayRating||"0"}/5)</h3>`;
      if(rec.dayNotes){
        html+= `<div class="notes">${escapeHtml(rec.dayNotes).replace(/\n/g,"<br/>")}</div>`;
      }
      // tasks
      const dailyT= rec.tasks||[];
      const wd= getWeekday(d);
      const wList= cliData.weeklyTasks[wd]||[];
      const doneMap= rec.weeklyDone||{};
      const merged=[];
      dailyT.forEach(t=> merged.push({...t,_type:"daily"}));
      wList.forEach(wt=> merged.push({...wt,_type:"weekly", completed:!!doneMap[wt.id], rating:"(weekly)"}));
      merged.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
      if(!merged.length) {
        html+= `<p>No tasks</p>`;
        return;
      }
      html+= `<table><thead>
        <tr><th>Time</th><th>Activity</th><th>Done?</th><th>Rating</th></tr>
      </thead><tbody>`;
      let doneCount=0;
      merged.forEach(t=>{
        if(t.completed) doneCount++;
        let ratingStr=(t._type==="daily"&&t.rating!=="0")? t.rating+"/5" : (t._type==="weekly" ? "(weekly)" : "--");
        html+= `<tr style="${t.completed?'text-decoration:line-through;color:#888;':''}">
         <td>${escapeHtml(t.time)}${t.duration?`<br><small>(${escapeHtml(t.duration)})</small>`:""}${t._type==="weekly"?'<br><small class="weekly">(Weekly)</small>':''}</td>
         <td>${escapeHtml(t.activity)}</td>
         <td>${t.completed?"Yes":"No"}</td>
         <td>${ratingStr}</td>
        </tr>`;
      });
      html+= `</tbody></table>`;
      html+= `<p>Completed: ${doneCount}/${merged.length}</p>`;
    });
  }

  html+= `</body></html>`;
  const w= window.open("","_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* EXPORT */
function exportData(){
  const str= JSON.stringify(allData,null,2);
  const blob= new Blob([str], {type:"application/json"});
  const url= URL.createObjectURL(blob);
  const a= document.createElement("a");
  a.href=url;
  a.download=`reset-singlepage-export-${(new Date()).toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* UTILS */
function timeToMin(str) {
  if(!str)return 9999;
  const map={
    "Before School":360,
    "During Study Hall":600,
    "During Lunch":720,
    "Right After School":930,
    "Before Dinner":1080,
    "After Dinner":1200,
    "Before Bed":1320
  };
  if(map[str]!==undefined) return map[str];
  const match= str.match(/(\d{1,2}):(\d{2})\s?(AM|PM)/i);
  if(match){
    let hh=parseInt(match[1],10);
    const mm=parseInt(match[2],10);
    let ampm=match[3].toUpperCase();
    if(ampm==="PM"&&hh<12) hh+=12;
    if(ampm==="AM"&&hh===12) hh=0;
    return hh*60+mm;
  }
  return 9999;
}
function getWeekday(ds) {
  const d=new Date(ds+"T00:00:00");
  const i= d.getDay(); // 0=Sun
  const arr=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
  return arr[i];
}
function formatDate(ds) {
  const d=new Date(ds+"T12:00:00");
  return d.toLocaleDateString(undefined,{weekday:"short", month:"short", day:"numeric"});
}
function escapeHtml(str) {
  if(!str)return "";
  return str
   .replace(/&/g,"&amp;")
   .replace(/</g,"&lt;")
   .replace(/>/g,"&gt;")
   .replace(/"/g,"&quot;")
   .replace(/'/g,"&#039;");
}
</script>
</body>
</html>
