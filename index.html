<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RESET Client Tracker (Version 2)</title>
  <style>
    /* Basic resets & body styling */
    body {
      background-color: #EAF6FF; /* light blueish tone */
      font-family: sans-serif;
      margin: 20px auto;
      max-width: 720px;
      padding: 0 10px;
    }
    h1, h2 {
      margin-bottom: 0.5em;
    }
    h3 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
    }
    select, input[type="date"], input[type="text"], textarea {
      font-size: 1em;
    }
    .btn {
      cursor: pointer;
      padding: 0.4em 0.8em;
      margin: 0.3em 0.3em 0.3em 0;
      border: 1px solid #ccc;
      background-color: #f5f5f5;
    }
    /* Title bar with a bit darker blue area */
    .title-bar {
      background-color: #BCDDFE;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 1em;
      text-align: center;
    }
    .controls {
      margin-bottom: 1em;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5em;
    }
    .controls label {
      font-weight: bold;
    }
    /* Big Goal display */
    #bigGoalDisplay {
      font-size: 1.2em; 
      font-weight: bold;
      margin: 0.5em 0;
      color: #333;
    }
    .client-info {
      background-color: #f0f8ff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 1em;
    }
    .client-info label {
      display: inline-block;
      margin-right: 5px;
      margin-top: 5px;
    }
    .client-info input {
      margin-right: 10px;
      width: 200px;
    }
    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #fafafa;
    }
    /* Completed-task styling */
    .completed-task {
      text-decoration: line-through;
      color: #888;
      background-color: #f8f8f8;
    }
    /* Mobile responsiveness */
    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
      }
      table, td, th {
        font-size: 0.9em;
      }
    }
    /* Progress Dashboard */
    #progressDashboard {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #fefefe;
      border-radius: 4px;
    }
    .progress-bar-container {
      width: 100%;
      background-color: #f1f1f1;
      border-radius: 4px;
      margin: 5px 0;
    }
    .progress-bar {
      height: 20px;
      background-color: #4CAF50;
      border-radius: 4px;
      text-align: center;
      color: white;
      font-weight: bold;
      font-size: 0.8em;
      line-height: 20px;
    }
    /* New client form */
    #newClientForm {
      display: none;
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f8ff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Multi-day planner modal */
    #plannerModal, #weeklyModal, #imageModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; 
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
    }
    .modal-content, .weekly-modal-content, .image-modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      width: 90%;
      max-width: 700px;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .weekly-modal-content { max-width: 800px; }
    /* Day plan block inside multi-day modal */
    .day-plan {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
    .time-container {
      display: flex;
      gap: 10px;
      margin-bottom: 5px;
    }
    /* Weekly day sections */
    .weekly-day-section {
      margin-bottom: 15px;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fafafa;
      border-radius: 4px;
    }
    .weekly-day-section h4 {
      margin-top: 0;
    }
    /* Image gallery */
    #imageGallery {
      margin-top: 20px;
      padding: 10px;
      background-color: #fefefe;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .gallery-item {
      margin-bottom: 10px;
    }
    .gallery-item img {
      max-width: 200px;
      margin-right: 10px;
      vertical-align: middle;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .gallery-item .title {
      font-weight: bold;
    }
    /* Footer */
    #footer {
      margin-top: 2em;
      font-size: 0.9em;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>

<div class="title-bar">
  <h1>RESET Client Tracker (Version 2)</h1>
</div>

<div class="controls">
  <label>Client:</label>
  <select id="clientSelect"></select>
  <button class="btn" id="addClientBtn">+ Add Client</button>

  <label>Date:</label>
  <input type="date" id="datePicker" />

  <button class="btn" id="clearTasksBtn">Clear Tasks</button>
  <button class="btn" id="exportBtn">Export Data</button>
  <button class="btn" id="reportBtn">View Report</button>

  <button class="btn" id="multiDayPlanBtn">Multi-Day Plan</button>
  <button class="btn" id="weeklyPlanBtn">Weekly Plan</button>
  <button class="btn" id="imageBtn">Add Image</button>
</div>

<!-- Form for adding a new client -->
<div id="newClientForm">
  <label><strong>New Client Name:</strong></label>
  <input type="text" id="newClientName" placeholder="Enter client name">
  <button class="btn" id="saveClientBtn">Save</button>
  <button class="btn" id="cancelClientBtn">Cancel</button>
</div>

<!-- Show or edit the Big Goal, Canvas link, and Classroom link -->
<div class="client-info">
  <div style="margin-bottom:6px;">
    <label>Big Goal:</label>
    <input type="text" id="bigGoalInput" placeholder="e.g. Get into Yale">
  </div>
  <div style="margin-bottom:6px;">
    <label>Canvas Link:</label>
    <input type="text" id="canvasLinkInput" placeholder="https://...">
    <label>Classroom Link:</label>
    <input type="text" id="classroomLinkInput" placeholder="https://...">
  </div>
  <button class="btn" id="saveClientInfoBtn">Save Client Info</button>
</div>

<!-- Big Goal displayed -->
<div id="bigGoalDisplay"></div>

<!-- External links displayed -->
<div style="margin-bottom: 1em;">
  <a href="#" id="canvasLinkAnchor" target="_blank" style="margin-right:10px; display:none;">Open Canvas</a>
  <a href="#" id="classroomLinkAnchor" target="_blank" style="display:none;">Open Google Classroom</a>
</div>

<!-- Day rating and reflection notes -->
<div style="margin-bottom:1em;">
  <label><strong>Day Rating (1–5):</strong></label>
  <select id="dayRatingSelect">
    <option value="0">--</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</div>

<div style="margin-bottom:1em;">
  <label><strong>Reflection Notes:</strong></label><br/>
  <textarea id="dayNotes" rows="3" style="width:98%;" placeholder="Notes for the day..."></textarea>
</div>

<hr/>

<h2>Add New Task</h2>
<div class="time-container">
  <div>
    <label>Time:</label>
    <select id="timeSelect"></select>
  </div>
  <div>
    <label>Duration:</label>
    <select id="durationSelect">
      <option value="5 min">5 minutes</option>
      <option value="10 min">10 minutes</option>
      <option value="15 min">15 minutes</option>
      <option value="30 min" selected>30 minutes</option>
      <option value="45 min">45 minutes</option>
      <option value="1 hour">1 hour</option>
      <option value="90 min">90 minutes</option>
      <option value="2 hours">2 hours</option>
    </select>
  </div>
</div>
<br>
<label>Activity:</label>
<input type="text" id="activityInput" style="width:98%;" placeholder="e.g. Work on Chemistry assignment" />
<br><br>
<input type="text" id="taskSearch" placeholder="Search tasks..." style="width:50%; margin-bottom:10px;"><br>
<button class="btn" id="addBtn">Add Task</button>

<table id="taskTable">
  <thead>
    <tr>
      <th style="width:15%;">Time</th>
      <th style="width:35%;">Activity</th>
      <th style="width:10%;">Done?</th>
      <th style="width:15%;">Rating</th>
      <th style="width:25%;">Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows appended dynamically -->
  </tbody>
</table>

<!-- Image gallery area -->
<div id="imageGallery"></div>

<div id="progressDashboard">
  <h3>Progress Dashboard</h3>
  
  <p><strong>Task Completion:</strong> <span id="completionRate">-</span></p>
  <div class="progress-bar-container">
    <div id="completionBar" class="progress-bar" style="width: 0%">0%</div>
  </div>
  
  <p><strong>Average Task Rating (this day):</strong> <span id="averageTaskRating">-</span></p>
  
  <hr/>
  
  <p><strong>Day Rating (this day):</strong> <span id="displayDayRating">-</span></p>
  
  <p><strong>Avg Day Rating (up to this date):</strong> <span id="avgDayRatingUpToDate">-</span></p>
  <div class="progress-bar-container">
    <div id="avgRatingBar" class="progress-bar" style="width: 0%; background-color: #2196F3;">0/5</div>
  </div>
</div>

<!-- Embed Google Calendar -->
<h2 style="margin-top:2em;">Google Calendar</h2>
<iframe 
  id="calendarEmbed" 
  style="width:100%; height:600px; border:1px solid #ccc;" 
  src="https://calendar.google.com/calendar/embed?src=your_calendar_id_here"
  frameborder="0">
</iframe>

<!-- Placeholder for Google Tasks -->
<h2 style="margin-top:2em;">Google Tasks Placeholder</h2>
<div id="googleTasksPlaceholder" style="background-color:#fefefe; border:1px solid #ccc; padding:10px; border-radius:4px;">
  <p>You can embed Google Tasks here in the future.</p>
</div>

<!-- Multi-Day Planner Modal -->
<div id="plannerModal">
  <div class="modal-content">
    <h3>Multi-Day Task Planner</h3>
    <p>Create a series of tasks across multiple days</p>
    
    <div id="plannerDays"></div>
    
    <button class="btn" id="addDayBtn">Add Another Day</button>
    
    <div style="margin-top:20px;">
      <button class="btn" id="savePlanBtn">Save All Tasks</button>
      <button class="btn" id="cancelPlanBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Weekly Planner Modal -->
<div id="weeklyModal">
  <div class="weekly-modal-content">
    <h3>Weekly Planner for: <span id="weeklyClientLabel"></span></h3>
    <p>Set tasks for each weekday. These tasks will appear automatically on those days.</p>
    
    <div id="weeklyContent"></div>
    
    <div style="margin-top:20px;">
      <button class="btn" id="saveWeeklyBtn">Save Weekly Schedule</button>
      <button class="btn" id="cancelWeeklyBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal">
  <div class="image-modal-content">
    <h3>Add an Image / Screenshot</h3>
    
    <div>
      <input type="file" id="imageFileInput" accept="image/*">
      <p style="color:#666;font-size:0.9em;">
        Or paste a screenshot directly (click here, then Ctrl+V).
      </p>
    </div>
    
    <img id="imagePreview" src="" alt="(Preview will appear here)" style="display:none; max-width:100%; max-height:200px; margin-top:10px; border:1px solid #ccc;">
    
    <div style="margin-top:10px;">
      <label>Image Title:</label><br/>
      <input type="text" id="imageTitle" style="width:90%;">
    </div>
    
    <div style="margin-top:10px;">
      <button class="btn" id="saveImageBtn">Save Image</button>
      <button class="btn" id="cancelImageBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="footer">
  <p>Data is stored in your browser's localStorage, keyed by client AND date. Add day notes, tasks, images, etc.</p>
  <p style="font-size: 0.8em; color:#444;">
    <em>You can save this as plain-text .html and open in any browser.</em>
  </p>
</div>

<script>
// *** STEP 1: Use a DIFFERENT localStorage key than the old code ***
const STORAGE_KEY = "multiClientDateDataV2";

// Data structure:
// allData[clientName] = {
//   bigGoal: "",
//   links: { canvas: "", classroom: "" },
//   weeklyTasks: { monday:[], tuesday:[], ... },
//   images: [],
//   "YYYY-MM-DD": {
//     dayRating: "0",
//     dayNotes: "",
//     tasks: [],
//     weeklyDone: {} // if they complete weekly tasks, we store done-check here
//   }
// };
let allData = {};
let currentClient = null;
let currentDate   = null;

/***************************************************************
  DOM ELEMENTS
****************************************************************/
const clientSelect        = document.getElementById("clientSelect");
const addClientBtn        = document.getElementById("addClientBtn");
const newClientForm       = document.getElementById("newClientForm");
const newClientName       = document.getElementById("newClientName");
const saveClientBtn       = document.getElementById("saveClientBtn");
const cancelClientBtn     = document.getElementById("cancelClientBtn");

const bigGoalInput        = document.getElementById("bigGoalInput");
const canvasLinkInput     = document.getElementById("canvasLinkInput");
const classroomLinkInput  = document.getElementById("classroomLinkInput");
const saveClientInfoBtn   = document.getElementById("saveClientInfoBtn");

const bigGoalDisplay      = document.getElementById("bigGoalDisplay");
const canvasLinkAnchor    = document.getElementById("canvasLinkAnchor");
const classroomLinkAnchor = document.getElementById("classroomLinkAnchor");

const datePicker          = document.getElementById("datePicker");
const clearTasksBtn       = document.getElementById("clearTasksBtn");
const exportBtn           = document.getElementById("exportBtn");
const reportBtn           = document.getElementById("reportBtn");

const dayRatingSelect     = document.getElementById("dayRatingSelect");
const dayNotesTextarea    = document.getElementById("dayNotes");

const timeSelect          = document.getElementById("timeSelect");
const durationSelect      = document.getElementById("durationSelect");
const activityInput       = document.getElementById("activityInput");
const taskSearch          = document.getElementById("taskSearch");
const addBtn              = document.getElementById("addBtn");
const taskTableBody       = document.getElementById("taskTable").querySelector("tbody");

/* Multi-day planner modal */
const multiDayPlanBtn     = document.getElementById("multiDayPlanBtn");
const plannerModal        = document.getElementById("plannerModal");
const plannerDays         = document.getElementById("plannerDays");
const addDayBtn           = document.getElementById("addDayBtn");
const savePlanBtn         = document.getElementById("savePlanBtn");
const cancelPlanBtn       = document.getElementById("cancelPlanBtn");

/* Weekly planner modal */
const weeklyPlanBtn       = document.getElementById("weeklyPlanBtn");
const weeklyModal         = document.getElementById("weeklyModal");
const weeklyClientLabel   = document.getElementById("weeklyClientLabel");
const weeklyContent       = document.getElementById("weeklyContent");
const saveWeeklyBtn       = document.getElementById("saveWeeklyBtn");
const cancelWeeklyBtn     = document.getElementById("cancelWeeklyBtn");

/* Images */
const imageBtn            = document.getElementById("imageBtn");
const imageModal          = document.getElementById("imageModal");
const imageFileInput      = document.getElementById("imageFileInput");
const imagePreview        = document.getElementById("imagePreview");
const imageTitleInput     = document.getElementById("imageTitle");
const saveImageBtn        = document.getElementById("saveImageBtn");
const cancelImageBtn      = document.getElementById("cancelImageBtn");
const imageGallery        = document.getElementById("imageGallery");

/* Progress dashboard */
const completionRateEl       = document.getElementById("completionRate");
const completionBarEl        = document.getElementById("completionBar");
const averageTaskRatingEl    = document.getElementById("averageTaskRating");
const displayDayRatingEl     = document.getElementById("displayDayRating");
const avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate");
const avgRatingBarEl         = document.getElementById("avgRatingBar");

/***************************************************************
  ON WINDOW LOAD
****************************************************************/
window.addEventListener("load", () => {
  // 1) Load from localStorage using our NEW KEY
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) {
    allData = JSON.parse(stored);
  }

  // 2) Populate client dropdown
  populateClientSelect();

  // 3) Default date = today
  const todayStr = new Date().toISOString().split("T")[0];
  datePicker.value = todayStr;
  currentDate = todayStr;

  // 4) If we have at least one client, pick the first
  const allClientNames = Object.keys(allData).sort();
  if (allClientNames.length > 0) {
    currentClient = allClientNames[0];
    clientSelect.value = currentClient;
    loadClientDate(currentClient, currentDate);
  } else {
    currentClient = null;
  }

  // 5) Build time dropdown
  populateTimeDropdown();

  // 6) Set up event listeners
  setupEventListeners();

  // 7) Prepare multi-day planner with an initial day
  addPlannerDay();
});

/***************************************************************
  EVENT LISTENERS
****************************************************************/
function setupEventListeners() {
  clientSelect.addEventListener("change", onClientOrDateChange);
  datePicker.addEventListener("change", onClientOrDateChange);
  dayRatingSelect.addEventListener("change", onDayRatingChange);
  dayNotesTextarea.addEventListener("input", onDayNotesChange);

  addBtn.addEventListener("click", addNewTask);
  clearTasksBtn.addEventListener("click", clearTasksForClientDate);
  exportBtn.addEventListener("click", exportData);
  reportBtn.addEventListener("click", generateReport);

  addClientBtn.addEventListener("click", showNewClientForm);
  saveClientBtn.addEventListener("click", saveNewClient);
  cancelClientBtn.addEventListener("click", hideNewClientForm);

  saveClientInfoBtn.addEventListener("click", saveClientInfo);

  multiDayPlanBtn.addEventListener("click", openPlannerModal);
  addDayBtn.addEventListener("click", addPlannerDay);
  savePlanBtn.addEventListener("click", saveMultiDayPlan);
  cancelPlanBtn.addEventListener("click", closePlannerModal);

  weeklyPlanBtn.addEventListener("click", openWeeklyModal);
  saveWeeklyBtn.addEventListener("click", saveWeeklySchedule);
  cancelWeeklyBtn.addEventListener("click", closeWeeklyModal);

  imageBtn.addEventListener("click", openImageModal);
  cancelImageBtn.addEventListener("click", closeImageModal);
  saveImageBtn.addEventListener("click", saveImage);
  imageModal.addEventListener("paste", handlePasteImage);
  imageFileInput.addEventListener("change", handleFileInputChange);

  // Task search
  taskSearch.addEventListener("input", () => {
    const searchText = taskSearch.value.toLowerCase();
    const rows = taskTableBody.querySelectorAll("tr");
    rows.forEach(row => {
      const activityCell = row.cells[1];
      if (!activityCell) return; // just in case
      const activityText = activityCell.textContent.toLowerCase();
      row.style.display = activityText.includes(searchText) ? "" : "none";
    });
  });

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    // Alt+A = Add Task
    if (e.altKey && e.key === "a") {
      e.preventDefault();
      addNewTask();
    }
    // Alt+D = Toggle last task as done
    if (e.altKey && e.key === "d") {
      e.preventDefault();
      const lastRow = taskTableBody.querySelector("tr:last-child");
      if (lastRow) {
        const checkbox = lastRow.querySelector("input[type='checkbox']");
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event("change"));
        }
      }
    }
    // Alt+S = Sort tasks by time
    if (e.altKey && e.key === "s") {
      e.preventDefault();
      sortTasksByTime();
    }
  });
}

/***************************************************************
  CLIENT SELECT & NEW CLIENT
****************************************************************/
function populateClientSelect() {
  clientSelect.innerHTML = "";
  const allClientNames = Object.keys(allData).sort();
  if (allClientNames.length === 0) {
    const opt = document.createElement("option");
    opt.textContent = "-- No Clients --";
    opt.value = "";
    clientSelect.appendChild(opt);
    return;
  }
  allClientNames.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    clientSelect.appendChild(opt);
  });
}
function onClientOrDateChange() {
  currentClient = clientSelect.value;
  currentDate = datePicker.value;
  loadClientDate(currentClient, currentDate);
}
function showNewClientForm() {
  newClientForm.style.display = "block";
  newClientName.value = "";
  newClientName.focus();
}
function hideNewClientForm() {
  newClientForm.style.display = "none";
}
function saveNewClient() {
  const name = newClientName.value.trim();
  if (!name) {
    alert("Please enter a client name.");
    return;
  }
  if (allData[name]) {
    alert(`Client "${name}" already exists!`);
    return;
  }
  allData[name] = {
    bigGoal: "",
    links: { canvas: "", classroom: "" },
    weeklyTasks: {
      monday: [], tuesday: [], wednesday: [], thursday: [],
      friday: [], saturday: [], sunday: []
    },
    images: []
    // daily date keys can be added as we go
  };
  saveToLocalStorage();
  populateClientSelect();
  clientSelect.value = name;
  currentClient = name;
  hideNewClientForm();
  // Show today’s date data
  loadClientDate(name, currentDate);
}

/***************************************************************
  BIG GOAL & LINKS
****************************************************************/
function saveClientInfo() {
  if (!currentClient) return;
  const cliData = allData[currentClient];
  if (!cliData) return;
  cliData.bigGoal = bigGoalInput.value.trim();
  cliData.links.canvas = canvasLinkInput.value.trim();
  cliData.links.classroom = classroomLinkInput.value.trim();
  saveToLocalStorage();
  renderClientInfo();
  alert("Client info saved!");
}
function renderClientInfo() {
  if (!currentClient || !allData[currentClient]) {
    bigGoalDisplay.textContent = "";
    canvasLinkAnchor.style.display = "none";
    classroomLinkAnchor.style.display = "none";
    return;
  }
  const cliData = allData[currentClient];
  // Big goal
  bigGoalDisplay.textContent = cliData.bigGoal || "(No big goal set)";
  bigGoalInput.value = cliData.bigGoal || "";

  // Canvas link
  if (cliData.links && cliData.links.canvas) {
    canvasLinkAnchor.href = cliData.links.canvas;
    canvasLinkAnchor.style.display = "inline-block";
  } else {
    canvasLinkAnchor.style.display = "none";
  }
  canvasLinkInput.value = cliData.links ? (cliData.links.canvas || "") : "";

  // Classroom link
  if (cliData.links && cliData.links.classroom) {
    classroomLinkAnchor.href = cliData.links.classroom;
    classroomLinkAnchor.style.display = "inline-block";
  } else {
    classroomLinkAnchor.style.display = "none";
  }
  classroomLinkInput.value = cliData.links ? (cliData.links.classroom || "") : "";
}

/***************************************************************
  LOAD CLIENT+DATE
****************************************************************/
function loadClientDate(clientName, dateStr) {
  if (!clientName) return;
  if (!allData[clientName]) {
    // create the shell
    allData[clientName] = {
      bigGoal: "",
      links: { canvas: "", classroom: "" },
      weeklyTasks: {
        monday: [], tuesday: [], wednesday: [], thursday: [],
        friday: [], saturday: [], sunday: []
      },
      images: []
    };
  }
  // Create a daily record if missing
  if (!allData[clientName][dateStr]) {
    allData[clientName][dateStr] = {
      dayRating: "0",
      dayNotes: "",
      tasks: [],
      weeklyDone: {}
    };
  }
  // Render top info
  renderClientInfo();

  // Fill out day rating, notes
  const rec = allData[clientName][dateStr];
  dayRatingSelect.value = rec.dayRating || "0";
  dayNotesTextarea.value = rec.dayNotes || "";

  // Clear tasks table
  taskTableBody.innerHTML = "";

  // Show daily tasks
  (rec.tasks || []).forEach(t => addTaskRow(t));

  // Show weekly tasks that apply to this date's weekday
  const weekday = getWeekdayFromDate(dateStr);
  const weeklyList = allData[clientName].weeklyTasks[weekday] || [];
  weeklyList.forEach(wt => addWeeklyTaskRow(wt, dateStr));

  // Render images
  renderImageGallery();
  // Update progress bars
  updateProgress();
}
function getWeekdayFromDate(dateStr) {
  const d = new Date(dateStr);
  // 0=Sun,1=Mon,2=Tue,...
  const map = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
  return map[d.getDay()];
}

/***************************************************************
  DAY RATING & NOTES
****************************************************************/
function onDayRatingChange() {
  if (!currentClient || !currentDate) return;
  const rec = allData[currentClient][currentDate];
  if (rec) {
    rec.dayRating = dayRatingSelect.value;
    saveToLocalStorage();
    updateProgress();
  }
}
function onDayNotesChange() {
  if (!currentClient || !currentDate) return;
  const rec = allData[currentClient][currentDate];
  if (rec) {
    rec.dayNotes = dayNotesTextarea.value;
    saveToLocalStorage();
  }
}

/***************************************************************
  TIME DROPDOWN
****************************************************************/
function populateTimeDropdown() {
  timeSelect.innerHTML = "";
  // 5am to 11pm in 15-min increments
  for (let hour=5; hour<24; hour++) {
    for (let min=0; min<60; min+=15) {
      const suffix = hour < 12 ? "AM" : "PM";
      let dispHour = hour % 12;
      if (dispHour===0) dispHour=12;
      const minStr = min===0 ? "00" : min.toString();
      const label = `${dispHour}:${minStr} ${suffix}`;
      const opt = document.createElement("option");
      opt.value = label;
      opt.textContent = label;
      timeSelect.appendChild(opt);
    }
  }
  // Common times
  const sep = document.createElement("option");
  sep.disabled = true;
  sep.textContent = "---- Common Times ----";
  timeSelect.appendChild(sep);
  const commonTimes = [
    "Before School","During Study Hall","During Lunch",
    "Right After School","Before Dinner","After Dinner","Before Bed"
  ];
  commonTimes.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    timeSelect.appendChild(opt);
  });
}

/***************************************************************
  ADD TASK
****************************************************************/
function addNewTask() {
  if (!currentClient || !currentDate) return;
  const actVal = activityInput.value.trim();
  if (!actVal) {
    alert("Please enter an activity.");
    return;
  }
  const rec = allData[currentClient][currentDate];
  const newTask = {
    time: timeSelect.value,
    duration: durationSelect.value,
    activity: actVal,
    completed: false,
    rating: "0"
  };
  rec.tasks.push(newTask);
  saveToLocalStorage();

  addTaskRow(newTask);
  activityInput.value = "";
  sortTasksByTime();
  updateProgress();
}
function addTaskRow(taskObj) {
  const row = taskTableBody.insertRow();
  row.classList.add("task-row");
  if (taskObj.completed) row.classList.add("completed-task");

  // Time cell
  const tdTime = row.insertCell(0);
  tdTime.innerHTML = taskObj.time;
  if (taskObj.duration) {
    tdTime.innerHTML += `<br><span style="font-size:0.8em; color:#666;">${taskObj.duration}</span>`;
  }
  // Activity cell
  const tdAct = row.insertCell(1);
  tdAct.textContent = taskObj.activity;

  // Done? cell
  const tdDone = row.insertCell(2);
  const chk = document.createElement("input");
  chk.type = "checkbox";
  chk.checked = taskObj.completed;
  chk.addEventListener("change", () => {
    taskObj.completed = chk.checked;
    row.classList.toggle("completed-task", chk.checked);
    saveToLocalStorage();
    updateProgress();
  });
  tdDone.appendChild(chk);

  // Rating cell
  const tdRating = row.insertCell(3);
  const sel = document.createElement("select");
  for (let i=0; i<=5; i++){
    const o = document.createElement("option");
    o.value = i.toString();
    o.text = (i===0) ? "--" : i.toString();
    sel.appendChild(o);
  }
  sel.value = taskObj.rating || "0";
  sel.addEventListener("change", () => {
    taskObj.rating = sel.value;
    saveToLocalStorage();
    updateProgress();
  });
  tdRating.appendChild(sel);

  // Actions cell
  const tdActions = row.insertCell(4);
  const editBtn = document.createElement("button");
  editBtn.textContent = "✎";
  editBtn.classList.add("btn");
  editBtn.addEventListener("click", () => {
    makeTaskEditable(row, taskObj);
  });
  tdActions.appendChild(editBtn);

  const rmBtn = document.createElement("button");
  rmBtn.textContent = "X";
  rmBtn.classList.add("btn");
  rmBtn.style.marginLeft = "5px";
  rmBtn.addEventListener("click", () => {
    removeTask(taskObj);
    row.remove();
    updateProgress();
  });
  tdActions.appendChild(rmBtn);
}

/***************************************************************
  ADD WEEKLY TASK ROW
****************************************************************/
function addWeeklyTaskRow(wTask, dateStr) {
  const rec = allData[currentClient][dateStr];
  if (!rec.weeklyDone) rec.weeklyDone = {};
  const row = taskTableBody.insertRow();
  row.classList.add("task-row");

  const wasDone = !!rec.weeklyDone[wTask.id];
  if (wasDone) row.classList.add("completed-task");

  // Time cell
  const tdTime = row.insertCell(0);
  tdTime.innerHTML = `(Weekly) ${wTask.time}`;
  if (wTask.duration) {
    tdTime.innerHTML += `<br><span style="font-size:0.8em; color:#666;">${wTask.duration}</span>`;
  }

  // Activity cell
  const tdAct = row.insertCell(1);
  tdAct.textContent = wTask.activity;

  // Done? cell
  const tdDone = row.insertCell(2);
  const chk = document.createElement("input");
  chk.type = "checkbox";
  chk.checked = wasDone;
  chk.addEventListener("change", () => {
    rec.weeklyDone[wTask.id] = chk.checked;
    row.classList.toggle("completed-task", chk.checked);
    saveToLocalStorage();
    updateProgress();
  });
  tdDone.appendChild(chk);

  // Rating cell (not used for weekly tasks)
  const tdRating = row.insertCell(3);
  tdRating.textContent = "--";

  // Actions cell
  const tdActions = row.insertCell(4);
  tdActions.innerHTML = `<em style="color:#888;">(Edit in Weekly Plan)</em>`;
}

/***************************************************************
  EDIT A TASK
****************************************************************/
function makeTaskEditable(row, taskObj) {
  const tdTime = row.cells[0];
  const tdAct  = row.cells[1];
  const oldTime = taskObj.time;
  const oldAct  = taskObj.activity;
  const oldDur  = taskObj.duration;

  // Time/duration editing
  tdTime.innerHTML = "";
  const newTimeSel = document.createElement("select");
  populateTempTimeDropdown(newTimeSel, oldTime);
  tdTime.appendChild(newTimeSel);

  const newDurSel = document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.text  = d;
    newDurSel.appendChild(opt);
  });
  newDurSel.value = oldDur;
  tdTime.appendChild(document.createElement("br"));
  tdTime.appendChild(newDurSel);

  // Activity editing
  tdAct.innerHTML = "";
  const actField = document.createElement("input");
  actField.type = "text";
  actField.value = oldAct;
  actField.style.width = "95%";
  tdAct.appendChild(actField);

  // Actions cell
  const tdActions = row.cells[4];
  const oldHTML = tdActions.innerHTML;
  tdActions.innerHTML = "";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";
  saveBtn.classList.add("btn");
  saveBtn.addEventListener("click", () => {
    const newTime = newTimeSel.value;
    const newDur  = newDurSel.value;
    const newAct  = actField.value.trim();
    if (!newAct) {
      alert("Activity cannot be empty.");
      return;
    }
    taskObj.time = newTime;
    taskObj.duration = newDur;
    taskObj.activity = newAct;
    saveToLocalStorage();
    // Re-render row
    const idx = Array.from(taskTableBody.rows).indexOf(row);
    row.remove();
    const newRow = taskTableBody.insertRow(idx);
    addTaskRow(taskObj);
    sortTasksByTime();
    updateProgress();
  });
  tdActions.appendChild(saveBtn);

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "Cancel";
  cancelBtn.classList.add("btn");
  cancelBtn.style.marginLeft = "5px";
  cancelBtn.addEventListener("click", () => {
    // revert
    tdTime.innerHTML = oldTime;
    tdAct.textContent = oldAct;
    tdActions.innerHTML = oldHTML;
  });
  tdActions.appendChild(cancelBtn);

  actField.focus();
}
function populateTempTimeDropdown(sel, currentVal) {
  // Copy from the main timeSelect
  for (let i=0; i<timeSelect.options.length; i++){
    const clone = timeSelect.options[i].cloneNode(true);
    sel.appendChild(clone);
  }
  sel.value = currentVal;
}

/***************************************************************
  SORT TASKS BY TIME
****************************************************************/
function sortTasksByTime() {
  if (!currentClient || !currentDate) return;
  const rec = allData[currentClient][currentDate];
  if (!rec || !rec.tasks) return;
  rec.tasks.sort((a,b) => {
    return convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time);
  });
  saveToLocalStorage();
  loadClientDate(currentClient, currentDate);
}
function convertTimeToMinutes(tStr) {
  // handle special blocks
  const special = {
    "Before School": 360,
    "During Study Hall": 600,
    "During Lunch": 720,
    "Right After School": 840,
    "Before Dinner": 1020,
    "After Dinner": 1140,
    "Before Bed": 1320
  };
  if (special[tStr]) return special[tStr];

  const parts = tStr.split(" ");
  if (parts.length<2) return 9999;
  const hhmm = parts[0], ampm = parts[1].toUpperCase();
  const [hh, mm] = hhmm.split(":").map(n=>parseInt(n,10));
  if (isNaN(hh) || isNaN(mm)) return 9999;
  let hours = hh;
  if (ampm==="PM" && hours<12) hours +=12;
  if (ampm==="AM" && hours===12) hours=0;
  return hours*60 + mm;
}

/***************************************************************
  REMOVE TASK
****************************************************************/
function removeTask(taskObj) {
  const rec = allData[currentClient][currentDate];
  const idx = rec.tasks.indexOf(taskObj);
  if (idx!==-1) {
    rec.tasks.splice(idx,1);
    saveToLocalStorage();
  }
}

/***************************************************************
  CLEAR TASKS
****************************************************************/
function clearTasksForClientDate() {
  if (!currentClient || !currentDate) return;
  if (confirm(`Clear ALL tasks for ${currentClient} on ${currentDate}?`)) {
    allData[currentClient][currentDate].tasks = [];
    saveToLocalStorage();
    loadClientDate(currentClient, currentDate);
  }
}

/***************************************************************
  EXPORT
****************************************************************/
function exportData() {
  const dataStr = JSON.stringify(allData, null, 2);
  const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);
  const link = document.createElement("a");
  link.setAttribute("href", dataUri);
  link.setAttribute("download", "client-tracker-v2-export-" + new Date().toISOString().split("T")[0] + ".json");
  link.click();
}

/***************************************************************
  SAVE TO LOCALSTORAGE
****************************************************************/
function saveToLocalStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
  } catch (err) {
    if (err.name==="QuotaExceededError") {
      alert("Storage limit exceeded. Please export data & clear some entries.");
    } else {
      console.error("Error saving data:", err);
      alert("Problem saving data; changes may not persist.");
    }
  }
}

/***************************************************************
  UPDATE PROGRESS
****************************************************************/
function updateProgress() {
  if (!currentClient || !currentDate) return;
  const rec = allData[currentClient][currentDate];
  if (!rec) return;

  const tasks = rec.tasks || [];
  const weekday = getWeekdayFromDate(currentDate);
  const weeklyTasks = allData[currentClient].weeklyTasks[weekday] || [];
  const wdMap = rec.weeklyDone || {};

  const dailyDone = tasks.filter(t=>t.completed).length;
  const weeklyDone = weeklyTasks.filter(wt=>wdMap[wt.id]).length;
  const totalDone = dailyDone + weeklyDone;
  const totalCount = tasks.length + weeklyTasks.length;

  // Completion Rate
  if (totalCount===0) {
    completionRateEl.textContent = "-";
    completionBarEl.style.width = "0%";
    completionBarEl.textContent = "0%";
    averageTaskRatingEl.textContent = "-";
  } else {
    const pct = Math.round((totalDone / totalCount)*100);
    completionRateEl.textContent = `${pct}% (${totalDone}/${totalCount})`;
    completionBarEl.style.width = pct+"%";
    completionBarEl.textContent = pct+"%";

    // Average daily task rating
    const rated = tasks.filter(t=>t.rating!=="0");
    if (rated.length>0) {
      const sum = rated.reduce((acc, t)=>acc + parseInt(t.rating,10), 0);
      const avg = sum / rated.length;
      averageTaskRatingEl.textContent = avg.toFixed(1) + " / 5";
    } else {
      averageTaskRatingEl.textContent = "No task ratings yet";
    }
  }

  // Day rating
  const dr = rec.dayRating;
  displayDayRatingEl.textContent = (dr && dr!=="0") ? dr+"/5" : "--";

  // Avg day rating up to this date
  const dateKeys = Object.keys(allData[currentClient])
    .filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)&&k<=currentDate)
    .sort();
  let sumDR=0, cntDR=0;
  dateKeys.forEach(d=>{
    const dayRec = allData[currentClient][d];
    if (dayRec.dayRating && dayRec.dayRating!=="0") {
      sumDR += parseInt(dayRec.dayRating,10);
      cntDR++;
    }
  });
  if (cntDR>0) {
    const avgDR = sumDR/cntDR;
    avgDayRatingUpToDateEl.textContent = avgDR.toFixed(1) + " / 5";
    const p = (avgDR/5)*100;
    avgRatingBarEl.style.width = p+"%";
    avgRatingBarEl.textContent = avgDR.toFixed(1) + "/5";
  } else {
    avgDayRatingUpToDateEl.textContent = "No day ratings yet";
    avgRatingBarEl.style.width = "0%";
    avgRatingBarEl.textContent = "0/5";
  }
}

/***************************************************************
  MULTI-DAY PLANNER
****************************************************************/
function openPlannerModal() {
  plannerDays.innerHTML = "";
  addPlannerDay();
  plannerModal.style.display = "block";
}
function closePlannerModal() {
  plannerModal.style.display = "none";
}
function addPlannerDay() {
  const dayCount = plannerDays.querySelectorAll(".day-plan").length;
  const baseDate = new Date(currentDate);
  baseDate.setDate(baseDate.getDate()+dayCount);
  const dateStr = baseDate.toISOString().split("T")[0];

  const dayDiv = document.createElement("div");
  dayDiv.className = "day-plan";
  dayDiv.dataset.date = dateStr;

  const h4 = document.createElement("h4");
  h4.textContent = `Day ${dayCount+1}: ${formatDate(dateStr)}`;
  dayDiv.appendChild(h4);

  // Time+duration row
  const taskContainer = document.createElement("div");
  const lblTime = document.createElement("label");
  lblTime.textContent = "Time:";
  taskContainer.appendChild(lblTime);

  const timeSel = document.createElement("select");
  populateTempTimeDropdown(timeSel, "3:00 PM");
  taskContainer.appendChild(timeSel);

  const lblDur = document.createElement("label");
  lblDur.textContent = " Duration:";
  lblDur.style.marginLeft = "10px";
  taskContainer.appendChild(lblDur);

  const durSel = document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    durSel.appendChild(opt);
  });
  durSel.value="30 min";
  taskContainer.appendChild(durSel);

  dayDiv.appendChild(taskContainer);

  // Activity
  const lblAct = document.createElement("label");
  lblAct.textContent = "Activity:";
  lblAct.style.display = "block";
  lblAct.style.marginTop="10px";
  dayDiv.appendChild(lblAct);

  const actInput = document.createElement("input");
  actInput.type="text";
  actInput.placeholder = "e.g. Complete Math assignment";
  actInput.style.width="100%";
  dayDiv.appendChild(actInput);

  // "Add Another Task" button
  const addAnotherBtn = document.createElement("button");
  addAnotherBtn.className="btn";
  addAnotherBtn.style.marginTop="10px";
  addAnotherBtn.textContent="Add Another Task to this Day";
  addAnotherBtn.addEventListener("click", ()=>{
    const newTaskContainer = taskContainer.cloneNode(true);
    const newLblAct = lblAct.cloneNode(true);
    const newActInput = actInput.cloneNode(true);
    newActInput.value="";
    dayDiv.insertBefore(document.createElement("hr"), addAnotherBtn);
    dayDiv.insertBefore(newTaskContainer, addAnotherBtn);
    dayDiv.insertBefore(newLblAct, addAnotherBtn);
    dayDiv.insertBefore(newActInput, addAnotherBtn);
  });
  dayDiv.appendChild(addAnotherBtn);

  plannerDays.appendChild(dayDiv);
}
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString(undefined,{weekday:"short", month:"short", day:"numeric"});
}
function saveMultiDayPlan() {
  const days = plannerDays.querySelectorAll(".day-plan");
  let tasksAdded=0;
  days.forEach(dayBlock=>{
    const ds = dayBlock.dataset.date;
    if (!allData[currentClient][ds]) {
      allData[currentClient][ds] = {
        dayRating: "0",
        dayNotes: "",
        tasks: [],
        weeklyDone:{}
      };
    }
    const rec = allData[currentClient][ds];
    const selects = dayBlock.querySelectorAll("select");
    const inputs = dayBlock.querySelectorAll("input[type='text']");
    // Each "task" = 2 selects + 1 text input
    for (let i=0; i<inputs.length; i++){
      const activity = inputs[i].value.trim();
      if (activity==="") continue;
      const timeVal = selects[i*2].value;
      const durVal  = selects[i*2+1].value;
      rec.tasks.push({
        time: timeVal,
        duration: durVal,
        activity,
        completed:false,
        rating:"0"
      });
      tasksAdded++;
    }
  });
  saveToLocalStorage();
  loadClientDate(currentClient, currentDate);
  closePlannerModal();
  alert(`Multi-day plan created! ${tasksAdded} tasks added total.`);
}

/***************************************************************
  WEEKLY PLANNER
****************************************************************/
function openWeeklyModal() {
  if (!currentClient) return;
  weeklyClientLabel.textContent = currentClient;
  buildWeeklyContent();
  weeklyModal.style.display = "block";
}
function closeWeeklyModal() {
  weeklyModal.style.display = "none";
}
function buildWeeklyContent() {
  weeklyContent.innerHTML="";
  const days = ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  const wData = allData[currentClient].weeklyTasks;
  days.forEach(d=>{
    const sec = document.createElement("div");
    sec.classList.add("weekly-day-section");
    const hd = document.createElement("h4");
    hd.textContent = d[0].toUpperCase() + d.slice(1);
    sec.appendChild(hd);

    // Show existing tasks
    const tasksDiv = document.createElement("div");
    const dayTasks = wData[d] || [];
    dayTasks.forEach(task=>{
      const row = document.createElement("div");
      row.style.marginBottom="5px";
      row.textContent = `[${task.time}] ${task.activity}`;
      const rmBtn = document.createElement("button");
      rmBtn.classList.add("btn");
      rmBtn.textContent="X";
      rmBtn.style.marginLeft="5px";
      rmBtn.addEventListener("click", ()=>{
        const idx = dayTasks.indexOf(task);
        if (idx!==-1) {
          dayTasks.splice(idx,1);
          saveToLocalStorage();
          buildWeeklyContent();
        }
      });
      row.appendChild(rmBtn);
      tasksDiv.appendChild(row);
    });
    sec.appendChild(tasksDiv);

    // Input to add a new weekly task
    const addRow = document.createElement("div");
    addRow.style.marginTop="10px";
    const timeSel = document.createElement("select");
    populateTempTimeDropdown(timeSel, "3:00 PM");
    addRow.appendChild(timeSel);

    const durSel = document.createElement("select");
    ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(dd=>{
      const opt = document.createElement("option");
      opt.value=dd;
      opt.textContent=dd;
      durSel.appendChild(opt);
    });
    durSel.value="30 min";
    addRow.appendChild(durSel);

    const inp = document.createElement("input");
    inp.type="text";
    inp.placeholder="Activity...";
    inp.style.width="220px";
    inp.style.marginLeft="5px";
    addRow.appendChild(inp);

    const plusBtn = document.createElement("button");
    plusBtn.textContent="+";
    plusBtn.classList.add("btn");
    plusBtn.style.marginLeft="5px";
    plusBtn.addEventListener("click", ()=>{
      const val = inp.value.trim();
      if (!val) {
        alert("Please enter an activity.");
        return;
      }
      const newId=`weekly_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      dayTasks.push({
        id:newId,
        time:timeSel.value,
        duration:durSel.value,
        activity:val
      });
      saveToLocalStorage();
      buildWeeklyContent();
    });
    addRow.appendChild(plusBtn);

    sec.appendChild(addRow);
    weeklyContent.appendChild(sec);
  });
}
function saveWeeklySchedule() {
  closeWeeklyModal();
  loadClientDate(currentClient, currentDate);
  alert("Weekly schedule saved!");
}

/***************************************************************
  IMAGES
****************************************************************/
function openImageModal() {
  imageFileInput.value="";
  imagePreview.src="";
  imagePreview.style.display="none";
  imageTitleInput.value="";
  imageModal.style.display="block";
}
function closeImageModal() {
  imageModal.style.display="none";
}
function handleFileInputChange() {
  const file = imageFileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    imagePreview.src=e.target.result;
    imagePreview.style.display="block";
  };
  reader.readAsDataURL(file);
}
function handlePasteImage(e) {
  // older browsers won't have e.clipboardData
  let items = [];
  if (e.clipboardData && e.clipboardData.items) {
    items = e.clipboardData.items;
  }
  for (let i=0; i<items.length; i++){
    const it = items[i];
    if (it.type.indexOf("image")===0) {
      const file = it.getAsFile();
      if (file) {
        const reader = new FileReader();
        reader.onload = evt=>{
          imagePreview.src=evt.target.result;
          imagePreview.style.display="block";
        };
        reader.readAsDataURL(file);
      }
    }
  }
}
function saveImage() {
  if (!imagePreview.src) {
    alert("No image to save");
    return;
  }
  if (!currentClient) return;
  const title = imageTitleInput.value.trim() || "(Untitled)";
  allData[currentClient].images.push({
    title,
    dataUrl: imagePreview.src
  });
  saveToLocalStorage();
  closeImageModal();
  renderImageGallery();
}
function renderImageGallery() {
  imageGallery.innerHTML="";
  if (!currentClient) return;
  const imgs = allData[currentClient].images || [];
  if (imgs.length===0) return;
  const h3 = document.createElement("h3");
  h3.textContent="Image Gallery";
  imageGallery.appendChild(h3);

  imgs.forEach((imgObj, idx)=>{
    const div = document.createElement("div");
    div.classList.add("gallery-item");
    const spn = document.createElement("span");
    spn.classList.add("title");
    spn.textContent = (imgObj.title||"") + " ";
    div.appendChild(spn);

    const thumb = document.createElement("img");
    thumb.src=imgObj.dataUrl;
    thumb.style.maxHeight="60px";
    thumb.style.cursor="pointer";
    thumb.addEventListener("click", ()=>{
      window.open(imgObj.dataUrl,"_blank");
    });
    div.appendChild(thumb);

    const rmBtn = document.createElement("button");
    rmBtn.classList.add("btn");
    rmBtn.textContent="X";
    rmBtn.style.marginLeft="10px";
    rmBtn.addEventListener("click", ()=>{
      if (confirm("Remove this image?")) {
        imgs.splice(idx,1);
        saveToLocalStorage();
        renderImageGallery();
      }
    });
    div.appendChild(rmBtn);

    imageGallery.appendChild(div);
  });
}

/***************************************************************
  VIEW REPORT
****************************************************************/
function generateReport() {
  if (!currentClient) return;
  const cliData = allData[currentClient];
  let html = `
    <html>
    <head>
      <title>Client Report - ${escapeHtml(currentClient)}</title>
      <style>
        body {
          font-family: sans-serif;
          margin: 20px auto;
          max-width: 800px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 1em;
        }
        table, th, td {
          border: 1px solid #999;
        }
        th {
          background-color: #f0f0f0;
        }
        th, td {
          padding: 6px;
          text-align: left;
          vertical-align: top;
        }
        .notes-box {
          background-color: #eef;
          border: 1px solid #ccc;
          padding: 5px;
          margin: 5px 0;
        }
        .gallery-img {
          max-width: 200px;
          margin: 5px;
          border: 1px solid #ccc;
        }
      </style>
    </head>
    <body>
      <h1>Client Report - ${escapeHtml(currentClient)}</h1>
  `;

  // Big goal
  html += `<p><strong>Big Goal:</strong> ${escapeHtml(cliData.bigGoal || "")}</p>`;

  // Links (canvas, classroom) if they exist
  if (cliData.links && cliData.links.canvas) {
    html += `<p><a href="${escapeHtml(cliData.links.canvas)}" target="_blank">Canvas Link</a></p>`;
  }
  if (cliData.links && cliData.links.classroom) {
    html += `<p><a href="${escapeHtml(cliData.links.classroom)}" target="_blank">Google Classroom</a></p>`;
  }

  // Weekly tasks
  if (cliData.weeklyTasks) {
    html += `<h2>Weekly Recurring Tasks</h2>`;
    Object.keys(cliData.weeklyTasks).forEach(day=>{
      const dayTasks = cliData.weeklyTasks[day];
      if (dayTasks && dayTasks.length>0) {
        html += `<h3>${escapeHtml(day)}</h3><ul>`;
        dayTasks.forEach(t=>{
          html += `<li>${escapeHtml(t.time)} - ${escapeHtml(t.activity)}</li>`;
        });
        html += `</ul>`;
      }
    });
  }

  // Images
  const images = cliData.images || [];
  if (images.length>0) {
    html += `<h2>Images</h2>`;
    images.forEach(img=>{
      html += `<div>
        <strong>${escapeHtml(img.title)}</strong><br/>
        <img src="${img.dataUrl}" alt="img" class="gallery-img"/>
      </div>`;
    });
  }

  // All daily dates
  const dateKeys = Object.keys(cliData)
    .filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k))
    .sort();
  if (dateKeys.length===0) {
    html += `<p>No daily records.</p>`;
  } else {
    dateKeys.forEach(d=>{
      const rec = cliData[d];
      if (!rec) return;
      const drVal = (rec.dayRating && rec.dayRating!=="0")? rec.dayRating +"/5" : "--";
      html += `<h2>Date: ${escapeHtml(d)} (Day Rating: ${drVal})</h2>`;
      if (rec.dayNotes) {
        html += `<div class="notes-box">${escapeHtml(rec.dayNotes).replace(/\n/g,"<br/>")}</div>`;
      }

      // Merge daily tasks + weekly tasks
      const tasks = rec.tasks || [];
      const weekday = getWeekdayFromDate(d);
      const wList = cliData.weeklyTasks[weekday] || [];
      const doneMap = rec.weeklyDone || {};
      const merged = [];
      tasks.forEach(t=> merged.push({...t, _type:"daily"}));
      wList.forEach(wt=>{
        const isDone = !!doneMap[wt.id];
        merged.push({
          time: wt.time, 
          duration: wt.duration, 
          activity: wt.activity, 
          completed: isDone, 
          rating:"(weekly)",
          _type:"weekly"
        });
      });

      // Sort by time
      merged.sort((a,b)=> convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time));
      if (merged.length===0) {
        html += `<p>(No tasks)</p>`;
        return;
      }
      // Table of tasks
      html += `<table>
        <thead>
          <tr>
            <th>Time</th><th>Activity</th><th>Done?</th><th>Rating</th>
          </tr>
        </thead>
        <tbody>`;
      let doneCount=0;
      merged.forEach(t=>{
        if (t.completed) doneCount++;
        let ratingStr="--";
        if (t._type==="daily" && t.rating!=="0") {
          ratingStr = t.rating+"/5";
        } else if (t._type==="weekly") {
          ratingStr = "(weekly)";
        }
        html += `<tr>
          <td>${escapeHtml(t.time)}${t.duration?("<br><small>"+escapeHtml(t.duration)+"</small>"):""}${t._type==="weekly"?"<br>(Weekly)":""}</td>
          <td>${escapeHtml(t.activity||"")}</td>
          <td>${t.completed?"Yes":"No"}</td>
          <td>${ratingStr}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      html += `<p><strong>Completed:</strong> ${doneCount}/${merged.length}</p>`;
    });
  }

  html += `</body></html>`;
  const w = window.open("","_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/***************************************************************
  HELPERS
****************************************************************/
function escapeHtml(str) {
  if (!str) return "";
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
</script>
</body>
</html>
