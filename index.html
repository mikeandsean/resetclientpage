<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>RESET Tracker - Single Page All-In</title>
  <style>
    /* -- BASIC STYLES -- */
    body {
      background: #EAF6FF;
      font-family: sans-serif;
      margin: 0 auto;
      max-width: 800px;
      padding: 0 1rem 2rem 1rem;
    }
    h1, h2, h3 {
      margin-bottom: 0.5rem;
    }
    h1 { margin-top: 1rem; }
    .btn {
      display: inline-block;
      padding: 0.4em 0.8em;
      margin: 0.2rem 0.2rem 0.2rem 0;
      border: 1px solid #ccc;
      background-color: #f5f5f5;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      background: #e9eef2;
    }
    .btn-primary {
      background: #4A90E2;
      color: #fff;
      border-color: #4A90E2;
    }
    .btn-primary:hover {
      background: #357ABD;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }
    .controls label {
      font-weight: bold;
      margin-right: 0.3rem;
    }
    select, input[type="date"], input[type="text"], textarea {
      font-size: 1em;
    }

    hr {
      border: none; 
      border-top: 1px solid #ccc;
      margin: 1rem 0;
    }

    /* -- TABLES -- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #fafafa;
    }
    tr.completed-task td:not(:last-child) {
      text-decoration: line-through;
      color: #888;
    }

    /* -- PROGRESS -- */
    .progress-bar-container {
      width: 100%;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
      margin: 0.4rem 0;
    }
    .progress-bar {
      height: 20px;
      background: #48BB78;
      color: #fff;
      text-align: center;
      line-height: 20px;
      font-weight: bold;
      transition: width 0.3s;
    }
    /* -- ALTERNATE BAR -- */
    .blue-bar {
      background: #4A90E2;
    }

    /* -- MODALS -- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      margin: 3rem auto;
      padding: 1rem;
      width: 90%;
      max-width: 700px;
      border-radius: 4px;
      position: relative;
    }
    .modal-header {
      margin-bottom: 1rem;
    }
    .modal-header h3 {
      margin: 0;
    }
    .modal-close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      cursor: pointer;
      background: #f33;
      color: #fff;
      border: none;
      font-weight: bold;
      padding: 0.2rem 0.6rem;
      border-radius: 3px;
    }

    /* .day-plan, .weekly-day-section, etc. for multi-day/weekly planner styling */
    .day-plan, .weekly-day-section {
      margin-bottom: 1rem;
      padding: 0.8rem;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .time-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .time-container label {
      margin-top: 0.4rem;
    }

    /* -- IMAGE GALLERY -- */
    #imageGallery {
      margin-top: 1rem;
      border: 1px solid #ccc;
      padding: 1rem;
      background: #fff;
      border-radius: 4px;
    }
    .gallery-item {
      margin-bottom: 0.5rem;
    }
    .gallery-item img {
      max-height: 60px;
      margin-right: 0.5rem;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    /* Mobile responsiveness */
    @media(max-width: 600px) {
      body {
        margin: 0 auto;
        padding: 0 0.5rem;
      }
      th, td {
        font-size: 0.9em;
      }
      .controls {
        flex-direction: column;
        gap: 0.2rem;
      }
    }
  </style>
</head>
<body>

<h1>RESET Tracker - Single Page All-In</h1>

<div class="controls">
  <div>
    <label>Client:</label>
    <select id="clientSelect"></select>
    <button class="btn" id="addClientBtn">+ Add Client</button>
  </div>
  <div>
    <label>Date:</label>
    <input type="date" id="datePicker" />
  </div>
  <button class="btn" id="clearTasksBtn">Clear Tasks</button>
  <button class="btn" id="reportBtn">View Report</button>
  <button class="btn" id="multiDayBtn">Multi-Day</button>
  <button class="btn" id="weeklyBtn">Weekly</button>
  <button class="btn" id="imageBtn">Images</button>
  <button class="btn" id="exportBtn">Export</button>
</div>

<!-- New Client Form -->
<div id="newClientForm" style="display:none; margin: 0.5rem 0; padding: 0.5rem; background:#f0f8ff; border:1px solid #ccc; border-radius:4px;">
  <label>New Client Name:</label>
  <input type="text" id="newClientName" placeholder="e.g. John" />
  <button class="btn btn-primary" id="saveClientBtn">Save</button>
  <button class="btn" id="cancelClientBtn">Cancel</button>
</div>

<!-- Big Goal & Links -->
<div style="margin-bottom:1rem;">
  <label>Big Goal:</label>
  <input type="text" id="bigGoalInput" placeholder="e.g. Get into Yale" style="width:300px;" />
  <label>Canvas Link:</label>
  <input type="text" id="canvasLinkInput" style="width:200px;" />
  <label>Classroom Link:</label>
  <input type="text" id="classroomLinkInput" style="width:200px;" />
  <button class="btn btn-primary" id="saveClientInfoBtn">Save Info</button>
</div>

<div id="bigGoalDisplay" style="margin-bottom:0.5rem; font-weight:bold; color:#006;">
  (No big goal set)
</div>
<div style="margin-bottom:1rem;">
  <a href="#" id="canvasLinkAnchor" target="_blank" style="margin-right:1rem; display:none;">Open Canvas</a>
  <a href="#" id="classroomLinkAnchor" target="_blank" style="display:none;">Open Classroom</a>
</div>

<hr/>

<!-- Reflection Section -->
<h2>Daily Reflection</h2>
<div style="margin-bottom:0.5rem;">
  <label>Day Rating (1–5):</label>
  <select id="dayRatingSelect">
    <option value="0">--</option>
    <option value="1">1</option><option value="2">2</option>
    <option value="3">3</option><option value="4">4</option>
    <option value="5">5</option>
  </select>
</div>
<div style="margin-bottom:1rem;">
  <label>Reflection Notes:</label><br/>
  <textarea id="dayNotes" rows="3" style="width:100%;" placeholder="Notes for the day..."></textarea>
</div>

<hr/>

<!-- Add New Task -->
<h2>Add New Task</h2>
<div style="margin-bottom:0.5rem;">
  <label>Time:</label>
  <select id="timeSelect"></select>
  <label>Duration:</label>
  <select id="durationSelect">
    <option value="5 min">5 min</option>
    <option value="10 min">10 min</option>
    <option value="15 min">15 min</option>
    <option value="30 min" selected>30 min</option>
    <option value="45 min">45 min</option>
    <option value="1 hour">1 hour</option>
    <option value="90 min">90 min</option>
    <option value="2 hours">2 hours</option>
  </select>
</div>
<div>
  <label>Activity:</label>
  <input type="text" id="activityInput" style="width:50%;" placeholder="e.g. Work on math..." />
</div>
<div style="margin-top:0.5rem;">
  <label>Search:</label>
  <input type="text" id="taskSearch" style="width:30%;" placeholder="Filter tasks below..." />
</div>
<button class="btn btn-primary" id="addTaskBtn" style="margin-top:0.5rem;">Add Task</button>

<table style="margin-top:1rem;">
  <thead>
    <tr>
      <th style="width:15%;">Time</th>
      <th style="width:40%;">Activity</th>
      <th style="width:10%;">Done?</th>
      <th style="width:10%;">Rating</th>
      <th style="width:25%;">Actions</th>
    </tr>
  </thead>
  <tbody id="taskTable">
    <tr><td colspan="5" style="text-align:center; color:#666;">(No tasks yet)</td></tr>
  </tbody>
</table>

<!-- Image Gallery -->
<div id="imageGallery"></div>

<hr/>

<!-- Progress Dashboard -->
<h2>Progress Dashboard</h2>
<p><strong>Task Completion:</strong> <span id="completionRate">-</span></p>
<div class="progress-bar-container">
  <div id="completionBar" class="progress-bar" style="width:0%">0%</div>
</div>

<p><strong>Average Task Rating (this day):</strong> <span id="averageTaskRating">-</span></p>
<hr/>
<p><strong>Day Rating (this day):</strong> <span id="displayDayRating">-</span></p>
<p><strong>Avg Day Rating (up to this date):</strong> <span id="avgDayRatingUpToDate">-</span></p>
<div class="progress-bar-container">
  <div id="avgRatingBar" class="progress-bar blue-bar" style="width:0%">0/5</div>
</div>

<!-- Google Calendar -->
<h2>Google Calendar</h2>
<iframe 
  style="width:100%; height:600px; border:1px solid #ccc; border-radius:4px;"
  src="https://calendar.google.com/calendar/embed?src=YOUR_CALENDAR_ID_HERE"
  frameborder="0">
</iframe>

<!-- Google Tasks Placeholder -->
<h2>Google Tasks (Placeholder)</h2>
<div style="background:#fff; border:1px solid #ccc; padding:1rem; border-radius:4px; margin-bottom:2rem;">
  <p>Future: Integrate Google Tasks with API & OAuth. For now, use the official Google Tasks in a separate tab.</p>
</div>

<!-- FOOTER -->
<div style="margin-top:2rem; color:#666; font-size:0.9em; border-top:1px solid #ccc; padding-top:1rem;">
  <p>All data stored in your browser's localStorage, keyed by client + date.</p>
</div>

<!-- 1) MULTI-DAY PLANNER MODAL -->
<div id="multiDayModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="multiDayModal">X</button>
    <div class="modal-header">
      <h3>Multi-Day Task Planner</h3>
    </div>
    <p>Create tasks for multiple upcoming days at once.</p>
    <div id="multiDaysContainer"></div>
    <button class="btn" id="addAnotherDayBtn">Add Another Day</button>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveMultiDayBtn">Save All</button>
      <button class="btn" data-close="multiDayModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 2) WEEKLY PLANNER MODAL -->
<div id="weeklyModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="weeklyModal">X</button>
    <div class="modal-header">
      <h3>Weekly Planner</h3>
    </div>
    <p>Set recurring tasks for each weekday.</p>
    <div id="weeklyContainer"></div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveWeeklyBtn">Save Weekly</button>
      <button class="btn" data-close="weeklyModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 3) IMAGES MODAL -->
<div id="imageModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="imageModal">X</button>
    <div class="modal-header">
      <h3>Add Image / Screenshot</h3>
    </div>
    <div>
      <input type="file" id="imageFileInput" accept="image/*" />
      <p style="color:#666; font-size:0.9em;">Or paste a screenshot directly (click here, then Ctrl+V).</p>
    </div>
    <img id="imagePreview" src="" alt="preview" style="display:none; max-width:100%; max-height:200px; margin:0.5rem 0; border:1px solid #ccc;" />
    <div>
      <label>Title:</label><br/>
      <input type="text" id="imageTitle" style="width:80%;" placeholder="Optional title">
    </div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveImageBtn">Save Image</button>
      <button class="btn" data-close="imageModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 4) REPORT POPUP (We'll open in new tab, but you could also do a modal) -->

<script type="module">
/********************************************************************
   SINGLE-PAGE "All-In" RESET TRACKER
********************************************************************/

/********************************************************************
   1) DATA STRUCTURE
********************************************************************/
let allData = {}; // all clients => localStorage
const STORAGE_KEY = "multiClientDateData_AdvancedSinglePage";

/********************************************************************
   2) ON LOAD
********************************************************************/
const clientSelect     = document.getElementById("clientSelect");
const datePicker       = document.getElementById("datePicker");
const addClientBtn     = document.getElementById("addClientBtn");
const clearTasksBtn    = document.getElementById("clearTasksBtn");
const reportBtn        = document.getElementById("reportBtn");
const multiDayBtn      = document.getElementById("multiDayBtn");
const weeklyBtn        = document.getElementById("weeklyBtn");
const imageBtn         = document.getElementById("imageBtn");
const exportBtn        = document.getElementById("exportBtn");

const newClientForm    = document.getElementById("newClientForm");
const newClientName    = document.getElementById("newClientName");
const saveClientBtn    = document.getElementById("saveClientBtn");
const cancelClientBtn  = document.getElementById("cancelClientBtn");

const bigGoalInput     = document.getElementById("bigGoalInput");
const canvasLinkInput  = document.getElementById("canvasLinkInput");
const classroomLinkInput = document.getElementById("classroomLinkInput");
const saveClientInfoBtn= document.getElementById("saveClientInfoBtn");
const bigGoalDisplay   = document.getElementById("bigGoalDisplay");
const canvasLinkAnchor = document.getElementById("canvasLinkAnchor");
const classroomLinkAnchor= document.getElementById("classroomLinkAnchor");

const dayRatingSelect  = document.getElementById("dayRatingSelect");
const dayNotesTextarea = document.getElementById("dayNotes");

const timeSelect       = document.getElementById("timeSelect");
const durationSelect   = document.getElementById("durationSelect");
const activityInput    = document.getElementById("activityInput");
const taskSearch       = document.getElementById("taskSearch");
const addTaskBtn       = document.getElementById("addTaskBtn");
const taskTable        = document.getElementById("taskTable");

const completionRateEl    = document.getElementById("completionRate");
const completionBarEl     = document.getElementById("completionBar");
const averageTaskRatingEl = document.getElementById("averageTaskRating");
const displayDayRatingEl  = document.getElementById("displayDayRating");
const avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate");
const avgRatingBarEl      = document.getElementById("avgRatingBar");

// Multi-day modal
const multiDayModal       = document.getElementById("multiDayModal");
const multiDaysContainer  = document.getElementById("multiDaysContainer");
const addAnotherDayBtn    = document.getElementById("addAnotherDayBtn");
const saveMultiDayBtn     = document.getElementById("saveMultiDayBtn");

// Weekly modal
const weeklyModal         = document.getElementById("weeklyModal");
const weeklyContainer     = document.getElementById("weeklyContainer");
const saveWeeklyBtn       = document.getElementById("saveWeeklyBtn");

// Image modal
const imageModal          = document.getElementById("imageModal");
const imageFileInput      = document.getElementById("imageFileInput");
const imagePreview        = document.getElementById("imagePreview");
const imageTitleInput     = document.getElementById("imageTitle");
const saveImageBtn        = document.getElementById("saveImageBtn");

// Gallery
const imageGallery        = document.getElementById("imageGallery");

let currentClient = null;
let currentDate   = null;

window.addEventListener("load", () => {
  loadFromLocalStorage();

  // Populate time select
  buildTimeSelect(timeSelect);

  // Populate client dropdown
  buildClientDropdown();

  // Default date = today
  const todayStr = new Date().toISOString().split("T")[0];
  datePicker.value = todayStr;
  currentDate = todayStr;

  // If we have at least 1 client, set it as current
  if (Object.keys(allData).length>0) {
    currentClient = Object.keys(allData).sort()[0];
    clientSelect.value = currentClient;
    loadClientDate(currentClient, currentDate);
  }

  /*************************
     EVENT LISTENERS
  *************************/
  clientSelect.addEventListener("change", onClientOrDateChange);
  datePicker.addEventListener("change", onClientOrDateChange);

  addClientBtn.addEventListener("click", () => {
    newClientForm.style.display="block";
    newClientName.value="";
    newClientName.focus();
  });
  cancelClientBtn.addEventListener("click", () => {
    newClientForm.style.display="none";
  });
  saveClientBtn.addEventListener("click", saveNewClient);

  saveClientInfoBtn.addEventListener("click", saveClientInfo);

  addTaskBtn.addEventListener("click", addNewTask);
  clearTasksBtn.addEventListener("click", clearTasksForDay);
  reportBtn.addEventListener("click", generateReport);
  multiDayBtn.addEventListener("click", () => openModal("multiDayModal"));
  weeklyBtn.addEventListener("click", () => openModal("weeklyModal"));
  imageBtn.addEventListener("click", () => openModal("imageModal"));

  exportBtn.addEventListener("click", exportData);

  dayRatingSelect.addEventListener("change", onDayRatingChange);
  dayNotesTextarea.addEventListener("input", onDayNotesChange);

  taskSearch.addEventListener("input", filterTasks);

  // Multi-day
  addAnotherDayBtn.addEventListener("click", addMultiDayBlock);
  saveMultiDayBtn.addEventListener("click", saveMultiDayTasks);

  // Weekly
  saveWeeklyBtn.addEventListener("click", saveWeeklyTasks);

  // IMAGES
  imageFileInput.addEventListener("change", handleImageFile);
  imageModal.addEventListener("paste", handleImagePaste);
  saveImageBtn.addEventListener("click", saveImage);

  // Close modals if [data-close] is clicked
  document.querySelectorAll(".modal-close, [data-close]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const targetId = btn.dataset.close;
      if (targetId) {
        closeModal(targetId);
      } else {
        btn.parentElement.parentElement.style.display="none";
      }
    });
  });

  // Build weekly content on load, just so it's ready
  buildWeeklyContent();

  // Keyboard shortcuts
  document.addEventListener("keydown", (e)=>{
    // ignore if in input/textarea
    if (["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)) {
      if (e.key==="Escape") {
        // allow closing modals
        closeModal("multiDayModal");
        closeModal("weeklyModal");
        closeModal("imageModal");
      }
      return;
    }
    // Alt+A => add new task
    if (e.altKey && e.key==="a") {
      e.preventDefault();
      if (activityInput.value.trim()!=="") {
        addNewTask();
      } else {
        activityInput.focus();
      }
    }
    // Alt+D => toggle last task done
    if (e.altKey && e.key==="d") {
      e.preventDefault();
      const lastRow = taskTable.querySelector("tr:last-child");
      if (lastRow) {
        const chk = lastRow.querySelector("input[type='checkbox']");
        if (chk) {
          chk.checked=!chk.checked;
          chk.dispatchEvent(new Event("change"));
        }
      }
    }
    // Alt+S => sort tasks by time
    if (e.altKey && e.key==="s") {
      e.preventDefault();
      sortDailyTasksByTime();
    }
    // Escape => close modals
    if (e.key==="Escape") {
      closeModal("multiDayModal");
      closeModal("weeklyModal");
      closeModal("imageModal");
    }
  });

  // Create first multi-day block (hidden unless user opens the modal)
  addMultiDayBlock();
});

/********************************************************************
   3) LOAD / SAVE localStorage
********************************************************************/
function loadFromLocalStorage() {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) {
    try {
      allData = JSON.parse(stored);
      if (!allData || typeof allData!=="object") {
        allData={};
      }
    } catch(e) {
      console.error("Error parsing data:", e);
      allData={};
    }
  } else {
    allData={};
  }
}
function saveToLocalStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
  } catch(e) {
    if (e.name==="QuotaExceededError") {
      alert("Storage limit exceeded. Export data & clear old entries.");
    } else {
      console.error("Error saving data:", e);
    }
  }
}

/********************************************************************
   4) CLIENTS
********************************************************************/
function buildClientDropdown() {
  clientSelect.innerHTML="";
  const names = Object.keys(allData).sort();
  if (!names.length) {
    const opt=document.createElement("option");
    opt.value=""; opt.textContent="--No Clients--";
    clientSelect.appendChild(opt);
    clientSelect.disabled=true;
    return;
  }
  clientSelect.disabled=false;
  names.forEach(n=>{
    const opt=document.createElement("option");
    opt.value=n; opt.textContent=n;
    clientSelect.appendChild(opt);
  });
}

function saveNewClient() {
  const name = newClientName.value.trim();
  if (!name) { alert("Enter name"); return;}
  if (allData[name]) { alert("Client exists"); return;}
  allData[name] = {
    bigGoal:"",
    links:{canvas:"", classroom:""},
    weeklyTasks:{
      monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[]
    },
    images:[]
  };
  saveToLocalStorage();
  buildClientDropdown();
  clientSelect.value=name;
  currentClient=name;
  loadClientDate(name, currentDate);
  newClientForm.style.display="none";
}

/********************************************************************
   5) ON CLIENT/DATE CHANGE
********************************************************************/
function onClientOrDateChange() {
  currentClient = clientSelect.value;
  currentDate   = datePicker.value;
  loadClientDate(currentClient, currentDate);
}

function loadClientDate(cli, dt) {
  // ensure daily record
  if (!allData[cli]) {
    allData[cli] = {
      bigGoal:"",
      links:{canvas:"", classroom:""},
      weeklyTasks:{
        monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[]
      },
      images:[]
    };
  }
  if (!allData[cli][dt]) {
    allData[cli][dt] = { dayRating:"0", dayNotes:"", tasks:[], weeklyDone:{} };
  }
  renderClientInfoArea(cli);
  renderDailyReflection(cli, dt);
  renderTaskTable(cli, dt);
  renderImageGallery(cli); // show images
  updateProgress(cli, dt);
}

/********************************************************************
   6) CLIENT INFO (big goal, links)
********************************************************************/
function renderClientInfoArea(cli) {
  const cData = allData[cli];
  bigGoalInput.value = cData.bigGoal||"";
  bigGoalDisplay.textContent = cData.bigGoal || "(No big goal set)";
  canvasLinkInput.value = cData.links?.canvas||"";
  classroomLinkInput.value = cData.links?.classroom||"";

  if (cData.links?.canvas) {
    canvasLinkAnchor.href=cData.links.canvas;
    canvasLinkAnchor.style.display="inline-block";
  } else {
    canvasLinkAnchor.style.display="none";
  }
  if (cData.links?.classroom) {
    classroomLinkAnchor.href=cData.links.classroom;
    classroomLinkAnchor.style.display="inline-block";
  } else {
    classroomLinkAnchor.style.display="none";
  }
}
function saveClientInfo() {
  if (!currentClient) return;
  const cData= allData[currentClient];
  cData.bigGoal= bigGoalInput.value.trim();
  if (!cData.links) cData.links={};
  cData.links.canvas= canvasLinkInput.value.trim();
  cData.links.classroom= classroomLinkInput.value.trim();
  saveToLocalStorage();
  renderClientInfoArea(currentClient);
  alert("Client info saved!");
}

/********************************************************************
   7) REFLECTION
********************************************************************/
function renderDailyReflection(cli, dt) {
  const rec= allData[cli][dt];
  dayRatingSelect.value= rec.dayRating || "0";
  dayNotesTextarea.value= rec.dayNotes || "";
}

function onDayRatingChange() {
  if (!currentClient || !currentDate) return;
  const rec= allData[currentClient][currentDate];
  if (!rec) return;
  rec.dayRating= dayRatingSelect.value;
  saveToLocalStorage();
  updateProgress(currentClient, currentDate);
}
function onDayNotesChange() {
  if (!currentClient || !currentDate) return;
  const rec= allData[currentClient][currentDate];
  if(!rec)return;
  rec.dayNotes= dayNotesTextarea.value;
  saveToLocalStorage();
}

/********************************************************************
   8) TIME SELECT
********************************************************************/
function buildTimeSelect(sel) {
  sel.innerHTML="";
  for(let hour=5; hour<24; hour++){
    for(let min=0; min<60; min+=15){
      const d=new Date();
      d.setHours(hour, min);
      const label = d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12:true});
      const opt=document.createElement("option");
      opt.value=label;
      opt.textContent=label;
      sel.appendChild(opt);
    }
  }
  // Common
  const sep=document.createElement("option");
  sep.disabled=true; sep.textContent="-----";
  sel.appendChild(sep);
  ["Before School","During Study Hall","During Lunch","Right After School","Before Dinner","After Dinner","Before Bed"].forEach(val=>{
    const o=document.createElement("option");
    o.value=val; o.textContent=val;
    sel.appendChild(o);
  });
  // default 3:00 PM if found
  if (Array.from(sel.options).some(o=>o.value==="3:00 PM")) {
    sel.value="3:00 PM";
  }
}

/********************************************************************
   9) DAILY TASKS
********************************************************************/
function renderTaskTable(cli, dt) {
  taskTable.innerHTML="";
  const rec= allData[cli][dt];
  if (!rec) {
    taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;">(No tasks yet)</td></tr>`;
    return;
  }
  const dailyTasks= rec.tasks||[];
  const weekday= getWeekday(dt);
  const weeklyList= allData[cli].weeklyTasks[weekday]||[];
  const weeklyDoneMap= rec.weeklyDone||{};
  // Merge daily+weekly
  const merged=[];
  dailyTasks.forEach(t=> merged.push({...t,_type:"daily"}));
  weeklyList.forEach(wt=> merged.push({...wt, completed:!!weeklyDoneMap[wt.id], rating:"0", _type:"weekly"}));
  // sort
  merged.sort((a,b)=> convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));
  if (!merged.length) {
    taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center; color:#666;">(No tasks yet)</td></tr>`;
    return;
  }
  merged.forEach(t=> addTaskRow(t, rec));
}
function addTaskRow(taskObj, dayRec) {
  const row= taskTable.insertRow();
  if (taskObj.completed) {
    row.classList.add("completed-task");
  }
  // TIME
  const cTime=row.insertCell(0);
  cTime.innerHTML= taskObj.time;
  if (taskObj.duration) {
    cTime.innerHTML+=`<br><small>(${taskObj.duration})</small>`;
  }
  if (taskObj._type==="weekly") {
    cTime.innerHTML+=`<br><small style="color:#006; font-weight:bold;">(Weekly)</small>`;
  }

  // ACTIVITY
  const cAct=row.insertCell(1);
  cAct.textContent= taskObj.activity;

  // DONE
  const cDone=row.insertCell(2);
  const chk=document.createElement("input");
  chk.type="checkbox";
  chk.checked= taskObj.completed;
  chk.addEventListener("change",()=>{
    row.classList.toggle("completed-task", chk.checked);
    if (taskObj._type==="daily") {
      // find in dayRec.tasks
      const idx= dayRec.tasks.indexOf(taskObj);
      if (idx>-1) {
        dayRec.tasks[idx].completed= chk.checked;
      }
    } else {
      // weekly
      if (!dayRec.weeklyDone) dayRec.weeklyDone={};
      dayRec.weeklyDone[taskObj.id]= chk.checked;
    }
    saveToLocalStorage();
    updateProgress(currentClient, currentDate);
  });
  cDone.appendChild(chk);

  // RATING
  const cRate=row.insertCell(3);
  if (taskObj._type==="daily") {
    const sel=document.createElement("select");
    for(let i=0;i<=5;i++){
      const opt=document.createElement("option");
      opt.value=i; opt.text=(i===0?"--":i.toString());
      sel.appendChild(opt);
    }
    sel.value= taskObj.rating||"0";
    sel.addEventListener("change",()=>{
      taskObj.rating= sel.value;
      saveToLocalStorage();
      updateProgress(currentClient, currentDate);
    });
    cRate.appendChild(sel);
  } else {
    cRate.textContent="--";
    cRate.style.color="#999";
  }

  // ACTIONS
  const cActn=row.insertCell(4);
  if (taskObj._type==="daily") {
    const editBtn=document.createElement("button");
    editBtn.classList.add("btn");
    editBtn.textContent="✎";
    editBtn.addEventListener("click",()=>{
      editDailyTask(row, taskObj, dayRec);
    });
    cActn.appendChild(editBtn);

    const rmBtn=document.createElement("button");
    rmBtn.classList.add("btn");
    rmBtn.textContent="X";
    rmBtn.addEventListener("click",()=>{
      if (confirm(`Remove task "${taskObj.activity}"?`)) {
        const idx= dayRec.tasks.indexOf(taskObj);
        if (idx>-1) {
          dayRec.tasks.splice(idx,1);
          saveToLocalStorage();
          row.remove();
          updateProgress(currentClient, currentDate);
          if (!taskTable.rows.length) {
            taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center; color:#666;">(No tasks yet)</td></tr>`;
          }
        }
      }
    });
    cActn.appendChild(rmBtn);
  } else {
    cActn.innerHTML=`<small style="color:#999;">(Edit in Weekly Plan)</small>`;
  }
}

function editDailyTask(row, taskObj, dayRec) {
  alert("Editing daily tasks inline is omitted for brevity—feel free to replicate earlier code if you want in-table editing. For now, just remove & re-add if you need changes!");
}

function addNewTask() {
  if (!currentClient || !currentDate) return;
  const timeVal= timeSelect.value;
  const durVal = durationSelect.value;
  const actVal = activityInput.value.trim();
  if (!actVal) { alert("Enter Activity"); return;}
  const rec= allData[currentClient][currentDate];
  const newTask= {
    time: timeVal,
    duration: durVal,
    activity: actVal,
    completed:false,
    rating:"0"
  };
  rec.tasks.push(newTask);
  saveToLocalStorage();
  renderTaskTable(currentClient, currentDate);
  updateProgress(currentClient, currentDate);
  activityInput.value="";
  sortDailyTasksByTime();
}
function sortDailyTasksByTime() {
  if (!currentClient || !currentDate) return;
  const rec= allData[currentClient][currentDate];
  if (!rec || !rec.tasks || rec.tasks.length<2) return;
  rec.tasks.sort((a,b)=> convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));
  saveToLocalStorage();
  renderTaskTable(currentClient, currentDate);
}

function filterTasks() {
  const txt= taskSearch.value.toLowerCase();
  const rows= taskTable.querySelectorAll("tr");
  rows.forEach(r=>{
    if(!r.cells[1]) return; // skip header if any
    const timeCell= r.cells[0].textContent.toLowerCase();
    const actCell = r.cells[1].textContent.toLowerCase();
    if (timeCell.includes(txt) || actCell.includes(txt)) {
      r.style.display="";
    } else {
      r.style.display="none";
    }
  });
}

function clearTasksForDay() {
  if (!currentClient || !currentDate) return;
  if(confirm("Clear ALL daily tasks (not weekly) for this day?")) {
    allData[currentClient][currentDate].tasks=[];
    saveToLocalStorage();
    renderTaskTable(currentClient, currentDate);
    updateProgress(currentClient, currentDate);
  }
}

/********************************************************************
   10) PROGRESS
********************************************************************/
function updateProgress(cli, dt) {
  const rec= allData[cli][dt];
  if (!rec) {
    completionRateEl.textContent="-";
    completionBarEl.style.width="0%";
    completionBarEl.textContent="0%";
    averageTaskRatingEl.textContent="-";
    displayDayRatingEl.textContent="--";
    avgDayRatingUpToDateEl.textContent="--";
    avgRatingBarEl.style.width="0%";
    avgRatingBarEl.textContent="0/5";
    return;
  }
  const daily= rec.tasks||[];
  const wd= getWeekday(dt);
  const weeklyList= allData[cli].weeklyTasks[wd]||[];
  const doneMap= rec.weeklyDone||{};
  const dailyDone= daily.filter(t=>t.completed).length;
  const weeklyDone= weeklyList.filter(w=> doneMap[w.id]).length;
  const totalDone= dailyDone+weeklyDone;
  const total= daily.length + weeklyList.length;
  if (!total) {
    completionRateEl.textContent="-";
    completionBarEl.style.width="0%";
    completionBarEl.textContent="0%";
    averageTaskRatingEl.textContent="-";
  } else {
    const pct= Math.round((totalDone/total)*100);
    completionRateEl.textContent=`${pct}% (${totalDone}/${total})`;
    completionBarEl.style.width=`${pct}%`;
    completionBarEl.textContent=`${pct}%`;
    // avg rating from daily tasks
    const rated= daily.filter(t=>t.rating!=="0");
    if (rated.length>0) {
      const sum= rated.reduce((acc,t)=> acc+ parseInt(t.rating,10), 0);
      const avg= sum / rated.length;
      averageTaskRatingEl.textContent= avg.toFixed(1)+ "/5";
    } else {
      averageTaskRatingEl.textContent="No rated tasks";
    }
  }
  // day rating
  if (rec.dayRating && rec.dayRating!=="0") {
    displayDayRatingEl.textContent= rec.dayRating+ " / 5";
  } else {
    displayDayRatingEl.textContent="--";
  }
  // avg day rating up to date
  const allDates= Object.keys(allData[cli]).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k) && k<=dt).sort();
  let sumDR=0, cntDR=0;
  allDates.forEach(d=>{
    const r2= allData[cli][d];
    if (r2.dayRating && r2.dayRating!=="0") {
      sumDR+= parseInt(r2.dayRating,10);
      cntDR++;
    }
  });
  if (cntDR>0) {
    const avgDR= sumDR/cntDR;
    avgDayRatingUpToDateEl.textContent= avgDR.toFixed(1)+"/5";
    const p2= (avgDR/5)*100;
    avgRatingBarEl.style.width=`${p2}%`;
    avgRatingBarEl.textContent=`${avgDR.toFixed(1)}/5`;
  } else {
    avgDayRatingUpToDateEl.textContent="No day ratings";
    avgRatingBarEl.style.width="0%";
    avgRatingBarEl.textContent="0/5";
  }
}

/********************************************************************
   11) MULTI-DAY PLANNER
********************************************************************/
function openModal(id) {
  document.getElementById(id).style.display="block";
}
function closeModal(id) {
  document.getElementById(id).style.display="none";
}
function addMultiDayBlock() {
  const index= multiDaysContainer.querySelectorAll(".day-plan").length;
  // date based on currentDate + index
  const startDate= new Date(currentDate+"T12:00:00");
  startDate.setDate(startDate.getDate()+ index);
  const ds= startDate.toISOString().split("T")[0];

  const div=document.createElement("div");
  div.classList.add("day-plan");
  div.dataset.date= ds;

  const h4=document.createElement("h4");
  h4.textContent=`Day ${index+1}: ${formatDay(ds)}`;
  div.appendChild(h4);

  const timeCont= document.createElement("div");
  timeCont.classList.add("time-container");
  const timeSel=document.createElement("select");
  buildTimeSelect(timeSel);
  timeCont.appendChild(timeSel);

  const durSel=document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(val=>{
    const o=document.createElement("option");
    o.value=val; o.textContent=val;
    durSel.appendChild(o);
  });
  durSel.value="30 min";
  timeCont.appendChild(durSel);
  div.appendChild(timeCont);

  const lab= document.createElement("label");
  lab.textContent="Activity:";
  div.appendChild(lab);
  const act=document.createElement("input");
  act.type="text";
  act.style.width="100%";
  act.placeholder="e.g. complete geometry hw";
  div.appendChild(act);

  const addBtn=document.createElement("button");
  addBtn.classList.add("btn");
  addBtn.textContent="+ Task for this day";
  addBtn.style.marginTop="0.5rem";
  addBtn.addEventListener("click", ()=>{
    // add another time/dur input?
    const newTimeCont= timeCont.cloneNode(true);
    const newLab= lab.cloneNode(true);
    const newAct= act.cloneNode(true);

    div.appendChild(document.createElement("hr"));
    div.appendChild(newTimeCont);
    div.appendChild(newLab);
    div.appendChild(newAct);
  });
  div.appendChild(addBtn);

  multiDaysContainer.appendChild(div);
}
function saveMultiDayTasks() {
  const dayBlocks= multiDaysContainer.querySelectorAll(".day-plan");
  let tasksAdded=0;
  dayBlocks.forEach(block=>{
    const ds= block.dataset.date;
    if (!allData[currentClient][ds]) {
      allData[currentClient][ds] = {dayRating:"0", dayNotes:"", tasks:[], weeklyDone:{}};
    }
    const rec= allData[currentClient][ds];
    // each block has multiple sets of (timeSel,durSel + actInput)
    // For quick approach: pairs in each chunk
    const selects= block.querySelectorAll("select");
    const texts= block.querySelectorAll("input[type='text']");

    // If we have N "task" sets, each is 2 selects + 1 text
    for (let i=0; i<texts.length; i++){
      const activity= texts[i].value.trim();
      if (!activity) continue;
      const timeSelIndex= i*2;
      const durSelIndex= i*2 +1;
      const timeVal= selects[timeSelIndex].value;
      const durVal = selects[durSelIndex].value;
      rec.tasks.push({
        time: timeVal,
        duration: durVal,
        activity: activity,
        completed:false,
        rating:"0"
      });
      tasksAdded++;
    }
  });
  saveToLocalStorage();
  loadClientDate(currentClient, currentDate);
  closeModal("multiDayModal");
  alert(`Saved multi-day tasks! ${tasksAdded} tasks added.`);
}

/********************************************************************
   12) WEEKLY PLANNER
********************************************************************/
function buildWeeklyContent() {
  weeklyContainer.innerHTML="";
  if (!currentClient) return;
  if (!allData[currentClient].weeklyTasks) {
    allData[currentClient].weeklyTasks= {
      monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[]
    };
  }
  const wData= allData[currentClient].weeklyTasks;
  const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  days.forEach(d=>{
    const sec=document.createElement("div");
    sec.classList.add("weekly-day-section");
    const hd=document.createElement("h4");
    hd.textContent= d[0].toUpperCase()+d.slice(1);
    sec.appendChild(hd);

    // existing tasks
    const tasksDiv=document.createElement("div");
    wData[d].forEach(task=>{
      const row=document.createElement("div");
      row.style.display="flex";
      row.style.gap="0.5rem";
      row.style.marginBottom="0.3rem";
      const label=document.createElement("span");
      label.textContent=`[${task.time}] ${task.activity} (${task.duration})`;
      row.appendChild(label);

      const rmBtn=document.createElement("button");
      rmBtn.classList.add("btn");
      rmBtn.textContent="X";
      rmBtn.addEventListener("click",()=>{
        const idx= wData[d].indexOf(task);
        if(idx>-1) {
          wData[d].splice(idx,1);
          saveToLocalStorage();
          buildWeeklyContent();
        }
      });
      row.appendChild(rmBtn);
      tasksDiv.appendChild(row);
    });
    sec.appendChild(tasksDiv);

    // add new
    const addRow=document.createElement("div");
    addRow.style.display="flex";
    addRow.style.gap="0.3rem";
    addRow.style.marginTop="0.5rem";

    const timeSel=document.createElement("select");
    buildTimeSelect(timeSel);
    addRow.appendChild(timeSel);

    const durSel=document.createElement("select");
    ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(val=>{
      const o=document.createElement("option");
      o.value=val; o.textContent=val;
      durSel.appendChild(o);
    });
    durSel.value="30 min";
    addRow.appendChild(durSel);

    const actInp=document.createElement("input");
    actInp.type="text";
    actInp.placeholder="Activity...";
    addRow.appendChild(actInp);

    const plusBtn=document.createElement("button");
    plusBtn.classList.add("btn","btn-primary");
    plusBtn.textContent="+";
    plusBtn.addEventListener("click",()=>{
      const val= actInp.value.trim();
      if(!val){alert("Enter an activity");return;}
      const newId=`wt_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      wData[d].push({
        id:newId,
        time: timeSel.value,
        duration: durSel.value,
        activity: val
      });
      // sort by time
      wData[d].sort((a,b)=> convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));
      saveToLocalStorage();
      buildWeeklyContent();
    });
    addRow.appendChild(plusBtn);

    sec.appendChild(addRow);
    weeklyContainer.appendChild(sec);
  });
}
function saveWeeklyTasks() {
  closeModal("weeklyModal");
  // reload daily tasks if needed
  loadClientDate(currentClient, currentDate);
  alert("Weekly tasks saved!");
}

/********************************************************************
   13) IMAGES
********************************************************************/
function renderImageGallery(cli) {
  imageGallery.innerHTML="";
  if (!cli) return;
  const arr= allData[cli].images || [];
  if (!arr.length) return; 
  const h3=document.createElement("h3");
  h3.textContent="Image Gallery";
  imageGallery.appendChild(h3);
  arr.forEach((imgObj, idx)=>{
    const div=document.createElement("div");
    div.classList.add("gallery-item");
    const titleSpan=document.createElement("span");
    titleSpan.style.fontWeight="bold";
    titleSpan.textContent= (imgObj.title||"Untitled") + " ";
    div.appendChild(titleSpan);

    const thumb=document.createElement("img");
    thumb.src= imgObj.dataUrl;
    thumb.addEventListener("click",()=>{
      const w=window.open("","_blank");
      w.document.write(`<title>${imgObj.title||"Untitled"}</title><img src="${imgObj.dataUrl}" style="max-width:100%;"/>`);
      w.document.close();
    });
    div.appendChild(thumb);

    const rmBtn=document.createElement("button");
    rmBtn.classList.add("btn");
    rmBtn.textContent="X";
    rmBtn.style.marginLeft="0.5rem";
    rmBtn.addEventListener("click",()=>{
      if (confirm(`Remove image "${imgObj.title}"?`)) {
        arr.splice(idx,1);
        saveToLocalStorage();
        renderImageGallery(cli);
      }
    });
    div.appendChild(rmBtn);

    imageGallery.appendChild(div);
  });
}

function handleImageFile(e) {
  const file= e.target.files[0];
  if(!file) return;
  const reader= new FileReader();
  reader.onload=(evt)=>{
    imagePreview.src= evt.target.result;
    imagePreview.style.display="block";
  };
  reader.readAsDataURL(file);
}
function handleImagePaste(e) {
  const items= e.clipboardData?.items||[];
  for(let i=0;i<items.length;i++){
    if (items[i].type.indexOf("image")===0) {
      const file= items[i].getAsFile();
      if (file) {
        const reader=new FileReader();
        reader.onload=(evt)=>{
          imagePreview.src= evt.target.result;
          imagePreview.style.display="block";
        };
        reader.readAsDataURL(file);
      }
    }
  }
}
function saveImage() {
  if (!imagePreview.src) {
    alert("No image to save");
    return;
  }
  if(!currentClient) {
    alert("No client selected.");
    return;
  }
  const title= imageTitleInput.value.trim()||"(Untitled)";
  allData[currentClient].images.push({
    title,
    dataUrl: imagePreview.src
  });
  saveToLocalStorage();
  closeModal("imageModal");
  // reset
  imageFileInput.value="";
  imagePreview.src="";
  imagePreview.style.display="none";
  imageTitleInput.value="";
  renderImageGallery(currentClient);
}

/********************************************************************
   14) REPORT
********************************************************************/
function generateReport() {
  if (!currentClient) {
    alert("No client to report.");
    return;
  }
  // We'll open in new tab
  const cliData = allData[currentClient];
  let html=`
  <html>
  <head>
    <meta charset="UTF-8">
    <title>Report - ${escapeHtml(currentClient)}</title>
    <style>
      body { font-family: sans-serif; margin: 2rem; line-height:1.4; }
      h1,h2,h3 { margin-bottom:0.3rem; }
      table { width:100%; border-collapse: collapse; margin:0.5rem 0; }
      table,th,td { border:1px solid #999; }
      th,td { padding:0.4rem; vertical-align:top; }
      th { background:#f3f3f3; }
      .notes-box {
        background:#eef;
        border:1px solid #ccc;
        padding:0.5rem;
        margin:0.5rem 0;
      }
      .gallery-img {
        max-width:200px; margin:0.5rem; border:1px solid #ccc; display:block;
      }
      .weekly-indicator { color:#09f; font-style:italic; }
    </style>
  </head>
  <body>
    <h1>RESET Tracker Report for ${escapeHtml(currentClient)}</h1>
    <p>Generated: ${new Date().toLocaleString()}</p>

    <h2>Big Goal</h2>
    <p>${escapeHtml(cliData.bigGoal||"(Not set)")}</p>

    <h2>Weekly Recurring Tasks</h2>
  `;
  const dayNames=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  dayNames.forEach(d=>{
    const arr= cliData.weeklyTasks[d]||[];
    if(arr.length){
      html+= `<h3>${escapeHtml(d)}</h3><ul>`;
      arr.forEach(t=>{
        html+= `<li>[${escapeHtml(t.time)}] ${escapeHtml(t.activity)} (${escapeHtml(t.duration)})</li>`;
      });
      html+=`</ul>`;
    }
  });
  // images
  const imgs= cliData.images||[];
  if(imgs.length>0){
    html+= `<h2>Images</h2>`;
    imgs.forEach(img=>{
      html+= `<div>
        <strong>${escapeHtml(img.title||"(Untitled)")}</strong><br/>
        <img class="gallery-img" src="${img.dataUrl}" />
      </div>`;
    });
  }
  // daily records
  const dateKeys= Object.keys(cliData).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
  if (!dateKeys.length){
    html+= `<h2>Daily Records</h2><p style="color:#666;">No daily records.</p>`;
  } else {
    html+= `<h2>Daily Records</h2>`;
    dateKeys.forEach(d=>{
      const rec= cliData[d];
      if(!rec)return;
      html+= `<h3>${d} (Day Rating: ${rec.dayRating||"0"}/5)</h3>`;
      if(rec.dayNotes){
        html+= `<div class="notes-box">
          <strong>Notes:</strong><br/>
          ${escapeHtml(rec.dayNotes).replace(/\n/g,"<br/>")}
        </div>`;
      }
      // Merge daily tasks + weekly tasks
      const dailyT= rec.tasks||[];
      const wd= getWeekday(d);
      const wList= cliData.weeklyTasks[wd]||[];
      const doneMap= rec.weeklyDone||{};
      const merged=[];
      dailyT.forEach(t=> merged.push({...t,_type:"daily"}));
      wList.forEach(wt=>{
        merged.push({
          ...wt,
          completed: !!doneMap[wt.id],
          rating:"(weekly)",
          _type:"weekly"
        });
      });
      merged.sort((a,b)=> convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));
      if (!merged.length) {
        html+= `<p style="color:#666;">(No tasks this day)</p>`;
        return;
      }
      html+= `<table><thead>
         <tr><th>Time</th><th>Activity</th><th>Done?</th><th>Rating</th></tr>
       </thead><tbody>`;
      let doneCount=0;
      merged.forEach(t=>{
        if(t.completed) doneCount++;
        let ratingStr="--";
        if(t._type==="daily" && t.rating!=="0") ratingStr= t.rating+"/5";
        if(t._type==="weekly") ratingStr="(weekly)";
        html+= `<tr style="${t.completed?'text-decoration:line-through;color:#888;':''}">
          <td>${escapeHtml(t.time)}${t.duration?("<br/><small>("+escapeHtml(t.duration)+")</small>"):""}${t._type==="weekly"?'<br/><span class="weekly-indicator">(Weekly)</span>':''}</td>
          <td>${escapeHtml(t.activity)}</td>
          <td>${t.completed?"Yes":"No"}</td>
          <td>${ratingStr}</td>
        </tr>`;
      });
      html+= `</tbody></table>`;
      html+= `<p><strong>Completed:</strong> ${doneCount}/${merged.length}</p>`;
    });
  }
  html+= `</body></html>`;

  const w= window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/********************************************************************
   15) EXPORT
********************************************************************/
function exportData() {
  const str= JSON.stringify(allData,null,2);
  const blob=new Blob([str], {type:"application/json"});
  const url= URL.createObjectURL(blob);
  const link=document.createElement("a");
  link.href=url;
  link.download=`reset-singlepage-export-${(new Date()).toISOString().split("T")[0]}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/********************************************************************
   16) UTILS
********************************************************************/
function convertTimeToMinutes(timeStr) {
  if(!timeStr) return 9999;
  const map={
    "Before School": 360,
    "During Study Hall": 600,
    "During Lunch": 720,
    "Right After School": 930,
    "Before Dinner": 1080,
    "After Dinner": 1200,
    "Before Bed": 1320
  };
  if (map[timeStr]!==undefined) return map[timeStr];
  const match= timeStr.match(/(\d{1,2}):(\d{2})\s?(AM|PM)/i);
  if (match) {
    let hh= parseInt(match[1],10);
    const mm= parseInt(match[2],10);
    let ampm= match[3].toUpperCase();
    if (ampm==="PM" && hh<12) hh+=12;
    if (ampm==="AM" && hh===12) hh=0;
    return hh*60+ mm;
  }
  return 9999;
}
function getWeekday(dateStr) {
  const d=new Date(dateStr+"T00:00:00");
  const idx= d.getDay(); // 0=Sunday
  const map=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
  return map[idx];
}
function formatDay(ds) {
  const d=new Date(ds+"T12:00:00");
  return d.toLocaleDateString(undefined, {weekday:"short", month:"short", day:"numeric"});
}
function escapeHtml(str) {
  if(!str)return "";
  return str
   .replace(/&/g,"&amp;")
   .replace(/</g,"&lt;")
   .replace(/>/g,"&gt;")
   .replace(/"/g,"&quot;")
   .replace(/'/g,"&#039;");
}
</script>
</body>
</html>
