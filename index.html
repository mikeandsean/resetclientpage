<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RESET Client Tracker</title>
  <!-- Import Google Font: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* === Theme Variables === */
    :root {
        --font-family-sans: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --bg-main: #FDFBF9; /* Warm creamy off-white */
        --bg-card: #FFFFFF;
        --bg-card-secondary: #F9F6F3; /* Very light warm beige */
        --text-primary: #262626; /* Dark charcoal */
        --text-secondary: #5C5C5C; /* Medium-dark gray */
        --text-light: #888888; /* Lighter gray */
        --text-on-accent: #FFFFFF;
        --border-color: #EAE0DA; /* Warm light gray/beige border */
        --border-color-light: #F5F1ED; /* Very light */

        /* --- Primary Accent (Terracotta/Brown) --- */
        --accent-primary: #B07A60; /* Muted terracotta */
        --accent-primary-dark: #915F4A; /* Darker shade for hover */
        --accent-primary-light: #F5ECE6; /* Very light shade for backgrounds */

        /* --- Other Accents (Optional - can be adjusted) --- */
        --accent-green: #689F84; /* Muted green */
        --accent-red: #D98680; /* Muted red */
        --accent-red-dark: #C76A62;
        --accent-red-light: #FAE8E6; /* Light red background for danger buttons */
        --accent-blue-progress: #7BA8C8; /* Muted blue for progress */

        /* --- Structure --- */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.04);
        --shadow-md: 0 3px 5px -1px rgba(0, 0, 0, 0.05), 0 2px 3px -2px rgba(0, 0, 0, 0.04);
        --border-radius: 4px; /* Slightly sharper corners */
        --spacing-unit: 1rem; /* Base spacing unit (approx 16px) */
    }

    /* === Reset & Base Styles === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; font-size: 16px; /* Base font size */ }

    body {
      background-color: var(--bg-main);
      font-family: var(--font-family-sans);
      color: var(--text-primary);
      margin: 0 auto;
      padding: 0;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased; /* Smoother fonts */
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
       max-width: 800px; /* Wider container */
       margin: calc(var(--spacing-unit) * 2) auto; /* More top/bottom margin */
       padding: 0 var(--spacing-unit);
    }

    h1, h2, h3, h4, h5, h6 {
      margin-bottom: calc(var(--spacing-unit) * 0.75); /* Adjusted spacing */
      line-height: 1.3;
      font-weight: 600;
    }
    /* H1 is styled specifically in .title-bar */
    h2 { font-size: 1.5rem; margin-top: calc(var(--spacing-unit) * 2.5); border-bottom: 1px solid var(--border-color); padding-bottom: calc(var(--spacing-unit) * 0.5); font-weight: 500; color: var(--text-secondary); }
    h3 { font-size: 1.2rem; margin-top: calc(var(--spacing-unit) * 2); color: var(--accent-primary); font-weight: 600;}
    h4 { font-size: 1rem; font-weight: 600; color: var(--text-primary); }

    p { margin-bottom: var(--spacing-unit); }
    a { color: var(--accent-primary); text-decoration: none; transition: color 0.2s ease; }
    a:hover { color: var(--accent-primary-dark); text-decoration: underline; }

    hr { border: none; border-top: 1px solid var(--border-color); margin: calc(var(--spacing-unit) * 2.5) 0; }

    label {
        display: block;
        font-weight: 500;
        margin-bottom: calc(var(--spacing-unit) * 0.3);
        color: var(--text-secondary);
        font-size: 0.9em;
    }

    select, input[type="date"], input[type="text"], textarea {
      font-family: inherit;
      font-size: 1em;
      padding: calc(var(--spacing-unit) * 0.6) calc(var(--spacing-unit) * 0.8); /* Slightly more padding */
      margin-bottom: calc(var(--spacing-unit) * 0.5);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--bg-card);
      width: 100%;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      color: var(--text-primary);
    }
    select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23888888'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.1em; padding-right: 2.5rem; }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent-primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(176, 122, 96, 0.2); /* Focus ring using accent color */
    }
    textarea { min-height: 90px; width: 100%; }

    /* === Buttons === */
    .btn {
      display: inline-block;
      font-family: inherit;
      font-size: 0.95em;
      font-weight: 500; /* Slightly lighter weight */
      padding: calc(var(--spacing-unit) * 0.55) calc(var(--spacing-unit) * 1.2); /* Adjust padding */
      margin: calc(var(--spacing-unit) * 0.25) calc(var(--spacing-unit) * 0.25) calc(var(--spacing-unit) * 0.25) 0;
      border: 1px solid transparent;
      border-radius: var(--border-radius);
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
      line-height: 1.5;
    }
    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(176, 122, 96, 0.25);
    }
    .btn:active { transform: translateY(1px); }

    /* Primary Button Style (Terracotta) */
    .btn-primary, #addBtn, #saveClientBtn, #saveClientInfoBtn, #savePlanBtn, #saveWeeklyBtn, #saveImageBtn {
      background-color: var(--accent-primary);
      color: var(--text-on-accent);
      border-color: var(--accent-primary);
    }
     .btn-primary:hover, #addBtn:hover, #saveClientBtn:hover, #saveClientInfoBtn:hover, #savePlanBtn:hover, #saveWeeklyBtn:hover, #saveImageBtn:hover {
      background-color: var(--accent-primary-dark);
      border-color: var(--accent-primary-dark);
       color: var(--text-on-accent); /* Ensure text stays white */
    }

    /* Default/Secondary Button Style (Outline/Text) */
    .btn {
      background-color: var(--bg-card);
      color: var(--accent-primary); /* Text color matches accent */
      border-color: var(--border-color);
    }
    .btn:hover {
      background-color: var(--accent-primary-light); /* Light accent background on hover */
      border-color: var(--accent-primary);
      color: var(--accent-primary-dark);
    }

    /* Danger Button Style */
    #clearTasksBtn {
        background-color: var(--accent-red-light);
        color: var(--accent-red-dark);
        border-color: var(--accent-red);
    }
     #clearTasksBtn:hover {
        background-color: var(--accent-red);
        border-color: var(--accent-red-dark);
        color: var(--text-on-accent);
    }
    /* Small delete buttons in table/gallery */
    .task-row .btn:last-child, .gallery-item .btn:last-child, .weekly-task-row .btn:last-child {
        background-color: transparent;
        color: var(--accent-red);
        border-color: transparent;
        padding: calc(var(--spacing-unit) * 0.2) calc(var(--spacing-unit) * 0.4); /* Minimal padding */
        font-size: 1.1em; /* Make icon slightly larger */
        line-height: 1;
    }
     .task-row .btn:last-child:hover, .gallery-item .btn:last-child:hover, .weekly-task-row .btn:last-child:hover {
        background-color: var(--accent-red-light);
        color: var(--accent-red-dark);
     }
    /* Edit button in table */
     .task-row .btn:first-child {
        background-color: transparent;
        color: var(--text-secondary);
        border-color: transparent;
         padding: calc(var(--spacing-unit) * 0.2) calc(var(--spacing-unit) * 0.4);
         font-size: 1.1em;
         line-height: 1;
     }
     .task-row .btn:first-child:hover {
         background-color: var(--border-color-light);
         color: var(--text-primary);
     }


    /* === Page Structure === */
    .title-bar {
      /* Remove background, rely on H1 styling */
      background: none;
      padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit);
      margin-bottom: calc(var(--spacing-unit) * 1.5);
      text-align: center;
      box-shadow: none;
    }
    .title-bar h1 {
        color: var(--text-secondary); /* Muted color */
        font-weight: 400; /* Lighter weight */
        font-size: 1.6rem;
        letter-spacing: 0.05em;
    }

    /* Section Card Styling */
    .card-style { /* Apply this class or style selectors directly */
        background-color: var(--bg-card);
        padding: calc(var(--spacing-unit) * 1.5);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md); /* Slightly more prominent shadow */
        margin-bottom: calc(var(--spacing-unit) * 1.75); /* Increased spacing */
        border: 1px solid var(--border-color-light);
    }
    /* Apply card style to sections */
    .controls, .client-info, .add-task-section, .reflection-section, #progressDashboard, #imageGallery, .google-embed-container > div, #newClientForm {
         /* Inherit from .card-style */
        background-color: var(--bg-card);
        padding: calc(var(--spacing-unit) * 1.5);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: calc(var(--spacing-unit) * 1.75);
        border: 1px solid var(--border-color-light);
    }
     .google-embed-container h2 { /* Adjust heading */
        margin-top: 0;
     }
     .google-embed-container > div { /* Placeholder/iframe specific */
        padding: calc(var(--spacing-unit) * 0.75);
     }


    /* Controls Bar */
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: calc(var(--spacing-unit) * 0.8); /* Adjust gap */
    }
    .controls > div { /* Wrap label/select pairs */
        display: flex;
        align-items: center;
        gap: calc(var(--spacing-unit) * 0.5);
    }
    .controls label { margin-bottom: 0; white-space: nowrap; }
    .controls select, .controls input[type="date"] { width: auto; min-width: 150px; margin-bottom: 0; }
    .controls button { margin: 0; }

    /* New Client Form */
     #newClientForm { border-left: 4px solid var(--accent-primary); }
     #newClientForm label { margin-bottom: 0; margin-right: calc(var(--spacing-unit) * 0.5); }
     #newClientForm input[type="text"] { width: auto; flex-grow: 1; margin-bottom: 0; }
     #newClientForm { display: none; align-items: center; gap: var(--spacing-unit);}


    /* Client Info Section */
    .client-info .info-row {
      display: grid;
      grid-template-columns: 120px 1fr; /* Fixed label width */
      align-items: center;
      gap: calc(var(--spacing-unit) * 0.5) var(--spacing-unit);
      margin-bottom: calc(var(--spacing-unit) * 0.75);
    }
    .client-info label { text-align: right; margin-bottom: 0; font-weight: 500; font-size: 0.95em;}
    .client-info input[type="text"] { margin-bottom: 0; }
    #saveClientInfoBtn { margin-top: var(--spacing-unit); }

    /* Big Goal Display */
    #bigGoalDisplay {
      font-size: 1.4em;
      font-weight: 500; /* Medium weight */
      margin: var(--spacing-unit) 0 calc(var(--spacing-unit) * 1.5) 0;
      color: var(--accent-primary-dark); /* Use darker accent */
      padding: calc(var(--spacing-unit) * 0.8) var(--spacing-unit);
      background-color: var(--accent-primary-light); /* Light accent bg */
      border: 1px solid var(--border-color); /* Subtle border */
      border-left: 4px solid var(--accent-primary); /* Accent border */
      border-radius: var(--border-radius);
      text-align: center;
    }

    /* External Links */
    .external-links { margin-bottom: calc(var(--spacing-unit) * 1.5); padding: 0;}
    .external-links a { margin-right: var(--spacing-unit); font-weight: 500; display: inline-flex; align-items: center; gap: 5px; color: var(--text-secondary); }
    .external-links a:hover { color: var(--accent-primary); }
    .external-links a:before { /* Replace icon with simpler one */
        content: '→';
        display: inline-block;
        font-weight: bold;
        transition: transform 0.2s ease;
     }
     .external-links a:hover:before { transform: translateX(3px); }


    /* Add Task Section */
    .add-task-section h2 { margin-top: 0; color: var(--text-primary); font-weight: 600; font-size: 1.3rem; }
    .time-duration-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--spacing-unit); margin-bottom: var(--spacing-unit); }
    #taskSearch { width: clamp(200px, 60%, 350px); margin-bottom: var(--spacing-unit); }

    /* === Table Styling === */
    table {
      width: 100%; border-collapse: collapse; margin-top: var(--spacing-unit);
      background-color: var(--bg-card); box-shadow: var(--shadow-sm);
      border-radius: var(--border-radius); overflow: hidden; border: 1px solid var(--border-color-light);
    }
    th, td { border: none; border-bottom: 1px solid var(--border-color-light); padding: calc(var(--spacing-unit) * 0.8); text-align: left; vertical-align: middle; } /* Increased padding */
    th { background-color: var(--bg-card-secondary); font-weight: 500; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-secondary); }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr { transition: background-color 0.15s ease-in-out; }
    tbody tr:hover { background-color: var(--accent-primary-light); }
    td:nth-child(3) { text-align: center; } /* Center 'Done?' */
    td:nth-child(4) select { width: auto; min-width: 60px; font-size: 0.9em; padding: calc(var(--spacing-unit) * 0.25) calc(var(--spacing-unit) * 0.5); background-position: right 0.3rem center; }
    td:nth-child(4) { vertical-align: middle; }

    .completed-task td:not(:last-child) { text-decoration: line-through; color: var(--text-light); }
    .completed-task td:first-child, .completed-task td:nth-child(2) { opacity: 0.75; }
    .weekly-indicator { font-size: 0.75em; color: var(--accent-primary); font-weight: 500; display: block; margin-top: 2px; }


    /* === Reflection Section === */
    .reflection-section h3 { margin-top: 0; color: var(--text-primary); font-weight: 600; font-size: 1.3rem;}
    .reflection-item { margin-bottom: var(--spacing-unit); }


    /* === Image gallery === */
     #imageGallery h3 { margin-top: 0; color: var(--text-primary); font-weight: 600; font-size: 1.3rem;}
    .gallery-item { display: flex; align-items: center; gap: var(--spacing-unit); margin-bottom: calc(var(--spacing-unit) * 0.75); padding: calc(var(--spacing-unit) * 0.6); border-radius: var(--border-radius); transition: background-color 0.2s ease; }
    .gallery-item:hover { background-color: var(--bg-card-secondary); }
    .gallery-item:not(:last-child) { border-bottom: 1px solid var(--border-color-light); }
    .gallery-item img { width: 80px; height: 50px; border-radius: calc(var(--border-radius) / 2); border: 1px solid var(--border-color); cursor: pointer; object-fit: cover; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .gallery-item img:hover { transform: scale(1.05); box-shadow: var(--shadow-md); }
    .gallery-item .title { font-weight: 500; flex-grow: 1; color: var(--text-secondary); }
    .gallery-item .btn { margin-left: auto; }

    /* === Progress Dashboard === */
    #progressDashboard h3 { margin-top: 0; color: var(--text-primary); font-weight: 600; font-size: 1.3rem;}
    #progressDashboard p { margin-bottom: calc(var(--spacing-unit)*0.5); font-size: 0.95em; }
    #progressDashboard strong { font-weight: 600; }
    .progress-bar-container { width: 100%; background-color: var(--border-color-light); border-radius: var(--border-radius); margin: 5px 0 var(--spacing-unit) 0; overflow: hidden; }
    .progress-bar { height: 18px; background-color: var(--accent-green); border-radius: var(--border-radius); text-align: center; padding: 0 8px; color: white; font-weight: 600; font-size: 0.75em; line-height: 18px; white-space: nowrap; transition: width 0.4s ease-in-out; box-shadow: inset 0 -1px 1px rgba(0,0,0,0.05); }
    .progress-bar.avg-rating { background-color: var(--accent-blue-progress); } /* Use muted blue */


    /* === Modals === */
    #plannerModal, #weeklyModal, #imageModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(38, 38, 38, 0.8); z-index: 1000; padding: var(--spacing-unit); overflow-y: auto; backdrop-filter: blur(4px); }
    .modal-content, .weekly-modal-content, .image-modal-content { background-color: var(--bg-card); margin: 6vh auto; padding: calc(var(--spacing-unit) * 1.75) calc(var(--spacing-unit) * 2.25); width: 90%; max-width: 700px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
    .weekly-modal-content { max-width: 850px; }
    .modal-content h3, .weekly-modal-content h3, .image-modal-content h3 { margin-top: 0; color: var(--text-primary); font-weight: 600; }
    /* Modal Footer explicit selection */
    #plannerModal > .modal-content > div:last-child, #weeklyModal > .weekly-modal-content > div:last-child, #imageModal > .image-modal-content > div:last-child { margin-top: calc(var(--spacing-unit) * 1.5); padding-top: var(--spacing-unit); border-top: 1px solid var(--border-color); text-align: right; display: flex; justify-content: flex-end; gap: var(--spacing-unit); }
    /* Planner/Weekly Modal specifics */
    .day-plan, .weekly-day-section { margin-bottom: var(--spacing-unit); padding: var(--spacing-unit); background-color: var(--bg-card-secondary); border: 1px solid var(--border-color-light); border-radius: var(--border-radius); }
    .day-plan h4, .weekly-day-section h4 { margin-top: 0; color: var(--text-secondary); font-weight: 600; }
    .task-entry { border-bottom: 1px dashed var(--border-color); padding-bottom: var(--spacing-unit); margin-bottom: var(--spacing-unit); }
    .task-entry:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
    .weekly-task-row { display: flex; align-items: center; gap: var(--spacing-unit); margin-bottom: calc(var(--spacing-unit)*0.5);}
    .weekly-task-row span { flex-grow: 1; font-size: 0.95em; }
    .weekly-day-section .no-data { color: var(--text-light); font-size: 0.9em; text-align: center; margin: var(--spacing-unit) 0; }
    /* Image Modal */
    #imagePreview { display: none; max-width: 100%; max-height: 300px; margin-top: var(--spacing-unit); border-radius: var(--border-radius); border: 1px solid var(--border-color); object-fit: contain; }
    #imageModal label { margin-top: var(--spacing-unit); }


    /* === Google Embeds === */
    .google-embed-container { margin-bottom: calc(var(--spacing-unit) * 1.5); }
    .google-embed-container h2 { margin-bottom: var(--spacing-unit); color: var(--text-primary); font-weight: 600; font-size: 1.3rem;}
    #googleCalendarEmbed { width: 100%; height: 600px; border: none; border-radius: var(--border-radius); }
    #googleTasksPlaceholder { color: var(--text-secondary); font-size: 0.95em; }

    /* === Footer === */
    #footer { margin-top: calc(var(--spacing-unit) * 3); padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit); border-top: 1px solid var(--border-color); font-size: 0.85em; color: var(--text-light); text-align: center; }
    #footer code { background-color: var(--border-color-light); padding: 2px 5px; border-radius: 3px; font-size: 0.9em; color: var(--text-secondary);}

    /* === Utility Classes === */
    .no-data { color: var(--text-light); font-style: italic; font-size: 0.9em; }
    .text-center { text-align: center; }

    /* === Mobile Responsiveness === */
    @media (max-width: 768px) {
         .container { margin: var(--spacing-unit) auto; }
         h1 { font-size: 1.4rem; } h2 { font-size: 1.2rem; } h3 { font-size: 1.1rem; }
         .client-info .info-row { grid-template-columns: 1fr; } /* Stack label/input */
         .client-info label { text-align: left; }
         #bigGoalDisplay { font-size: 1.2em; }
         .add-task-section h2, .reflection-section h3, #progressDashboard h3, #imageGallery h3, .google-embed-container h2 { font-size: 1.2rem; } /* Adjust heading sizes */

    }

    @media (max-width: 600px) {
      html { font-size: 15px; } /* Slightly smaller base font on mobile */
      .container { margin: calc(var(--spacing-unit)*0.5) auto; padding: 0 calc(var(--spacing-unit)*0.75); }
      .controls { flex-direction: column; align-items: stretch; gap: calc(var(--spacing-unit)*0.5); }
      .controls > div { justify-content: space-between;}
      .controls select, .controls input[type="date"] { flex-grow: 1; }
      .controls button { width: 100%; margin: calc(var(--spacing-unit)*0.25) 0; }

      .time-duration-container { grid-template-columns: 1fr; }
      table, td, th { font-size: 0.9em; padding: calc(var(--spacing-unit) * 0.6); } /* Adjust table padding */
       th:nth-child(4), td:nth-child(4) { min-width: 65px; } /* Rating */
       th:nth-child(5), td:nth-child(5) { min-width: 65px; text-align: right; } /* Actions */
       .task-row .btn { font-size: 1em; } /* Ensure icons are large enough */

      .modal-content, .weekly-modal-content, .image-modal-content { margin: var(--spacing-unit) auto; padding: var(--spacing-unit); max-width: 95%; }
       /* Modal Footer for mobile */
       #plannerModal > .modal-content > div:last-child, #weeklyModal > .weekly-modal-content > div:last-child, #imageModal > .image-modal-content > div:last-child { flex-direction: column-reverse; align-items: stretch; }
       #plannerModal > .modal-content > div:last-child button, #weeklyModal > .weekly-modal-content > div:last-child button, #imageModal > .image-modal-content > div:last-child button { width: 100%; margin: calc(var(--spacing-unit) * 0.25) 0; }

      #googleCalendarEmbed { height: 450px; }
    }
  </style>
</head>
<body>

<div class="title-bar">
  <h1>RESET Client Tracker</h1>
</div>

<!-- Add the main content container -->
<div class="container">

    <div class="controls">
      <div>
        <label for="clientSelect">Client:</label>
        <select id="clientSelect"></select>
      </div>
      <button class="btn" id="addClientBtn">+ Add Client</button>

      <div>
        <label for="datePicker">Date:</label>
        <input type="date" id="datePicker" />
      </div>

      <!-- Grouping other action buttons -->
      <div> <!-- New div for better wrapping -->
        <button class="btn" id="clearTasksBtn" title="Clear tasks for this client on this date">Clear Tasks</button>
        <button class="btn" id="exportBtn" title="Export all client data to a JSON file">Export Data</button>
        <button class="btn" id="reportBtn" title="Generate an HTML report for the current client">View Report</button>
        <button class="btn" id="multiDayPlanBtn" title="Plan tasks across multiple upcoming days">Multi-Day Plan</button>
        <button class="btn" id="weeklyPlanBtn" title="Set recurring weekly tasks">Weekly Plan</button>
        <button class="btn" id="imageBtn" title="Add an image or screenshot">Add Image</button>
      </div>
    </div>

    <!-- Form for adding a new client -->
    <div id="newClientForm">
      <label for="newClientName">New Client Name:</label>
      <input type="text" id="newClientName" placeholder="Enter client name">
      <button class="btn" id="saveClientBtn">Save</button> <!-- Will be styled primary via selector -->
      <button class="btn" id="cancelClientBtn">Cancel</button> <!-- Will be styled default via .btn -->
    </div>

    <!-- Show or edit the Big Goal, Canvas link, and Classroom link -->
    <div class="client-info">
      <div class="info-row">
        <label for="bigGoalInput">Big Goal:</label>
        <input type="text" id="bigGoalInput" placeholder="e.g., Improve Organization Skills">
      </div>
      <div class="info-row">
        <label for="canvasLinkInput">Canvas Link:</label>
        <input type="text" id="canvasLinkInput" placeholder="https://...">
      </div>
      <div class="info-row">
        <label for="classroomLinkInput">Classroom Link:</label>
        <input type="text" id="classroomLinkInput" placeholder="https://...">
      </div>
      <button class="btn" id="saveClientInfoBtn">Save Client Info</button>
    </div>

    <!-- Big Goal displayed prominently -->
    <div id="bigGoalDisplay">(Select a client)</div>

    <!-- External links displayed -->
    <div class="external-links">
      <a href="#" id="canvasLinkAnchor" target="_blank" style="display:none;">Open Canvas</a>
      <a href="#" id="classroomLinkAnchor" target="_blank" style="display:none;">Open Google Classroom</a>
    </div>

    <hr />

    <!-- Add New Task Section -->
    <div class="add-task-section">
        <h2>Add New Task</h2>
        <div class="time-duration-container">
        <div>
            <label for="timeSelect">Time:</label>
            <select id="timeSelect"></select>
        </div>
        <div>
            <label for="durationSelect">Duration:</label>
            <select id="durationSelect">
            <option value="5 min">5 minutes</option>
            <option value="10 min">10 minutes</option>
            <option value="15 min">15 minutes</option>
            <option value="30 min" selected>30 minutes</option>
            <option value="45 min">45 minutes</option>
            <option value="1 hour">1 hour</option>
            <option value="90 min">90 minutes</option>
            <option value="2 hours">2 hours</option>
            </select>
        </div>
        </div>
        <div>
            <label for="activityInput">Activity:</label>
            <input type="text" id="activityInput" placeholder="e.g., Plan history essay outline" />
        </div>
        <div>
             <label for="taskSearch">Search Tasks:</label>
            <input type="text" id="taskSearch" placeholder="Filter tasks in table by activity or time..." title="Filter tasks in the table below">
        </div>
        <button class="btn" id="addBtn" title="Add task to the table (Alt+A)">Add Task</button>
    </div>


    <!-- Task Table -->
    <table id="taskTable">
      <thead>
        <tr>
          <th style="width:20%;">Time & Duration</th> <!-- Adjusted widths -->
          <th style="width:40%;">Activity</th>
          <th style="width:8%;">Done?</th>
          <th style="width:12%;">Rating</th>
          <th style="width:20%;">Actions</th> <!-- Adjusted widths -->
        </tr>
      </thead>
      <tbody>
        <!-- Rows appended dynamically -->
        <tr><td colspan="5" class="text-center no-data">(No tasks added for this day yet)</td></tr>
      </tbody>
    </table>

    <!-- Image gallery area -->
    <div id="imageGallery">
        <!-- Images loaded dynamically -->
        <p class="no-data text-center">(No images added for this client yet)</p>
    </div>


    <!-- Reflection Section -->
    <div class="reflection-section">
        <h3>Daily Reflection</h3>
        <div class="reflection-item">
          <label for="dayRatingSelect">Day Rating (1–5):</label>
          <select id="dayRatingSelect">
            <option value="0">--</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>

        <div class="reflection-item">
          <label for="dayNotes">Reflection Notes:</label>
          <textarea id="dayNotes" rows="4" placeholder="How did the day go? What worked? What didn't? Next steps?"></textarea>
        </div>
    </div>


    <!-- Progress Dashboard -->
    <div id="progressDashboard">
      <h3>Progress Dashboard</h3>

      <p><strong>Task Completion (This Day):</strong> <span id="completionRate">-</span></p>
      <div class="progress-bar-container">
        <div id="completionBar" class="progress-bar" style="width: 0%"></div> <!-- Text removed from bar -->
      </div>

      <p><strong>Average Task Rating (This Day):</strong> <span id="averageTaskRating">-</span></p>

      <hr style="margin: 1.5em 0;"/>

      <p><strong>Day Rating (This Day):</strong> <span id="displayDayRating">-</span></p>

      <p><strong>Avg Day Rating (All Time up to this Date):</strong> <span id="avgDayRatingUpToDate">-</span></p>
      <div class="progress-bar-container">
        <div id="avgRatingBar" class="progress-bar avg-rating" style="width: 0%;"></div> <!-- Text removed from bar -->
      </div>
    </div>

    <!-- Google Embeds Section -->
    <div class="google-embed-container">
        <h2>Google Calendar</h2>
        <div> <!-- Added div to receive card styling -->
            <p style="font-size: 0.9em; color: var(--text-light); margin-top: 0; margin-bottom: 0.5em;">
            <!-- IMPORTANT: Replace 'YOUR_CALENDAR_ID_HERE' in the 'src' attribute below -->
            </p>
            <iframe
            id="googleCalendarEmbed"
            src="https://calendar.google.com/calendar/embed?src=YOUR_CALENDAR_ID_HERE&ctz=America%2FNew_York"
            frameborder="0"
            scrolling="no">
            </iframe>
        </div>
    </div>

    <div class="google-embed-container">
        <h2>Google Tasks</h2>
        <div id="googleTasksPlaceholder"> <!-- This div receives card styling -->
          <p style="margin-top:0;">
            <strong>Note:</strong> Direct Google Tasks embedding requires complex authentication.
          </p>
          <p>Please use Google Tasks in a separate browser tab or window during coaching sessions.</p>
        </div>
    </div>


    <!-- Modals remain outside the main container for full-screen overlay -->


    <div id="footer">
      <p>Client data is stored locally in your browser via <code>localStorage</code>.</p>
      <p><em>Save this HTML file ("File > Save Page As...") to keep the tracker structure. Data persists until browser cache is cleared. Use Export regularly.</em></p>
    </div>

</div> <!-- End of .container -->


<!-- === MODALS (Keep outside .container for positioning) === -->

<!-- Multi-Day Planner Modal -->
<div id="plannerModal">
  <div class="modal-content">
    <h3>Multi-Day Task Planner</h3>
    <p>Create tasks for upcoming days for: <strong><span id="plannerClientLabel"></span></strong></p>
    <hr style="margin: var(--spacing-unit) 0;" />

    <div id="plannerDays"></div>

    <button class="btn" id="addDayBtn">+ Add Another Day</button>

    <!-- Modal Footer -->
    <div>
      <button class="btn" id="savePlanBtn">Save All Tasks</button>
      <button class="btn" id="cancelPlanBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Weekly Planner Modal -->
<div id="weeklyModal">
  <div class="weekly-modal-content">
    <h3>Weekly Planner for: <span id="weeklyClientLabel"></span></h3>
    <p>Set recurring tasks for each weekday.</p>
     <hr style="margin: var(--spacing-unit) 0;" />

    <div id="weeklyContent"></div>

    <!-- Modal Footer -->
    <div>
      <button class="btn" id="saveWeeklyBtn">Done</button> <!-- Simpler text -->
      <button class="btn" id="cancelWeeklyBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal">
  <div class="image-modal-content">
    <h3>Add Image / Screenshot for: <strong><span id="imageClientLabel"></span></strong></h3>
     <hr style="margin: var(--spacing-unit) 0;" />

    <div>
      <label for="imageFileInput">Select Image File:</label>
      <input type="file" id="imageFileInput" accept="image/*">
      <p style="color:var(--text-light);font-size:0.9em; margin-top: 0.5em;">
        Or paste an image directly into this modal (Ctrl+V / Cmd+V).
      </p>
    </div>

    <img id="imagePreview" src="#" alt="(Preview will appear here)">

    <div>
      <label for="imageTitle">Image Title (Optional):</label>
      <input type="text" id="imageTitle" placeholder="Brief description of the image...">
    </div>

    <!-- Modal Footer -->
    <div>
      <button class="btn" id="saveImageBtn">Save Image</button>
      <button class="btn" id="cancelImageBtn">Cancel</button>
    </div>
  </div>
</div>


<script>
    // ALL THE JAVASCRIPT from the previous version goes here.
    // It does not need to be changed for this styling update.
    // Copy and paste the entire <script>...</script> block
    // from the previous response here.

/***************************************************************
  1) DATA STRUCTURE (localStorage key: "resetClientTrackerData")
     allData = {
       clientName1: {
         bigGoal: "Goal text",
         links: { canvas: "url", classroom: "url" },
         weeklyTasks: {
           monday: [ {id:"wt_...", time:"...", duration:"...", activity:"..."} ],
           tuesday: [], ... sunday: []
         },
         images: [ { title: "...", dataUrl: "..." } ],
         "YYYY-MM-DD": { // Date specific data
           dayRating: "1-5" or "0",
           dayNotes: "Notes text",
           tasks: [ { id:"task_...", time:"...", duration:"...", activity:"...", completed:bool, rating:"0-5" } ], // Added ID to daily tasks
           weeklyDone: { weeklyTaskId: true/false } // Tracks completion of weekly tasks for this specific day
         },
         "YYYY-MM-DD": { ... }
       },
       clientName2: { ... }
     }
****************************************************************/
const STORAGE_KEY = "resetClientTrackerData";
let allData = {};
let currentClient = null;
let currentDate   = null;

/***************************************************************
  DOM ELEMENTS
****************************************************************/
// Controls
const clientSelect        = document.getElementById("clientSelect");
const addClientBtn        = document.getElementById("addClientBtn");
const datePicker          = document.getElementById("datePicker");
const clearTasksBtn       = document.getElementById("clearTasksBtn");
const exportBtn           = document.getElementById("exportBtn");
const reportBtn           = document.getElementById("reportBtn");
const multiDayPlanBtn     = document.getElementById("multiDayPlanBtn");
const weeklyPlanBtn       = document.getElementById("weeklyPlanBtn");
const imageBtn            = document.getElementById("imageBtn");

// New Client Form
const newClientForm       = document.getElementById("newClientForm");
const newClientName       = document.getElementById("newClientName");
const saveClientBtn       = document.getElementById("saveClientBtn");
const cancelClientBtn     = document.getElementById("cancelClientBtn");

// Client Info Area
const bigGoalInput        = document.getElementById("bigGoalInput");
const canvasLinkInput     = document.getElementById("canvasLinkInput");
const classroomLinkInput  = document.getElementById("classroomLinkInput");
const saveClientInfoBtn   = document.getElementById("saveClientInfoBtn");
const bigGoalDisplay      = document.getElementById("bigGoalDisplay");
const canvasLinkAnchor    = document.getElementById("canvasLinkAnchor");
const classroomLinkAnchor = document.getElementById("classroomLinkAnchor");

// Add Task Section
const timeSelect          = document.getElementById("timeSelect");
const durationSelect      = document.getElementById("durationSelect");
const activityInput       = document.getElementById("activityInput");
const taskSearch          = document.getElementById("taskSearch");
const addBtn              = document.getElementById("addBtn");
const taskTableBody       = document.getElementById("taskTable").querySelector("tbody");

// Reflection Section (Moved)
const dayRatingSelect     = document.getElementById("dayRatingSelect");
const dayNotesTextarea    = document.getElementById("dayNotes");

// Image Gallery
const imageGallery        = document.getElementById("imageGallery");

// Progress Dashboard
const completionRateEl       = document.getElementById("completionRate");
const completionBarEl        = document.getElementById("completionBar");
const averageTaskRatingEl    = document.getElementById("averageTaskRating");
const displayDayRatingEl     = document.getElementById("displayDayRating");
const avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate");
const avgRatingBarEl         = document.getElementById("avgRatingBar");

// Multi-day planner modal
const plannerModal        = document.getElementById("plannerModal");
const plannerClientLabel  = document.getElementById("plannerClientLabel");
const plannerDays         = document.getElementById("plannerDays");
const addDayBtn           = document.getElementById("addDayBtn");
const savePlanBtn         = document.getElementById("savePlanBtn");
const cancelPlanBtn       = document.getElementById("cancelPlanBtn");

// Weekly planner modal
const weeklyModal         = document.getElementById("weeklyModal");
const weeklyClientLabel   = document.getElementById("weeklyClientLabel");
const weeklyContent       = document.getElementById("weeklyContent");
const saveWeeklyBtn       = document.getElementById("saveWeeklyBtn");
const cancelWeeklyBtn     = document.getElementById("cancelWeeklyBtn");

// Image Modal
const imageModal          = document.getElementById("imageModal");
const imageClientLabel    = document.getElementById("imageClientLabel");
const imageFileInput      = document.getElementById("imageFileInput");
const imagePreview        = document.getElementById("imagePreview");
const imageTitleInput     = document.getElementById("imageTitle");
const saveImageBtn        = document.getElementById("saveImageBtn");
const cancelImageBtn      = document.getElementById("cancelImageBtn");

/***************************************************************
  INITIALIZATION
****************************************************************/
window.addEventListener("load", () => {
  // Load from localStorage with error handling
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      allData = JSON.parse(stored);
      if (typeof allData !== 'object' || allData === null) {
          console.warn("Invalid data found in localStorage, resetting."); allData = {};
      }
    } else { allData = {}; }
  } catch (error) {
    console.error("Error parsing data from localStorage:", error);
    alert("Could not load saved data. It might be corrupted. Starting fresh."); allData = {};
  }

  populateClientSelect();
  const todayStr = new Date().toISOString().split("T")[0];
  datePicker.value = todayStr; currentDate = todayStr;

  const clientNames = Object.keys(allData).sort();
  if (clientNames.length > 0) {
    currentClient = clientNames[0]; clientSelect.value = currentClient;
    loadClientDate(currentClient, currentDate);
  } else {
    currentClient = null;
    bigGoalDisplay.textContent = "(Add a client to get started)";
    taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(Add a client and select a date)</td></tr>';
    imageGallery.innerHTML = '<p class="no-data text-center">(No images added for this client yet)</p>';
  }

  populateTimeDropdown();
  setupEventListeners();
});

/***************************************************************
  EVENT LISTENERS SETUP
****************************************************************/
function setupEventListeners() {
  clientSelect.addEventListener("change", onClientOrDateChange);
  datePicker.addEventListener("change", onClientOrDateChange);
  addClientBtn.addEventListener("click", showNewClientForm);
  saveClientBtn.addEventListener("click", saveNewClient);
  cancelClientBtn.addEventListener("click", hideNewClientForm);
  saveClientInfoBtn.addEventListener("click", saveClientInfo);
  addBtn.addEventListener("click", addNewTask);
  clearTasksBtn.addEventListener("click", clearTasksForClientDate);
  exportBtn.addEventListener("click", exportData);
  reportBtn.addEventListener("click", generateReport);
  dayRatingSelect.addEventListener("change", onDayRatingChange);
  dayNotesTextarea.addEventListener("input", onDayNotesChange); // Debounced save
  multiDayPlanBtn.addEventListener("click", openPlannerModal);
  addDayBtn.addEventListener("click", addPlannerDay);
  savePlanBtn.addEventListener("click", saveMultiDayPlan);
  cancelPlanBtn.addEventListener("click", closePlannerModal);
  weeklyPlanBtn.addEventListener("click", openWeeklyModal);
  saveWeeklyBtn.addEventListener("click", saveWeeklySchedule);
  cancelWeeklyBtn.addEventListener("click", closeWeeklyModal);
  imageBtn.addEventListener("click", openImageModal);
  cancelImageBtn.addEventListener("click", closeImageModal);
  saveImageBtn.addEventListener("click", saveImage);
  imageModal.addEventListener("paste", handlePasteImage);
  imageFileInput.addEventListener("change", handleFileInputChange);
  taskSearch.addEventListener("input", filterTaskTable);

  document.addEventListener("keydown", (e) => {
    const activeEl = document.activeElement;
    const isInputFocused = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT');

    if (e.key === "Escape") {
        if (plannerModal.style.display === "block") closePlannerModal();
        else if (weeklyModal.style.display === "block") closeWeeklyModal();
        else if (imageModal.style.display === "block") closeImageModal();
        else if (newClientForm.style.display === "flex") hideNewClientForm();
        else if (isInputFocused) activeEl.blur(); // Blur input on Escape if no modal is open
        return; // Handle Escape globally
    }

    // Ignore other shortcuts if typing in specific fields
    if (isInputFocused && activeEl !== taskSearch) { // Allow shortcuts even if search is focused
        return;
    }

    if (e.altKey && e.key === "a") { e.preventDefault(); if (document.activeElement === activityInput && activityInput.value.trim() !== '') { addNewTask(); } else { activityInput.focus(); } }
    if (e.altKey && e.key === "d") { e.preventDefault(); const lastRow = taskTableBody.querySelector("tr.task-row:last-child"); if (lastRow) { const checkbox = lastRow.querySelector("input[type='checkbox']"); if (checkbox) { checkbox.checked = !checkbox.checked; checkbox.dispatchEvent(new Event("change")); } } }
    if (e.altKey && e.key === "s") { e.preventDefault(); sortTasksByTime(); taskTableBody.style.transition = 'background-color 0.1s ease-out'; taskTableBody.style.backgroundColor = 'var(--accent-primary-light)'; setTimeout(() => { taskTableBody.style.backgroundColor = ''; }, 200); }
  });
}

/***************************************************************
  CLIENT MANAGEMENT FUNCTIONS
****************************************************************/
function populateClientSelect() {
  clientSelect.innerHTML = "";
  const clientNames = Object.keys(allData).sort();
  const hasClients = clientNames.length > 0;

  clientSelect.disabled = !hasClients;
  multiDayPlanBtn.disabled = !hasClients;
  weeklyPlanBtn.disabled = !hasClients;
  imageBtn.disabled = !hasClients;
  reportBtn.disabled = !hasClients;
  clearTasksBtn.disabled = !hasClients;
  saveClientInfoBtn.disabled = !hasClients;

  if (!hasClients) {
    const opt = document.createElement("option"); opt.textContent = "-- No Clients Added --"; opt.value = ""; clientSelect.appendChild(opt);
  } else {
    // Optional: Add default selection prompt
    // const defaultOpt = document.createElement("option"); defaultOpt.textContent = "-- Select Client --"; defaultOpt.value = ""; clientSelect.appendChild(defaultOpt);
    clientNames.forEach(name => { const opt = document.createElement("option"); opt.value = name; opt.textContent = name; clientSelect.appendChild(opt); });
  }
}

function showNewClientForm() { newClientForm.style.display = "flex"; newClientName.value = ""; newClientName.focus(); }
function hideNewClientForm() { newClientForm.style.display = "none"; }

function saveNewClient() {
  const name = newClientName.value.trim();
  if (!name) { alert("Please enter a client name."); return; }
  if (allData[name]) { alert(`Client "${name}" already exists.`); return; }
  allData[name] = { bigGoal: "", links: { canvas: "", classroom: "" }, weeklyTasks: { monday: [], tuesday: [], wednesday: [], thursday: [], friday: [], saturday: [], sunday: [] }, images: [] };
  saveToLocalStorage(); populateClientSelect(); clientSelect.value = name;
  currentClient = name; currentDate = datePicker.value;
  loadClientDate(currentClient, currentDate); hideNewClientForm();
}

function saveClientInfo() {
  if (!currentClient) { alert("Please select a client first."); return; }
  const cliData = allData[currentClient]; if (!cliData) return;
  cliData.bigGoal = bigGoalInput.value.trim();
  if (!cliData.links) cliData.links = {};
  cliData.links.canvas = canvasLinkInput.value.trim();
  cliData.links.classroom = classroomLinkInput.value.trim();
  saveToLocalStorage(); renderClientInfo();
  const originalText = saveClientInfoBtn.textContent; const originalBg = saveClientInfoBtn.style.backgroundColor;
  saveClientInfoBtn.textContent = 'Saved!'; saveClientInfoBtn.style.backgroundColor = 'var(--accent-green)'; saveClientInfoBtn.disabled = true;
  setTimeout(() => { saveClientInfoBtn.textContent = originalText; saveClientInfoBtn.style.backgroundColor = originalBg; saveClientInfoBtn.disabled = false; }, 1500);
}

function renderClientInfo() {
  if (!currentClient || !allData[currentClient]) {
    bigGoalDisplay.textContent = "(Select a client)"; bigGoalInput.value = "";
    canvasLinkInput.value = ""; classroomLinkInput.value = "";
    canvasLinkAnchor.style.display = "none"; classroomLinkAnchor.style.display = "none";
    return;
  }
  const cliData = allData[currentClient];
  bigGoalDisplay.textContent = cliData.bigGoal || "(No Big Goal Set)"; bigGoalInput.value = cliData.bigGoal || "";
  const links = cliData.links || { canvas: "", classroom: "" };
  canvasLinkAnchor.style.display = (links.canvas && links.canvas.startsWith('http')) ? "inline-flex" : "none";
  if (links.canvas) canvasLinkAnchor.href = links.canvas; canvasLinkInput.value = links.canvas || "";
  classroomLinkAnchor.style.display = (links.classroom && links.classroom.startsWith('http')) ? "inline-flex" : "none";
  if (links.classroom) classroomLinkAnchor.href = links.classroom; classroomLinkInput.value = links.classroom || "";
}

/***************************************************************
  CORE DATA LOADING & DISPLAY
****************************************************************/
function onClientOrDateChange() {
  currentClient = clientSelect.value; currentDate = datePicker.value;
  if (currentClient && currentDate) { loadClientDate(currentClient, currentDate); }
  else {
    taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(Select a client and date)</td></tr>';
    renderClientInfo(); resetReflectionFields(); resetProgressDashboard();
    imageGallery.innerHTML = '<p class="no-data text-center">(No images added for this client yet)</p>';
  }
}

function loadClientDate(clientName, dateStr) {
  if (!clientName || !dateStr) return;
  if (!allData[clientName]) { console.error(`Data for client "${clientName}" not found.`); allData[clientName] = { bigGoal: "", links: {}, weeklyTasks: {}, images: [] }; }
  if (!allData[clientName][dateStr]) { allData[clientName][dateStr] = { dayRating: "0", dayNotes: "", tasks: [], weeklyDone: {} }; }

  const clientData = allData[clientName]; const dayRecord = clientData[dateStr];
  renderClientInfo();
  dayRatingSelect.value = dayRecord.dayRating || "0"; dayNotesTextarea.value = dayRecord.dayNotes || "";
  renderTaskTable(clientData, dayRecord, dateStr); // This now handles sorting and rendering
  renderImageGallery();
  updateProgress();
  taskSearch.value = ""; filterTaskTable(); // Clear search and filter
}

function renderTaskTable(clientData, dayRecord, dateStr) {
    taskTableBody.innerHTML = "";
    const dailyTasks = dayRecord.tasks || []; const weekday = getWeekdayFromDate(dateStr);
    const weeklyTaskList = clientData.weeklyTasks && clientData.weeklyTasks[weekday] ? clientData.weeklyTasks[weekday] : [];
    const weeklyDoneMap = dayRecord.weeklyDone || {};
    const allTasksToRender = [];
    dailyTasks.forEach(task => allTasksToRender.push({ ...task, taskType: 'daily' }));
    weeklyTaskList.forEach(wTask => allTasksToRender.push({ ...wTask, completed: !!weeklyDoneMap[wTask.id], rating: "0", taskType: 'weekly' }));
    allTasksToRender.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time));

    if (allTasksToRender.length === 0) { taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(No tasks scheduled for this day)</td></tr>'; }
    else { allTasksToRender.forEach(task => addTaskRow(task, task.taskType)); }
}

function resetReflectionFields() { dayRatingSelect.value = "0"; dayNotesTextarea.value = ""; }
function resetProgressDashboard() { completionRateEl.textContent = "-"; completionBarEl.style.width = "0%"; completionBarEl.textContent = ""; averageTaskRatingEl.textContent = "-"; displayDayRatingEl.textContent = "-"; avgDayRatingUpToDateEl.textContent = "-"; avgRatingBarEl.style.width = "0%"; avgRatingBarEl.textContent = ""; }

/***************************************************************
  REFLECTION (DAY RATING + NOTES)
****************************************************************/
function onDayRatingChange() { if (!currentClient || !currentDate) return; const rec = getDayRecord(); if (!rec) return; rec.dayRating = dayRatingSelect.value; saveToLocalStorage(); updateProgress(); }
const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; };
const debouncedSaveNotes = debounce(() => { if (!currentClient || !currentDate) return; const rec = getDayRecord(); if (!rec) return; rec.dayNotes = dayNotesTextarea.value; saveToLocalStorage(); }, 500);
function onDayNotesChange() { debouncedSaveNotes(); }
function getDayRecord() { if (!currentClient || !currentDate || !allData[currentClient]) return null; if (!allData[currentClient][currentDate]) { allData[currentClient][currentDate] = { dayRating: "0", dayNotes: "", tasks: [], weeklyDone: {} }; } return allData[currentClient][currentDate]; }

/***************************************************************
  TIME DROPDOWN POPULATION
****************************************************************/
function populateTimeDropdown() { timeSelect.innerHTML = ""; for (let hour = 5; hour < 24; hour++) { for (let minute = 0; minute < 60; minute += 15) { const d = new Date(); d.setHours(hour, minute); const label = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }); const opt = document.createElement("option"); opt.value = label; opt.textContent = label; timeSelect.appendChild(opt); } } const separator = document.createElement("option"); separator.disabled = true; separator.textContent = "──────────"; timeSelect.appendChild(separator); const commonTimes = ["Before School", "During Study Hall", "During Lunch", "Right After School", "Before Dinner", "After Dinner", "Before Bed"]; commonTimes.forEach(t => { const opt = document.createElement("option"); opt.value = t; opt.textContent = t; timeSelect.appendChild(opt); }); const defaultTime = "3:00 PM"; if (Array.from(timeSelect.options).some(opt => opt.value === defaultTime)) { timeSelect.value = defaultTime; } }

/***************************************************************
  TASK MANAGEMENT (ADD, RENDER, EDIT, REMOVE, SORT)
****************************************************************/
function addNewTask() {
  if (!currentClient || !currentDate) { alert("Select client/date."); return; }
  const chosenTime = timeSelect.value; const actVal = activityInput.value.trim(); const durationVal = durationSelect.value;
  if (!actVal) { alert("Enter activity."); activityInput.focus(); return; }
  const rec = getDayRecord(); if (!rec) return; if (!rec.tasks) rec.tasks = [];
  const newTask = { id: `task_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, time: chosenTime, activity: actVal, completed: false, rating: "0", duration: durationVal };
  rec.tasks.push(newTask); saveToLocalStorage();
  renderTaskTable(allData[currentClient], rec, currentDate); // Re-render table
  activityInput.value = ""; activityInput.focus();
  updateProgress();
}

function addTaskRow(taskObj, taskType) {
  const row = taskTableBody.insertRow(); row.classList.add("task-row");
  row.dataset.taskId = taskObj.id; row.dataset.taskType = taskType; row.dataset.timeValue = convertTimeToMinutes(taskObj.time);
  if (taskObj.completed) row.classList.add("completed-task");

  const tdTime = row.insertCell(0); tdTime.innerHTML = escapeHtml(taskObj.time);
  if (taskObj.duration) tdTime.innerHTML += `<br><span style="font-size:0.8em; color: var(--text-light);">${escapeHtml(taskObj.duration)}</span>`;
  if (taskType === 'weekly') tdTime.innerHTML += `<span class="weekly-indicator">(Weekly)</span>`;

  const tdAct = row.insertCell(1); tdAct.textContent = taskObj.activity;

  const tdDone = row.insertCell(2); const chk = document.createElement("input"); chk.type = "checkbox"; chk.checked = taskObj.completed; chk.title = "Mark done/undone";
  chk.addEventListener("change", () => { row.classList.toggle("completed-task", chk.checked); if (taskType === 'daily') { const dayRec = getDayRecord(); const task = dayRec?.tasks?.find(t => t.id === taskObj.id); if (task) task.completed = chk.checked; } else if (taskType === 'weekly') { const dayRec = getDayRecord(); if (!dayRec.weeklyDone) dayRec.weeklyDone = {}; dayRec.weeklyDone[taskObj.id] = chk.checked; } saveToLocalStorage(); updateProgress(); });
  tdDone.appendChild(chk);

  const tdRating = row.insertCell(3);
  if (taskType === 'daily') { const ratingSel = document.createElement("select"); ratingSel.title = "Rate task (1-5)"; for (let i = 0; i <= 5; i++) { const opt = document.createElement("option"); opt.value = i; opt.text = i === 0 ? "–" : i.toString(); ratingSel.appendChild(opt); } ratingSel.value = taskObj.rating || "0"; ratingSel.addEventListener("change", () => { const dayRec = getDayRecord(); const task = dayRec?.tasks?.find(t => t.id === taskObj.id); if (task) task.rating = ratingSel.value; saveToLocalStorage(); updateProgress(); }); tdRating.appendChild(ratingSel); }
  else { tdRating.innerHTML = `<span class="no-data">–</span>`; }

  const tdActions = row.insertCell(4); tdActions.style.whiteSpace = 'nowrap';
  if (taskType === 'daily') { const editBtn = document.createElement("button"); editBtn.textContent = "✎"; editBtn.classList.add("btn"); editBtn.title = "Edit task"; editBtn.addEventListener("click", (e) => { e.stopPropagation(); makeTaskEditable(row, taskObj); }); tdActions.appendChild(editBtn); const rmBtn = document.createElement("button"); rmBtn.textContent = "✕"; rmBtn.classList.add("btn"); rmBtn.title = "Delete task"; rmBtn.addEventListener("click", (e) => { e.stopPropagation(); if (confirm(`Delete task: "${taskObj.activity}"?`)) { removeTask(taskObj); row.remove(); updateProgress(); if (taskTableBody.querySelectorAll('tr.task-row').length === 0) { taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(No tasks scheduled for this day)</td></tr>'; } } }); tdActions.appendChild(rmBtn); }
  else { tdActions.innerHTML = `<span style="color:var(--text-light); font-size:0.85em;">(Weekly)</span>`; }
}

function makeTaskEditable(row, taskObj) {
    const currentlyEditing = taskTableBody.querySelector('.editing-task-row');
    if (currentlyEditing && currentlyEditing !== row) { const otherCancelBtn = currentlyEditing.querySelector('.btn-cancel-edit'); if (otherCancelBtn) otherCancelBtn.click(); }
    row.classList.add('editing-task-row');

    const originalRowIndex = Array.from(taskTableBody.rows).indexOf(row);
    const tdTime = row.cells[0]; const tdAct = row.cells[1]; const tdRating = row.cells[3]; const tdActions = row.cells[4];
    const originalTimeHTML = tdTime.innerHTML; const originalActivityHTML = tdAct.innerHTML; const originalRatingHTML = tdRating.innerHTML; const originalActionsHTML = tdActions.innerHTML;

    tdTime.innerHTML = ""; const timeDurContainer = document.createElement('div'); timeDurContainer.style.display = 'flex'; timeDurContainer.style.flexDirection = 'column'; timeDurContainer.style.gap = '4px';
    const newTimeSel = document.createElement("select"); newTimeSel.style.marginBottom = '0'; populateTempTimeDropdown(newTimeSel, taskObj.time); timeDurContainer.appendChild(newTimeSel);
    const newDurSel = document.createElement("select"); newDurSel.style.marginBottom = '0'; ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => { const opt = document.createElement("option"); opt.value = d; opt.text = d; newDurSel.appendChild(opt); }); newDurSel.value = taskObj.duration || "30 min"; timeDurContainer.appendChild(newDurSel); tdTime.appendChild(timeDurContainer);

    tdAct.innerHTML = ""; const actInput = document.createElement("input"); actInput.type = "text"; actInput.value = taskObj.activity; actInput.style.width = "100%"; actInput.style.marginBottom = '0'; tdAct.appendChild(actInput); actInput.focus(); actInput.select();
    tdRating.innerHTML = ""; tdActions.innerHTML = "";

    const saveBtn = document.createElement("button"); saveBtn.textContent = "Save"; saveBtn.classList.add("btn", "btn-primary"); saveBtn.style.fontSize = '0.85em'; saveBtn.style.padding = '0.3em 0.6em';
    saveBtn.addEventListener("click", (e) => { e.stopPropagation(); const newTime = newTimeSel.value; const newActivity = actInput.value.trim(); const newDuration = newDurSel.value; if (!newActivity) { alert("Activity empty."); actInput.focus(); return; } const dayRec = getDayRecord(); const taskIndex = dayRec?.tasks?.findIndex(t => t.id === taskObj.id); if (taskIndex !== undefined && taskIndex > -1) { dayRec.tasks[taskIndex].time = newTime; dayRec.tasks[taskIndex].activity = newActivity; dayRec.tasks[taskIndex].duration = newDuration; saveToLocalStorage(); taskObj.time = newTime; taskObj.activity = newActivity; taskObj.duration = newDuration; renderTaskTable(allData[currentClient], dayRec, currentDate); updateProgress(); } else { console.error("Failed to find task:", taskObj.id); renderTaskTable(allData[currentClient], getDayRecord(), currentDate); } });
    tdActions.appendChild(saveBtn);

    const cancelBtn = document.createElement("button"); cancelBtn.textContent = "Cancel"; cancelBtn.classList.add("btn", "btn-cancel-edit"); cancelBtn.style.fontSize = '0.85em'; cancelBtn.style.padding = '0.3em 0.6em';
    cancelBtn.addEventListener("click", (e) => { e.stopPropagation(); const currentScroll = window.scrollY; renderTaskTable(allData[currentClient], getDayRecord(), currentDate); window.scrollTo(0, currentScroll); });
    tdActions.appendChild(cancelBtn);
}

function populateTempTimeDropdown(selectElem, currentVal) { const masterOptions = timeSelect.options; for (let i = 0; i < masterOptions.length; i++){ const clone = masterOptions[i].cloneNode(true); selectElem.appendChild(clone); } if (Array.from(selectElem.options).some(opt => opt.value === currentVal)) { selectElem.value = currentVal; } }
function sortTasksByTimeInData() { if (!currentClient || !currentDate) return; const rec = getDayRecord(); if (!rec || !rec.tasks || rec.tasks.length < 2) return; rec.tasks.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); saveToLocalStorage(); }
function sortTasksByTime() { sortTasksByTimeInData(); if (currentClient && currentDate) { const dayRec = getDayRecord(); renderTaskTable(allData[currentClient], dayRec, currentDate); } }
function convertTimeToMinutes(timeStr) { if (!timeStr) return 9999; const specialTimes = { "Before School": 360, "During Study Hall": 600, "During Lunch": 720, "Right After School": 930, "Before Dinner": 1080, "After Dinner": 1200, "Before Bed": 1320 }; if (specialTimes[timeStr] !== undefined) return specialTimes[timeStr]; const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i); if (match) { let hours = parseInt(match[1], 10); const minutes = parseInt(match[2], 10); const ampm = match[3].toUpperCase(); if (isNaN(hours) || isNaN(minutes)) return 9999; if (ampm === "PM" && hours < 12) hours += 12; if (ampm === "AM" && hours === 12) hours = 0; return hours * 60 + minutes; } return 9999; }

function removeTask(taskObj) { const rec = getDayRecord(); if (!rec || !rec.tasks) return; const idx = rec.tasks.findIndex(task => task.id === taskObj.id); if (idx !== -1) { rec.tasks.splice(idx, 1); saveToLocalStorage(); } else { console.warn("Task object not found for removal by ID:", taskObj.id); const refIdx = rec.tasks.indexOf(taskObj); if (refIdx !== -1) { rec.tasks.splice(refIdx, 1); saveToLocalStorage(); console.log("Removed task by ref fallback."); } else { console.error("Failed to remove task."); } } }
function clearTasksForClientDate() { if (!currentClient || !currentDate) { alert("Select client/date."); return; } if (confirm(`ARE YOU SURE?\n\nDelete ALL daily tasks for ${currentClient} on ${currentDate}?\n(Cannot be undone).`)) { const rec = getDayRecord(); if (rec) { rec.tasks = []; saveToLocalStorage(); renderTaskTable(allData[currentClient], rec, currentDate); updateProgress(); alert("Daily tasks cleared."); } } }

function filterTaskTable() {
    const searchText = taskSearch.value.toLowerCase().trim();
    const rows = taskTableBody.querySelectorAll("tr.task-row");
    let matchFound = false;
    rows.forEach(row => { const activityCell = row.cells[1]; const activityText = activityCell?.textContent.toLowerCase() || ""; const timeCell = row.cells[0]; const timeText = timeCell?.textContent.toLowerCase() || ""; const isVisible = activityText.includes(searchText) || timeText.includes(searchText); row.style.display = isVisible ? "" : "none"; if (isVisible) matchFound = true; });
    let noMatchRow = taskTableBody.querySelector('.no-match-row');
    if (!matchFound && searchText !== '' && rows.length > 0) { if (!noMatchRow) { noMatchRow = taskTableBody.insertRow(); noMatchRow.classList.add('no-match-row'); const cell = noMatchRow.insertCell(0); cell.colSpan = 5; cell.textContent = "No tasks match search."; cell.className = 'text-center no-data'; } }
    else { if (noMatchRow) noMatchRow.remove(); }
}

/***************************************************************
  EXPORT & REPORT
****************************************************************/
function exportData() { if (Object.keys(allData).length === 0) { alert("No data."); return; } try { const dataStr = JSON.stringify(allData, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json;charset=utf-8"}); const exportFilename = `reset-client-tracker-export-${new Date().toISOString().split('T')[0]}.json`; if (window.navigator && window.navigator.msSaveOrOpenBlob) { window.navigator.msSaveOrOpenBlob(dataBlob, exportFilename); } else { const dataUri = URL.createObjectURL(dataBlob); const link = document.createElement("a"); link.setAttribute("href", dataUri); link.setAttribute("download", exportFilename); document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(dataUri); } } catch (error) { console.error("Export error:", error); alert("Error exporting data."); } }
function generateReport() { if (!currentClient || !allData[currentClient]) { alert("Select client."); return; } const cliData = allData[currentClient]; let reportHtml = ` <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <title>Client Report - ${escapeHtml(currentClient)}</title> <style> :root { --accent-primary: #B07A60; --primary-blue-light: #EBF4FF; --text-primary: #262626; --text-secondary: #5C5C5C; --text-light: #888888; --border-color: #EAE0DA; --border-color-light: #F5F1ED; --bg-card-secondary: #F9F6F3; --border-radius: 4px; --spacing-unit: 1rem; } body { font-family: 'Inter', system-ui, sans-serif; margin: 20px; line-height: 1.6; color: var(--text-primary); } .report-container { max-width: 800px; margin: 0 auto; } h1, h2, h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; margin-top: 1.5em; font-weight: 600;} h1 { font-size: 1.8em; color: var(--accent-primary); border-bottom-width: 2px; } h2 { font-size: 1.4em; margin-top: 2em; } h3 { font-size: 1.1em; color: var(--text-secondary); margin-top: 1.5em; border-bottom-style: dashed;} table { width: 100%; border-collapse: collapse; margin-bottom: 1.5em; margin-top: 0.5em; font-size: 0.9em; border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; } th { background-color: var(--bg-card-secondary); text-align: left; padding: 10px; font-weight: 600; text-transform: uppercase; font-size: 0.8em; letter-spacing: 0.05em;} td { padding: 10px; vertical-align: top; border-top: 1px solid var(--border-color-light); } tbody tr:nth-child(even) { background-color: #fdfdff; } .notes-box { background-color: #f9f9f9; border: 1px solid var(--border-color-light); padding: 10px; margin: 10px 0; white-space: pre-wrap; border-radius: var(--border-radius); font-size: 0.95em; } .gallery-item { margin-bottom: 15px; border-bottom: 1px solid var(--border-color-light); padding-bottom: 10px; } .gallery-img { max-width: 250px; max-height: 200px; margin-top: 5px; border: 1px solid var(--border-color); display: block; border-radius: var(--border-radius);} .completed td:not(:last-child) { text-decoration: line-through; color: var(--text-light); opacity: 0.8; } .weekly-task-indicator { font-size: 0.8em; color: var(--accent-primary); font-style: italic; display: block; } .rating-value { font-weight: bold; color: var(--accent-primary); } .no-data { color: var(--text-light); font-style: italic; } ul { padding-left: 20px; margin-top: 0.5em; } li { margin-bottom: 0.3em; } a { color: var(--accent-primary); text-decoration: none; } a:hover { text-decoration: underline; } </style> </head> <body> <div class="report-container"> <h1>Client Report: ${escapeHtml(currentClient)}</h1> <p><em>Generated: ${new Date().toLocaleString()}</em></p> <h2>Client Info</h2> <p><strong>Big Goal:</strong> ${escapeHtml(cliData.bigGoal || "(Not Set)")}</p> `; const links = cliData.links || {}; if (links.canvas || links.classroom) { reportHtml += `<p><strong>Links:</strong> `; if (links.canvas) reportHtml += `<a href="${escapeHtml(links.canvas)}" target="_blank">Canvas</a> `; if (links.classroom) reportHtml += ` <a href="${escapeHtml(links.classroom)}" target="_blank">Google Classroom</a>`; reportHtml += `</p>`; } else { reportHtml += `<p class="no-data">No links saved.</p>`; } const weeklyTasks = cliData.weeklyTasks || {}; let hasWeeklyTasks = false; let weeklyHtml = `<h2>Weekly Tasks</h2>`; Object.keys(weeklyTasks).sort((a, b) => ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(a) - ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(b)).forEach(day => { const dayTasks = weeklyTasks[day] || []; if (dayTasks.length > 0) { hasWeeklyTasks = true; weeklyHtml += `<h3>${escapeHtml(day.charAt(0).toUpperCase() + day.slice(1))}</h3><ul>`; dayTasks.forEach(t => { weeklyHtml += `<li>[${escapeHtml(t.time)}] ${escapeHtml(t.activity)} ${t.duration ? '(' + escapeHtml(t.duration) + ')' : ''}</li>`; }); weeklyHtml += `</ul>`; } }); if (hasWeeklyTasks) reportHtml += weeklyHtml; else reportHtml += `<h2>Weekly Tasks</h2><p class="no-data">No weekly tasks set.</p>`; const images = cliData.images || []; if (images.length > 0) { reportHtml += `<h2>Images</h2>`; images.forEach(img => { reportHtml += `<div class="gallery-item"> <strong>${escapeHtml(img.title || "(Untitled)")}</strong><br/> <a href="${img.dataUrl}" target="_blank"><img src="${img.dataUrl}" alt="${escapeHtml(img.title)}" class="gallery-img"/></a> </div>`; }); } else { reportHtml += `<h2>Images</h2><p class="no-data">No images saved.</p>`; } reportHtml += `<h2>Daily Records</h2>`; const dateKeys = Object.keys(cliData).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k)).sort(); if (dateKeys.length === 0) { reportHtml += `<p class="no-data">No daily records.</p>`; } else { dateKeys.forEach(d => { const rec = cliData[d]; if (!rec) return; const formattedDate = formatDateForReport(d); const dayRating = (rec.dayRating && rec.dayRating !== "0") ? `<span class="rating-value">${rec.dayRating}/5</span>` : "--"; reportHtml += `<h3>${formattedDate}   |   Day Rating: ${dayRating}</h3>`; if (rec.dayNotes && rec.dayNotes.trim() !== "") { reportHtml += `<div class="notes-box"><strong>Notes:</strong><br/>${escapeHtml(rec.dayNotes).replace(/\n/g, "<br/>")}</div>`; } else { reportHtml += `<p class="no-data">No notes.</p>`; } const dailyTasks = rec.tasks || []; const weekday = getWeekdayFromDate(d); const weeklyList = (cliData.weeklyTasks && cliData.weeklyTasks[weekday]) ? cliData.weeklyTasks[weekday] : []; const weeklyDoneMap = rec.weeklyDone || {}; const mergedTasks = []; dailyTasks.forEach(t => mergedTasks.push({ ...t, _type: 'daily' })); weeklyList.forEach(wt => { mergedTasks.push({ ...wt, completed: !!weeklyDoneMap[wt.id], rating: "0", _type: 'weekly' }); }); mergedTasks.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); if (mergedTasks.length === 0) { reportHtml += `<p class="no-data">No tasks.</p>`; } else { reportHtml += `<table><thead><tr><th>Time</th><th>Activity</th><th>Duration</th><th>Done?</th><th>Rating</th></tr></thead><tbody>`; let completedCount = 0; mergedTasks.forEach(t => { if (t.completed) completedCount++; const isCompletedClass = t.completed ? 'class="completed"' : ''; const ratingStr = (t._type === "daily" && t.rating !== "0") ? `<span class="rating-value">${t.rating}/5</span>` : (t._type === "daily" ? "--" : "<span class='no-data'>(N/A)</span>"); const weeklyIndicator = t._type === 'weekly' ? `<span class="weekly-task-indicator">(Weekly)</span>` : ''; reportHtml += `<tr ${isCompletedClass}> <td>${escapeHtml(t.time)}${weeklyIndicator}</td> <td>${escapeHtml(t.activity)}</td> <td>${escapeHtml(t.duration || '--')}</td> <td>${t.completed ? 'Yes' : 'No'}</td> <td>${ratingStr}</td> </tr>`; }); reportHtml += `</tbody></table><p><strong>Completion:</strong> ${completedCount} / ${mergedTasks.length} tasks</p>`; } }); } reportHtml += ` <hr style="margin-top: 2em; border-color: var(--border-color);"> <p style="text-align:center; font-size: 0.8em; color: var(--text-light);">End of Report</p> </div> </body></html>`; const reportWindow = window.open("", "_blank"); if (reportWindow) { reportWindow.document.open(); reportWindow.document.write(reportHtml); reportWindow.document.close(); } else { alert("Could not open report window."); } }
function formatDateForReport(dateStr) { try { const date = new Date(dateStr + 'T12:00:00Z'); return date.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' }); } catch (e) { return dateStr; } }

/***************************************************************
  LOCALSTORAGE & UTILITIES
****************************************************************/
function saveToLocalStorage() { try { const dataString = JSON.stringify(allData); localStorage.setItem(STORAGE_KEY, dataString); } catch (error) { if (error.name === 'QuotaExceededError' || error.name === 'NS_ERROR_DOM_QUOTA_REACHED' ) { console.error("LocalStorage quota exceeded!", error); alert("Error: Storage limit exceeded! Cannot save.\nExport data and clear old records/images."); } else { console.error("Error saving to localStorage:", error); alert("Error saving data."); } } }
function updateProgress() { if (!currentClient || !currentDate) { resetProgressDashboard(); return; } const rec = getDayRecord(); if (!rec) { resetProgressDashboard(); return; } const clientData = allData[currentClient]; const dailyTasks = rec.tasks || []; const weekday = getWeekdayFromDate(currentDate); const weeklyList = (clientData.weeklyTasks && clientData.weeklyTasks[weekday]) ? clientData.weeklyTasks[weekday] : []; const weeklyDoneMap = rec.weeklyDone || {}; const dailyDoneCount = dailyTasks.filter(t => t.completed).length; const weeklyDoneCount = weeklyList.filter(wt => weeklyDoneMap[wt.id]).length; const totalDone = dailyDoneCount + weeklyDoneCount; const totalTasks = dailyTasks.length + weeklyList.length; if (totalTasks === 0) { completionRateEl.textContent = "- (No tasks)"; completionBarEl.style.width = "0%"; completionBarEl.textContent = ""; } else { const percentage = Math.round((totalDone / totalTasks) * 100); completionRateEl.textContent = `${percentage}% (${totalDone}/${totalTasks})`; completionBarEl.style.width = `${percentage}%`; completionBarEl.textContent = `${percentage}%`; } const ratedDailyTasks = dailyTasks.filter(t => t.rating && parseInt(t.rating, 10) > 0); if (ratedDailyTasks.length > 0) { const sumRatings = ratedDailyTasks.reduce((acc, t) => acc + parseInt(t.rating, 10), 0); const avgRating = (sumRatings / ratedDailyTasks.length); averageTaskRatingEl.textContent = `${avgRating.toFixed(1)} / 5 (from ${ratedDailyTasks.length} rated)`; } else { averageTaskRatingEl.textContent = "No daily tasks rated yet"; } const dayRating = rec.dayRating || "0"; displayDayRatingEl.textContent = (dayRating !== "0") ? `${dayRating} / 5` : "--"; const allClientDates = Object.keys(clientData).filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d) && d <= currentDate).sort(); let sumDayRatings = 0; let countRatedDays = 0; allClientDates.forEach(d => { const dayData = clientData[d]; if (dayData && dayData.dayRating && dayData.dayRating !== "0") { sumDayRatings += parseInt(dayData.dayRating, 10); countRatedDays++; } }); if (countRatedDays > 0) { const avgDayRatingOverall = sumDayRatings / countRatedDays; avgDayRatingUpToDateEl.textContent = `${avgDayRatingOverall.toFixed(1)} / 5 (Avg over ${countRatedDays} days)`; const avgPercentage = Math.max(0, Math.min(100, (avgDayRatingOverall / 5) * 100)); avgRatingBarEl.style.width = avgPercentage + "%"; avgRatingBarEl.textContent = avgDayRatingOverall.toFixed(1) + "/5"; } else { avgDayRatingUpToDateEl.textContent = "No prior day ratings"; avgRatingBarEl.style.width = "0%"; avgRatingBarEl.textContent = ""; } }
function getWeekdayFromDate(dateStr) { try { const date = new Date(dateStr + 'T12:00:00Z'); const weekdays = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]; return weekdays[date.getUTCDay()]; } catch (e) { console.error("Weekday error:", dateStr, e); const fallbackDate = new Date(); const weekdays = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]; return weekdays[fallbackDate.getDay()]; } }
function escapeHtml(str) { if (typeof str !== 'string') return ""; const map = { '&': '&', '<': '<', '>': '>', '"': '"', "'": ''' }; return str.replace(/[&<>"']/g, (m) => map[m]); }

/***************************************************************
  MULTI-DAY PLANNER MODAL
****************************************************************/
function openPlannerModal() { if (!currentClient) { alert("Select client."); return; } plannerClientLabel.textContent = currentClient; plannerDays.innerHTML = ""; addPlannerDay(); plannerModal.style.display = "block"; }
function closePlannerModal() { plannerModal.style.display = "none"; }
function addPlannerDay() { const dayCount = plannerDays.querySelectorAll(".day-plan").length; const startDate = new Date(currentDate + 'T12:00:00Z'); startDate.setUTCDate(startDate.getUTCDate() + dayCount); const dateStr = startDate.toISOString().split("T")[0]; const dayDiv = document.createElement("div"); dayDiv.className = "day-plan"; dayDiv.dataset.date = dateStr; const dateLabel = document.createElement("h4"); dateLabel.textContent = `Day ${dayCount + 1}: ${formatDateForUI(dateStr)}`; dayDiv.appendChild(dateLabel); addPlannerTaskEntry(dayDiv); const addAnotherTaskBtn = document.createElement("button"); addAnotherTaskBtn.className = "btn"; addAnotherTaskBtn.textContent = "+ Task"; addAnotherTaskBtn.title = "Add another task to this day"; addAnotherTaskBtn.style.marginTop = "5px"; addAnotherTaskBtn.style.padding = '0.3em 0.8em'; addAnotherTaskBtn.addEventListener("click", () => addPlannerTaskEntry(dayDiv, addAnotherTaskBtn)); dayDiv.appendChild(addAnotherTaskBtn); plannerDays.appendChild(dayDiv); }
function addPlannerTaskEntry(dayDiv, insertBeforeElement = null) { const taskEntryDiv = document.createElement("div"); taskEntryDiv.className = "task-entry"; const controlsContainer = document.createElement('div'); controlsContainer.style.display = 'grid'; controlsContainer.style.gridTemplateColumns = 'auto auto 1fr'; controlsContainer.style.gap = 'var(--spacing-unit)'; controlsContainer.style.alignItems = 'flex-end'; const timeGroup = document.createElement('div'); const timeLabel = document.createElement("label"); timeLabel.textContent = "Time:"; timeLabel.style.marginBottom='2px'; const timeSel = document.createElement("select"); populateTempTimeDropdown(timeSel, "3:00 PM"); timeGroup.appendChild(timeLabel); timeGroup.appendChild(timeSel); controlsContainer.appendChild(timeGroup); const durGroup = document.createElement('div'); const durLabel = document.createElement("label"); durLabel.textContent = "Duration:"; durLabel.style.marginBottom='2px'; const durSel = document.createElement("select"); ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => { const opt = document.createElement("option"); opt.value = d; opt.text = d; durSel.appendChild(opt); }); durSel.value = "30 min"; durGroup.appendChild(durLabel); durGroup.appendChild(durSel); controlsContainer.appendChild(durGroup); const actGroup = document.createElement('div'); const actLabel = document.createElement("label"); actLabel.textContent = "Activity:"; actLabel.style.marginBottom='2px'; const actInput = document.createElement("input"); actInput.type = "text"; actInput.placeholder = "Task description..."; actGroup.appendChild(actLabel); actGroup.appendChild(actInput); controlsContainer.appendChild(actGroup); taskEntryDiv.appendChild(controlsContainer); if (insertBeforeElement) { dayDiv.insertBefore(taskEntryDiv, insertBeforeElement); } else { dayDiv.appendChild(taskEntryDiv); } }
function formatDateForUI(dateStr) { try { const d = new Date(dateStr + 'T12:00:00Z'); return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' }); } catch (e) { return dateStr; } }
function saveMultiDayPlan() { if (!currentClient) return; const dayPlanDivs = plannerDays.querySelectorAll(".day-plan"); let tasksAddedCount = 0; dayPlanDivs.forEach(dayDiv => { const dateStr = dayDiv.dataset.date; if (!dateStr) return; if (!allData[currentClient][dateStr]) { allData[currentClient][dateStr] = { dayRating: "0", dayNotes: "", tasks: [], weeklyDone: {} }; } const dayRecord = allData[currentClient][dateStr]; if (!dayRecord.tasks) dayRecord.tasks = []; const taskEntries = dayDiv.querySelectorAll(".task-entry"); taskEntries.forEach(entry => { const timeSelect = entry.querySelector("select:nth-of-type(1)"); const durationSelect = entry.querySelector("select:nth-of-type(2)"); const activityInput = entry.querySelector("input[type='text']"); if (timeSelect && durationSelect && activityInput) { const activity = activityInput.value.trim(); if (activity) { dayRecord.tasks.push({ id: `task_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, time: timeSelect.value, duration: durationSelect.value, activity: activity, completed: false, rating: "0" }); tasksAddedCount++; } } }); dayRecord.tasks.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); }); saveToLocalStorage(); loadClientDate(currentClient, currentDate); closePlannerModal(); alert(`Multi-day plan saved! ${tasksAddedCount} tasks added.`); }

/***************************************************************
  WEEKLY PLANNER MODAL
****************************************************************/
function openWeeklyModal() { if (!currentClient) { alert("Select client."); return; } weeklyClientLabel.textContent = currentClient; buildWeeklyContent(); weeklyModal.style.display = "block"; }
function closeWeeklyModal() { weeklyModal.style.display = "none"; }
function buildWeeklyContent() { weeklyContent.innerHTML = ""; const weekdays = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]; if (!allData[currentClient].weeklyTasks) allData[currentClient].weeklyTasks = {}; const clientWeeklyTasks = allData[currentClient].weeklyTasks; weekdays.forEach(day => { const daySectionDiv = document.createElement("div"); daySectionDiv.classList.add("weekly-day-section"); const heading = document.createElement("h4"); heading.textContent = day.charAt(0).toUpperCase() + day.slice(1); daySectionDiv.appendChild(heading); const tasksListDiv = document.createElement("div"); tasksListDiv.id = `weekly-tasks-${day}`; if (!clientWeeklyTasks[day]) clientWeeklyTasks[day] = []; const dayTasks = clientWeeklyTasks[day]; if (dayTasks.length > 0) { dayTasks.forEach(task => { const taskRow = document.createElement("div"); taskRow.classList.add('weekly-task-row'); const taskText = document.createElement("span"); taskText.textContent = `[${escapeHtml(task.time)}] ${escapeHtml(task.activity)} (${escapeHtml(task.duration)})`; taskRow.appendChild(taskText); const removeBtn = document.createElement("button"); removeBtn.textContent = "✕"; removeBtn.classList.add("btn"); removeBtn.title = "Remove weekly task"; removeBtn.style.marginLeft = "auto"; removeBtn.addEventListener("click", () => { if (confirm(`Remove weekly task "${task.activity}" for ${day}?`)) { const index = dayTasks.findIndex(t => t.id === task.id); if (index !== -1) { dayTasks.splice(index, 1); saveToLocalStorage(); buildWeeklyContent(); } } }); taskRow.appendChild(removeBtn); tasksListDiv.appendChild(taskRow); }); } else { tasksListDiv.innerHTML = `<p class="no-data">No weekly tasks for ${day}.</p>`; } daySectionDiv.appendChild(tasksListDiv); const addRow = document.createElement("div"); addRow.style.marginTop = "15px"; addRow.style.paddingTop = "10px"; addRow.style.borderTop = "1px dashed var(--border-color)"; addRow.style.display = "flex"; addRow.style.flexWrap = "wrap"; addRow.style.gap = "10px"; addRow.style.alignItems = "flex-end"; const timeSel = document.createElement("select"); populateTempTimeDropdown(timeSel, "3:00 PM"); timeSel.title = "Time"; const durSel = document.createElement("select"); ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => { const opt = document.createElement("option"); opt.value = d; opt.text = d; durSel.appendChild(opt); }); durSel.value = "30 min"; durSel.title = "Duration"; const actInput = document.createElement("input"); actInput.type = "text"; actInput.placeholder = "New weekly activity..."; actInput.style.flexGrow = "1"; actInput.style.minWidth = "200px"; const addBtn = document.createElement("button"); addBtn.textContent = "+ Add"; addBtn.classList.add("btn"); addBtn.title = `Add weekly task for ${day}`; addBtn.addEventListener("click", () => { const activity = actInput.value.trim(); if (!activity) { alert("Enter activity."); actInput.focus(); return; } const newWeeklyId = `wt_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; clientWeeklyTasks[day].push({ id: newWeeklyId, time: timeSel.value, duration: durSel.value, activity: activity }); clientWeeklyTasks[day].sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); saveToLocalStorage(); buildWeeklyContent(); }); addRow.appendChild(timeSel); addRow.appendChild(durSel); addRow.appendChild(actInput); addRow.appendChild(addBtn); daySectionDiv.appendChild(addRow); weeklyContent.appendChild(daySectionDiv); }); }
function saveWeeklySchedule() { closeWeeklyModal(); loadClientDate(currentClient, currentDate); }

/***************************************************************
  IMAGE HANDLING MODAL & GALLERY
****************************************************************/
function openImageModal() { if (!currentClient) { alert("Select client."); return; } imageClientLabel.textContent = currentClient; imageFileInput.value = ""; imagePreview.src = "#"; imagePreview.style.display = "none"; imageTitleInput.value = ""; imageModal.style.display = "block"; }
function closeImageModal() { imageModal.style.display = "none"; }
function handleFileInputChange(event) { const file = event.target.files ? event.target.files[0] : null; if (!file) return; if (!file.type.startsWith("image/")) { alert("Select image file."); imageFileInput.value = ""; return; } if (file.size > 10 * 1024 * 1024) { alert("Warning: Image > 10MB."); } const reader = new FileReader(); reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = "block"; }; reader.onerror = (e) => { console.error("FileReader error:", e); alert("Error reading file."); }; reader.readAsDataURL(file); }
function handlePasteImage(event) { if (imageModal.style.display !== 'block') return; const items = (event.clipboardData || window.clipboardData)?.items; if (!items) return; let foundImage = false; for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf("image") !== -1) { const blob = items[i].getAsFile(); if (blob) { if (blob.size > 10 * 1024 * 1024) { alert("Warning: Pasted image > 10MB."); } foundImage = true; const reader = new FileReader(); reader.onload = (evt) => { imagePreview.src = evt.target.result; imagePreview.style.display = "block"; }; reader.onerror = (e) => { console.error("Paste error:", e); alert("Error reading paste."); }; reader.readAsDataURL(blob); imageFileInput.value = ""; break; } } } }
function saveImage() { if (!imagePreview.src || imagePreview.src === window.location.href + "#" || imagePreview.style.display === 'none') { alert("No image selected."); return; } if (!currentClient || !allData[currentClient]) return; if (!allData[currentClient].images) allData[currentClient].images = []; const title = imageTitleInput.value.trim() || `Image (${formatDateForUI(currentDate)})`; const imageDataUrl = imagePreview.src; if (imageDataUrl.length > 15 * 1024 * 1024) { if (!confirm("SAVE WARNING: Large image may exceed storage limits. Save anyway?")) return; } allData[currentClient].images.push({ title: title, dataUrl: imageDataUrl }); try { saveToLocalStorage(); } catch(e) { allData[currentClient].images.pop(); return; } closeImageModal(); renderImageGallery(); }
function renderImageGallery() { imageGallery.innerHTML = ""; if (!currentClient || !allData[currentClient] || !allData[currentClient].images || allData[currentClient].images.length === 0) { imageGallery.innerHTML = '<p class="no-data text-center">(No images added)</p>'; return; } const imgs = allData[currentClient].images; const h3 = document.createElement("h3"); h3.textContent = "Image Gallery"; h3.style.marginTop = "0"; imageGallery.appendChild(h3); [...imgs].reverse().forEach((imgObj, index) => { const originalIndex = imgs.length - 1 - index; const div = document.createElement("div"); div.classList.add("gallery-item"); const thumb = document.createElement("img"); thumb.src = imgObj.dataUrl; thumb.alt = escapeHtml(imgObj.title); thumb.title = "Click to view full size"; thumb.addEventListener("click", () => { const imgWindow = window.open("", "_blank"); imgWindow.document.write(`<title>${escapeHtml(imgObj.title)}</title><style>body{margin:0; background:#333;} img{display:block; max-width:100%; max-height:100vh; margin:auto;}</style><body><img src="${imgObj.dataUrl}" alt="${escapeHtml(imgObj.title)}"></body>`); imgWindow.document.close(); }); div.appendChild(thumb); const span = document.createElement("span"); span.classList.add("title"); span.textContent = escapeHtml(imgObj.title); div.appendChild(span); const rmBtn = document.createElement("button"); rmBtn.classList.add("btn"); rmBtn.textContent = "✕"; rmBtn.title = "Remove image"; rmBtn.style.marginLeft = "auto"; rmBtn.addEventListener("click", () => { if (confirm(`Remove image "${escapeHtml(imgObj.title)}"?`)) { imgs.splice(originalIndex, 1); saveToLocalStorage(); renderImageGallery(); } }); div.appendChild(rmBtn); imageGallery.appendChild(div); }); }

</script>

</body>
</html>
