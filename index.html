    <script>
        // === START OF CORRECTED JAVASCRIPT (v5) ===

        // Wrap almost everything in DOMContentLoaded to ensure HTML exists
        document.addEventListener('DOMContentLoaded', () => {

            const STORAGE_KEY = "clientTrackerData_v5"; // Incremented key again
            let allData = {};
            let currentClient = null;
            let currentDate   = null;

            // --- DOM Elements --- (Ensure these match your HTML IDs EXACTLY)
            const clientSelect = document.getElementById("clientSelect"), addClientBtn = document.getElementById("addClientBtn"), datePicker = document.getElementById("datePicker"), clearTasksBtn = document.getElementById("clearTasksBtn"), exportBtn = document.getElementById("exportBtn"), reportBtn = document.getElementById("reportBtn"), multiDayPlanBtn = document.getElementById("multiDayPlanBtn"), weeklyPlanBtn = document.getElementById("weeklyPlanBtn"), imageBtn = document.getElementById("imageBtn"), newClientForm = document.getElementById("newClientForm"), newClientName = document.getElementById("newClientName"), saveClientBtn = document.getElementById("saveClientBtn"), cancelClientBtn = document.getElementById("cancelClientBtn"), bigGoalInput = document.getElementById("bigGoalInput"), canvasLinkInput = document.getElementById("canvasLinkInput"), classroomLinkInput = document.getElementById("classroomLinkInput"), saveClientInfoBtn = document.getElementById("saveClientInfoBtn"), bigGoalDisplay = document.getElementById("bigGoalDisplay"), canvasLinkAnchor = document.getElementById("canvasLinkAnchor"), classroomLinkAnchor = document.getElementById("classroomLinkAnchor"), timeSelect = document.getElementById("timeSelect"), durationSelect = document.getElementById("durationSelect"), activityInput = document.getElementById("activityInput"), taskSearch = document.getElementById("taskSearch"), addBtn = document.getElementById("addBtn"), taskTableBody = document.getElementById("taskTable").querySelector("tbody"), dayRatingSelect = document.getElementById("dayRatingSelect"), dayNotesTextarea = document.getElementById("dayNotes"), imageGallery = document.getElementById("imageGallery"), completionRateEl = document.getElementById("completionRate"), completionBarEl = document.getElementById("completionBar"), averageTaskRatingEl = document.getElementById("averageTaskRating"), displayDayRatingEl = document.getElementById("displayDayRating"), avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate"), avgRatingBarEl = document.getElementById("avgRatingBar"), plannerModal = document.getElementById("plannerModal"), plannerClientLabel = document.getElementById("plannerClientLabel"), plannerDays = document.getElementById("plannerDays"), addDayBtn = document.getElementById("addDayBtn"), savePlanBtn = document.getElementById("savePlanBtn"), cancelPlanBtn = document.getElementById("cancelPlanBtn"), weeklyModal = document.getElementById("weeklyModal"), weeklyClientLabel = document.getElementById("weeklyClientLabel"), weeklyContent = document.getElementById("weeklyContent"), saveWeeklyBtn = document.getElementById("saveWeeklyBtn"), cancelWeeklyBtn = document.getElementById("cancelWeeklyBtn"), imageModal = document.getElementById("imageModal"), imageClientLabel = document.getElementById("imageClientLabel"), imageFileInput = document.getElementById("imageFileInput"), imagePreview = document.getElementById("imagePreview"), imageTitleInput = document.getElementById("imageTitle"), saveImageBtn = document.getElementById("saveImageBtn"), cancelImageBtn = document.getElementById("cancelImageBtn");
            const editIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em"> <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /> <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /> </svg>`;
            const deleteIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em"> <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /> </svg>`;

            // --- Initialization Code --- (Moved inside DOMContentLoaded)
            function initializeApp() {
                console.log("Initializing App..."); // Debug log
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        allData = JSON.parse(stored);
                        if (typeof allData !== 'object' || allData === null) {
                            console.warn("Invalid data, resetting."); allData = {};
                        }
                    } else {
                        allData = {};
                    }
                } catch (error) {
                    console.error("Load error:", error); alert("Could not load data."); allData = {};
                }
                populateClientSelect();
                const todayStr = new Date().toISOString().split("T")[0];
                datePicker.value = todayStr; currentDate = todayStr;
                const clientNames = Object.keys(allData).sort();
                if (clientNames.length > 0) {
                    currentClient = clientNames[0]; clientSelect.value = currentClient;
                    loadClientDate(currentClient, currentDate);
                } else {
                    currentClient = null;
                    bigGoalDisplay.textContent = "(Add client)";
                    taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(Add client/date)</td></tr>';
                    imageGallery.innerHTML = '<p class="no-data text-center">(No images)</p>';
                    // Disable buttons if no client initially
                    disableClientSpecificButtons(true);
                }
                populateTimeDropdown();
                setupEventListeners();
                console.log("App Initialized."); // Debug log
            }

            // --- Event Listeners Setup ---
            function setupEventListeners() {
                 console.log("Setting up Event Listeners..."); // Debug log
                // Ensure elements exist before adding listeners
                if (clientSelect) clientSelect.addEventListener("change", onClientOrDateChange); else console.error("clientSelect not found");
                if (datePicker) datePicker.addEventListener("change", onClientOrDateChange); else console.error("datePicker not found");
                if (addClientBtn) addClientBtn.addEventListener("click", showNewClientForm); else console.error("addClientBtn not found");
                if (saveClientBtn) saveClientBtn.addEventListener("click", saveNewClient); else console.error("saveClientBtn not found");
                if (cancelClientBtn) cancelClientBtn.addEventListener("click", hideNewClientForm); else console.error("cancelClientBtn not found");
                if (saveClientInfoBtn) saveClientInfoBtn.addEventListener("click", saveClientInfo); else console.error("saveClientInfoBtn not found");
                if (addBtn) addBtn.addEventListener("click", addNewTask); else console.error("addBtn not found");
                if (clearTasksBtn) clearTasksBtn.addEventListener("click", clearTasksForClientDate); else console.error("clearTasksBtn not found");
                if (exportBtn) exportBtn.addEventListener("click", exportData); else console.error("exportBtn not found");
                if (reportBtn) reportBtn.addEventListener("click", generateReport); else console.error("reportBtn not found");
                if (dayRatingSelect) dayRatingSelect.addEventListener("change", onDayRatingChange); else console.error("dayRatingSelect not found");
                if (dayNotesTextarea) dayNotesTextarea.addEventListener("input", onDayNotesChange); else console.error("dayNotesTextarea not found");
                if (multiDayPlanBtn) multiDayPlanBtn.addEventListener("click", openPlannerModal); else console.error("multiDayPlanBtn not found");
                if (addDayBtn) addDayBtn.addEventListener("click", addPlannerDay); else console.error("addDayBtn not found");
                if (savePlanBtn) savePlanBtn.addEventListener("click", saveMultiDayPlan); else console.error("savePlanBtn not found");
                if (cancelPlanBtn) cancelPlanBtn.addEventListener("click", closePlannerModal); else console.error("cancelPlanBtn not found");
                if (weeklyPlanBtn) weeklyPlanBtn.addEventListener("click", openWeeklyModal); else console.error("weeklyPlanBtn not found");
                if (saveWeeklyBtn) saveWeeklyBtn.addEventListener("click", saveWeeklySchedule); else console.error("saveWeeklyBtn not found");
                if (cancelWeeklyBtn) cancelWeeklyBtn.addEventListener("click", closeWeeklyModal); else console.error("cancelWeeklyBtn not found");
                if (imageBtn) imageBtn.addEventListener("click", openImageModal); else console.error("imageBtn not found");
                if (cancelImageBtn) cancelImageBtn.addEventListener("click", closeImageModal); else console.error("cancelImageBtn not found");
                if (saveImageBtn) saveImageBtn.addEventListener("click", saveImage); else console.error("saveImageBtn not found");
                if (imageModal) imageModal.addEventListener("paste", handlePasteImage); else console.error("imageModal not found");
                if (imageFileInput) imageFileInput.addEventListener("change", handleFileInputChange); else console.error("imageFileInput not found");
                if (taskSearch) taskSearch.addEventListener("input", filterTaskTable); else console.error("taskSearch not found");

                document.addEventListener("keydown", handleKeyboardShortcuts);
                console.log("Event Listeners Setup Complete."); // Debug log
            }

             // --- All other functions (populateClientSelect, loadClientDate, etc.) go here ---
             // (Copy the FULL, correctly formatted functions from the previous step inside this DOMContentLoaded wrapper)

            // --- Client Management ---
            function populateClientSelect(){clientSelect.innerHTML="";const cN=Object.keys(allData).sort();const hC=cN.length>0;clientSelect.disabled=!hC;disableClientSpecificButtons(!hC); if(!hC){const o=document.createElement("option");o.textContent="-- No Clients --";o.value="";clientSelect.appendChild(o);}else{cN.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;clientSelect.appendChild(o);});}}
            function disableClientSpecificButtons(isDisabled) { multiDayPlanBtn.disabled = isDisabled; weeklyPlanBtn.disabled = isDisabled; imageBtn.disabled = isDisabled; reportBtn.disabled = isDisabled; clearTasksBtn.disabled = isDisabled; saveClientInfoBtn.disabled = isDisabled; }
            function showNewClientForm(){newClientForm.style.display="flex";newClientName.value="";newClientName.focus();}
            function hideNewClientForm(){newClientForm.style.display="none";}
            function saveNewClient(){const n=newClientName.value.trim();if(!n){alert("Enter name.");return;}if(allData[n]){alert(`Client "${n}" exists.`);return;}allData[n]={bigGoal:"",links:{canvas:"",classroom:""},weeklyTasks:{monday:[],tuesday:[],wednesday:[],thursday:[],friday:[],saturday:[],sunday:[]},images:[]};saveToLocalStorage();populateClientSelect();clientSelect.value=n;currentClient=n;currentDate=datePicker.value;loadClientDate(currentClient,currentDate);hideNewClientForm();}
            function saveClientInfo(){if(!currentClient){alert("Select client.");return;}const cD=allData[currentClient];if(!cD)return;cD.bigGoal=bigGoalInput.value.trim();if(!cD.links)cD.links={};cD.links.canvas=canvasLinkInput.value.trim();cD.links.classroom=classroomLinkInput.value.trim();saveToLocalStorage();renderClientInfo();const btn=saveClientInfoBtn;const oT=btn.textContent;btn.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em" style="margin-right: 0.4em;"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg> Saved!`;btn.style.backgroundColor='#10B981';btn.disabled=true;setTimeout(()=>{btn.innerHTML=oT;btn.style.backgroundColor='';btn.disabled=false;},1500);}
            function renderClientInfo(){if(!currentClient||!allData[currentClient]){bigGoalDisplay.textContent="(Select client)";bigGoalInput.value="";canvasLinkInput.value="";classroomLinkInput.value="";canvasLinkAnchor.style.display="none";classroomLinkAnchor.style.display="none";return;}const cD=allData[currentClient];bigGoalDisplay.textContent=cD.bigGoal||"(No Goal Set)";bigGoalInput.value=cD.bigGoal||"";const l=cD.links||{};canvasLinkAnchor.style.display=(l.canvas&&l.canvas.startsWith('http'))?"inline-flex":"none";if(l.canvas)canvasLinkAnchor.href=l.canvas;canvasLinkInput.value=l.canvas||"";classroomLinkAnchor.style.display=(l.classroom&&l.classroom.startsWith('http'))?"inline-flex":"none";if(l.classroom)classroomLinkAnchor.href=l.classroom;classroomLinkInput.value=l.classroom||"";}

            // --- Core Data Loading & Display ---
            function onClientOrDateChange(){currentClient=clientSelect.value;currentDate=datePicker.value;if(currentClient&¤tDate){loadClientDate(currentClient,currentDate);}else{taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(Select client/date)</td></tr>';renderClientInfo();resetReflectionFields();resetProgressDashboard();imageGallery.innerHTML='<p class="no-data text-center">(No images)</p>';disableClientSpecificButtons(true);}}
            function loadClientDate(cN,dS){if(!cN||!dS)return;if(!allData[cN]){allData[cN]={bigGoal:"",links:{},weeklyTasks:{},images:[]};}if(!allData[cN][dS]){allData[cN][dS]={dayRating:"0",dayNotes:"",tasks:[],weeklyDone:{}};}const cD=allData[cN];const dR=cD[dS];renderClientInfo();dayRatingSelect.value=dR.dayRating||"0";dayNotesTextarea.value=dR.dayNotes||"";renderTaskTable(cD,dR,dS);renderImageGallery();updateProgress();taskSearch.value="";filterTaskTable();disableClientSpecificButtons(false);} // Enable buttons on load
            function renderTaskTable(cD,dR,dS){taskTableBody.innerHTML="";const dT=dR.tasks||[];const wd=getWeekdayFromDate(dS);const wL=(cD.weeklyTasks&&cD.weeklyTasks[wd])?cD.weeklyTasks[wd]:[];const wDM=dR.weeklyDone||{};const allT=[];dT.forEach(t=>allT.push({...t,taskType:'daily'}));wL.forEach(wT=>allT.push({...wT,completed:!!wDM[wT.id],rating:"0",taskType:'weekly'}));allT.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));if(allT.length===0){taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(No tasks scheduled)</td></tr>';}else{allT.forEach(t=>addTaskRow(t,t.taskType));}}
            function resetReflectionFields(){dayRatingSelect.value="0";dayNotesTextarea.value="";}
            function resetProgressDashboard(){completionRateEl.textContent="-";completionBarEl.style.width="0%";averageTaskRatingEl.textContent="-";displayDayRatingEl.textContent="-";avgDayRatingUpToDateEl.textContent="-";avgRatingBarEl.style.width="0%";}

            // --- Reflection ---
            function onDayRatingChange(){if(!currentClient||!currentDate)return;const r=getDayRecord();if(!r)return;r.dayRating=dayRatingSelect.value;saveToLocalStorage();updateProgress();}
            const debounce=(func,wait)=>{let timeout;return(...args)=>{clearTimeout(timeout);timeout=setTimeout(()=>func.apply(this,args),wait);};};
            const debouncedSaveNotes=debounce(()=>{if(!currentClient||!currentDate)return;const r=getDayRecord();if(!r)return;r.dayNotes=dayNotesTextarea.value;saveToLocalStorage();},500);
            function onDayNotesChange(){debouncedSaveNotes();}
            function getDayRecord(){if(!currentClient||!currentDate||!allData[currentClient])return null;if(!allData[currentClient][currentDate]){allData[currentClient][currentDate]={dayRating:"0",dayNotes:"",tasks:[],weeklyDone:{}};}return allData[currentClient][currentDate];}

            // --- Time Dropdown ---
            function populateTimeDropdown(){timeSelect.innerHTML="";for(let h=5;h<24;h++){for(let m=0;m<60;m+=15){const d=new Date();d.setHours(h,m);const l=d.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true});const o=document.createElement("option");o.value=l;o.textContent=l;timeSelect.appendChild(o);}}const s=document.createElement("option");s.disabled=true;s.textContent="──────────";timeSelect.appendChild(s);const cT=["Before School","Study Hall","Lunch","After School","Before Dinner","After Dinner","Before Bed"];cT.forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t;timeSelect.appendChild(o);});const dF="3:00 PM";if(Array.from(timeSelect.options).some(o=>o.value===dF))timeSelect.value=dF;}

            // --- Task Management ---
            function addNewTask(){if(!currentClient||!currentDate){alert("Select client/date.");return;}const t=timeSelect.value;const a=activityInput.value.trim();const d=durationSelect.value;if(!a){alert("Enter activity.");activityInput.focus();return;}const rec=getDayRecord();if(!rec)return;if(!rec.tasks)rec.tasks=[];const nT={id:`task_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,time:t,activity:a,completed:false,rating:"0",duration:d};rec.tasks.push(nT);saveToLocalStorage();renderTaskTable(allData[currentClient],rec,currentDate);activityInput.value="";activityInput.focus();updateProgress();}
            function addTaskRow(tO,tT){const r=taskTableBody.insertRow();r.className="task-row";r.dataset.taskId=tO.id;r.dataset.taskType=tT;r.dataset.timeValue=convertTimeToMinutes(tO.time);if(tO.completed)r.classList.add("completed-task");const tD=r.insertCell(0);tD.innerHTML=escapeHtml(tO.time);if(tO.duration)tD.innerHTML+=`<br><span style="font-size:0.8em;color:#6B7280;">${escapeHtml(tO.duration)}</span>`;if(tT==='weekly')tD.innerHTML+=`<span class="weekly-indicator">(Weekly)</span>`;const tA=r.insertCell(1);tA.textContent=tO.activity;const tDn=r.insertCell(2);const cK=document.createElement("input");cK.type="checkbox";cK.checked=tO.completed;cK.title="Mark done/undone";cK.className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500";cK.addEventListener("change",()=>{r.classList.toggle("completed-task",cK.checked);if(tT==='daily'){const dR=getDayRecord();const t=dR?.tasks?.find(t=>t.id===tO.id);if(t)t.completed=cK.checked;}else if(tT==='weekly'){const dR=getDayRecord();if(!dR.weeklyDone)dR.weeklyDone={};dR.weeklyDone[tO.id]=cK.checked;}saveToLocalStorage();updateProgress();});tDn.appendChild(cK);const tR=r.insertCell(3);if(tT==='daily'){const sL=document.createElement("select");sL.title="Rate task (1-5)";for(let i=0;i<=5;i++){const o=document.createElement("option");o.value=i;o.text=i===0?"–":i.toString();sL.appendChild(o);}sL.value=tO.rating||"0";sL.addEventListener("change",()=>{const dR=getDayRecord();const t=dR?.tasks?.find(t=>t.id===tO.id);if(t)t.rating=sL.value;saveToLocalStorage();updateProgress();});tR.appendChild(sL);}else{tR.innerHTML=`<span class="no-data">–</span>`;}const tAc=r.insertCell(4);tAc.style.textAlign='right';if(tT==='daily'){const eB=document.createElement("button");eB.innerHTML=editIconSVG;eB.className="btn btn-icon";eB.title="Edit task";eB.addEventListener("click",(e)=>{e.stopPropagation();makeTaskEditable(r,tO);});tAc.appendChild(eB);const rB=document.createElement("button");rB.innerHTML=deleteIconSVG;rB.className="btn btn-icon btn-icon-delete";rB.title="Delete task";rB.addEventListener("click",(e)=>{e.stopPropagation();if(confirm(`Delete task: "${tO.activity}"?`)){removeTask(tO);r.remove();updateProgress();if(taskTableBody.querySelectorAll('tr.task-row').length===0){taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(No tasks)</td></tr>';}}});tAc.appendChild(rB);}}
            function makeTaskEditable(row,taskObj){const cE=taskTableBody.querySelector('.editing-task-row');if(cE&&cE!==row){const oCB=cE.querySelector('.btn-cancel-edit');if(oCB)oCB.click();}row.classList.add('editing-task-row');const tdTime=row.cells[0];const tdAct=row.cells[1];const tdRating=row.cells[3];const tdActions=row.cells[4];const oTHTML=tdTime.innerHTML;const oAHTML=tdAct.innerHTML;const oRHTML=tdRating.innerHTML;const oAcHTML=tdActions.innerHTML;tdTime.innerHTML="";const tDC=document.createElement('div');tDC.style.display='flex';tDC.style.flexDirection='column';tDC.style.gap='4px';const nTS=document.createElement("select");nTS.style.marginBottom='0';populateTempTimeDropdown(nTS,taskObj.time);tDC.appendChild(nTS);const nDS=document.createElement("select");nDS.style.marginBottom='0';["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{const o=document.createElement("option");o.value=d;o.text=d;nDS.appendChild(o);});nDS.value=taskObj.duration||"30 min";tDC.appendChild(nDS);tdTime.appendChild(tDC);tdAct.innerHTML="";const aI=document.createElement("input");aI.type="text";aI.value=taskObj.activity;aI.style.width="100%";aI.style.marginBottom='0';tdAct.appendChild(aI);aI.focus();aI.select();tdRating.innerHTML="";tdActions.innerHTML="";const sB=document.createElement("button");sB.textContent="Save";sB.className="btn btn-primary";sB.style.fontSize='0.85em';sB.style.padding='0.3em 0.6em';sB.addEventListener("click",(e)=>{e.stopPropagation();const nT=nTS.value;const nA=aI.value.trim();const nD=nDS.value;if(!nA){alert("Activity empty.");aI.focus();return;}const dR=getDayRecord();const tI=dR?.tasks?.findIndex(t=>t.id===taskObj.id);if(tI!==undefined&&tI>-1){dR.tasks[tI].time=nT;dR.tasks[tI].activity=nA;dR.tasks[tI].duration=nD;saveToLocalStorage();taskObj.time=nT;taskObj.activity=nA;taskObj.duration=nD;renderTaskTable(allData[currentClient],dR,currentDate);updateProgress();}else{console.error("Failed find task:",taskObj.id);renderTaskTable(allData[currentClient],getDayRecord(),currentDate);}});tAc.appendChild(sB);const cB=document.createElement("button");cB.textContent="Cancel";cB.className="btn btn-secondary btn-cancel-edit";cB.style.fontSize='0.85em';cB.style.padding='0.3em 0.6em';cB.addEventListener("click",(e)=>{e.stopPropagation();row.classList.remove('editing-task-row');tdTime.innerHTML=oTHTML;tdAct.innerHTML=oAHTML;tR.innerHTML=oRHTML;tAc.innerHTML=oAcHTML;const rEB=tAc.querySelector('.btn-icon:not(.btn-icon-delete)');const rDB=tAc.querySelector('.btn-icon-delete');if(rEB)rEB.addEventListener("click",(ev)=>{ev.stopPropagation();makeTaskEditable(row,taskObj);});if(rDB)rDB.addEventListener("click",(ev)=>{ev.stopPropagation();if(confirm(`Delete task: "${taskObj.activity}"?`)){removeTask(taskObj);row.remove();updateProgress();if(taskTableBody.querySelectorAll('tr.task-row').length===0){taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(No tasks)</td></tr>';}}});});tAc.appendChild(cB);}
            function populateTempTimeDropdown(sel,cur){const mO=timeSelect.options;for(let i=0;i<mO.length;i++){const c=mO[i].cloneNode(true);sel.appendChild(c);}if(Array.from(sel.options).some(o=>o.value===cur)){sel.value=cur;}}
            function sortTasksByTimeInData(){if(!currentClient||!currentDate)return;const r=getDayRecord();if(!r||!r.tasks||r.tasks.length<2)return;r.tasks.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));saveToLocalStorage();}
            function sortTasksByTime(){sortTasksByTimeInData();if(currentClient&¤tDate){const dR=getDayRecord();renderTaskTable(allData[currentClient],dR,currentDate);}}
            function convertTimeToMinutes(tS){if(!tS)return 9999;const sT={"Before School":360,"Study Hall":600,"Lunch":720,"After School":930,"Before Dinner":1080,"After Dinner":1200,"Before Bed":1320};if(sT[tS]!==undefined)return sT[tS];const m=tS.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);if(m){let h=parseInt(m[1],10);const mn=parseInt(m[2],10);const ampm=m[3].toUpperCase();if(isNaN(h)||isNaN(mn))return 9999;if(ampm==="PM"&&h<12)h+=12;if(ampm==="AM"&&h===12)h=0;return h*60+mn;}return 9999;}
            function removeTask(tO){const r=getDayRecord();if(!r||!r.tasks)return;const i=r.tasks.findIndex(t=>t.id===tO.id);if(i!==-1){r.tasks.splice(i,1);saveToLocalStorage();}else{console.warn("Task not found:",tO.id);}}
            function clearTasksForClientDate(){if(!currentClient||!currentDate){alert("Select client/date.");return;}if(confirm(`DELETE ALL daily tasks for ${currentClient} on ${currentDate}? This cannot be undone.`)){const r=getDayRecord();if(r){r.tasks=[];saveToLocalStorage();renderTaskTable(allData[currentClient],r,currentDate);updateProgress();}}}
            function filterTaskTable(){const s=taskSearch.value.toLowerCase().trim();const rows=taskTableBody.querySelectorAll("tr.task-row");let match=false;rows.forEach(r=>{const aT=r.cells[1]?.textContent.toLowerCase()||"";const tT=r.cells[0]?.textContent.toLowerCase()||"";const v=aT.includes(s)||tT.includes(s);r.style.display=v?"":"none";if(v)match=true;});let nR=taskTableBody.querySelector('.no-match-row');if(!match&&s!==''&&rows.length>0){if(!nR){nR=taskTableBody.insertRow();nR.className='no-match-row';const c=nR.insertCell(0);c.colSpan=5;c.textContent="No tasks match search.";c.className='text-center no-data';}}else{if(nR)nR.remove();}}

            // --- Export & Report ---
            function exportData(){if(Object.keys(allData).length===0){alert("No data.");return;}try{const dS=JSON.stringify(allData,null,2);const dB=new Blob([dS],{type:"application/json;charset=utf-8"});const fN=`client-tracker-export-${new Date().toISOString().split('T')[0]}.json`;if(window.navigator&&window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(dB,fN);}else{const dU=URL.createObjectURL(dB);const l=document.createElement("a");l.href=dU;l.download=fN;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(dU);}}catch(e){console.error("Export error:",e);alert("Error exporting.");}}
            function generateReport(){if(!currentClient||!allData[currentClient]){alert("Select client.");return;}const cD=allData[currentClient];let rH=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Report - ${escapeHtml(currentClient)}</title><style>body{font-family:'Inter',sans-serif;margin:20px;line-height:1.6;color:#1F2937;}.report-container{max-width:800px;margin:0 auto;}h1,h2,h3{border-bottom:1px solid #E5E7EB;padding-bottom:0.3em;margin-top:1.5em;font-weight:600;}h1{font-size:1.8em;color:#1D4ED8;border-bottom-width:2px;}h2{font-size:1.4em;margin-top:2em;}h3{font-size:1.1em;color:#4B5563;margin-top:1.5em;border-bottom-style:dashed;}table{width:100%;border-collapse:collapse;margin:0.5em 0 1.5em;font-size:0.9em;border:1px solid #E5E7EB;border-radius:0.375rem;overflow:hidden;}th{background-color:#F9FAFB;text-align:left;padding:10px;font-weight:500;text-transform:uppercase;font-size:0.8em;letter-spacing:0.05em;}td{padding:10px;vertical-align:top;border-top:1px solid #F3F4F6;}tbody tr:nth-child(even){background-color:#F9FAFB;}.notes-box{background-color:#F9FAFB;border:1px solid #E5E7EB;padding:10px;margin:10px 0;white-space:pre-wrap;border-radius:0.375rem;font-size:0.95em;}.gallery-item{margin-bottom:15px;border-bottom:1px solid #F3F4F6;padding-bottom:10px;}.gallery-img{max-width:250px;max-height:200px;margin-top:5px;border:1px solid #E5E7EB;display:block;border-radius:0.375rem;}.completed td:not(:last-child){text-decoration:line-through;color:#9CA3AF;opacity:0.8;}.weekly-task-indicator{font-size:0.8em;color:#60A5FA;font-style:italic;display:block;}.rating-value{font-weight:bold;color:#2563EB;}.no-data{color:#6B7280;font-style:italic;}ul{padding-left:20px;margin-top:0.5em;}li{margin-bottom:0.3em;}a{color:#2563EB;text-decoration:none;}a:hover{text-decoration:underline;}</style></head><body><div class="report-container"><h1>Client Report: ${escapeHtml(currentClient)}</h1><p><em>Generated: ${new Date().toLocaleString()}</em></p><h2>Client Info</h2><p><strong>Big Goal:</strong> ${escapeHtml(cD.bigGoal||"(Not Set)")}</p>`;const l=cD.links||{};if(l.canvas||l.classroom){rH+=`<p><strong>Links:</strong> `;if(l.canvas)rH+=`<a href="${escapeHtml(l.canvas)}" target="_blank">Canvas</a> `;if(l.classroom)rH+=` <a href="${escapeHtml(l.classroom)}" target="_blank">Classroom</a>`;rH+=`</p>`;}else{rH+=`<p class="no-data">No links saved.</p>`;}const wT=cD.weeklyTasks||{};let hWT=false;let wH=`<h2>Weekly Tasks</h2>`;Object.keys(wT).sort((a,b)=>["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(a)-["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(b)).forEach(d=>{const dT=wT[d]||[];if(dT.length>0){hWT=true;wH+=`<h3>${escapeHtml(d.charAt(0).toUpperCase()+d.slice(1))}</h3><ul>`;dT.forEach(t=>{wH+=`<li>[${escapeHtml(t.time)}] ${escapeHtml(t.activity)} ${t.duration?'('+escapeHtml(t.duration)+')':''}</li>`;});wH+=`</ul>`;}});if(hWT)rH+=wH;else rH+=`<h2>Weekly Tasks</h2><p class="no-data">No weekly tasks set.</p>`;const imgs=cD.images||[];if(imgs.length>0){rH+=`<h2>Images</h2>`;imgs.forEach(i=>{rH+=`<div class="gallery-item"><strong>${escapeHtml(i.title||"(Untitled)")}</strong><br/><a href="${i.dataUrl}" target="_blank"><img src="${i.dataUrl}" alt="${escapeHtml(i.title)}" class="gallery-img"/></a></div>`;});}else{rH+=`<h2>Images</h2><p class="no-data">No images saved.</p>`;}rH+=`<h2>Daily Records</h2>`;const dK=Object.keys(cD).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();if(dK.length===0){rH+=`<p class="no-data">No daily records.</p>`;}else{dK.forEach(d=>{const r=cD[d];if(!r)return;const fD=formatDateForReport(d);const dR=(r.dayRating&&r.dayRating!=="0")?`<span class="rating-value">${r.dayRating}/5</span>`:"--";rH+=`<h3>${fD}  |  Day Rating: ${dR}</h3>`;if(r.dayNotes&&r.dayNotes.trim()!==""){rH+=`<div class="notes-box"><strong>Notes:</strong><br/>${escapeHtml(r.dayNotes).replace(/\n/g,"<br/>")}</div>`;}else{rH+=`<p class="no-data">No notes.</p>`;}const dT=r.tasks||[];const wd=getWeekdayFromDate(d);const wL=(cD.weeklyTasks&&cD.weeklyTasks[wd])?cD.weeklyTasks[wd]:[];const wDM=r.weeklyDone||{};const mT=[];dT.forEach(t=>mT.push({...t,_type:'daily'}));wL.forEach(wt=>mT.push({...wt,completed:!!wDM[wt.id],rating:"0",_type:'weekly'}));mT.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));if(mT.length===0){rH+=`<p class="no-data">No tasks.</p>`;}else{rH+=`<table><thead><tr><th>Time</th><th>Activity</th><th>Duration</th><th>Done?</th><th>Rating</th></tr></thead><tbody>`;let cC=0;mT.forEach(t=>{if(t.completed)cC++;const iCC=t.completed?'class="completed"':'';const rS=(t._type==="daily"&&t.rating!=="0")?`<span class="rating-value">${t.rating}/5</span>`:(t._type==="daily"?"--":"<span class='no-data'>(N/A)</span>");const wI=t._type==='weekly'?`<span class="weekly-task-indicator">(Weekly)</span>`:'';rH+=`<tr ${iCC}><td>${escapeHtml(t.time)}${wI}</td><td>${escapeHtml(t.activity)}</td><td>${escapeHtml(t.duration||'--')}</td><td>${t.completed?'Yes':'No'}</td><td>${rS}</td></tr>`;});rH+=`</tbody></table><p><strong>Completion:</strong> ${cC}/${mT.length} tasks</p>`;}});rH+=`<hr style="margin-top:2em;border-color:#E5E7EB;"><p style="text-align:center;font-size:0.8em;color:#6B7280;">End Report</p></div></body></html>`;const rW=window.open("","_blank");if(rW){rW.document.open();rW.document.write(rH);rW.document.close();}else{alert("Could not open report.");}}
            function formatDateForReport(dS){try{const d=new Date(dS+'T12:00:00Z');return d.toLocaleDateString(undefined,{weekday:'short',year:'numeric',month:'long',day:'numeric'});}catch(e){return dS;}}

            // --- LocalStorage & Utilities ---
            function saveToLocalStorage(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(allData));}catch(e){if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){alert("Error: Storage limit!\nExport/clear data.");}else{alert("Error saving data.");}throw e;}}
            function updateProgress(){if(!currentClient||!currentDate){resetProgressDashboard();return;}const r=getDayRecord();if(!r){resetProgressDashboard();return;}const cD=allData[currentClient];const dT=r.tasks||[];const wd=getWeekdayFromDate(currentDate);const wL=(cD.weeklyTasks&&cD.weeklyTasks[wd])?cD.weeklyTasks[wd]:[];const wDM=r.weeklyDone||{};const dDC=dT.filter(t=>t.completed).length;const wDC=wL.filter(wt=>wDM[wt.id]).length;const tD=dDC+wDC;const tT=dT.length+wL.length;if(tT===0){completionRateEl.textContent="-";completionBarEl.style.width="0%";}else{const p=Math.round((tD/tT)*100);completionRateEl.textContent=`${p}% (${tD}/${tT})`;completionBarEl.style.width=`${p}%`;}const rDT=dT.filter(t=>t.rating&&parseInt(t.rating,10)>0);if(rDT.length>0){const sR=rDT.reduce((a,t)=>a+parseInt(t.rating,10),0);const aR=(sR/rDT.length);averageTaskRatingEl.textContent=`${aR.toFixed(1)}/5 (${rDT.length})`;}else{averageTaskRatingEl.textContent="-";}const dR=r.dayRating||"0";displayDayRatingEl.textContent=(dR!=="0")?`${dR}/5`:"--";const allD=Object.keys(cD).filter(d=>/^\d{4}-\d{2}-\d{2}$/.test(d)&&d<=currentDate).sort();let sDR=0;let cRD=0;allD.forEach(d=>{const dD=cD[d];if(dD&&dD.dayRating&&dD.dayRating!=="0"){sDR+=parseInt(dD.dayRating,10);cRD++;}});if(cRD>0){const aDRO=sDR/cRD;avgDayRatingUpToDateEl.textContent=`${aDRO.toFixed(1)}/5 (${cRD})`;const aP=Math.max(0,Math.min(100,(aDRO/5)*100));avgRatingBarEl.style.width=aP+"%";}else{avgDayRatingUpToDateEl.textContent="-";avgRatingBarEl.style.width="0%";}}
            function getWeekdayFromDate(dS){try{const d=new Date(dS+'T12:00:00Z');const wd=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];return wd[d.getUTCDay()];}catch(e){return"";}}
            function escapeHtml(str){if(typeof str!=='string')return"";const map={'&':'&','<':'<','>':'>','"':'"',"'":'''};return str.replace(/[&<>"']/g,(m)=>map[m]);}

            // --- Multi-Day Planner ---
            function openPlannerModal(){if(!currentClient){alert("Select client.");return;}plannerClientLabel.textContent=currentClient;plannerDays.innerHTML="";addPlannerDay();plannerModal.style.display="block";}
            function closePlannerModal(){plannerModal.style.display="none";}
            function addPlannerDay(){const dC=plannerDays.querySelectorAll(".day-plan").length;const sD=new Date(currentDate+'T12:00:00Z');sD.setUTCDate(sD.getUTCDate()+dC);const dS=sD.toISOString().split("T")[0];const dDiv=document.createElement("div");dDiv.className="day-plan";dDiv.dataset.date=dS;const dLbl=document.createElement("h4");dLbl.textContent=`Day ${dC+1}: ${formatDateForUI(dS)}`;dDiv.appendChild(dLbl);addPlannerTaskEntry(dDiv);const addTBtn=document.createElement("button");addTBtn.className="btn btn-secondary";addTBtn.textContent="+ Task";addTBtn.title="Add task";addTBtn.style.marginTop="0.5rem";addTBtn.style.padding='0.3em 0.8em';addTBtn.addEventListener("click",()=>addPlannerTaskEntry(dDiv,addTBtn));dDiv.appendChild(addTBtn);plannerDays.appendChild(dDiv);}
            function addPlannerTaskEntry(dDiv,iB=null){const tE=document.createElement("div");tE.className="task-entry";const cC=document.createElement('div');cC.className='controls-container';const tG=document.createElement('div');const tL=document.createElement("label");tL.textContent="Time:";tL.style.marginBottom='2px';const tS=document.createElement("select");populateTempTimeDropdown(tS,"3:00 PM");tG.append(tL,tS);cC.appendChild(tG);const dG=document.createElement('div');const dL=document.createElement("label");dL.textContent="Duration:";dL.style.marginBottom='2px';const dS=document.createElement("select");["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{const o=document.createElement("option");o.value=d;o.text=d;dS.appendChild(o);});dS.value="30 min";dG.append(dL,dS);cC.appendChild(dG);const aG=document.createElement('div');const aL=document.createElement("label");aL.textContent="Activity:";aL.style.marginBottom='2px';const aI=document.createElement("input");aI.type="text";aI.placeholder="Task...";aG.append(aL,aI);cC.appendChild(aG);tE.appendChild(cC);if(iB){dDiv.insertBefore(tE,iB);}else{dDiv.appendChild(tE);}}
            function formatDateForUI(dS){try{const d=new Date(dS+'T12:00:00Z');return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});}catch(e){return dS;}}
            function saveMultiDayPlan(){if(!currentClient)return;const dP=plannerDays.querySelectorAll(".day-plan");let tAC=0;dP.forEach(dD=>{const dS=dD.dataset.date;if(!dS)return;if(!allData[currentClient][dS]){allData[currentClient][dS]={dayRating:"0",dayNotes:"",tasks:[],weeklyDone:{}};}const dR=allData[currentClient][dS];if(!dR.tasks)dR.tasks=[];const tE=dD.querySelectorAll(".task-entry");tE.forEach(e=>{const tS=e.querySelector("select:nth-of-type(1)");const dS_sel=e.querySelector("select:nth-of-type(2)");const aI=e.querySelector("input[type='text']");if(tS&&dS_sel&&aI){const a=aI.value.trim();if(a){dR.tasks.push({id:`task_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,time:tS.value,duration:dS_sel.value,activity:a,completed:false,rating:"0"});tAC++;}}});dR.tasks.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));});saveToLocalStorage();loadClientDate(currentClient,currentDate);closePlannerModal();alert(`${tAC} tasks added.`);}

            // --- Weekly Planner ---
            function openWeeklyModal(){if(!currentClient){alert("Select client.");return;}weeklyClientLabel.textContent=currentClient;buildWeeklyContent();weeklyModal.style.display="block";}
            function closeWeeklyModal(){weeklyModal.style.display="none";}
            function buildWeeklyContent(){weeklyContent.innerHTML="";const wd=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];if(!allData[currentClient].weeklyTasks)allData[currentClient].weeklyTasks={};const cWT=allData[currentClient].weeklyTasks;wd.forEach(day=>{const dS=document.createElement("div");dS.className="weekly-day-section";const h=document.createElement("h4");h.textContent=day.charAt(0).toUpperCase()+day.slice(1);dS.appendChild(h);const tL=document.createElement("div");tL.id=`weekly-tasks-${day}`;if(!cWT[day])cWT[day]=[];const dT=cWT[day];if(dT.length>0){dT.forEach(task=>{const tR=document.createElement("div");tR.className='weekly-task-row';const tT=document.createElement("span");tT.textContent=`[${escapeHtml(task.time)}] ${escapeHtml(task.activity)} (${escapeHtml(task.duration)})`;tR.appendChild(tT);const rB=document.createElement("button");rB.innerHTML=deleteIconSVG;rB.className="btn btn-icon btn-icon-delete";rB.title="Remove";rB.style.marginLeft="auto";rB.addEventListener("click",()=>{if(confirm(`Remove "${task.activity}" for ${day}?`)){const i=dT.findIndex(t=>t.id===task.id);if(i!==-1){dT.splice(i,1);saveToLocalStorage();buildWeeklyContent();}}});tR.appendChild(rB);tL.appendChild(tR);});}else{tL.innerHTML=`<p class="no-data">No tasks.</p>`;}dS.appendChild(tL);const aR=document.createElement("div");aR.className='add-row';const tS=document.createElement("select");populateTempTimeDropdown(tS,"3:00 PM");tS.title="Time";const dS_sel=document.createElement("select");["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{const o=document.createElement("option");o.value=d;o.text=d;dS_sel.appendChild(o);});dS_sel.value="30 min";dS_sel.title="Duration";const aI=document.createElement("input");aI.type="text";aI.placeholder="New weekly activity...";const aB=document.createElement("button");aB.textContent="+ Add";aB.className="btn btn-secondary";aB.title=`Add task for ${day}`;aB.addEventListener("click",()=>{const act=aI.value.trim();if(!act){alert("Enter activity.");aI.focus();return;}const nId=`wt_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;cWT[day].push({id:nId,time:tS.value,duration:dS_sel.value,activity:act});cWT[day].sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));saveToLocalStorage();buildWeeklyContent();});aR.append(tS,dS_sel,aI,aB);dS.appendChild(aR);weeklyContent.appendChild(dS);});}
            function saveWeeklySchedule(){closeWeeklyModal();loadClientDate(currentClient,currentDate);}

            // --- Image Handling ---
            function openImageModal(){if(!currentClient){alert("Select client.");return;}imageClientLabel.textContent=currentClient;imageFileInput.value="";imagePreview.src="#";imagePreview.style.display="none";imageTitleInput.value="";imageModal.style.display="block";}
            function closeImageModal(){imageModal.style.display="none";}
            function handleFileInputChange(e){const f=e.target.files?e.target.files[0]:null;if(!f)return;if(!f.type.startsWith("image/")){alert("Select image.");e.target.value="";return;}if(f.size>10*1024*1024)alert("Warn: Image > 10MB.");const r=new FileReader();r.onload=(e)=>{imagePreview.src=e.target.result;imagePreview.style.display="block";};r.onerror=(e)=>{alert("Error reading file.");};r.readAsDataURL(f);}
            function handlePasteImage(e){if(imageModal.style.display!=='block')return;const items=(e.clipboardData||window.clipboardData)?.items;if(!items)return;let fI=false;for(let i=0;i<items.length;i++){if(items[i].type.includes("image")){const b=items[i].getAsFile();if(b){if(b.size>10*1024*1024)alert("Warn: Pasted image > 10MB.");fI=true;const r=new FileReader();r.onload=(e)=>{imagePreview.src=e.target.result;imagePreview.style.display="block";};r.onerror=(e)=>{alert("Error reading paste.");};r.readAsDataURL(b);imageFileInput.value="";break;}}}}
            function saveImage(){if(!imagePreview.src||imagePreview.src===window.location.href+"#"||imagePreview.style.display==='none'){alert("No image.");return;}if(!currentClient||!allData[currentClient])return;if(!allData[currentClient].images)allData[currentClient].images=[];const t=imageTitleInput.value.trim()||`Image (${formatDateForUI(currentDate)})`;const iDU=imagePreview.src;if(iDU.length>15*1024*1024){if(!confirm("SAVE WARNING: Large image?"))return;}allData[currentClient].images.push({title:t,dataUrl:iDU});try{saveToLocalStorage();}catch(e){allData[currentClient].images.pop();return;}closeImageModal();renderImageGallery();}
            function renderImageGallery(){imageGallery.innerHTML="";if(!currentClient||!allData[currentClient]||!allData[currentClient].images||allData[currentClient].images.length===0){imageGallery.innerHTML='<h3 style="margin-top:0;">Image Gallery</h3><p class="no-data text-center">(No images)</p>';return;}const imgs=allData[currentClient].images;const h3=document.createElement("h3");h3.textContent="Image Gallery";h3.style.marginTop="0";imageGallery.appendChild(h3);[...imgs].reverse().forEach((imgObj,index)=>{const oI=imgs.length-1-index;const d=document.createElement("div");d.className="gallery-item";const th=document.createElement("img");th.src=imgObj.dataUrl;th.alt=escapeHtml(imgObj.title);th.title="Click view full";th.addEventListener("click",()=>{const iW=window.open("","_blank");iW.document.write(`<title>${escapeHtml(imgObj.title)}</title><style>body{margin:0;background:#333;}img{display:block;max-width:100%;max-height:100vh;margin:auto;}</style><body><img src="${imgObj.dataUrl}" alt="${escapeHtml(imgObj.title)}"></body>`);iW.document.close();});d.appendChild(th);const s=document.createElement("span");s.className="title";s.textContent=escapeHtml(imgObj.title);d.appendChild(s);const rB=document.createElement("button");rB.innerHTML=deleteIconSVG;rB.className="btn btn-icon btn-icon-delete";rB.title="Remove image";rB.addEventListener("click",()=>{if(confirm(`Remove image "${escapeHtml(imgObj.title)}"?`)){imgs.splice(oI,1);saveToLocalStorage();renderImageGallery();}});d.appendChild(rB);imageGallery.appendChild(d);});}

             // --- Final call to initialize ---
             initializeApp();

        }); // End of DOMContentLoaded listener

        // === END OF JAVASCRIPT ===
    </script>

</body>
</html>
