<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RESET Client Tracker (Merged Client List)</title>
  <style>
    /* Light background */
    body {
      background-color: #EAF6FF;
      font-family: sans-serif;
      margin: 20px;
      max-width: 720px;
    }
    h1, h2 {
      margin-bottom: 0.5em;
    }
    select, input[type="date"] {
      font-size: 1em;
      margin-right: 0.5em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background-color: #fff;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 0.5em;
      text-align: left;
      vertical-align: middle;
    }
    .task-row input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }
    .btn {
      cursor: pointer;
      padding: 0.4em 0.8em;
      margin: 0.5em 0.3em 0.5em 0;
      border: 1px solid #ccc;
      background-color: #f5f5f5;
    }
    #footer {
      margin-top: 2em;
      font-size: 0.9em;
      color: #666;
    }
    .controls {
      margin-bottom: 1em;
    }
    /* Completed-task styling */
    .completed-task {
      text-decoration: line-through;
      color: #888;
      background-color: #f8f8f8;
    }
    /* Progress panel */
    #progressDashboard {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #fefefe;
    }
    /* Title bar with a darker blue to stand out */
    .title-bar {
      background-color: #BCDDFE;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 1em;
    }
    /* New client form */
    #newClientForm {
      display: none;
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f8ff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Progress bar */
    .progress-bar-container {
      width: 100%;
      background-color: #f1f1f1;
      border-radius: 4px;
      margin: 5px 0;
    }
    .progress-bar {
      height: 20px;
      background-color: #4CAF50;
      border-radius: 4px;
      text-align: center;
      color: white;
      font-weight: bold;
    }
    /* Multi-day planner modal */
    #plannerModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
    }
    .modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .day-plan {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
    .time-container {
      display: flex;
      gap: 10px;
    }
    /* Weekly planner modal */
    #weeklyModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
    }
    .weekly-modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      width: 80%;
      max-width: 800px;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .weekly-day-section {
      margin-bottom: 15px;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fafafa;
      border-radius: 4px;
    }
    .weekly-day-section h4 {
      margin-top: 0;
    }
    /* Image modal */
    #imageModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
    }
    .image-modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      width: 90%;
      max-width: 700px;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #imagePreview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      display: block;
      border: 1px solid #ccc;
    }
    /* Gallery */
    #imageGallery {
      margin-top: 20px;
      padding: 10px;
      background-color: #fefefe;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .gallery-item {
      margin-bottom: 10px;
    }
    .gallery-item img {
      max-width: 200px;
      margin-right: 10px;
      vertical-align: middle;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .gallery-item .title {
      font-weight: bold;
    }
    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body {
        margin: 10px;
        padding: 0;
      }
      table {
        font-size: 14px;
      }
      .controls {
        display: flex;
        flex-direction: column;
      }
      .controls select, .controls input, .controls button {
        margin-bottom: 10px;
        width: 100%;
      }
      /* Stack the cells vertically on small screens */
      .task-row {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #ccc;
      }
      .task-row td {
        display: block;
        border: none;
        border-bottom: 1px solid #eee;
      }
      .task-row td:last-child {
        border-bottom: none;
      }
    }
  </style>
</head>
<body>

<div class="title-bar">
  <h1>RESET Client Tracker (Merged Client List)</h1>
</div>

<div class="controls">
  <!-- Client selection -->
  <label><strong>Client:</strong></label>
  <select id="clientSelect"></select>
  <button class="btn" id="addClientBtn">+ Add Client</button>

  <!-- Date selection -->
  <label><strong>Date:</strong></label>
  <input type="date" id="datePicker" />

  <!-- Clear tasks & Export & Report -->
  <button class="btn" id="clearTasksBtn">Clear Tasks</button>
  <button class="btn" id="exportBtn">Export Data</button>
  <button class="btn" id="reportBtn">View Report</button>

  <!-- Multi-day & Weekly plan & Images -->
  <button class="btn" id="multiDayPlanBtn">Multi-Day Plan</button>
  <button class="btn" id="weeklyPlanBtn">Weekly Plan</button>
  <button class="btn" id="imageBtn">Add Image</button>
</div>

<!-- New client form -->
<div id="newClientForm">
  <label><strong>New Client Name:</strong></label>
  <input type="text" id="newClientName" placeholder="Enter client name">
  <button class="btn" id="saveClientBtn">Save</button>
  <button class="btn" id="cancelClientBtn">Cancel</button>
</div>

<!-- Day rating dropdown -->
<div style="margin-bottom:1em;">
  <label><strong>Day Rating (1â€“5):</strong></label>
  <select id="dayRatingSelect" class="rating-dropdown">
    <option value="0">--</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</div>

<!-- Quick daily notes -->
<div style="margin-bottom:1em;">
  <label><strong>Daily Notes:</strong></label><br/>
  <textarea id="dayNotes" rows="3" style="width:98%;" placeholder="Any quick notes for today..."></textarea>
  <br/>
</div>

<hr/>

<h2>Add New Task</h2>
<div class="time-container">
  <div>
    <label for="timeSelect">Time:</label>
    <select id="timeSelect" class="time-dropdown"></select>
  </div>
  <div>
    <label for="durationSelect">Duration:</label>
    <select id="durationSelect">
      <option value="5 min">5 minutes</option>
      <option value="10 min">10 minutes</option>
      <option value="15 min">15 minutes</option>
      <option value="30 min" selected>30 minutes</option>
      <option value="45 min">45 minutes</option>
      <option value="1 hour">1 hour</option>
      <option value="90 min">90 minutes</option>
      <option value="2 hours">2 hours</option>
    </select>
  </div>
</div>
<br>

<label for="activityInput">Activity:</label>
<input type="text" id="activityInput" style="width:98%;" placeholder="e.g. Work on Chemistry assignment" />
<br><br>
<div style="margin-bottom:10px;">
  <input type="text" id="taskSearch" placeholder="Search tasks..." style="width:50%;">
</div>
<button class="btn" id="addBtn">Add Task</button>

<table id="taskTable">
  <thead>
    <tr>
      <th style="width:15%">Time</th>
      <th style="width:35%">Activity</th>
      <th style="width:10%">Done?</th>
      <th style="width:15%">Task Rating</th>
      <th style="width:25%">Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows dynamically inserted here -->
  </tbody>
</table>

<!-- Image gallery area -->
<div id="imageGallery"></div>

<div id="progressDashboard">
  <h3>Progress Dashboard</h3>
  
  <p><strong>Task Completion:</strong> <span id="completionRate">-</span></p>
  <div class="progress-bar-container">
    <div id="completionBar" class="progress-bar" style="width: 0%">0%</div>
  </div>
  
  <p><strong>Average Task Rating (this day):</strong> <span id="averageTaskRating">-</span></p>
  
  <hr/>
  
  <p><strong>Day Rating (this day):</strong> <span id="displayDayRating">-</span></p>
  
  <p><strong>Avg Day Rating (up to this date):</strong> <span id="avgDayRatingUpToDate">-</span></p>
  <div class="progress-bar-container">
    <div id="avgRatingBar" class="progress-bar" style="width: 0%; background-color: #2196F3;">0/5</div>
  </div>
</div>

<!-- Multi-Day Planner Modal -->
<div id="plannerModal">
  <div class="modal-content">
    <h3>Multi-Day Task Planner</h3>
    
    <p>Create a series of tasks across multiple days</p>
    
    <div id="plannerDays">
      <!-- Day plans will be added here -->
    </div>
    
    <button class="btn" id="addDayBtn">Add Another Day</button>
    
    <div style="margin-top:20px;">
      <button class="btn" id="savePlanBtn">Save All Tasks</button>
      <button class="btn" id="cancelPlanBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Weekly Plan Modal -->
<div id="weeklyModal">
  <div class="weekly-modal-content">
    <h3>Weekly Planner for: <span id="weeklyClientLabel"></span></h3>
    <p>Set tasks for each weekday. These tasks will appear automatically on those days.</p>
    
    <div id="weeklyContent"></div>
    
    <div style="margin-top:20px;">
      <button class="btn" id="saveWeeklyBtn">Save Weekly Schedule</button>
      <button class="btn" id="cancelWeeklyBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal">
  <div class="image-modal-content">
    <h3>Add an Image / Screenshot</h3>
    
    <div>
      <input type="file" id="imageFileInput" accept="image/*">
      <p style="color:#666;font-size:0.9em;">
        Or paste a screenshot directly (click here, then Ctrl+V).
      </p>
    </div>
    
    <img id="imagePreview" src="" alt="(Preview will appear here)" style="display:none;">
    
    <div style="margin-top:10px;">
      <label>Image Title:</label><br/>
      <input type="text" id="imageTitle" style="width:90%;">
    </div>
    
    <div style="margin-top:10px;">
      <button class="btn" id="saveImageBtn">Save Image</button>
      <button class="btn" id="cancelImageBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="footer">
  <p>Data is stored in your browser's localStorage, keyed by client AND date. Add day notes, tasks, etc.</p>
  <p style="font-size: 0.8em; color:#444;">
    <em>Save as plain-text .html, then open in your web browser (ideally via an HTTP server).</em>
  </p>
</div>

<script>
// --------------------------------------------------
// 1) Default "starter" clients you want to preload:
// --------------------------------------------------
const defaultClientNames = [
  "Giancarlo","Walter","Brendan B","Kai","Rafferty","Bardez",
  "KariBella","Zeb","Griffin","Charlie","Troy","Owen",
  "Sean","Bethany","DannyMike","Zelda","Whoadie"
];

// "allData" from localStorage
let allData = {};
let currentClient = null;
let currentDate   = null;

// DOM references
const clientSelect        = document.getElementById("clientSelect");
const datePicker          = document.getElementById("datePicker");
const clearTasksBtn       = document.getElementById("clearTasksBtn");
const exportBtn           = document.getElementById("exportBtn");
const reportBtn           = document.getElementById("reportBtn");
const multiDayPlanBtn     = document.getElementById("multiDayPlanBtn");

const dayRatingSelect     = document.getElementById("dayRatingSelect");
const dayNotesTextarea    = document.getElementById("dayNotes");

const timeSelect          = document.getElementById("timeSelect");
const durationSelect      = document.getElementById("durationSelect");
const activityInput       = document.getElementById("activityInput");
const taskSearch          = document.getElementById("taskSearch");
const addBtn              = document.getElementById("addBtn");
const taskTableBody       = document.getElementById("taskTable").querySelector("tbody");

// New client elements
const addClientBtn        = document.getElementById("addClientBtn");
const newClientForm       = document.getElementById("newClientForm");
const newClientName       = document.getElementById("newClientName");
const saveClientBtn       = document.getElementById("saveClientBtn");
const cancelClientBtn     = document.getElementById("cancelClientBtn");

// Multi-day planner elements
const plannerModal        = document.getElementById("plannerModal");
const plannerDays         = document.getElementById("plannerDays");
const addDayBtn           = document.getElementById("addDayBtn");
const savePlanBtn         = document.getElementById("savePlanBtn");
const cancelPlanBtn       = document.getElementById("cancelPlanBtn");

// Progress elements
const completionRateEl       = document.getElementById("completionRate");
const completionBarEl        = document.getElementById("completionBar");
const averageTaskRatingEl    = document.getElementById("averageTaskRating");
const displayDayRatingEl     = document.getElementById("displayDayRating");
const avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate");
const avgRatingBarEl         = document.getElementById("avgRatingBar");

// WEEKLY PLANNER
const weeklyPlanBtn      = document.getElementById("weeklyPlanBtn");
const weeklyModal        = document.getElementById("weeklyModal");
const weeklyContent      = document.getElementById("weeklyContent");
const weeklyClientLabel  = document.getElementById("weeklyClientLabel");
const saveWeeklyBtn      = document.getElementById("saveWeeklyBtn");
const cancelWeeklyBtn    = document.getElementById("cancelWeeklyBtn");

// IMAGES
const imageBtn           = document.getElementById("imageBtn");
const imageModal         = document.getElementById("imageModal");
const imageFileInput     = document.getElementById("imageFileInput");
const imagePreview       = document.getElementById("imagePreview");
const imageTitleInput    = document.getElementById("imageTitle");
const saveImageBtn       = document.getElementById("saveImageBtn");
const cancelImageBtn     = document.getElementById("cancelImageBtn");
const imageGallery       = document.getElementById("imageGallery");

// --------------------------------------------------
// On Load
// --------------------------------------------------
window.addEventListener("load", () => {
  // 1) Load from localStorage
  const stored = localStorage.getItem("multiClientDateData");
  if (stored) {
    allData = JSON.parse(stored);
  } else {
    allData = {};
  }

  // 2) Make sure default clients exist in allData
  defaultClientNames.forEach(name => {
    if (!allData[name]) {
      allData[name] = {};
    }
    if (!allData[name].weeklyTasks) {
      allData[name].weeklyTasks = {
        monday: [], tuesday: [], wednesday: [], thursday: [],
        friday: [], saturday: [], sunday: []
      };
    }
    if (!allData[name].images) {
      allData[name].images = [];
    }
  });

  // 3) Build the client dropdown from allData keys
  buildClientDropdown();

  // 4) Default selection: first client in alphabetical order + todayâ€™s date
  const allClients = Object.keys(allData).sort();
  if (allClients.length > 0) {
    currentClient = allClients[0];
  } else {
    // If somehow no clients, we create a blank one
    currentClient = "FirstClient";
    allData[currentClient] = {weeklyTasks:{monday:[],tuesday:[],wednesday:[],thursday:[],friday:[],saturday:[],sunday:[]}, images:[]};
  }
  clientSelect.value = currentClient;

  const todayStr = new Date().toISOString().split("T")[0];
  datePicker.value = todayStr;
  currentDate = todayStr;

  // 5) Set up event listeners
  clientSelect.addEventListener("change", onClientOrDateChange);
  datePicker.addEventListener("change", onClientOrDateChange);
  dayRatingSelect.addEventListener("change", onDayRatingChange);
  dayNotesTextarea.addEventListener("input", onDayNotesChange);

  addBtn.addEventListener("click", addNewTask);
  clearTasksBtn.addEventListener("click", clearTasksForClientDate);
  exportBtn.addEventListener("click", exportData);
  reportBtn.addEventListener("click", generateReport);

  // New client form
  addClientBtn.addEventListener("click", showNewClientForm);
  saveClientBtn.addEventListener("click", saveNewClient);
  cancelClientBtn.addEventListener("click", hideNewClientForm);

  // Multi-day planner
  multiDayPlanBtn.addEventListener("click", openPlannerModal);
  addDayBtn.addEventListener("click", addPlannerDay);
  savePlanBtn.addEventListener("click", saveMultiDayPlan);
  cancelPlanBtn.addEventListener("click", closePlannerModal);

  // Weekly planner
  weeklyPlanBtn.addEventListener("click", openWeeklyModal);
  saveWeeklyBtn.addEventListener("click", saveWeeklySchedule);
  cancelWeeklyBtn.addEventListener("click", closeWeeklyModal);

  // Images
  imageBtn.addEventListener("click", openImageModal);
  cancelImageBtn.addEventListener("click", closeImageModal);
  saveImageBtn.addEventListener("click", saveImage);
  imageModal.addEventListener("paste", handlePasteImage);
  imageFileInput.addEventListener("change", handleFileInputChange);

  // Task search
  taskSearch.addEventListener("input", () => {
    const searchText = taskSearch.value.toLowerCase();
    const rows = taskTableBody.querySelectorAll("tr");
    rows.forEach(row => {
      const activity = row.cells[1].textContent.toLowerCase();
      row.style.display = activity.includes(searchText) ? "" : "none";
    });
  });

  // Keyboard shortcuts
  setupKeyboardShortcuts();

  // Populate the time dropdown
  populateTimeDropdown();

  // Load the data for current client + date
  loadClientDate(currentClient, currentDate);
});

// --------------------------------------------------
// Build the client dropdown from allData keys
// --------------------------------------------------
function buildClientDropdown() {
  clientSelect.innerHTML = "";
  const clientNamesSorted = Object.keys(allData).sort();
  clientNamesSorted.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    clientSelect.appendChild(opt);
  });
}

// --------------------------------------------------
// Show/hide new client form
// --------------------------------------------------
function showNewClientForm() {
  newClientForm.style.display = "block";
  newClientName.value = "";
  newClientName.focus();
}
function hideNewClientForm() {
  newClientForm.style.display = "none";
}

// --------------------------------------------------
// Save a new client into allData
// --------------------------------------------------
function saveNewClient() {
  const name = newClientName.value.trim();
  if (!name) {
    alert("Please enter a client name");
    return;
  }
  // If it already exists in allData, just alert
  if (allData[name]) {
    alert(`Client "${name}" already exists (showing existing).`);
    clientSelect.value = name;
    currentClient = name;
    loadClientDate(name, currentDate);
    hideNewClientForm();
    return;
  }
  // Otherwise create it
  allData[name] = {
    weeklyTasks: {
      monday:[], tuesday:[], wednesday:[], thursday:[],
      friday:[], saturday:[], sunday:[]
    },
    images:[]
  };
  saveToLocalStorage();

  // Rebuild dropdown
  buildClientDropdown();

  // Select new client
  clientSelect.value = name;
  currentClient = name;
  loadClientDate(currentClient, currentDate);

  hideNewClientForm();
  alert(`New client "${name}" created!`);
}

// --------------------------------------------------
// On client or date change
// --------------------------------------------------
function onClientOrDateChange() {
  currentClient = clientSelect.value;
  currentDate = datePicker.value;
  loadClientDate(currentClient, currentDate);
}

// --------------------------------------------------
// Load tasks, notes, etc. for the current client/date
// --------------------------------------------------
function loadClientDate(cli, dt) {
  // Ensure day record
  if (!allData[cli][dt]) {
    allData[cli][dt] = {
      dayRating: "0",
      dayNotes: "",
      tasks: [],
      weeklyDone: {}
    };
    saveToLocalStorage();
  }
  const rec = allData[cli][dt];
  
  // Set rating & notes
  dayRatingSelect.value = rec.dayRating || "0";
  dayNotesTextarea.value = rec.dayNotes || "";

  // Clear table
  taskTableBody.innerHTML = "";

  // Show daily tasks
  const tasks = rec.tasks || [];
  tasks.forEach(t => addTaskRow(t));

  // Show weekly tasks
  const weekday = getWeekdayFromDate(dt);
  const weeklyList = allData[cli].weeklyTasks[weekday] || [];
  weeklyList.forEach(wt => addWeeklyTaskRow(wt, dt));

  // Render images
  renderImageGallery();

  // Update progress
  updateProgress();
}

// --------------------------------------------------
// Day rating / day notes
// --------------------------------------------------
function onDayRatingChange() {
  const rec = allData[currentClient][currentDate];
  if (!rec) return;
  rec.dayRating = dayRatingSelect.value;
  saveToLocalStorage();
  updateProgress();
}
function onDayNotesChange() {
  const rec = allData[currentClient][currentDate];
  if (!rec) return;
  rec.dayNotes = dayNotesTextarea.value;
  saveToLocalStorage();
}

// --------------------------------------------------
// Time dropdown (5am-11:45pm + common times)
// --------------------------------------------------
function populateTimeDropdown() {
  timeSelect.innerHTML = "";
  // 15-min increments from 5:00 AM up to 11:45 PM
  for (let hour = 5; hour < 24; hour++) {
    for (let minute = 0; minute < 60; minute += 15) {
      const suffix = hour < 12 ? "AM" : "PM";
      let displayHour = hour % 12;
      if (displayHour === 0) displayHour = 12;
      const minStr = minute === 0 ? "00" : minute.toString();
      const label = `${displayHour}:${minStr} ${suffix}`;
      const opt = document.createElement("option");
      opt.value = label;
      opt.textContent = label;
      timeSelect.appendChild(opt);
    }
  }
  // Separator
  const sep = document.createElement("option");
  sep.disabled = true;
  sep.textContent = "---- Common Times ----";
  timeSelect.appendChild(sep);
  // Common times
  const commonTimes = [
    "Before School","During Study Hall","During Lunch",
    "Right After School","Before Dinner","After Dinner","Before Bed"
  ];
  commonTimes.forEach(ct => {
    const opt = document.createElement("option");
    opt.value = ct;
    opt.textContent = ct;
    timeSelect.appendChild(opt);
  });
}

// --------------------------------------------------
// Add new task (daily) + sort
// --------------------------------------------------
function addNewTask() {
  if (!currentClient || !currentDate) return;
  const timeVal = timeSelect.value;
  const durVal  = durationSelect.value;
  const actVal  = activityInput.value.trim();
  if (!actVal) {
    alert("Please fill in the Activity field.");
    return;
  }
  const rec = allData[currentClient][currentDate];
  const newTask = {
    time: timeVal,
    duration: durVal,
    activity: actVal,
    completed: false,
    rating: "0"
  };
  rec.tasks.push(newTask);
  saveToLocalStorage();

  addTaskRow(newTask);
  activityInput.value = "";

  // Sort tasks by time
  sortTasksByTime();
  updateProgress();
}

// --------------------------------------------------
// Add daily task row to table
// --------------------------------------------------
function addTaskRow(taskObj) {
  const row = taskTableBody.insertRow();
  row.classList.add("task-row");
  if (taskObj.completed) {
    row.classList.add("completed-task");
  }

  // Time + duration
  const tdTime = row.insertCell(0);
  tdTime.innerHTML = taskObj.time;
  if (taskObj.duration) {
    tdTime.innerHTML += `<br><span style="font-size:0.8em; color:#666;">${taskObj.duration}</span>`;
  }

  // Activity
  const tdAct = row.insertCell(1);
  tdAct.textContent = taskObj.activity;

  // Completed?
  const tdComp = row.insertCell(2);
  const chk = document.createElement("input");
  chk.type = "checkbox";
  chk.checked = taskObj.completed;
  chk.addEventListener("change", () => {
    taskObj.completed = chk.checked;
    row.classList.toggle("completed-task", chk.checked);
    saveToLocalStorage();
    updateProgress();
  });
  tdComp.appendChild(chk);

  // Rating
  const tdRating = row.insertCell(3);
  const sel = document.createElement("select");
  ["0","1","2","3","4","5"].forEach(v => {
    const op = document.createElement("option");
    op.value = v;
    op.textContent = (v === "0") ? "--" : v;
    sel.appendChild(op);
  });
  sel.value = taskObj.rating || "0";
  sel.addEventListener("change", () => {
    taskObj.rating = sel.value;
    saveToLocalStorage();
    updateProgress();
  });
  tdRating.appendChild(sel);

  // Actions
  const tdActn = row.insertCell(4);
  const editBtn = document.createElement("button");
  editBtn.classList.add("btn");
  editBtn.textContent = "âœŽ";
  editBtn.style.marginRight = "6px";
  editBtn.addEventListener("click", () => {
    makeTaskEditable(row, taskObj);
  });
  tdActn.appendChild(editBtn);

  const rmBtn = document.createElement("button");
  rmBtn.classList.add("btn");
  rmBtn.textContent = "X";
  rmBtn.addEventListener("click", () => {
    removeTask(taskObj);
    row.remove();
    updateProgress();
  });
  tdActn.appendChild(rmBtn);
}

// --------------------------------------------------
// Add row for weekly tasks (non-editable here)
// --------------------------------------------------
function addWeeklyTaskRow(wTask, dt) {
  // Access daily recordâ€™s "weeklyDone"
  if (!allData[currentClient][dt].weeklyDone) {
    allData[currentClient][dt].weeklyDone = {};
  }
  const doneMap = allData[currentClient][dt].weeklyDone;
  const isDone = !!doneMap[wTask.id];

  const row = taskTableBody.insertRow();
  row.classList.add("task-row");
  if (isDone) {
    row.classList.add("completed-task");
  }

  // Time
  const tdTime = row.insertCell(0);
  tdTime.innerHTML = "(Weekly) " + wTask.time;
  if (wTask.duration) {
    tdTime.innerHTML += `<br><span style="font-size:0.8em; color:#666;">${wTask.duration}</span>`;
  }

  // Activity
  row.insertCell(1).textContent = wTask.activity;

  // Done?
  const tdComp = row.insertCell(2);
  const chk = document.createElement("input");
  chk.type = "checkbox";
  chk.checked = isDone;
  chk.addEventListener("change", () => {
    doneMap[wTask.id] = chk.checked;
    row.classList.toggle("completed-task", chk.checked);
    saveToLocalStorage();
    updateProgress();
  });
  tdComp.appendChild(chk);

  // Rating column
  row.insertCell(3).textContent = "(Weekly)";

  // Actions
  row.insertCell(4).innerHTML = `<em style="color:#888;">(Edit in Weekly Plan)</em>`;
}

// --------------------------------------------------
// Make a daily task editable
// --------------------------------------------------
function makeTaskEditable(row, taskObj) {
  const oldTime = taskObj.time;
  const oldDur  = taskObj.duration || "30 min";
  const oldAct  = taskObj.activity;

  // Time cell
  const tdTime = row.cells[0];
  tdTime.innerHTML = "";
  const timeSel = document.createElement("select");
  populateTempTimeDropdown(timeSel, oldTime);
  tdTime.appendChild(timeSel);

  const durSel = document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => {
    const op = document.createElement("option");
    op.value = d;
    op.textContent = d;
    durSel.appendChild(op);
  });
  durSel.value = oldDur;
  tdTime.appendChild(document.createElement("br"));
  tdTime.appendChild(durSel);

  // Activity cell
  const tdAct = row.cells[1];
  tdAct.innerHTML = "";
  const inp = document.createElement("input");
  inp.type = "text";
  inp.value = oldAct;
  inp.style.width = "98%";
  tdAct.appendChild(inp);

  // Overwrite actions
  const tdActn = row.cells[4];
  const oldHtml = tdActn.innerHTML;
  tdActn.innerHTML = "";
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";
  saveBtn.classList.add("btn");
  saveBtn.addEventListener("click", () => {
    const newA = inp.value.trim();
    if (!newA) {
      alert("Activity cannot be empty.");
      return;
    }
    taskObj.time = timeSel.value;
    taskObj.duration = durSel.value;
    taskObj.activity = newA;
    saveToLocalStorage();
    // Refresh row
    loadClientDate(currentClient, currentDate);
  });
  tdActn.appendChild(saveBtn);
  inp.focus();
}

// --------------------------------------------------
// Helper for time dropdown in edit mode
// --------------------------------------------------
function populateTempTimeDropdown(selectElem, currentVal) {
  for (let i=0; i<timeSelect.options.length; i++) {
    const clone = timeSelect.options[i].cloneNode(true);
    selectElem.appendChild(clone);
  }
  selectElem.value = currentVal;
}

// --------------------------------------------------
// Remove a daily task
// --------------------------------------------------
function removeTask(taskObj) {
  const rec = allData[currentClient][currentDate];
  const idx = rec.tasks.indexOf(taskObj);
  if (idx > -1) {
    rec.tasks.splice(idx,1);
    saveToLocalStorage();
  }
}

// --------------------------------------------------
// Clear tasks
// --------------------------------------------------
function clearTasksForClientDate() {
  if (!currentClient || !currentDate) return;
  if (confirm(`Clear ALL tasks for ${currentClient} on ${currentDate}?`)) {
    allData[currentClient][currentDate].tasks = [];
    saveToLocalStorage();
    loadClientDate(currentClient, currentDate);
  }
}

// --------------------------------------------------
// Export data to JSON file
// --------------------------------------------------
function exportData() {
  const dataStr = JSON.stringify(allData, null, 2);
  const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);
  const exportLink = document.createElement("a");
  exportLink.setAttribute("href", dataUri);
  exportLink.setAttribute("download", `planner-export-${new Date().toISOString().split('T')[0]}.json`);
  exportLink.click();
}

// --------------------------------------------------
// Save to localStorage
// --------------------------------------------------
function saveToLocalStorage() {
  try {
    localStorage.setItem("multiClientDateData", JSON.stringify(allData));
  } catch (err) {
    if (err.name === "QuotaExceededError") {
      alert("Storage limit exceeded! Please export data & clear old entries/images.");
    } else {
      console.error("Error saving data:", err);
      alert("Problem saving data; changes may not persist.");
    }
  }
}

// --------------------------------------------------
// Update progress dashboard
// --------------------------------------------------
function updateProgress() {
  const rec = allData[currentClient][currentDate];
  if (!rec) return;
  const tasks = rec.tasks || [];

  // Weekly tasks
  const wd = getWeekdayFromDate(currentDate);
  const wList = allData[currentClient].weeklyTasks[wd] || [];
  const wDone = rec.weeklyDone || {};
  const weeklyDoneCount = wList.filter(wt => wDone[wt.id]).length;

  const dailyDoneCount = tasks.filter(t => t.completed).length;
  const totalDone = weeklyDoneCount + dailyDoneCount;
  const totalTasks = wList.length + tasks.length;

  if (totalTasks === 0) {
    completionRateEl.textContent = "-";
    completionBarEl.style.width = "0%";
    completionBarEl.textContent = "0%";
    averageTaskRatingEl.textContent = "-";
  } else {
    const pct = Math.round((totalDone / totalTasks) * 100);
    completionRateEl.textContent = `${pct}% (${totalDone}/${totalTasks})`;
    completionBarEl.style.width = `${pct}%`;
    completionBarEl.textContent = `${pct}%`;

    // Average task rating (daily tasks only)
    const rated = tasks.filter(t => t.rating !== "0");
    if (rated.length > 0) {
      const sum = rated.reduce((acc, t) => acc + parseInt(t.rating, 10), 0);
      const avg = sum / rated.length;
      averageTaskRatingEl.textContent = avg.toFixed(1) + " / 5";
    } else {
      averageTaskRatingEl.textContent = "No task ratings yet";
    }
  }

  // Day rating
  const dr = rec.dayRating;
  if (dr && dr !== "0") {
    displayDayRatingEl.textContent = dr + "/5";
  } else {
    displayDayRatingEl.textContent = "--";
  }

  // Avg day rating up to this date
  const allDates = Object.keys(allData[currentClient]).filter(d => d.match(/^\d{4}-\d{2}-\d{2}$/) && d <= currentDate);
  let sumDR = 0, countDR = 0;
  allDates.forEach(d => {
    const dayR = allData[currentClient][d].dayRating;
    if (dayR && dayR !== "0") {
      sumDR += parseInt(dayR, 10);
      countDR++;
    }
  });
  if (countDR > 0) {
    const avgdr = sumDR / countDR;
    avgDayRatingUpToDateEl.textContent = avgdr.toFixed(1) + "/5";
    const barPct = (avgdr / 5)*100;
    avgRatingBarEl.style.width = `${barPct}%`;
    avgRatingBarEl.textContent = `${avgdr.toFixed(1)}/5`;
  } else {
    avgDayRatingUpToDateEl.textContent = "No day ratings yet";
    avgRatingBarEl.style.width = "0%";
    avgRatingBarEl.textContent = "0/5";
  }
}

// --------------------------------------------------
// Sort daily tasks by time
// --------------------------------------------------
function sortTasksByTime() {
  const rec = allData[currentClient][currentDate];
  if (!rec || !rec.tasks) return;
  rec.tasks.sort((a,b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time));
  saveToLocalStorage();
  loadClientDate(currentClient, currentDate);
}

// Converts "1:30 PM" or "Before School" to a numeric for sorting
function convertTimeToMinutes(str) {
  const specialTimes = {
    "Before School": 360,
    "During Study Hall": 600,
    "During Lunch": 720,
    "Right After School": 840,
    "Before Dinner": 1020,
    "After Dinner": 1140,
    "Before Bed": 1320
  };
  if (specialTimes[str] !== undefined) {
    return specialTimes[str];
  }
  try {
    const [timePart, ampm] = str.split(" ");
    const [hh, mm] = timePart.split(":").map(Number);
    let hours = hh;
    if (ampm.toUpperCase() === "PM" && hours < 12) hours += 12;
    if (ampm.toUpperCase() === "AM" && hours === 12) hours = 0;
    return hours*60 + mm;
  } catch {
    return 9999;
  }
}

// Helper to get weekday name
function getWeekdayFromDate(ds) {
  const d = new Date(ds);
  const dayIdx = d.getDay(); // 0=Sun,1=Mon,...
  const map = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
  return map[dayIdx] || "sunday";
}

// --------------------------------------------------
// Multi-day planner
// --------------------------------------------------
function openPlannerModal() {
  plannerDays.innerHTML = "";
  // Start with 1 day block
  addPlannerDay();
  plannerModal.style.display = "block";
}
function closePlannerModal() {
  plannerModal.style.display = "none";
}
function addPlannerDay() {
  const index = plannerDays.querySelectorAll(".day-plan").length;
  // base date = currentDate + index
  const base = new Date(currentDate);
  base.setDate(base.getDate() + index);
  const ds = base.toISOString().split("T")[0];

  const div = document.createElement("div");
  div.classList.add("day-plan");
  div.dataset.date = ds;

  const hd = document.createElement("h4");
  hd.textContent = `Day ${index+1}: ${formatDate(ds)}`;
  div.appendChild(hd);

  // Time/Duration
  const container = document.createElement("div");
  
  const timeLabel = document.createElement("label");
  timeLabel.textContent = "Time:";
  container.appendChild(timeLabel);

  const timeSel = document.createElement("select");
  populateTempTimeDropdown(timeSel, "3:00 PM");
  container.appendChild(timeSel);

  const durLabel = document.createElement("label");
  durLabel.textContent = " Duration:";
  durLabel.style.marginLeft = "10px";
  container.appendChild(durLabel);

  const durSel = document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => {
    const op = document.createElement("option");
    op.value = d;
    op.textContent = d;
    durSel.appendChild(op);
  });
  durSel.value = "30 min";
  container.appendChild(durSel);

  div.appendChild(container);

  // Activity
  const labelA = document.createElement("label");
  labelA.textContent = "Activity:";
  labelA.style.display = "block";
  labelA.style.marginTop = "8px";
  div.appendChild(labelA);

  const inpA = document.createElement("input");
  inpA.type = "text";
  inpA.placeholder = "e.g. Complete Math assignment";
  inpA.style.width = "100%";
  div.appendChild(inpA);

  // "Add Another Task to this day"
  const addTaskBtn = document.createElement("button");
  addTaskBtn.classList.add("btn");
  addTaskBtn.textContent = "Add Another Task to this Day";
  addTaskBtn.style.marginTop = "8px";
  addTaskBtn.addEventListener("click", () => {
    const cloneContainer = container.cloneNode(true);
    const cloneLabel = labelA.cloneNode(true);
    const cloneInp = inpA.cloneNode(true);
    cloneInp.value = "";
    div.insertBefore(document.createElement("hr"), addTaskBtn);
    div.insertBefore(cloneContainer, addTaskBtn);
    div.insertBefore(cloneLabel, addTaskBtn);
    div.insertBefore(cloneInp, addTaskBtn);
  });
  div.appendChild(addTaskBtn);

  plannerDays.appendChild(div);
}

function saveMultiDayPlan() {
  const dayPlans = plannerDays.querySelectorAll(".day-plan");
  let taskCount = 0;

  dayPlans.forEach(dayPlan => {
    const ds = dayPlan.dataset.date;
    if (!allData[currentClient][ds]) {
      allData[currentClient][ds] = { dayRating:"0", dayNotes:"", tasks:[], weeklyDone:{} };
    }
    const rec = allData[currentClient][ds];
    
    // Each dayPlan has multiple sets of (selectTime, selectDur) + inputActivity
    // We'll pair them in sets of 1 container + 1 activity
    const containers = dayPlan.querySelectorAll("div>select"); 
    const textInputs = dayPlan.querySelectorAll('input[type="text"]');

    // Because each "Add Another Task" creates pairs of <select> (time/dur) + activity
    // We'll handle them in matching indexes
    // Each "container" has 2 selects (time, dur).
    // But we didn't nest them in a single parent, so let's handle them carefully
    // Easiest approach: each "Activity" input corresponds to a pair of selects
    // in the same sequence
    // We'll just do them in order:
    // (first 2 selects, first input), (next 2 selects, next input), etc.

    let selIndex = 0;
    for (let i = 0; i < textInputs.length; i++) {
      // We want to find the 2 selects before each input
      // Actually we cloned entire container, so we can just do:
      //   2 selects => then 1 activity
      //   next 2 selects => next activity
      // But a simpler approach is to just gather them in chunk of 2
      // We'll do something a bit manual:

      const timeSel = dayPlan.querySelectorAll("select")[selIndex];
      const durSel  = dayPlan.querySelectorAll("select")[selIndex+1];
      selIndex += 2;

      const activityVal = textInputs[i].value.trim();
      if (activityVal) {
        rec.tasks.push({
          time: timeSel.value,
          duration: durSel.value,
          activity: activityVal,
          completed: false,
          rating: "0"
        });
        taskCount++;
      }
    }
  });

  saveToLocalStorage();
  loadClientDate(currentClient, currentDate);
  closePlannerModal();
  alert(`Multi-day plan saved! ${taskCount} tasks added.`);
}

function formatDate(ds) {
  const d = new Date(ds);
  return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
}

// --------------------------------------------------
// Weekly Planner
// --------------------------------------------------
function openWeeklyModal() {
  weeklyClientLabel.textContent = currentClient;
  buildWeeklyContent();
  weeklyModal.style.display = "block";
}
function closeWeeklyModal() {
  weeklyModal.style.display = "none";
}
function buildWeeklyContent() {
  weeklyContent.innerHTML = "";
  const days = ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  const wData = allData[currentClient].weeklyTasks;

  days.forEach(d => {
    const sec = document.createElement("div");
    sec.classList.add("weekly-day-section");
    const hd = document.createElement("h4");
    hd.textContent = d[0].toUpperCase()+d.slice(1);
    sec.appendChild(hd);

    const dayTasks = wData[d];
    const tasksDiv = document.createElement("div");

    dayTasks.forEach(task => {
      const row = document.createElement("div");
      row.style.marginBottom = "5px";
      row.textContent = `[${task.time}] ${task.activity}`;
      // remove
      const rm = document.createElement("button");
      rm.classList.add("btn");
      rm.textContent = "X";
      rm.style.marginLeft = "10px";
      rm.addEventListener("click", () => {
        const idx = dayTasks.indexOf(task);
        if (idx > -1) {
          dayTasks.splice(idx,1);
          saveToLocalStorage();
          buildWeeklyContent();
        }
      });
      row.appendChild(rm);
      tasksDiv.appendChild(row);
    });

    sec.appendChild(tasksDiv);

    // Input row
    const addRow = document.createElement("div");
    addRow.style.marginTop = "10px";

    // Time select
    const selTime = document.createElement("select");
    populateTempTimeDropdown(selTime, "3:00 PM");
    addRow.appendChild(selTime);

    // Duration
    const selDur = document.createElement("select");
    ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(dur => {
      const opt = document.createElement("option");
      opt.value = dur;
      opt.textContent = dur;
      selDur.appendChild(opt);
    });
    selDur.value = "30 min";
    addRow.appendChild(selDur);

    // Activity
    const inpA = document.createElement("input");
    inpA.type = "text";
    inpA.placeholder = "Activity...";
    inpA.style.width = "200px";
    inpA.style.marginLeft = "5px";
    addRow.appendChild(inpA);

    const plus = document.createElement("button");
    plus.textContent = "+";
    plus.classList.add("btn");
    plus.style.marginLeft = "10px";
    plus.addEventListener("click", () => {
      const val = inpA.value.trim();
      if (!val) {
        alert("Please enter an activity");
        return;
      }
      const newId = `weekly_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      wData[d].push({
        id: newId,
        time: selTime.value,
        duration: selDur.value,
        activity: val
      });
      saveToLocalStorage();
      buildWeeklyContent();
    });
    addRow.appendChild(plus);

    sec.appendChild(addRow);

    weeklyContent.appendChild(sec);
  });
}
function saveWeeklySchedule() {
  // Data is saved on each add/remove, so just close and reload
  closeWeeklyModal();
  loadClientDate(currentClient, currentDate);
  alert("Weekly schedule saved!");
}

// --------------------------------------------------
// Images
// --------------------------------------------------
function openImageModal() {
  imageModal.style.display = "block";
  imageFileInput.value = "";
  imageTitleInput.value = "";
  imagePreview.style.display = "none";
  imagePreview.src = "";
}
function closeImageModal() {
  imageModal.style.display = "none";
}
function handleFileInputChange() {
  const file = imageFileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    imagePreview.src = evt.target.result;
    imagePreview.style.display = "block";
  };
  reader.readAsDataURL(file);
}
function handlePasteImage(e) {
  const items = e.clipboardData?.items || [];
  for (let i=0; i<items.length; i++){
    if (items[i].type.indexOf("image") === 0) {
      const file = items[i].getAsFile();
      if (file) {
        const reader = new FileReader();
        reader.onload = evt => {
          imagePreview.src = evt.target.result;
          imagePreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    }
  }
}
function saveImage() {
  if (!imagePreview.src) {
    alert("No image selected or pasted");
    return;
  }
  const titleVal = imageTitleInput.value.trim() || "(Untitled)";
  allData[currentClient].images.push({
    title: titleVal,
    dataUrl: imagePreview.src
  });
  saveToLocalStorage();
  closeImageModal();
  renderImageGallery();
}
function renderImageGallery() {
  imageGallery.innerHTML = "";
  const imgs = allData[currentClient].images || [];
  if (imgs.length === 0) return;

  const hd = document.createElement("h3");
  hd.textContent = "Image Gallery";
  imageGallery.appendChild(hd);

  imgs.forEach((imgObj, idx) => {
    const div = document.createElement("div");
    div.classList.add("gallery-item");

    const titleSpan = document.createElement("span");
    titleSpan.classList.add("title");
    titleSpan.textContent = imgObj.title + " ";
    div.appendChild(titleSpan);

    const im = document.createElement("img");
    im.src = imgObj.dataUrl;
    im.style.maxHeight = "60px";
    im.style.cursor = "pointer";
    im.addEventListener("click", () => {
      window.open(imgObj.dataUrl, "_blank");
    });
    div.appendChild(im);

    const rm = document.createElement("button");
    rm.classList.add("btn");
    rm.textContent = "X";
    rm.style.marginLeft = "10px";
    rm.addEventListener("click", () => {
      if (confirm("Remove this image?")) {
        imgs.splice(idx,1);
        saveToLocalStorage();
        renderImageGallery();
      }
    });
    div.appendChild(rm);

    imageGallery.appendChild(div);
  });
}

// --------------------------------------------------
// Report
// --------------------------------------------------
function generateReport() {
  let html = `
  <!DOCTYPE html>
  <html><head><meta charset="UTF-8"/>
    <title>RESET Tracker Report</title>
    <style>
      body { font-family:sans-serif; margin:20px; max-width:800px; }
      h1,h2,h3 { margin-bottom:0.4em; }
      table { border-collapse:collapse; width:100%; margin:1em 0; }
      table, th, td { border:1px solid #999; }
      th, td { padding:6px; vertical-align:top; }
      th { background:#f0f0f0; }
      .notes-box { background:#eef; border:1px solid #ccc; padding:6px; margin:6px 0; }
      .gallery-img { max-width:200px; margin:5px; border:1px solid #ccc; }
    </style>
  </head><body>
    <h1>RESET Client Tracker Report</h1>
    <p>Client: <strong>${escapeHtml(currentClient)}</strong></p>
  `;

  // Weekly tasks
  const wt = allData[currentClient].weeklyTasks;
  html += `<h2>Weekly Recurring Tasks</h2>`;
  Object.keys(wt).forEach(day => {
    const tasksArr = wt[day];
    if (tasksArr.length>0) {
      html += `<h3>${day[0].toUpperCase()+day.slice(1)}</h3><ul>`;
      tasksArr.forEach(t => {
        html += `<li>${escapeHtml(t.time)} - ${escapeHtml(t.activity)}</li>`;
      });
      html += `</ul>`;
    }
  });

  // Images
  const images = allData[currentClient].images || [];
  if (images.length > 0) {
    html += `<h2>Images</h2>`;
    images.forEach(img => {
      html += `<div><strong>${escapeHtml(img.title)}</strong><br/>
               <img class="gallery-img" src="${img.dataUrl}" alt="img"></div>`;
    });
  }

  // Daily records
  const dateKeys = Object.keys(allData[currentClient]).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
  if (dateKeys.length === 0) {
    html += `<p>No daily records found.</p>`;
  } else {
    dateKeys.forEach(d => {
      const rec = allData[currentClient][d];
      if (!rec) return;
      html += `<h2>${d} - Day Rating: ${rec.dayRating && rec.dayRating!=="0" ? rec.dayRating+"/5" : "No rating"}</h2>`;
      if (rec.dayNotes) {
        html += `<div class="notes-box">${escapeHtml(rec.dayNotes).replace(/\n/g,"<br>")}</div>`;
      }
      // Merge daily + weekly tasks
      const merged = [];
      (rec.tasks||[]).forEach(t => merged.push({ ...t, _type:"daily" }));
      const wd = getWeekdayFromDate(d);
      (allData[currentClient].weeklyTasks[wd]||[]).forEach(wtk => {
        const doneMap = rec.weeklyDone || {};
        merged.push({
          time: wtk.time,
          duration: wtk.duration,
          activity: wtk.activity,
          completed: !!doneMap[wtk.id],
          rating: "(Weekly)",
          _type:"weekly"
        });
      });
      if (merged.length === 0) {
        html += `<p style="color:#999;">(No tasks for this day)</p>`;
      } else {
        // Sort by time
        merged.sort((a,b) => convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));
        html += `<table>
          <thead>
            <tr><th>Time</th><th>Activity</th><th>Done?</th><th>Rating</th></tr>
          </thead><tbody>`;
        merged.forEach(m => {
          html += `<tr>
            <td>${escapeHtml(m.time||"")} ${m.duration ? `<br><small>${escapeHtml(m.duration)}</small>`:""}
                ${m._type==="weekly"?"<br>(Weekly)":""}</td>
            <td>${escapeHtml(m.activity||"")}</td>
            <td>${m.completed?"Yes":"No"}</td>
            <td>${m._type==="daily" ? (m.rating&&m.rating!=="0"?m.rating+"/5":"--") : "(Weekly)"}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
      }
    });
  }

  html += `</body></html>`;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// Basic html escaping
function escapeHtml(str) {
  if (!str) return "";
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

// --------------------------------------------------
// Keyboard shortcuts
// --------------------------------------------------
function setupKeyboardShortcuts() {
  document.addEventListener("keydown", e => {
    // alt+a => add task
    if (e.altKey && e.key.toLowerCase() === "a") {
      e.preventDefault();
      addNewTask();
    }
    // alt+d => toggle last row
    if (e.altKey && e.key.toLowerCase() === "d") {
      e.preventDefault();
      const lastRow = taskTableBody.querySelector("tr:last-child");
      if (lastRow) {
        const chk = lastRow.querySelector("input[type='checkbox']");
        chk.checked = !chk.checked;
        chk.dispatchEvent(new Event("change"));
      }
    }
    // alt+s => sort
    if (e.altKey && e.key.toLowerCase() === "s") {
      e.preventDefault();
      sortTasksByTime();
    }
  });
}
</script>
</body>
</html>
