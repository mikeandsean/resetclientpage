<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Tracker Dashboard</title>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* === Modern CSS Reset & Base === */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB; /* Very light gray background */
            color: #1F2937; /* Dark gray text */
            line-height: 1.6;
            padding-top: 2rem; /* Space from top */
        }
        .container { max-width: 850px; margin: 0 auto; padding: 0 1rem; }
        a { color: #2563EB; text-decoration: none; transition: color 0.2s; }
        a:hover { color: #1D4ED8; text-decoration: underline;}
        h1, h2, h3, h4 { margin-bottom: 0.75rem; font-weight: 600; line-height: 1.3; }
        h1 { font-size: 1.875rem; /* 30px */ text-align: center; color: #374151; margin-bottom: 2rem; font-weight: 500;}
        h2 { font-size: 1.25rem; /* 20px */ color: #111827; border-bottom: 1px solid #E5E7EB; padding-bottom: 0.5rem; margin-top: 1.5rem; font-weight: 600;}
        h3 { font-size: 1.125rem; /* 18px */ color: #1F2937; margin-top: 1rem; font-weight: 600;}
        hr { border: none; border-top: 1px solid #E5E7EB; margin: 2rem 0; }
        label { display: block; font-size: 0.875rem; /* 14px */ font-weight: 500; color: #4B5563; margin-bottom: 0.25rem; }

        /* === Utility === */
        .text-center { text-align: center; }
        .no-data { color: #6B7280; font-style: italic; font-size: 0.9em; padding: 1rem; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* === Card Styling === */
        .card {
            background-color: #FFFFFF;
            border-radius: 0.5rem; /* 8px */
            border: 1px solid #E5E7EB; /* Light gray border */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }
        .card h2:first-child, .card h3:first-child { margin-top: 0; } /* Remove top margin if heading is first */

        /* === Forms === */
        select, input[type="date"], input[type="text"], textarea {
            display: block; width: 100%;
            padding: 0.625rem 0.75rem; /* 10px 12px */
            font-size: 1rem; line-height: 1.5;
            color: #1F2937; background-color: #FFFFFF;
            border: 1px solid #D1D5DB; border-radius: 0.375rem; /* 6px */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em; padding-right: 2.5rem; }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #60A5FA; /* Lighter blue focus */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        textarea { min-height: 100px; }

        /* === Buttons === */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            font-family: inherit; font-size: 0.9375rem; /* 15px */ font-weight: 500;
            padding: 0.625rem 1rem; /* 10px 16px */
            margin: 0.25rem 0.25rem 0.25rem 0;
            border: 1px solid transparent; border-radius: 0.375rem; /* 6px */
            cursor: pointer; line-height: 1.5;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }
        .btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: translateY(1px); }

        /* Primary Button (Blue) */
        .btn-primary { background-color: #2563EB; color: #FFFFFF; border-color: #2563EB; }
        .btn-primary:hover:not(:disabled) { background-color: #1D4ED8; border-color: #1D4ED8; }

        /* Secondary Button (White / Light Gray) */
        .btn-secondary { background-color: #FFFFFF; color: #374151; border-color: #D1D5DB; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .btn-secondary:hover:not(:disabled) { background-color: #F9FAFB; border-color: #BDBDBD; }

        /* Destructive Button (Red Outline/Subtle Red) */
        .btn-danger { background-color: #FEF2F2; color: #DC2626; border-color: #FCA5A5; }
        .btn-danger:hover:not(:disabled) { background-color: #FEE2E2; border-color: #F87171; color: #B91C1C; }
        #clearTasksBtn { /* Make clear tasks more prominent */
             background-color: #FEF2F2; color: #DC2626; border-color: #FCA5A5;
        }
         #clearTasksBtn:hover:not(:disabled) {
             background-color: #DC2626; color: #FFFFFF; border-color: #DC2626;
        }

        /* Small Icon-style Buttons (e.g., table actions) */
        .btn-icon {
            padding: 0.375rem; /* 6px */
            background-color: transparent;
            color: #6B7280; /* Medium gray */
            border-color: transparent;
            line-height: 1;
        }
        .btn-icon:hover:not(:disabled) { background-color: #F3F4F6; color: #1F2937; }
        .btn-icon svg { width: 1.125rem; height: 1.125rem; /* 18px */ }
        .btn-icon-delete { color: #EF4444; } /* Red for delete */
        .btn-icon-delete:hover:not(:disabled) { background-color: #FEF2F2; color: #DC2626; }

        /* Apply button styles */
        #addClientBtn, #addBtn, #saveClientBtn, #saveClientInfoBtn, #savePlanBtn, #saveWeeklyBtn, #saveImageBtn { /* Primary */
             background-color: #2563EB; color: #FFFFFF; border-color: #2563EB;
        }
        #addClientBtn:hover, #addBtn:hover, #saveClientBtn:hover, #saveClientInfoBtn:hover, #savePlanBtn:hover, #saveWeeklyBtn:hover, #saveImageBtn:hover {
             background-color: #1D4ED8; border-color: #1D4ED8;
        }
        #exportBtn, #reportBtn, #multiDayPlanBtn, #weeklyPlanBtn, #imageBtn, #cancelClientBtn, #cancelPlanBtn, #cancelWeeklyBtn, #cancelImageBtn, #addDayBtn { /* Secondary */
             background-color: #FFFFFF; color: #374151; border-color: #D1D5DB; box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
         #exportBtn:hover, #reportBtn:hover, #multiDayPlanBtn:hover, #weeklyPlanBtn:hover, #imageBtn:hover, #cancelClientBtn:hover, #cancelPlanBtn:hover, #cancelWeeklyBtn:hover, #cancelImageBtn:hover, #addDayBtn:hover {
             background-color: #F9FAFB; border-color: #BDBDBD;
        }

        /* === Specific Sections === */

        /* Controls Bar */
        .controls-grid { /* New class for the controls container */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, auto)); /* Auto columns */
            gap: 0.75rem 1rem;
            align-items: center;
        }
        .controls-grid > div { display: flex; flex-direction: column; } /* Stack label/input */
        .controls-grid label { margin-bottom: 0.1rem; }
        .controls-grid select, .controls-grid input { width: 100%; }
        .controls-button-group {
             grid-column: 1 / -1; /* Span full width */
             margin-top: 0.5rem;
             display: flex; flex-wrap: wrap; gap: 0.5rem;
        }

        /* New Client Form */
         #newClientForm { border-left: 4px solid #2563EB; display: none; align-items: center; gap: 1rem;}
         #newClientForm label { margin-bottom: 0; flex-shrink: 0; }
         #newClientForm input[type="text"] { width: auto; flex-grow: 1; }
         #newClientForm .btn { margin-left: auto; } /* Push buttons right */

        /* Client Info */
        .client-info .info-row { display: grid; grid-template-columns: 130px 1fr; gap: 0.5rem 1rem; margin-bottom: 0.75rem; align-items: center; }
        .client-info label { text-align: right; margin-bottom: 0; }
        .client-info h3 { /* Specific styling for the heading inside this card */
            grid-column: 1 / -1; /* Span full width */
            margin-top: 0; margin-bottom: 1rem;
            padding-bottom: 0.5rem; border-bottom: 1px solid #E5E7EB;
            font-size: 1.125rem; color: #111827;
        }

        /* Big Goal Display */
        #bigGoalDisplay {
            font-size: 1.25rem; font-weight: 500; margin: 1.5rem 0; color: #111827;
            padding: 1rem; background-color: #EFF6FF; /* Light blue bg */
            border: 1px solid #BFDBFE; /* Lighter blue border */
            border-radius: 0.5rem; text-align: center;
        }

        /* External Links */
        .external-links { margin-bottom: 1.5rem; padding: 0; display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .external-links a { font-weight: 500; display: inline-flex; align-items: center; gap: 0.3rem; color: #374151; }
        .external-links a:hover { color: #1D4ED8; }
        .external-links svg { width: 1em; height: 1em; color: #9CA3AF; } /* Link icon */

        /* Add Task Section */
        .add-task-section .time-duration-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1rem; }

        /* === Table === */
        .table-wrapper { overflow-x: auto; } /* Allow table scroll on small screens */
        table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; background-color: #FFFFFF; font-size: 0.9375rem; }
        th, td { border-bottom: 1px solid #E5E7EB; padding: 0.875rem 1rem; text-align: left; vertical-align: middle; }
        th { background-color: #F9FAFB; font-weight: 500; font-size: 0.8rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color 0.15s ease-in-out; }
        tbody tr:hover { background-color: #F9FAFB; }
        td:nth-child(3) { text-align: center; padding: 0.5rem; } /* Done Checkbox */
        td:nth-child(3) input { display: block; margin: auto; width: 1.1rem; height: 1.1rem;}
        td:nth-child(4) select { width: auto; min-width: 65px; font-size: 0.9em; padding: 0.25rem 0.5rem; background-position: right 0.3rem center; } /* Rating Select */
        td:nth-child(4) { vertical-align: middle; } /* Ensure rating select aligns */
        td:nth-child(5) { text-align: right; white-space: nowrap; padding-right: 0.5rem;} /* Actions */
        .completed-task td:not(:last-child) { text-decoration: line-through; color: #9CA3AF; }
        .completed-task td:first-child, .completed-task td:nth-child(2) { opacity: 0.8; }
        .weekly-indicator { font-size: 0.75em; color: #60A5FA; font-weight: 500; display: block; margin-top: 2px; }

        /* === Reflection, Gallery, Dashboard Headers === */
        .reflection-section h3, #imageGallery h3, #progressDashboard h3, .google-embed-container h2 {
            margin-top: 0; color: #111827; font-weight: 600; font-size: 1.125rem; /* 18px */
        }

        /* Image gallery */
        #imageGallery .gallery-item { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; padding: 0.5rem 0; }
        #imageGallery .gallery-item:not(:last-child) { border-bottom: 1px solid #F3F4F6; }
        #imageGallery .gallery-item img { width: 70px; height: 45px; border-radius: 0.25rem; border: 1px solid #E5E7EB; cursor: pointer; object-fit: cover; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #imageGallery .gallery-item img:hover { transform: scale(1.05); box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        #imageGallery .gallery-item .title { font-weight: 500; flex-grow: 1; color: #374151; font-size: 0.95rem;}
        #imageGallery .gallery-item .btn-icon { margin-left: auto; }

        /* Progress Dashboard */
        #progressDashboard p { margin-bottom: 0.5rem; font-size: 0.95rem; color: #374151;}
        #progressDashboard strong { font-weight: 600; color: #1F2937; }
        .progress-bar-container { width: 100%; background-color: #E5E7EB; border-radius: 999px; /* Pill shape */ margin: 0.5rem 0 1rem 0; overflow: hidden; height: 10px; /* Thinner bar */ }
        .progress-bar { height: 100%; background-color: #34D399; /* Green */ border-radius: 999px; transition: width 0.4s ease-in-out; }
        .progress-bar.avg-rating { background-color: #60A5FA; } /* Blue for rating */

        /* === Modals === */
        #plannerModal, #weeklyModal, #imageModal { display: none; position: fixed; inset: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.7); z-index: 1000; padding: 1.5rem; overflow-y: auto; backdrop-filter: blur(4px); }
        .modal-content, .weekly-modal-content, .image-modal-content { background-color: #FFFFFF; margin: 4vh auto; padding: 2rem; width: 100%; max-width: 700px; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .weekly-modal-content { max-width: 850px; }
        .modal-content h3, .weekly-modal-content h3, .image-modal-content h3 { margin-top: 0; color: #111827; font-size: 1.25rem; }
        .modal-footer { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 0.75rem; }
         /* Use explicit selector for modal footers */
         #plannerModal .modal-content > div:last-of-type:not(#plannerDays),
         #weeklyModal .weekly-modal-content > div:last-of-type:not(#weeklyContent),
         #imageModal .image-modal-content > div:last-of-type:not([style*="margin-top"]) { /* Target last div unless it's the preview div */
            margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 0.75rem;
         }


        /* Planner/Weekly Modal specifics */
        .day-plan, .weekly-day-section { margin-bottom: 1rem; padding: 1rem; background-color: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 0.375rem; }
        .day-plan h4, .weekly-day-section h4 { margin-top: 0; color: #4B5563; font-weight: 600; font-size: 1rem; }
        .task-entry { border-bottom: 1px dashed #E5E7EB; padding-bottom: 1rem; margin-bottom: 1rem; }
        .task-entry:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .task-entry .controls-container { display: grid; grid-template-columns: auto auto 1fr; gap: 0.75rem; align-items: flex-end; } /* Grid for task entry */
        .task-entry label { font-size: 0.8rem; } /* Smaller labels inside task entry */

        .weekly-task-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;}
        .weekly-task-row span { flex-grow: 1; font-size: 0.95rem; color: #374151; }
        .weekly-day-section .no-data { color: #6B7280; font-size: 0.9em; text-align: center; margin: 1rem 0; }
        .weekly-day-section .add-row { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #E5E7EB; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; }
        .weekly-day-section .add-row select, .weekly-day-section .add-row input { flex: 1 1 150px; } /* Flexible inputs */
        .weekly-day-section .add-row .btn { flex-shrink: 0; } /* Prevent button shrinking */

        /* Image Modal */
        #imagePreview { display: none; max-width: 100%; max-height: 300px; margin-top: 1rem; border-radius: 0.375rem; border: 1px solid #E5E7EB; object-fit: contain; }

        /* === Google Embeds === */
        .google-embed-container h2 { font-size: 1.125rem; }
        #googleCalendarEmbed { width: 100%; height: 600px; border: none; border-radius: 0.375rem; }
        #googleTasksPlaceholder p { font-size: 0.95rem; color: #4B5563; margin-bottom: 0.5rem; }

        /* === Footer === */
        #footer { margin-top: 3rem; padding: 1.5rem 1rem; border-top: 1px solid #E5E7EB; font-size: 0.875rem; color: #6B7280; text-align: center; }
        #footer code { background-color: #F3F4F6; padding: 0.15em 0.4em; border-radius: 3px; font-size: 0.9em; color: #4B5563;}

        /* === Responsive Adjustments === */
        @media (max-width: 768px) {
             h1 { font-size: 1.5rem; } h2 { font-size: 1.125rem; } h3 { font-size: 1rem; }
             .client-info .info-row { grid-template-columns: 1fr; } /* Stack label/input */
             .client-info label { text-align: left; }
             #bigGoalDisplay { font-size: 1.125rem; }
             .card { padding: 1rem; }
        }
        @media (max-width: 600px) {
             html { font-size: 15px; }
             body { padding-top: 1rem; }
             .container { padding: 0 0.75rem; }
             h1 { margin-bottom: 1.5rem; }
             .controls-grid { grid-template-columns: 1fr; } /* Stack all controls */
             .controls-button-group { flex-direction: column; align-items: stretch; }
             .controls-button-group .btn { width: 100%; margin: 0.25rem 0; }
             th, td { padding: 0.75rem 0.5rem; font-size: 0.9rem; }
             th:nth-child(4), td:nth-child(4), th:nth-child(5), td:nth-child(5) { /* Rating, Actions */ }
             .modal-content, .weekly-modal-content, .image-modal-content { padding: 1.5rem 1rem; margin: 2vh auto; }
             /* Modal Footer for mobile */
             .modal-footer,
             #plannerModal .modal-content > div:last-of-type:not(#plannerDays),
             #weeklyModal .weekly-modal-content > div:last-of-type:not(#weeklyContent),
             #imageModal .image-modal-content > div:last-of-type:not([style*="margin-top"]) {
                  flex-direction: column-reverse; align-items: stretch;
             }
             .modal-footer .btn,
             #plannerModal .modal-content > div:last-of-type:not(#plannerDays) button,
             #weeklyModal .weekly-modal-content > div:last-of-type:not(#weeklyContent) button,
             #imageModal .image-modal-content > div:last-of-type:not([style*="margin-top"]) button {
                  width: 100%; margin: 0.25rem 0;
             }
             #googleCalendarEmbed { height: 450px; }
             .task-entry .controls-container { grid-template-columns: 1fr; }
             .weekly-day-section .add-row { flex-direction: column; align-items: stretch; }
             .weekly-day-section .add-row .btn { margin-top: 0.5rem; }
        }
    </style>
</head>
<body>

    <h1>Client Tracker Dashboard</h1>

    <div class="container">

        <div class="card controls-grid">
            <!-- Client Selection -->
            <div>
                <label for="clientSelect">Client:</label>
                <select id="clientSelect"></select>
            </div>
            <!-- Add Client Button -->
            <div style="align-self: flex-end;">
                 <button class="btn btn-secondary" id="addClientBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em" style="margin-right: 0.4em;"> <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /> </svg> <!-- Updated Plus Icon -->
                    Add Client
                 </button>
            </div>
            <!-- Date Selection -->
            <div>
                <label for="datePicker">Date:</label>
                <input type="date" id="datePicker" />
            </div>
            <!-- Action Buttons Group -->
            <div class="controls-button-group">
                <button class="btn btn-secondary" id="exportBtn" title="Export all client data to a JSON file">Export Data</button>
                <button class="btn btn-secondary" id="reportBtn" title="Generate an HTML report for the current client">View Report</button>
                <button class="btn btn-secondary" id="multiDayPlanBtn" title="Plan tasks across multiple upcoming days">Multi-Day Plan</button>
                <button class="btn btn-secondary" id="weeklyPlanBtn" title="Set recurring weekly tasks">Weekly Plan</button>
                <button class="btn btn-secondary" id="imageBtn" title="Add an image or screenshot">Add Image</button>
                <button class="btn btn-danger" id="clearTasksBtn" title="Clear tasks for this client on this date">Clear Tasks</button> <!-- Moved Clear Tasks -->
            </div>
        </div>


        <!-- Form for adding a new client -->
        <div id="newClientForm" class="card">
          <label for="newClientName">New Client Name:</label>
          <input type="text" id="newClientName" placeholder="Enter client name">
          <button class="btn btn-secondary" id="cancelClientBtn">Cancel</button>
          <button class="btn btn-primary" id="saveClientBtn">Save</button>
        </div>

        <!-- Show or edit the Big Goal, Canvas link, and Classroom link -->
        <div class="card client-info">
             <h3>Client Information</h3>
            <div class="info-row">
                <label for="bigGoalInput">Big Goal:</label>
                <input type="text" id="bigGoalInput" placeholder="e.g., Improve Organization Skills">
            </div>
            <div class="info-row">
                <label for="canvasLinkInput">Canvas Link:</label>
                <input type="text" id="canvasLinkInput" placeholder="https://...">
            </div>
            <div class="info-row">
                <label for="classroomLinkInput">Classroom Link:</label>
                <input type="text" id="classroomLinkInput" placeholder="https://...">
            </div>
            <div style="grid-column: 2 / 3; margin-top: 0.5rem;">
                 <button class="btn btn-primary" id="saveClientInfoBtn">Save Client Info</button>
            </div>
        </div>

        <!-- Big Goal displayed prominently -->
        <div id="bigGoalDisplay">(Select a client)</div>

        <!-- External links displayed -->
        <div class="external-links">
          <a href="#" id="canvasLinkAnchor" target="_blank" rel="noopener noreferrer" style="display:none;">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.665l3-3z" /> <path d="M8.603 14.53a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 005.656 5.656l3-3a4 4 0 00-.225-5.865.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.665l-3 3z" /> </svg>
             Canvas
          </a>
          <a href="#" id="classroomLinkAnchor" target="_blank" rel="noopener noreferrer" style="display:none;">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.665l3-3z" /> <path d="M8.603 14.53a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 005.656 5.656l3-3a4 4 0 00-.225-5.865.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.665l-3 3z" /> </svg>
             Classroom
          </a>
        </div>

        <!-- Add New Task Section -->
        <div class="card add-task-section">
            <h2>Add New Task</h2>
            <div class="time-duration-container">
            <div>
                <label for="timeSelect">Time:</label>
                <select id="timeSelect"></select>
            </div>
            <div>
                <label for="durationSelect">Duration:</label>
                <select id="durationSelect">
                    <option value="5 min">5 min</option> <option value="10 min">10 min</option> <option value="15 min">15 min</option>
                    <option value="30 min" selected>30 min</option> <option value="45 min">45 min</option> <option value="1 hour">1 hour</option>
                    <option value="90 min">90 min</option> <option value="2 hours">2 hours</option>
                </select>
            </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <label for="activityInput">Activity:</label>
                <input type="text" id="activityInput" placeholder="e.g., Plan history essay outline" />
            </div>
            <div style="margin-bottom: 1rem;">
                 <label for="taskSearch">Search Tasks:</label>
                <input type="text" id="taskSearch" placeholder="Filter tasks in table..." title="Filter tasks in the table below">
            </div>
            <button class="btn btn-primary" id="addBtn" title="Add task to the table (Alt+A)">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em" style="margin-right: 0.4em;"> <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /> </svg> <!-- Different Plus Icon -->
                Add Task
            </button>
        </div>


        <!-- Task Table -->
         <div class="card" style="padding: 0;">
             <div class="table-wrapper">
                <table id="taskTable">
                  <thead>
                    <tr>
                      <th style="width:20%;">Time & Duration</th>
                      <th style="width:40%;">Activity</th>
                      <th style="width:8%;">Done</th>
                      <th style="width:12%;">Rating</th>
                      <th style="width:20%; text-align: right;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="5" class="text-center no-data">(No tasks added yet)</td></tr>
                  </tbody>
                </table>
             </div>
        </div>

        <!-- Image gallery area -->
        <div class="card" id="imageGallery">
            <h3>Image Gallery</h3>
            <p class="no-data text-center">(No images added)</p>
        </div>


        <!-- Reflection Section -->
        <div class="card reflection-section">
            <h3>Daily Reflection</h3>
            <div class="reflection-item" style="max-width: 150px; margin-bottom: 1rem;">
              <label for="dayRatingSelect">Day Rating (1–5):</label>
              <select id="dayRatingSelect"> <option value="0">--</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> </select>
            </div>
            <div class="reflection-item">
              <label for="dayNotes">Reflection Notes:</label>
              <textarea id="dayNotes" rows="4" placeholder="How did the day go? Insights? Challenges? Next steps?"></textarea>
            </div>
        </div>


        <!-- Progress Dashboard -->
        <div class="card" id="progressDashboard">
          <h3>Progress Dashboard</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
              <div> <p><strong>Task Completion (Today):</strong> <span id="completionRate">-</span></p> <div class="progress-bar-container"> <div id="completionBar" class="progress-bar" style="width: 0%"></div> </div> </div>
              <div> <p><strong>Avg Day Rating (Overall):</strong> <span id="avgDayRatingUpToDate">-</span></p> <div class="progress-bar-container"> <div id="avgRatingBar" class="progress-bar avg-rating" style="width: 0%;"></div> </div> </div>
              <div> <p><strong>Avg Task Rating (Today):</strong> <span id="averageTaskRating">-</span></p> </div>
              <div> <p><strong>Day Rating (Today):</strong> <span id="displayDayRating">-</span></p> </div>
          </div>
        </div>

        <!-- Google Embeds Section -->
        <div class="google-embed-container">
            <h2>Google Calendar</h2>
            <div class="card">
                <p style="font-size: 0.9em; color: #6B7280; margin-top: 0; margin-bottom: 0.5em;"> Replace 'YOUR_CALENDAR_ID_HERE' below. </p>
                <iframe id="googleCalendarEmbed" src="https://calendar.google.com/calendar/embed?src=YOUR_CALENDAR_ID_HERE&ctz=America%2FNew_York" frameborder="0" scrolling="no"> </iframe>
            </div>
        </div>
        <div class="google-embed-container">
            <h2>Google Tasks</h2>
            <div id="googleTasksPlaceholder" class="card">
              <p style="margin-top:0;"> <strong>Note:</strong> Direct Google Tasks embedding requires complex setup. </p> <p>Use Google Tasks in a separate tab/window.</p>
            </div>
        </div>

        <div id="footer">
          <p>Client data stored locally via <code>localStorage</code>.</p>
          <p><em>Save file structure. Use Export/Import for backup.</em></p>
        </div>

    </div> <!-- End of .container -->


    <!-- === MODALS === -->
    <div id="plannerModal"> <div class="modal-content"> <h3>Multi-Day Planner</h3> <p style="color: #4B5563;">For: <strong><span id="plannerClientLabel"></span></strong></p> <hr style="margin: 1rem 0;" /> <div id="plannerDays" style="max-height: 50vh; overflow-y: auto; margin-bottom: 1rem; padding-right: 0.5rem;"></div> <button class="btn btn-secondary" id="addDayBtn" style="margin-bottom: 1rem;">+ Add Day</button> <div> <button class="btn btn-secondary" id="cancelPlanBtn">Cancel</button> <button class="btn btn-primary" id="savePlanBtn">Save Plan</button> </div> </div> </div>
    <div id="weeklyModal"> <div class="weekly-modal-content"> <h3>Weekly Planner</h3> <p style="color: #4B5563;">For: <span id="weeklyClientLabel"></span></p> <hr style="margin: 1rem 0;" /> <div id="weeklyContent" style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;"></div> <div> <button class="btn btn-secondary" id="cancelWeeklyBtn">Cancel</button> <button class="btn btn-primary" id="saveWeeklyBtn">Done</button> </div> </div> </div>
    <div id="imageModal"> <div class="image-modal-content"> <h3>Add Image</h3> <p style="color: #4B5563;">For: <strong><span id="imageClientLabel"></span></strong></p> <hr style="margin: 1rem 0;" /> <div style="margin-bottom: 1rem;"> <label for="imageFileInput">Select File:</label> <input type="file" id="imageFileInput" accept="image/*"> <p style="color:#6B7280;font-size:0.9em; margin-top: 0.5em;"> Or paste image (Ctrl+V / Cmd+V). </p> </div> <img id="imagePreview" src="#" alt="Preview"> <div style="margin-top: 1rem;"> <label for="imageTitle">Title (Optional):</label> <input type="text" id="imageTitle" placeholder="Description..."> </div> <div> <button class="btn btn-secondary" id="cancelImageBtn">Cancel</button> <button class="btn btn-primary" id="saveImageBtn">Save Image</button> </div> </div> </div>


    <script>
        // === START OF JAVASCRIPT ===

        const STORAGE_KEY = "clientTrackerData_v2"; // Updated key maybe
        let allData = {};
        let currentClient = null;
        let currentDate   = null;

        // --- DOM Elements (Simplified for brevity in comment, full list used below) ---
        const clientSelect = document.getElementById("clientSelect");
        const addClientBtn = document.getElementById("addClientBtn");
        // ... (all other const declarations from previous JS needed here)

        const datePicker          = document.getElementById("datePicker");
        const clearTasksBtn       = document.getElementById("clearTasksBtn");
        const exportBtn           = document.getElementById("exportBtn");
        const reportBtn           = document.getElementById("reportBtn");
        const multiDayPlanBtn     = document.getElementById("multiDayPlanBtn");
        const weeklyPlanBtn       = document.getElementById("weeklyPlanBtn");
        const imageBtn            = document.getElementById("imageBtn");
        const newClientForm       = document.getElementById("newClientForm");
        const newClientName       = document.getElementById("newClientName");
        const saveClientBtn       = document.getElementById("saveClientBtn");
        const cancelClientBtn     = document.getElementById("cancelClientBtn");
        const bigGoalInput        = document.getElementById("bigGoalInput");
        const canvasLinkInput     = document.getElementById("canvasLinkInput");
        const classroomLinkInput  = document.getElementById("classroomLinkInput");
        const saveClientInfoBtn   = document.getElementById("saveClientInfoBtn");
        const bigGoalDisplay      = document.getElementById("bigGoalDisplay");
        const canvasLinkAnchor    = document.getElementById("canvasLinkAnchor");
        const classroomLinkAnchor = document.getElementById("classroomLinkAnchor");
        const timeSelect          = document.getElementById("timeSelect");
        const durationSelect      = document.getElementById("durationSelect");
        const activityInput       = document.getElementById("activityInput");
        const taskSearch          = document.getElementById("taskSearch");
        const addBtn              = document.getElementById("addBtn");
        const taskTableBody       = document.getElementById("taskTable").querySelector("tbody");
        const dayRatingSelect     = document.getElementById("dayRatingSelect");
        const dayNotesTextarea    = document.getElementById("dayNotes");
        const imageGallery        = document.getElementById("imageGallery");
        const completionRateEl       = document.getElementById("completionRate");
        const completionBarEl        = document.getElementById("completionBar");
        const averageTaskRatingEl    = document.getElementById("averageTaskRating");
        const displayDayRatingEl     = document.getElementById("displayDayRating");
        const avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate");
        const avgRatingBarEl         = document.getElementById("avgRatingBar");
        const plannerModal        = document.getElementById("plannerModal");
        const plannerClientLabel  = document.getElementById("plannerClientLabel");
        const plannerDays         = document.getElementById("plannerDays");
        const addDayBtn           = document.getElementById("addDayBtn");
        const savePlanBtn         = document.getElementById("savePlanBtn");
        const cancelPlanBtn       = document.getElementById("cancelPlanBtn");
        const weeklyModal         = document.getElementById("weeklyModal");
        const weeklyClientLabel   = document.getElementById("weeklyClientLabel");
        const weeklyContent       = document.getElementById("weeklyContent");
        const saveWeeklyBtn       = document.getElementById("saveWeeklyBtn");
        const cancelWeeklyBtn     = document.getElementById("cancelWeeklyBtn");
        const imageModal          = document.getElementById("imageModal");
        const imageClientLabel    = document.getElementById("imageClientLabel");
        const imageFileInput      = document.getElementById("imageFileInput");
        const imagePreview        = document.getElementById("imagePreview");
        const imageTitleInput     = document.getElementById("imageTitle");
        const saveImageBtn        = document.getElementById("saveImageBtn");
        const cancelImageBtn      = document.getElementById("cancelImageBtn");

        // --- SVG Icons ---
        const editIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em"> <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /> <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /> </svg>`;
        const deleteIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em"> <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /> </svg>`;


        // --- Initialization ---
        window.addEventListener("load", () => {
          try { const stored = localStorage.getItem(STORAGE_KEY); if (stored) { allData = JSON.parse(stored); if (typeof allData !== 'object' || allData === null) { console.warn("Invalid data, resetting."); allData = {}; } } else { allData = {}; } } catch (error) { console.error("Load error:", error); alert("Could not load data."); allData = {}; }
          populateClientSelect(); const todayStr = new Date().toISOString().split("T")[0]; datePicker.value = todayStr; currentDate = todayStr; const clientNames = Object.keys(allData).sort(); if (clientNames.length > 0) { currentClient = clientNames[0]; clientSelect.value = currentClient; loadClientDate(currentClient, currentDate); } else { currentClient = null; bigGoalDisplay.textContent = "(Add client)"; taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(Add client/date)</td></tr>'; imageGallery.innerHTML = '<p class="no-data text-center">(No images)</p>'; } populateTimeDropdown(); setupEventListeners();
        });

        // --- Event Listeners Setup ---
        function setupEventListeners() {
          clientSelect.addEventListener("change", onClientOrDateChange); datePicker.addEventListener("change", onClientOrDateChange);
          addClientBtn.addEventListener("click", showNewClientForm); saveClientBtn.addEventListener("click", saveNewClient); cancelClientBtn.addEventListener("click", hideNewClientForm);
          saveClientInfoBtn.addEventListener("click", saveClientInfo); addBtn.addEventListener("click", addNewTask); clearTasksBtn.addEventListener("click", clearTasksForClientDate); exportBtn.addEventListener("click", exportData); reportBtn.addEventListener("click", generateReport);
          dayRatingSelect.addEventListener("change", onDayRatingChange); dayNotesTextarea.addEventListener("input", onDayNotesChange);
          multiDayPlanBtn.addEventListener("click", openPlannerModal); addDayBtn.addEventListener("click", addPlannerDay); savePlanBtn.addEventListener("click", saveMultiDayPlan); cancelPlanBtn.addEventListener("click", closePlannerModal);
          weeklyPlanBtn.addEventListener("click", openWeeklyModal); saveWeeklyBtn.addEventListener("click", saveWeeklySchedule); cancelWeeklyBtn.addEventListener("click", closeWeeklyModal);
          imageBtn.addEventListener("click", openImageModal); cancelImageBtn.addEventListener("click", closeImageModal); saveImageBtn.addEventListener("click", saveImage); imageModal.addEventListener("paste", handlePasteImage); imageFileInput.addEventListener("change", handleFileInputChange);
          taskSearch.addEventListener("input", filterTaskTable);
          document.addEventListener("keydown", handleKeyboardShortcuts);
        }

        function handleKeyboardShortcuts(e) {
            const activeEl = document.activeElement; const isInputFocused = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT');
            if (e.key === "Escape") { if (plannerModal.style.display === "block") closePlannerModal(); else if (weeklyModal.style.display === "block") closeWeeklyModal(); else if (imageModal.style.display === "block") closeImageModal(); else if (newClientForm.style.display === "flex") hideNewClientForm(); else if (isInputFocused) activeEl.blur(); return; }
            if (isInputFocused && activeEl !== taskSearch) return;
            if (e.altKey && e.key === "a") { e.preventDefault(); if (document.activeElement === activityInput && activityInput.value.trim() !== '') { addNewTask(); } else { activityInput.focus(); } }
            if (e.altKey && e.key === "d") { e.preventDefault(); const lastRow = taskTableBody.querySelector("tr.task-row:last-child"); if (lastRow) { const checkbox = lastRow.querySelector("input[type='checkbox']"); if (checkbox) { checkbox.checked = !checkbox.checked; checkbox.dispatchEvent(new Event("change")); } } }
            if (e.altKey && e.key === "s") { e.preventDefault(); sortTasksByTime(); const table = document.getElementById('taskTable'); table.style.transition = 'background-color 0.1s ease-out'; table.style.backgroundColor = '#EFF6FF'; setTimeout(() => { table.style.backgroundColor = ''; }, 200); }
        }

        // --- Client Management ---
        function populateClientSelect() { clientSelect.innerHTML = ""; const clientNames = Object.keys(allData).sort(); const hasClients = clientNames.length > 0; clientSelect.disabled = !hasClients; multiDayPlanBtn.disabled = !hasClients; weeklyPlanBtn.disabled = !hasClients; imageBtn.disabled = !hasClients; reportBtn.disabled = !hasClients; clearTasksBtn.disabled = !hasClients; saveClientInfoBtn.disabled = !hasClients; if (!hasClients) { const opt = document.createElement("option"); opt.textContent = "-- No Clients --"; opt.value = ""; clientSelect.appendChild(opt); } else { clientNames.forEach(name => { const opt = document.createElement("option"); opt.value = name; opt.textContent = name; clientSelect.appendChild(opt); }); } }
        function showNewClientForm() { newClientForm.style.display = "flex"; newClientName.value = ""; newClientName.focus(); }
        function hideNewClientForm() { newClientForm.style.display = "none"; }
        function saveNewClient() { const name = newClientName.value.trim(); if (!name) { alert("Enter name."); return; } if (allData[name]) { alert(`Client "${name}" exists.`); return; } allData[name] = { bigGoal: "", links: { canvas: "", classroom: "" }, weeklyTasks: { monday: [], tuesday: [], wednesday: [], thursday: [], friday: [], saturday: [], sunday: [] }, images: [] }; saveToLocalStorage(); populateClientSelect(); clientSelect.value = name; currentClient = name; currentDate = datePicker.value; loadClientDate(currentClient, currentDate); hideNewClientForm(); }
        function saveClientInfo() { if (!currentClient) { alert("Select client."); return; } const cliData = allData[currentClient]; if (!cliData) return; cliData.bigGoal = bigGoalInput.value.trim(); if (!cliData.links) cliData.links = {}; cliData.links.canvas = canvasLinkInput.value.trim(); cliData.links.classroom = classroomLinkInput.value.trim(); saveToLocalStorage(); renderClientInfo(); const btn = saveClientInfoBtn; const originalText = btn.textContent; btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em" style="margin-right: 0.4em;"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg> Saved!`; btn.style.backgroundColor = '#10B981'; btn.disabled = true; setTimeout(() => { btn.textContent = originalText; btn.style.backgroundColor = ''; btn.disabled = false; }, 1500); } // Green check icon
        function renderClientInfo() { if (!currentClient || !allData[currentClient]) { bigGoalDisplay.textContent = "(Select client)"; bigGoalInput.value = ""; canvasLinkInput.value = ""; classroomLinkInput.value = ""; canvasLinkAnchor.style.display = "none"; classroomLinkAnchor.style.display = "none"; return; } const cliData = allData[currentClient]; bigGoalDisplay.textContent = cliData.bigGoal || "(No Big Goal Set)"; bigGoalInput.value = cliData.bigGoal || ""; const links = cliData.links || {}; canvasLinkAnchor.style.display = (links.canvas && links.canvas.startsWith('http')) ? "inline-flex" : "none"; if (links.canvas) canvasLinkAnchor.href = links.canvas; canvasLinkInput.value = links.canvas || ""; classroomLinkAnchor.style.display = (links.classroom && links.classroom.startsWith('http')) ? "inline-flex" : "none"; if (links.classroom) classroomLinkAnchor.href = links.classroom; classroomLinkInput.value = links.classroom || ""; }

        // --- Core Data Loading & Display ---
        function onClientOrDateChange() { currentClient = clientSelect.value; currentDate = datePicker.value; if (currentClient && currentDate) { loadClientDate(currentClient, currentDate); } else { taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(Select client/date)</td></tr>'; renderClientInfo(); resetReflectionFields(); resetProgressDashboard(); imageGallery.innerHTML = '<p class="no-data text-center">(No images)</p>'; } }
        function loadClientDate(clientName, dateStr) { if (!clientName || !dateStr) return; if (!allData[clientName]) { allData[clientName] = { bigGoal: "", links: {}, weeklyTasks: {}, images: [] }; } if (!allData[clientName][dateStr]) { allData[clientName][dateStr] = { dayRating: "0", dayNotes: "", tasks: [], weeklyDone: {} }; } const clientData = allData[clientName]; const dayRecord = clientData[dateStr]; renderClientInfo(); dayRatingSelect.value = dayRecord.dayRating || "0"; dayNotesTextarea.value = dayRecord.dayNotes || ""; renderTaskTable(clientData, dayRecord, dateStr); renderImageGallery(); updateProgress(); taskSearch.value = ""; filterTaskTable(); }
        function renderTaskTable(clientData, dayRecord, dateStr) { taskTableBody.innerHTML = ""; const dailyTasks = dayRecord.tasks || []; const weekday = getWeekdayFromDate(dateStr); const weeklyTaskList = clientData.weeklyTasks && clientData.weeklyTasks[weekday] ? clientData.weeklyTasks[weekday] : []; const weeklyDoneMap = dayRecord.weeklyDone || {}; const allTasksToRender = []; dailyTasks.forEach(task => allTasksToRender.push({ ...task, taskType: 'daily' })); weeklyTaskList.forEach(wTask => allTasksToRender.push({ ...wTask, completed: !!weeklyDoneMap[wTask.id], rating: "0", taskType: 'weekly' })); allTasksToRender.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); if (allTasksToRender.length === 0) { taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(No tasks scheduled)</td></tr>'; } else { allTasksToRender.forEach(task => addTaskRow(task, task.taskType)); } }
        function resetReflectionFields() { dayRatingSelect.value = "0"; dayNotesTextarea.value = ""; }
        function resetProgressDashboard() { completionRateEl.textContent = "-"; completionBarEl.style.width = "0%"; averageTaskRatingEl.textContent = "-"; displayDayRatingEl.textContent = "-"; avgDayRatingUpToDateEl.textContent = "-"; avgRatingBarEl.style.width = "0%"; }

        // --- Reflection ---
        function onDayRatingChange() { if (!currentClient || !currentDate) return; const rec = getDayRecord(); if (!rec) return; rec.dayRating = dayRatingSelect.value; saveToLocalStorage(); updateProgress(); }
        const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; };
        const debouncedSaveNotes = debounce(() => { if (!currentClient || !currentDate) return; const rec = getDayRecord(); if (!rec) return; rec.dayNotes = dayNotesTextarea.value; saveToLocalStorage(); }, 500);
        function onDayNotesChange() { debouncedSaveNotes(); }
        function getDayRecord() { if (!currentClient || !currentDate || !allData[currentClient]) return null; if (!allData[currentClient][currentDate]) { allData[currentClient][currentDate] = { dayRating: "0", dayNotes: "", tasks: [], weeklyDone: {} }; } return allData[currentClient][currentDate]; }

        // --- Time Dropdown ---
        function populateTimeDropdown() { timeSelect.innerHTML = ""; for (let h = 5; h < 24; h++) { for (let m = 0; m < 60; m += 15) { const d=new Date(); d.setHours(h,m); const l=d.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true}); const o=document.createElement("option"); o.value=l; o.textContent=l; timeSelect.appendChild(o); } } const s=document.createElement("option"); s.disabled=true; s.textContent="──────────"; timeSelect.appendChild(s); const cT=["Before School", "Study Hall", "Lunch", "After School", "Before Dinner", "After Dinner", "Before Bed"]; cT.forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t; timeSelect.appendChild(o);}); const dF="3:00 PM"; if(Array.from(timeSelect.options).some(o=>o.value===dF)) timeSelect.value=dF; } // Condensed slightly

        // --- Task Management ---
        function addNewTask() { if (!currentClient || !currentDate) { alert("Select client/date."); return; } const t = timeSelect.value; const a = activityInput.value.trim(); const d = durationSelect.value; if (!a) { alert("Enter activity."); activityInput.focus(); return; } const rec = getDayRecord(); if (!rec) return; if (!rec.tasks) rec.tasks = []; const nT = { id: `task_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, time: t, activity: a, completed: false, rating: "0", duration: d }; rec.tasks.push(nT); saveToLocalStorage(); renderTaskTable(allData[currentClient], rec, currentDate); activityInput.value = ""; activityInput.focus(); updateProgress(); }
        function addTaskRow(taskObj, taskType) { const row = taskTableBody.insertRow(); row.className = "task-row"; row.dataset.taskId = taskObj.id; row.dataset.taskType = taskType; row.dataset.timeValue = convertTimeToMinutes(taskObj.time); if (taskObj.completed) row.classList.add("completed-task"); const tdTime = row.insertCell(0); tdTime.innerHTML = escapeHtml(taskObj.time); if (taskObj.duration) tdTime.innerHTML += `<br><span style="font-size:0.8em; color: #6B7280;">${escapeHtml(taskObj.duration)}</span>`; if (taskType === 'weekly') tdTime.innerHTML += `<span class="weekly-indicator">(Weekly)</span>`; const tdAct = row.insertCell(1); tdAct.textContent = taskObj.activity; const tdDone = row.insertCell(2); const chk = document.createElement("input"); chk.type = "checkbox"; chk.checked = taskObj.completed; chk.title = "Mark done/undone"; chk.className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"; /* Style checkbox */ chk.addEventListener("change", () => { row.classList.toggle("completed-task", chk.checked); if (taskType === 'daily') { const dayRec = getDayRecord(); const task = dayRec?.tasks?.find(t => t.id === taskObj.id); if (task) task.completed = chk.checked; } else if (taskType === 'weekly') { const dayRec = getDayRecord(); if (!dayRec.weeklyDone) dayRec.weeklyDone = {}; dayRec.weeklyDone[taskObj.id] = chk.checked; } saveToLocalStorage(); updateProgress(); }); tdDone.appendChild(chk); const tdRating = row.insertCell(3); if (taskType === 'daily') { const sel = document.createElement("select"); sel.title = "Rate task (1-5)"; for (let i = 0; i <= 5; i++) { const opt = document.createElement("option"); opt.value = i; opt.text = i === 0 ? "–" : i.toString(); sel.appendChild(opt); } sel.value = taskObj.rating || "0"; sel.addEventListener("change", () => { const dayRec = getDayRecord(); const task = dayRec?.tasks?.find(t => t.id === taskObj.id); if (task) task.rating = sel.value; saveToLocalStorage(); updateProgress(); }); tdRating.appendChild(sel); } else { tdRating.innerHTML = `<span class="no-data">–</span>`; } const tdActions = row.insertCell(4); tdActions.style.textAlign = 'right'; if (taskType === 'daily') { const editBtn = document.createElement("button"); editBtn.innerHTML = editIconSVG; editBtn.className = "btn btn-icon"; editBtn.title = "Edit task"; editBtn.addEventListener("click", (e) => { e.stopPropagation(); makeTaskEditable(row, taskObj); }); tdActions.appendChild(editBtn); const rmBtn = document.createElement("button"); rmBtn.innerHTML = deleteIconSVG; rmBtn.className = "btn btn-icon btn-icon-delete"; rmBtn.title = "Delete task"; rmBtn.addEventListener("click", (e) => { e.stopPropagation(); if (confirm(`Delete task: "${taskObj.activity}"?`)) { removeTask(taskObj); row.remove(); updateProgress(); if (taskTableBody.querySelectorAll('tr.task-row').length === 0) { taskTableBody.innerHTML = '<tr><td colspan="5" class="text-center no-data">(No tasks)</td></tr>'; } } }); tdActions.appendChild(rmBtn); } } // No action for weekly row display
        function makeTaskEditable(row, taskObj) { const currentlyEditing = taskTableBody.querySelector('.editing-task-row'); if (currentlyEditing && currentlyEditing !== row) { const otherCancelBtn = currentlyEditing.querySelector('.btn-cancel-edit'); if (otherCancelBtn) otherCancelBtn.click(); } row.classList.add('editing-task-row'); const tdTime = row.cells[0]; const tdAct = row.cells[1]; const tdRating = row.cells[3]; const tdActions = row.cells[4]; tdTime.innerHTML = ""; const timeDurContainer = document.createElement('div'); timeDurContainer.style.display = 'flex'; timeDurContainer.style.flexDirection = 'column'; timeDurContainer.style.gap = '4px'; const newTimeSel = document.createElement("select"); newTimeSel.style.marginBottom = '0'; populateTempTimeDropdown(newTimeSel, taskObj.time); timeDurContainer.appendChild(newTimeSel); const newDurSel = document.createElement("select"); newDurSel.style.marginBottom = '0'; ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => { const opt = document.createElement("option"); opt.value = d; opt.text = d; newDurSel.appendChild(opt); }); newDurSel.value = taskObj.duration || "30 min"; timeDurContainer.appendChild(newDurSel); tdTime.appendChild(timeDurContainer); tdAct.innerHTML = ""; const actInput = document.createElement("input"); actInput.type = "text"; actInput.value = taskObj.activity; actInput.style.width = "100%"; actInput.style.marginBottom = '0'; tdAct.appendChild(actInput); actInput.focus(); actInput.select(); tdRating.innerHTML = ""; tdActions.innerHTML = ""; const saveBtn = document.createElement("button"); saveBtn.textContent = "Save"; saveBtn.className = "btn btn-primary"; saveBtn.style.fontSize = '0.85em'; saveBtn.style.padding = '0.3em 0.6em'; saveBtn.addEventListener("click", (e) => { e.stopPropagation(); const newTime = newTimeSel.value; const newActivity = actInput.value.trim(); const newDuration = newDurSel.value; if (!newActivity) { alert("Activity empty."); actInput.focus(); return; } const dayRec = getDayRecord(); const taskIndex = dayRec?.tasks?.findIndex(t => t.id === taskObj.id); if (taskIndex !== undefined && taskIndex > -1) { dayRec.tasks[taskIndex].time = newTime; dayRec.tasks[taskIndex].activity = newActivity; dayRec.tasks[taskIndex].duration = newDuration; saveToLocalStorage(); taskObj.time = newTime; taskObj.activity = newActivity; taskObj.duration = newDuration; renderTaskTable(allData[currentClient], dayRec, currentDate); updateProgress(); } else { console.error("Failed find task:", taskObj.id); renderTaskTable(allData[currentClient], getDayRecord(), currentDate); } }); tdActions.appendChild(saveBtn); const cancelBtn = document.createElement("button"); cancelBtn.textContent = "Cancel"; cancelBtn.className = "btn btn-secondary btn-cancel-edit"; cancelBtn.style.fontSize = '0.85em'; cancelBtn.style.padding = '0.3em 0.6em'; cancelBtn.addEventListener("click", (e) => { e.stopPropagation(); const currentScroll = window.scrollY; renderTaskTable(allData[currentClient], getDayRecord(), currentDate); window.scrollTo(0, currentScroll); }); tdActions.appendChild(cancelBtn); }
        function populateTempTimeDropdown(selectElem, currentVal) { const masterOptions = timeSelect.options; for (let i = 0; i < masterOptions.length; i++){ const clone = masterOptions[i].cloneNode(true); selectElem.appendChild(clone); } if (Array.from(selectElem.options).some(opt => opt.value === currentVal)) { selectElem.value = currentVal; } }
        function sortTasksByTimeInData() { if (!currentClient || !currentDate) return; const rec = getDayRecord(); if (!rec || !rec.tasks || rec.tasks.length < 2) return; rec.tasks.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); saveToLocalStorage(); }
        function sortTasksByTime() { sortTasksByTimeInData(); if (currentClient && currentDate) { const dayRec = getDayRecord(); renderTaskTable(allData[currentClient], dayRec, currentDate); } }
        function convertTimeToMinutes(timeStr) { if (!timeStr) return 9999; const sT = { "Before School": 360, "Study Hall": 600, "Lunch": 720, "After School": 930, "Before Dinner": 1080, "After Dinner": 1200, "Before Bed": 1320 }; if (sT[timeStr] !== undefined) return sT[timeStr]; const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i); if (match) { let h = parseInt(match[1], 10); const m = parseInt(match[2], 10); const ampm = match[3].toUpperCase(); if (isNaN(h) || isNaN(m)) return 9999; if (ampm === "PM" && h < 12) h += 12; if (ampm === "AM" && h === 12) h = 0; return h * 60 + m; } return 9999; } // Condensed special times
        function removeTask(taskObj) { const rec = getDayRecord(); if (!rec || !rec.tasks) return; const idx = rec.tasks.findIndex(task => task.id === taskObj.id); if (idx !== -1) { rec.tasks.splice(idx, 1); saveToLocalStorage(); } else { console.warn("Task not found:", taskObj.id); } }
        function clearTasksForClientDate() { if (!currentClient || !currentDate) { alert("Select client/date."); return; } if (confirm(`DELETE ALL daily tasks for ${currentClient} on ${currentDate}?`)) { const rec = getDayRecord(); if (rec) { rec.tasks = []; saveToLocalStorage(); renderTaskTable(allData[currentClient], rec, currentDate); updateProgress(); } } }
        function filterTaskTable() { const s = taskSearch.value.toLowerCase().trim(); const rows = taskTableBody.querySelectorAll("tr.task-row"); let match = false; rows.forEach(r => { const aT = r.cells[1]?.textContent.toLowerCase() || ""; const tT = r.cells[0]?.textContent.toLowerCase() || ""; const v = aT.includes(s) || tT.includes(s); r.style.display = v ? "" : "none"; if (v) match = true; }); let nR = taskTableBody.querySelector('.no-match-row'); if (!match && s !== '' && rows.length > 0) { if (!nR) { nR = taskTableBody.insertRow(); nR.className = 'no-match-row'; const c = nR.insertCell(0); c.colSpan = 5; c.textContent = "No tasks match search."; c.className = 'text-center no-data'; } } else { if (nR) nR.remove(); } }

        // --- Export & Report --- (Keeping existing functions, should work with new styles)
        function exportData() { if (Object.keys(allData).length === 0) { alert("No data."); return; } try { const dS = JSON.stringify(allData, null, 2); const dB = new Blob([dS], {type: "application/json;charset=utf-8"}); const fN = `client-tracker-export-${new Date().toISOString().split('T')[0]}.json`; if (window.navigator && window.navigator.msSaveOrOpenBlob) { window.navigator.msSaveOrOpenBlob(dB, fN); } else { const dU = URL.createObjectURL(dB); const l = document.createElement("a"); l.href = dU; l.download = fN; document.body.appendChild(l); l.click(); document.body.removeChild(l); URL.revokeObjectURL(dU); } } catch (e) { console.error("Export error:", e); alert("Error exporting."); } }
        function generateReport() { /* ... (Keep existing generateReport function as it uses standard HTML/CSS) ... */ if (!currentClient || !allData[currentClient]) { alert("Select client."); return; } const cliData = allData[currentClient]; let reportHtml = ` <!DOCTYPE html> <html><head><meta charset="UTF-8"><title>Report - ${escapeHtml(currentClient)}</title><style> body { font-family: 'Inter', sans-serif; margin: 20px; line-height: 1.6; color: #1F2937; } .report-container { max-width: 800px; margin: 0 auto; } h1, h2, h3 { border-bottom: 1px solid #E5E7EB; padding-bottom: 0.3em; margin-top: 1.5em; font-weight: 600;} h1 { font-size: 1.8em; color: #1D4ED8; border-bottom-width: 2px; } h2 { font-size: 1.4em; margin-top: 2em; } h3 { font-size: 1.1em; color: #4B5563; margin-top: 1.5em; border-bottom-style: dashed;} table { width: 100%; border-collapse: collapse; margin: 0.5em 0 1.5em; font-size: 0.9em; border: 1px solid #E5E7EB; border-radius: 0.375rem; overflow: hidden; } th { background-color: #F9FAFB; text-align: left; padding: 10px; font-weight: 500; text-transform: uppercase; font-size: 0.8em; letter-spacing: 0.05em;} td { padding: 10px; vertical-align: top; border-top: 1px solid #F3F4F6; } tbody tr:nth-child(even) { background-color: #F9FAFB; } .notes-box { background-color: #F9FAFB; border: 1px solid #E5E7EB; padding: 10px; margin: 10px 0; white-space: pre-wrap; border-radius: 0.375rem; font-size: 0.95em; } .gallery-item { margin-bottom: 15px; border-bottom: 1px solid #F3F4F6; padding-bottom: 10px; } .gallery-img { max-width: 250px; max-height: 200px; margin-top: 5px; border: 1px solid #E5E7EB; display: block; border-radius: 0.375rem;} .completed td:not(:last-child) { text-decoration: line-through; color: #9CA3AF; opacity: 0.8; } .weekly-task-indicator { font-size: 0.8em; color: #60A5FA; font-style: italic; display: block; } .rating-value { font-weight: bold; color: #2563EB; } .no-data { color: #6B7280; font-style: italic; } ul { padding-left: 20px; margin-top: 0.5em; } li { margin-bottom: 0.3em; } a { color: #2563EB; text-decoration: none; } a:hover { text-decoration: underline; } </style></head><body><div class="report-container"> <h1>Client Report: ${escapeHtml(currentClient)}</h1> <p><em>Generated: ${new Date().toLocaleString()}</em></p> <h2>Client Info</h2> <p><strong>Big Goal:</strong> ${escapeHtml(cliData.bigGoal || "(Not Set)")}</p> `; const links = cliData.links || {}; if (links.canvas || links.classroom) { reportHtml += `<p><strong>Links:</strong> `; if (links.canvas) reportHtml += `<a href="${escapeHtml(links.canvas)}" target="_blank">Canvas</a> `; if (links.classroom) reportHtml += ` <a href="${escapeHtml(links.classroom)}" target="_blank">Classroom</a>`; reportHtml += `</p>`; } else { reportHtml += `<p class="no-data">No links saved.</p>`; } const weeklyTasks = cliData.weeklyTasks || {}; let hasWeeklyTasks = false; let weeklyHtml = `<h2>Weekly Tasks</h2>`; Object.keys(weeklyTasks).sort((a, b) => ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(a) - ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(b)).forEach(day => { const dayTasks = weeklyTasks[day] || []; if (dayTasks.length > 0) { hasWeeklyTasks = true; weeklyHtml += `<h3>${escapeHtml(day.charAt(0).toUpperCase() + day.slice(1))}</h3><ul>`; dayTasks.forEach(t => { weeklyHtml += `<li>[${escapeHtml(t.time)}] ${escapeHtml(t.activity)} ${t.duration ? '(' + escapeHtml(t.duration) + ')' : ''}</li>`; }); weeklyHtml += `</ul>`; } }); if (hasWeeklyTasks) reportHtml += weeklyHtml; else reportHtml += `<h2>Weekly Tasks</h2><p class="no-data">No weekly tasks set.</p>`; const images = cliData.images || []; if (images.length > 0) { reportHtml += `<h2>Images</h2>`; images.forEach(img => { reportHtml += `<div class="gallery-item"> <strong>${escapeHtml(img.title || "(Untitled)")}</strong><br/> <a href="${img.dataUrl}" target="_blank"><img src="${img.dataUrl}" alt="${escapeHtml(img.title)}" class="gallery-img"/></a> </div>`; }); } else { reportHtml += `<h2>Images</h2><p class="no-data">No images saved.</p>`; } reportHtml += `<h2>Daily Records</h2>`; const dateKeys = Object.keys(cliData).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k)).sort(); if (dateKeys.length === 0) { reportHtml += `<p class="no-data">No daily records.</p>`; } else { dateKeys.forEach(d => { const rec = cliData[d]; if (!rec) return; const formattedDate = formatDateForReport(d); const dayRating = (rec.dayRating && rec.dayRating !== "0") ? `<span class="rating-value">${rec.dayRating}/5</span>` : "--"; reportHtml += `<h3>${formattedDate}  |  Day Rating: ${dayRating}</h3>`; if (rec.dayNotes && rec.dayNotes.trim() !== "") { reportHtml += `<div class="notes-box"><strong>Notes:</strong><br/>${escapeHtml(rec.dayNotes).replace(/\n/g, "<br/>")}</div>`; } else { reportHtml += `<p class="no-data">No notes.</p>`; } const dailyTasks = rec.tasks || []; const weekday = getWeekdayFromDate(d); const weeklyList = (cliData.weeklyTasks && cliData.weeklyTasks[weekday]) ? cliData.weeklyTasks[weekday] : []; const weeklyDoneMap = rec.weeklyDone || {}; const mergedTasks = []; dailyTasks.forEach(t => mergedTasks.push({ ...t, _type: 'daily' })); weeklyList.forEach(wt => { mergedTasks.push({ ...wt, completed: !!weeklyDoneMap[wt.id], rating: "0", _type: 'weekly' }); }); mergedTasks.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); if (mergedTasks.length === 0) { reportHtml += `<p class="no-data">No tasks.</p>`; } else { reportHtml += `<table><thead><tr><th>Time</th><th>Activity</th><th>Duration</th><th>Done?</th><th>Rating</th></tr></thead><tbody>`; let completedCount = 0; mergedTasks.forEach(t => { if (t.completed) completedCount++; const isCompletedClass = t.completed ? 'class="completed"' : ''; const ratingStr = (t._type === "daily" && t.rating !== "0") ? `<span class="rating-value">${t.rating}/5</span>` : (t._type === "daily" ? "--" : "<span class='no-data'>(N/A)</span>"); const weeklyIndicator = t._type === 'weekly' ? `<span class="weekly-task-indicator">(Weekly)</span>` : ''; reportHtml += `<tr ${isCompletedClass}> <td>${escapeHtml(t.time)}${weeklyIndicator}</td> <td>${escapeHtml(t.activity)}</td> <td>${escapeHtml(t.duration || '--')}</td> <td>${t.completed ? 'Yes' : 'No'}</td> <td>${ratingStr}</td> </tr>`; }); reportHtml += `</tbody></table><p><strong>Completion:</strong> ${completedCount} / ${mergedTasks.length} tasks</p>`; } }); } reportHtml += ` <hr style="margin-top: 2em; border-color: #E5E7EB;"> <p style="text-align:center; font-size: 0.8em; color: #6B7280;">End of Report</p> </div> </body></html>`; const reportWindow = window.open("", "_blank"); if (reportWindow) { reportWindow.document.open(); reportWindow.document.write(reportHtml); reportWindow.document.close(); } else { alert("Could not open report window."); } }
        function formatDateForReport(dateStr) { try { const date = new Date(dateStr + 'T12:00:00Z'); return date.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' }); } catch (e) { return dateStr; } }

        // --- LocalStorage & Utilities ---
        function saveToLocalStorage() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(allData)); } catch (e) { if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') { alert("Error: Storage limit!\nExport data & clear."); } else { alert("Error saving data."); } throw e; /* Rethrow error after alert */ } }
        function updateProgress() { if (!currentClient || !currentDate) { resetProgressDashboard(); return; } const rec = getDayRecord(); if (!rec) { resetProgressDashboard(); return; } const clientData = allData[currentClient]; const dT = rec.tasks || []; const wd = getWeekdayFromDate(currentDate); const wL = (clientData.weeklyTasks && clientData.weeklyTasks[wd]) ? clientData.weeklyTasks[wd] : []; const wDM = rec.weeklyDone || {}; const dDC = dT.filter(t => t.completed).length; const wDC = wL.filter(wt => wDM[wt.id]).length; const tD = dDC + wDC; const tT = dT.length + wL.length; if (tT === 0) { completionRateEl.textContent = "-"; completionBarEl.style.width = "0%"; } else { const p = Math.round((tD / tT) * 100); completionRateEl.textContent = `${p}% (${tD}/${tT})`; completionBarEl.style.width = `${p}%`; } const rDT = dT.filter(t => t.rating && parseInt(t.rating, 10) > 0); if (rDT.length > 0) { const sR = rDT.reduce((a, t) => a + parseInt(t.rating, 10), 0); const aR = (sR / rDT.length); averageTaskRatingEl.textContent = `${aR.toFixed(1)}/5 (${rDT.length})`; } else { averageTaskRatingEl.textContent = "-"; } const dR = rec.dayRating || "0"; displayDayRatingEl.textContent = (dR !== "0") ? `${dR}/5` : "--"; const allD = Object.keys(clientData).filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d) && d <= currentDate).sort(); let sDR = 0; let cRD = 0; allD.forEach(d => { const dD = clientData[d]; if (dD && dD.dayRating && dD.dayRating !== "0") { sDR += parseInt(dD.dayRating, 10); cRD++; } }); if (cRD > 0) { const aDRO = sDR / cRD; avgDayRatingUpToDateEl.textContent = `${aDRO.toFixed(1)}/5 (${cRD})`; const aP = Math.max(0, Math.min(100, (aDRO / 5) * 100)); avgRatingBarEl.style.width = aP + "%"; } else { avgDayRatingUpToDateEl.textContent = "-"; avgRatingBarEl.style.width = "0%"; } } // Simplified progress update text
        function getWeekdayFromDate(dateStr) { try { const d = new Date(dateStr + 'T12:00:00Z'); const wd = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]; return wd[d.getUTCDay()]; } catch (e) { return ""; } }
        function escapeHtml(str) { if (typeof str !== 'string') return ""; const map = { '&': '&', '<': '<', '>': '>', '"': '"', "'": ''' }; return str.replace(/[&<>"']/g, (m) => map[m]); }

        // --- Multi-Day Planner ---
        function openPlannerModal() { if (!currentClient) { alert("Select client."); return; } plannerClientLabel.textContent = currentClient; plannerDays.innerHTML = ""; addPlannerDay(); plannerModal.style.display = "block"; }
        function closePlannerModal() { plannerModal.style.display = "none"; }
        function addPlannerDay() { const dC = plannerDays.querySelectorAll(".day-plan").length; const sD = new Date(currentDate + 'T12:00:00Z'); sD.setUTCDate(sD.getUTCDate() + dC); const dS = sD.toISOString().split("T")[0]; const dDiv = document.createElement("div"); dDiv.className = "day-plan"; dDiv.dataset.date = dS; const dLbl = document.createElement("h4"); dLbl.textContent = `Day ${dC + 1}: ${formatDateForUI(dS)}`; dDiv.appendChild(dLbl); addPlannerTaskEntry(dDiv); const addTBtn = document.createElement("button"); addTBtn.className = "btn btn-secondary"; addTBtn.textContent = "+ Task"; addTBtn.title = "Add task this day"; addTBtn.style.marginTop = "0.5rem"; addTBtn.style.padding = '0.3em 0.8em'; addTBtn.addEventListener("click", () => addPlannerTaskEntry(dDiv, addTBtn)); dDiv.appendChild(addTBtn); plannerDays.appendChild(dDiv); }
        function addPlannerTaskEntry(dayDiv, insertBefore = null) { const taskDiv = document.createElement("div"); taskDiv.className = "task-entry"; const cont = document.createElement('div'); cont.className = 'controls-container'; const tGrp = document.createElement('div'); const tLbl = document.createElement("label"); tLbl.textContent = "Time:"; tLbl.style.marginBottom='2px'; const tSel = document.createElement("select"); populateTempTimeDropdown(tSel, "3:00 PM"); tGrp.append(tLbl, tSel); cont.appendChild(tGrp); const dGrp = document.createElement('div'); const dLbl = document.createElement("label"); dLbl.textContent = "Duration:"; dLbl.style.marginBottom='2px'; const dSel = document.createElement("select"); ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{const o=document.createElement("option");o.value=d;o.text=d;dSel.appendChild(o);}); dSel.value="30 min"; dGrp.append(dLbl, dSel); cont.appendChild(dGrp); const aGrp = document.createElement('div'); const aLbl = document.createElement("label"); aLbl.textContent = "Activity:"; aLbl.style.marginBottom='2px'; const aInp = document.createElement("input"); aInp.type = "text"; aInp.placeholder = "Task..."; aGrp.append(aLbl, aInp); cont.appendChild(aGrp); taskDiv.appendChild(cont); if (insertBefore) { dayDiv.insertBefore(taskDiv, insertBefore); } else { dayDiv.appendChild(taskDiv); } } // Condensed task entry creation
        function formatDateForUI(dateStr) { try { const d = new Date(dateStr + 'T12:00:00Z'); return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' }); } catch (e) { return dateStr; } }
        function saveMultiDayPlan() { if (!currentClient) return; const dP = plannerDays.querySelectorAll(".day-plan"); let tAC = 0; dP.forEach(dD => { const dS = dD.dataset.date; if (!dS) return; if (!allData[currentClient][dS]) { allData[currentClient][dS] = { dayRating: "0", dayNotes: "", tasks: [], weeklyDone: {} }; } const dR = allData[currentClient][dS]; if (!dR.tasks) dR.tasks = []; const tE = dD.querySelectorAll(".task-entry"); tE.forEach(e => { const tS = e.querySelector("select:nth-of-type(1)"); const dS = e.querySelector("select:nth-of-type(2)"); const aI = e.querySelector("input[type='text']"); if (tS && dS && aI) { const a = aI.value.trim(); if (a) { dR.tasks.push({ id: `task_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, time: tS.value, duration: dS.value, activity: a, completed: false, rating: "0" }); tAC++; } } }); dR.tasks.sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); }); saveToLocalStorage(); loadClientDate(currentClient, currentDate); closePlannerModal(); alert(`${tAC} tasks added.`); }

        // --- Weekly Planner ---
        function openWeeklyModal() { if (!currentClient) { alert("Select client."); return; } weeklyClientLabel.textContent = currentClient; buildWeeklyContent(); weeklyModal.style.display = "block"; }
        function closeWeeklyModal() { weeklyModal.style.display = "none"; }
        function buildWeeklyContent() { weeklyContent.innerHTML = ""; const wd = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]; if (!allData[currentClient].weeklyTasks) allData[currentClient].weeklyTasks = {}; const cWT = allData[currentClient].weeklyTasks; wd.forEach(day => { const dS = document.createElement("div"); dS.className = "weekly-day-section"; const h = document.createElement("h4"); h.textContent = day.charAt(0).toUpperCase() + day.slice(1); dS.appendChild(h); const tL = document.createElement("div"); tL.id = `weekly-tasks-${day}`; if (!cWT[day]) cWT[day] = []; const dT = cWT[day]; if (dT.length > 0) { dT.forEach(task => { const tR = document.createElement("div"); tR.className = 'weekly-task-row'; const tT = document.createElement("span"); tT.textContent = `[${escapeHtml(task.time)}] ${escapeHtml(task.activity)} (${escapeHtml(task.duration)})`; tR.appendChild(tT); const rB = document.createElement("button"); rB.innerHTML = deleteIconSVG; rB.className = "btn btn-icon btn-icon-delete"; rB.title = "Remove weekly task"; rB.style.marginLeft = "auto"; rB.addEventListener("click", () => { if (confirm(`Remove "${task.activity}" for ${day}?`)) { const i = dT.findIndex(t => t.id === task.id); if (i !== -1) { dT.splice(i, 1); saveToLocalStorage(); buildWeeklyContent(); } } }); tR.appendChild(rB); tL.appendChild(tR); }); } else { tL.innerHTML = `<p class="no-data">No tasks.</p>`; } dS.appendChild(tL); const aR = document.createElement("div"); aR.className = 'add-row'; const tS = document.createElement("select"); populateTempTimeDropdown(tS, "3:00 PM"); tS.title = "Time"; const dS_sel = document.createElement("select"); ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => { const o = document.createElement("option"); o.value = d; o.text = d; dS_sel.appendChild(o); }); dS_sel.value = "30 min"; dS_sel.title = "Duration"; const aI = document.createElement("input"); aI.type = "text"; aI.placeholder = "New weekly activity..."; const aB = document.createElement("button"); aB.textContent = "+ Add"; aB.className = "btn btn-secondary"; aB.title = `Add task for ${day}`; aB.addEventListener("click", () => { const act = aI.value.trim(); if (!act) { alert("Enter activity."); aI.focus(); return; } const nId = `wt_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; cWT[day].push({ id: nId, time: tS.value, duration: dS_sel.value, activity: act }); cWT[day].sort((a, b) => convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time)); saveToLocalStorage(); buildWeeklyContent(); }); aR.append(tS, dS_sel, aI, aB); dS.appendChild(aR); weeklyContent.appendChild(dS); }); } // Condensed weekly builder
        function saveWeeklySchedule() { closeWeeklyModal(); loadClientDate(currentClient, currentDate); }

        // --- Image Handling ---
        function openImageModal() { if (!currentClient) { alert("Select client."); return; } imageClientLabel.textContent = currentClient; imageFileInput.value = ""; imagePreview.src = "#"; imagePreview.style.display = "none"; imageTitleInput.value = ""; imageModal.style.display = "block"; }
        function closeImageModal() { imageModal.style.display = "none"; }
        function handleFileInputChange(event) { const f = event.target.files ? event.target.files[0] : null; if (!f) return; if (!f.type.startsWith("image/")) { alert("Select image file."); imageFileInput.value = ""; return; } if (f.size > 10*1024*1024) alert("Warn: Image > 10MB."); const r = new FileReader(); r.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = "block"; }; r.onerror = (e) => { console.error("Read error:", e); alert("Error reading file."); }; r.readAsDataURL(f); }
        function handlePasteImage(event) { if (imageModal.style.display !== 'block') return; const items = (event.clipboardData || window.clipboardData)?.items; if (!items) return; let fI = false; for (let i=0; i<items.length; i++) { if (items[i].type.includes("image")) { const b = items[i].getAsFile(); if (b) { if (b.size > 10*1024*1024) alert("Warn: Pasted image > 10MB."); fI = true; const r = new FileReader(); r.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = "block"; }; r.onerror = (e) => { console.error("Paste error:", e); alert("Error reading paste."); }; r.readAsDataURL(b); imageFileInput.value = ""; break; } } } }
        function saveImage() { if (!imagePreview.src || imagePreview.src === window.location.href + "#" || imagePreview.style.display === 'none') { alert("No image."); return; } if (!currentClient || !allData[currentClient]) return; if (!allData[currentClient].images) allData[currentClient].images = []; const t = imageTitleInput.value.trim() || `Image (${formatDateForUI(currentDate)})`; const iDU = imagePreview.src; if (iDU.length > 15*1024*1024) { if (!confirm("SAVE WARNING: Large image may cause issues. Save anyway?")) return; } allData[currentClient].images.push({ title: t, dataUrl: iDU }); try { saveToLocalStorage(); } catch(e) { allData[currentClient].images.pop(); return; } closeImageModal(); renderImageGallery(); }
        function renderImageGallery() { imageGallery.innerHTML = ""; if (!currentClient || !allData[currentClient] || !allData[currentClient].images || allData[currentClient].images.length === 0) { imageGallery.innerHTML = '<h3 style="margin-top:0;">Image Gallery</h3><p class="no-data text-center">(No images)</p>'; return; } const imgs = allData[currentClient].images; const h3 = document.createElement("h3"); h3.textContent = "Image Gallery"; h3.style.marginTop = "0"; imageGallery.appendChild(h3); [...imgs].reverse().forEach((imgObj, index) => { const oI = imgs.length - 1 - index; const d = document.createElement("div"); d.className = "gallery-item"; const th = document.createElement("img"); th.src = imgObj.dataUrl; th.alt = escapeHtml(imgObj.title); th.title = "Click view full"; th.addEventListener("click", () => { const iW = window.open("", "_blank"); iW.document.write(`<title>${escapeHtml(imgObj.title)}</title><style>body{margin:0; background:#333;} img{display:block; max-width:100%; max-height:100vh; margin:auto;}</style><body><img src="${imgObj.dataUrl}" alt="${escapeHtml(imgObj.title)}"></body>`); iW.document.close(); }); d.appendChild(th); const s = document.createElement("span"); s.className = "title"; s.textContent = escapeHtml(imgObj.title); d.appendChild(s); const rB = document.createElement("button"); rB.innerHTML = deleteIconSVG; rB.className = "btn btn-icon btn-icon-delete"; rB.title = "Remove image"; rB.addEventListener("click", () => { if (confirm(`Remove image "${escapeHtml(imgObj.title)}"?`)) { imgs.splice(oI, 1); saveToLocalStorage(); renderImageGallery(); } }); d.appendChild(rB); imageGallery.appendChild(d); }); }

        // === END OF JAVASCRIPT ===
    </script>

</body>
</html>
