<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Tracker</title>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* === Light Blue Theme Variables === */
        :root {
            --font-family-sans: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --bg-main: #F0F9FF; /* Very Light Blue Background */
            --bg-card: #FFFFFF;
            --bg-card-secondary: #F7FAFC; /* Off-white/Very Light Gray */
            --text-primary: #1A202C; /* Very Dark Gray/Almost Black */
            --text-secondary: #4A5568; /* Medium Gray */
            --text-light: #718096; /* Lighter Gray */
            --text-on-accent: #FFFFFF;
            --border-color: #E2E8F0; /* Light Gray Border */
            --border-color-light: #EDF2F7;

            /* --- Primary Accent (Blue) --- */
            --accent-primary: #3182CE; /* Medium Blue */
            --accent-primary-dark: #2B6CB0; /* Darker Blue */
            --accent-primary-light: #EBF8FF; /* Very Light Blue (like old bg) */

            /* --- Other Accents --- */
            --accent-green: #38A169; /* Green */
            --accent-red: #E53E3E; /* Red */
            --accent-red-dark: #C53030;
            --accent-red-light: #FFF5F5; /* Light Red Background */

            /* --- Structure --- */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
            --border-radius: 0.375rem; /* 6px */
            --spacing-unit: 1rem; /* Base spacing unit (approx 16px) */
        }

        /* === Reset & Base Styles === */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: var(--font-family-sans);
            background-color: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            padding-top: 1.5rem;
        }
        .container { max-width: 850px; margin: 0 auto; padding: 0 1rem; }
        a { color: var(--accent-primary); text-decoration: none; transition: color 0.2s; }
        a:hover { color: var(--accent-primary-dark); text-decoration: underline;}
        h1, h2, h3, h4 { margin-bottom: 0.75rem; font-weight: 600; line-height: 1.3; }
        h1 { font-size: 1.75rem; text-align: center; color: #2D3748; margin-bottom: 1.5rem; font-weight: 600;}
        h2 { font-size: 1.25rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 1.5rem; font-weight: 600;}
        h3 { font-size: 1.125rem; color: var(--text-primary); margin-top: 1rem; font-weight: 600;}
        hr { border: none; border-top: 1px solid var(--border-color); margin: 2rem 0; }
        label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.25rem; }

        /* === Utility === */
        .text-center { text-align: center; }
        .no-data { color: var(--text-light); font-style: italic; font-size: 0.9em; padding: 1rem; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* === Card Styling === */
        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }
        .card h2:first-child, .card h3:first-child { margin-top: 0; }

        /* === Forms === */
        select, input[type="date"], input[type="text"], textarea {
            display: block; width: 100%;
            padding: 0.625rem 0.75rem;
            font-size: 1rem; line-height: 1.5;
            color: var(--text-primary); background-color: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: var(--border-radius);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
         /* Fix date placeholder visibility */
         input[type="date"] { color: var(--text-primary); } /* Ensure text color is set */
         input[type="date"]::-webkit-datetime-edit-fields-wrapper { /* Might need vendor prefixes */ }
         input[type="date"]::-webkit-datetime-edit-text { color: var(--text-light); margin-right: 0.3em; }
         input[type="date"]::-webkit-datetime-edit-month-field { color: var(--text-light); }
         input[type="date"]::-webkit-datetime-edit-day-field { color: var(--text-light); }
         input[type="date"]::-webkit-datetime-edit-year-field { color: var(--text-light); }
         /* Change color when a date is selected */
         input[type="date"]:valid { color: var(--text-primary); }
         input[type="date"]:valid::-webkit-datetime-edit-text,
         input[type="date"]:valid::-webkit-datetime-edit-month-field,
         input[type="date"]:valid::-webkit-datetime-edit-day-field,
         input[type="date"]:valid::-webkit-datetime-edit-year-field {
             color: var(--text-primary);
         }

        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23A0AEC0'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em; padding-right: 2.5rem; }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.2); /* Blue focus ring */
        }
        textarea { min-height: 100px; }

        /* === Buttons === */
        .btn { display: inline-flex; align-items: center; justify-content: center; font-family: inherit; font-size: 0.9375rem; font-weight: 500; padding: 0.625rem 1rem; margin: 0.25rem 0.25rem 0.25rem 0; border: 1px solid transparent; border-radius: var(--border-radius); cursor: pointer; line-height: 1.5; transition: all 0.2s ease; }
        .btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.25); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: translateY(1px); }

        /* Primary Button (Blue) */
        .btn-primary { background-color: var(--accent-primary); color: var(--text-on-accent); border-color: var(--accent-primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-dark); border-color: var(--accent-primary-dark); }

        /* Secondary Button (White / Gray Border) */
        .btn-secondary { background-color: var(--bg-card); color: var(--text-secondary); border-color: var(--border-color); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-card-secondary); border-color: #CBD5E0; color: var(--text-primary); }

        /* Danger Button (Subtle Red) */
        .btn-danger { background-color: var(--accent-red-light); color: var(--accent-red-dark); border-color: #FEE2E2; }
        .btn-danger:hover:not(:disabled) { background-color: #FECACA; border-color: #FCA5A5; color: var(--accent-red-dark); }
        #clearTasksBtn:hover:not(:disabled) { background-color: var(--accent-red); color: var(--text-on-accent); border-color: var(--accent-red); } /* Solid red hover for clear */

        /* Icon Button */
        .btn-icon { padding: 0.375rem; background-color: transparent; color: var(--text-light); border-color: transparent; line-height: 1; }
        .btn-icon:hover:not(:disabled) { background-color: var(--border-color-light); color: var(--text-secondary); }
        .btn-icon svg { width: 1.125rem; height: 1.125rem; }
        .btn-icon-delete { color: var(--accent-red); }
        .btn-icon-delete:hover:not(:disabled) { background-color: var(--accent-red-light); color: var(--accent-red-dark); }

        /* Apply styles - Primary */
        #addBtn, #saveClientBtn, #saveClientInfoBtn, #savePlanBtn, #saveWeeklyBtn, #saveImageBtn { background-color: var(--accent-primary); color: var(--text-on-accent); border-color: var(--accent-primary); }
        #addBtn:hover, #saveClientBtn:hover, #saveClientInfoBtn:hover, #savePlanBtn:hover, #saveWeeklyBtn:hover, #saveImageBtn:hover { background-color: var(--accent-primary-dark); border-color: var(--accent-primary-dark); }
        /* Apply styles - Secondary */
        #addClientBtn, #exportBtn, #reportBtn, #multiDayPlanBtn, #weeklyPlanBtn, #imageBtn, #cancelClientBtn, #cancelPlanBtn, #cancelWeeklyBtn, #cancelImageBtn, #addDayBtn { background-color: var(--bg-card); color: var(--text-secondary); border-color: var(--border-color); box-shadow: var(--shadow-sm); }
        #addClientBtn:hover, #exportBtn:hover, #reportBtn:hover, #multiDayPlanBtn:hover, #weeklyPlanBtn:hover, #imageBtn:hover, #cancelClientBtn:hover, #cancelPlanBtn:hover, #cancelWeeklyBtn:hover, #cancelImageBtn:hover, #addDayBtn:hover { background-color: var(--bg-card-secondary); border-color: #CBD5E0; color: var(--text-primary); }
        /* Apply styles - Danger */
         #clearTasksBtn { background-color: var(--accent-red-light); color: var(--accent-red-dark); border-color: #FEE2E2; }
         #clearTasksBtn:hover:not(:disabled) { background-color: var(--accent-red); color: var(--text-on-accent); border-color: var(--accent-red); }

        /* === Specific Sections === */
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, auto)); gap: 0.75rem 1rem; align-items: end; /* Align items bottom */ }
        .controls-grid > div { display: flex; flex-direction: column; }
        .controls-grid label { margin-bottom: 0.1rem; }
        .controls-grid select, .controls-grid input { width: 100%; margin-bottom: 0; } /* Remove margin */
        .controls-button-group { grid-column: 1 / -1; margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }

        #newClientForm { border-left: 4px solid var(--accent-primary); display: none; align-items: center; gap: 1rem;}
        #newClientForm label { margin-bottom: 0; flex-shrink: 0; }
        #newClientForm input[type="text"] { width: auto; flex-grow: 1; }
        #newClientForm .button-group { margin-left: auto; display: flex; gap: 0.5rem; } /* Group buttons right */

        .client-info h3 { grid-column: 1 / -1; margin: 0 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color-light); font-size: 1.125rem; color: var(--text-primary); }
        .client-info .info-row { display: grid; grid-template-columns: 130px 1fr; gap: 0.5rem 1rem; margin-bottom: 0.75rem; align-items: center; }
        .client-info label { text-align: right; margin-bottom: 0; color: var(--text-secondary); font-weight: 500;}
        .client-info .button-container { grid-column: 2 / 3; margin-top: 0.5rem; } /* Align button */

        #bigGoalDisplay { font-size: 1.25rem; font-weight: 500; margin: 1.5rem 0; color: var(--text-primary); padding: 1rem; background-color: var(--accent-primary-light); border: 1px solid #BEE3F8; border-radius: var(--border-radius); text-align: center; }

        .external-links { margin-bottom: 1.5rem; padding: 0; display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .external-links a { font-weight: 500; display: inline-flex; align-items: center; gap: 0.3rem; color: var(--text-secondary); }
        .external-links a:hover { color: var(--accent-primary); }
        .external-links svg { width: 1em; height: 1em; color: #A0AEC0; }

        .add-task-section .time-duration-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1rem; }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; background-color: var(--bg-card); font-size: 0.9375rem; }
        th, td { border-bottom: 1px solid var(--border-color); padding: 0.875rem 1rem; text-align: left; vertical-align: middle; }
        th { background-color: var(--bg-card-secondary); font-weight: 500; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color 0.15s ease-in-out; }
        tbody tr:hover { background-color: var(--accent-primary-light); }
        td:nth-child(3) { text-align: center; padding: 0.5rem; }
        td:nth-child(3) input { display: block; margin: auto; width: 1.1rem; height: 1.1rem; border-color: var(--border-color);} /* Style checkbox slightly */
        td:nth-child(4) select { width: auto; min-width: 65px; font-size: 0.9em; padding: 0.25rem 0.5rem; background-position: right 0.3rem center; margin: 0; } /* Remove margin */
        td:nth-child(4) { vertical-align: middle; }
        td:nth-child(5) { text-align: right; white-space: nowrap; padding-right: 0.5rem;}
        .completed-task td:not(:last-child) { text-decoration: line-through; color: var(--text-light); }
        .completed-task td:first-child, .completed-task td:nth-child(2) { opacity: 0.8; }
        .weekly-indicator { font-size: 0.75em; color: var(--accent-primary); font-weight: 500; display: block; margin-top: 2px; }

        #imageGallery .gallery-item { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; padding: 0.5rem 0; }
        #imageGallery .gallery-item:not(:last-child) { border-bottom: 1px solid var(--border-color-light); }
        #imageGallery .gallery-item img { width: 70px; height: 45px; border-radius: 0.25rem; border: 1px solid var(--border-color); cursor: pointer; object-fit: cover; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #imageGallery .gallery-item img:hover { transform: scale(1.05); box-shadow: var(--shadow-md); }
        #imageGallery .gallery-item .title { font-weight: 500; flex-grow: 1; color: var(--text-secondary); font-size: 0.95rem;}
        #imageGallery .gallery-item .btn-icon { margin-left: auto; }

        #progressDashboard p { margin-bottom: 0.5rem; font-size: 0.95rem; color: var(--text-secondary);}
        #progressDashboard strong { font-weight: 600; color: var(--text-primary); }
        .progress-bar-container { width: 100%; background-color: var(--border-color-light); border-radius: 999px; margin: 0.5rem 0 1rem 0; overflow: hidden; height: 10px; }
        .progress-bar { height: 100%; background-color: var(--accent-green); border-radius: 999px; transition: width 0.4s ease-in-out; }
        .progress-bar.avg-rating { background-color: var(--accent-primary); } /* Blue for rating */

        /* === Modals === */
        #plannerModal, #weeklyModal, #imageModal { display: none; position: fixed; inset: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.7); z-index: 1000; padding: 1.5rem; overflow-y: auto; backdrop-filter: blur(4px); }
        .modal-content, .weekly-modal-content, .image-modal-content { background-color: var(--bg-card); margin: 4vh auto; padding: 2rem; width: 100%; max-width: 700px; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .weekly-modal-content { max-width: 850px; }
        .modal-content h3, .weekly-modal-content h3, .image-modal-content h3 { margin-top: 0; color: var(--text-primary); font-size: 1.25rem; }
        .modal-footer { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem; }
        .day-plan, .weekly-day-section { margin-bottom: 1rem; padding: 1rem; background-color: var(--bg-card-secondary); border: 1px solid var(--border-color-light); border-radius: var(--border-radius); }
        .day-plan h4, .weekly-day-section h4 { margin-top: 0; color: var(--text-secondary); font-weight: 600; font-size: 1rem; }
        .task-entry { border-bottom: 1px dashed var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .task-entry:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .task-entry .controls-container { display: grid; grid-template-columns: auto auto 1fr; gap: 0.75rem; align-items: flex-end; }
        .task-entry label { font-size: 0.8rem; }
        .weekly-task-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;}
        .weekly-task-row span { flex-grow: 1; font-size: 0.95rem; color: var(--text-secondary); }
        .weekly-day-section .add-row { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-color); display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; }
        .weekly-day-section .add-row select, .weekly-day-section .add-row input { flex: 1 1 150px; }
        .weekly-day-section .add-row .btn { flex-shrink: 0; }
        #imagePreview { display: none; max-width: 100%; max-height: 300px; margin-top: 1rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); object-fit: contain; }

        /* === Google Embeds === */
        .google-embed-container h2 { font-size: 1.125rem; }
        #googleCalendarEmbed { width: 100%; height: 600px; border: none; border-radius: var(--border-radius); }
        #googleTasksPlaceholder p { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 0.5rem; }

        /* === Footer === */
        #footer { margin-top: 3rem; padding: 1.5rem 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-light); text-align: center; }
        #footer code { background-color: var(--border-color-light); padding: 0.15em 0.4em; border-radius: 3px; font-size: 0.9em; color: var(--text-secondary);}

        /* === Responsive Adjustments === */
        @media (max-width: 768px) {
             h1 { font-size: 1.5rem; } h2 { font-size: 1.125rem; } h3 { font-size: 1rem; }
             .client-info .info-row { grid-template-columns: 1fr; }
             .client-info label { text-align: left; }
             #bigGoalDisplay { font-size: 1.125rem; }
             .card { padding: 1rem; }
        }
        @media (max-width: 600px) {
             html { font-size: 15px; } body { padding-top: 1rem; }
             .container { padding: 0 0.75rem; } h1 { margin-bottom: 1.5rem; }
             .controls-grid { grid-template-columns: 1fr; }
             .controls-button-group { flex-direction: column; align-items: stretch; }
             .controls-button-group .btn { width: 100%; margin: 0.25rem 0; }
             th, td { padding: 0.75rem 0.5rem; font-size: 0.9rem; }
             .modal-content, .weekly-modal-content, .image-modal-content { padding: 1.5rem 1rem; margin: 2vh auto; }
             .modal-footer { flex-direction: column-reverse; align-items: stretch; }
             .modal-footer .btn { width: 100%; margin: 0.25rem 0; }
             #googleCalendarEmbed { height: 450px; }
             .task-entry .controls-container { grid-template-columns: 1fr; }
             .weekly-day-section .add-row { flex-direction: column; align-items: stretch; }
             .weekly-day-section .add-row .btn { margin-top: 0.5rem; }
        }
    </style>
</head>
<body>

    <h1>Client Tracker</h1>

    <div class="container">

        <div class="card controls-grid">
            <!-- Client Selection -->
            <div>
                <label for="clientSelect">Client</label>
                <select id="clientSelect"></select>
            </div>
            <!-- Date Selection -->
            <div>
                <label for="datePicker">Date</label>
                <input type="date" id="datePicker" />
            </div>
             <!-- Add Client Button -->
            <div style="align-self: flex-end;">
                 <button class="btn btn-secondary" id="addClientBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em" style="margin-right: 0.4em;"><path d="M10.75 6.75a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" /></svg>
                    Add Client
                 </button>
            </div>
            <!-- Action Buttons Group -->
            <div class="controls-button-group">
                <button class="btn btn-secondary" id="exportBtn" title="Export all data">Export Data</button>
                <button class="btn btn-secondary" id="reportBtn" title="View report">View Report</button>
                <button class="btn btn-secondary" id="multiDayPlanBtn" title="Multi-Day Plan">Multi-Day Plan</button>
                <button class="btn btn-secondary" id="weeklyPlanBtn" title="Weekly Plan">Weekly Plan</button>
                <button class="btn btn-secondary" id="imageBtn" title="Add image">Add Image</button>
                <button class="btn btn-danger" id="clearTasksBtn" title="Clear tasks for date">Clear Tasks</button>
            </div>
        </div>

        <div id="newClientForm" class="card">
          <label for="newClientName">New Client Name:</label>
          <input type="text" id="newClientName" placeholder="Enter name">
          <div class="button-group">
            <button class="btn btn-secondary" id="cancelClientBtn">Cancel</button>
            <button class="btn btn-primary" id="saveClientBtn">Save</button>
          </div>
        </div>

        <div class="card client-info">
             <h3>Client Information</h3>
            <div class="info-row"> <label for="bigGoalInput">Big Goal:</label> <input type="text" id="bigGoalInput" placeholder="e.g., Improve Organization"> </div>
            <div class="info-row"> <label for="canvasLinkInput">Canvas Link:</label> <input type="text" id="canvasLinkInput" placeholder="https://..."> </div>
            <div class="info-row"> <label for="classroomLinkInput">Classroom Link:</label> <input type="text" id="classroomLinkInput" placeholder="https://..."> </div>
            <div class="button-container"> <button class="btn btn-primary" id="saveClientInfoBtn">Save Info</button> </div>
        </div>

        <div id="bigGoalDisplay">(Select Client)</div>

        <div class="external-links">
          <a href="#" id="canvasLinkAnchor" target="_blank" rel="noopener noreferrer" style="display:none;"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.665l3-3z" /><path d="M8.603 14.53a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 005.656 5.656l3-3a4 4 0 00-.225-5.865.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.665l-3 3z" /></svg> Canvas </a>
          <a href="#" id="classroomLinkAnchor" target="_blank" rel="noopener noreferrer" style="display:none;"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.665l3-3z" /><path d="M8.603 14.53a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 005.656 5.656l3-3a4 4 0 00-.225-5.865.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.665l-3 3z" /></svg> Classroom </a>
        </div>

        <div class="card add-task-section">
            <h2>Add Task</h2>
            <div class="time-duration-container">
                <div> <label for="timeSelect">Time</label> <select id="timeSelect"></select> </div>
                <div> <label for="durationSelect">Duration</label> <select id="durationSelect"> <option value="5 min">5 min</option> <option value="10 min">10 min</option> <option value="15 min">15 min</option> <option value="30 min" selected>30 min</option> <option value="45 min">45 min</option> <option value="1 hour">1 hour</option> <option value="90 min">90 min</option> <option value="2 hours">2 hours</option> </select> </div>
            </div>
            <div style="margin-bottom: 1rem;"> <label for="activityInput">Activity</label> <input type="text" id="activityInput" placeholder="Task description..."> </div>
            <div style="margin-bottom: 1rem;"> <label for="taskSearch">Search Tasks</label> <input type="text" id="taskSearch" placeholder="Filter tasks in table..." title="Filter tasks"> </div>
            <button class="btn btn-primary" id="addBtn" title="Add task (Alt+A)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em" style="margin-right: 0.4em;"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg> Add Task </button>
        </div>

         <div class="card" style="padding: 0;">
             <h2 style="padding: 1.5rem 1.5rem 0.5rem; margin: 0; border-bottom: 1px solid var(--border-color);">Daily Tasks</h2>
             <div class="table-wrapper">
                <table id="taskTable">
                  <thead><tr><th style="width:20%;">Time/Duration</th><th style="width:40%;">Activity</th><th style="width:8%;">Done</th><th style="width:12%;">Rating</th><th style="width:20%; text-align: right;">Actions</th></tr></thead>
                  <tbody><tr><td colspan="5" class="text-center no-data">(No tasks added)</td></tr></tbody>
                </table>
             </div>
        </div>

        <div class="card" id="imageGallery">
            <h3>Image Gallery</h3> <p class="no-data text-center">(No images)</p>
        </div>

        <div class="card reflection-section">
            <h3>Daily Reflection</h3>
            <div class="reflection-item" style="max-width: 150px; margin-bottom: 1rem;"> <label for="dayRatingSelect">Rating (1–5)</label> <select id="dayRatingSelect"> <option value="0">--</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> </select> </div>
            <div class="reflection-item"> <label for="dayNotes">Notes</label> <textarea id="dayNotes" rows="4" placeholder="Insights? Challenges? Next steps?"></textarea> </div>
        </div>

        <div class="card" id="progressDashboard">
          <h3>Progress Dashboard</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
              <div> <p><strong>Task Completion:</strong> <span id="completionRate">-</span></p> <div class="progress-bar-container"> <div id="completionBar" class="progress-bar" style="width: 0%"></div> </div> </div>
              <div> <p><strong>Avg Day Rating:</strong> <span id="avgDayRatingUpToDate">-</span></p> <div class="progress-bar-container"> <div id="avgRatingBar" class="progress-bar avg-rating" style="width: 0%;"></div> </div> </div>
              <div> <p><strong>Avg Task Rating:</strong> <span id="averageTaskRating">-</span></p> </div>
              <div> <p><strong>Today's Rating:</strong> <span id="displayDayRating">-</span></p> </div>
          </div>
        </div>

        <div class="google-embed-container">
            <h2>Google Calendar</h2>
            <div class="card">
                <p style="font-size: 0.9em; color: var(--text-light); margin-top: 0; margin-bottom: 0.5em;"> Replace 'YOUR_CALENDAR_ID_HERE'. </p>
                <iframe id="googleCalendarEmbed" src="https://calendar.google.com/calendar/embed?src=YOUR_CALENDAR_ID_HERE&ctz=America%2FNew_York" frameborder="0" scrolling="no"> </iframe>
            </div>
        </div>
        <div class="google-embed-container">
            <h2>Google Tasks</h2>
            <div id="googleTasksPlaceholder" class="card">
              <p style="margin-top:0;"> <strong>Note:</strong> Direct embedding unavailable. </p> <p>Use Google Tasks in a separate window.</p>
            </div>
        </div>

        <div id="footer"> <p>Data stored locally via <code>localStorage</code>.</p> <p><em>Use Export/Import for backup.</em></p> </div>

    </div> <!-- End .container -->

    <!-- === MODALS === -->
    <div id="plannerModal"> <div class="modal-content"> <h3>Multi-Day Planner</h3> <p style="color: #4B5563;">For: <strong><span id="plannerClientLabel"></span></strong></p> <hr style="margin: 1rem 0;" /> <div id="plannerDays" style="max-height: 50vh; overflow-y: auto; margin-bottom: 1rem; padding-right: 0.5rem;"></div> <button class="btn btn-secondary" id="addDayBtn" style="margin-bottom: 1rem;">+ Day</button> <div class="modal-footer"> <button class="btn btn-secondary" id="cancelPlanBtn">Cancel</button> <button class="btn btn-primary" id="savePlanBtn">Save Plan</button> </div> </div> </div>
    <div id="weeklyModal"> <div class="weekly-modal-content"> <h3>Weekly Planner</h3> <p style="color: #4B5563;">For: <span id="weeklyClientLabel"></span></p> <hr style="margin: 1rem 0;" /> <div id="weeklyContent" style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;"></div> <div class="modal-footer"> <button class="btn btn-secondary" id="cancelWeeklyBtn">Cancel</button> <button class="btn btn-primary" id="saveWeeklyBtn">Done</button> </div> </div> </div>
    <div id="imageModal"> <div class="image-modal-content"> <h3>Add Image</h3> <p style="color: #4B5563;">For: <strong><span id="imageClientLabel"></span></strong></p> <hr style="margin: 1rem 0;" /> <div style="margin-bottom: 1rem;"> <label for="imageFileInput">Select File:</label> <input type="file" id="imageFileInput" accept="image/*"> <p style="color:#6B7280;font-size:0.9em; margin-top: 0.5em;"> Or paste (Ctrl+V / Cmd+V). </p> </div> <img id="imagePreview" src="#" alt="Preview"> <div style="margin-top: 1rem;"> <label for="imageTitle">Title (Opt):</label> <input type="text" id="imageTitle" placeholder="Description..."> </div> <div class="modal-footer"> <button class="btn btn-secondary" id="cancelImageBtn">Cancel</button> <button class="btn btn-primary" id="saveImageBtn">Save Image</button> </div> </div> </div>

    <script>
        // === JAVASCRIPT - Ensure this is the functional version from previous steps ===
        // (Pasting the same JS block again for absolute certainty)

        const STORAGE_KEY = "clientTrackerData_v3"; // Incremented key just in case
        let allData = {}; let currentClient = null; let currentDate = null;

        // --- DOM Elements --- (Assuming all these exist with correct IDs)
        const clientSelect = document.getElementById("clientSelect"), addClientBtn = document.getElementById("addClientBtn"), datePicker = document.getElementById("datePicker"), clearTasksBtn = document.getElementById("clearTasksBtn"), exportBtn = document.getElementById("exportBtn"), reportBtn = document.getElementById("reportBtn"), multiDayPlanBtn = document.getElementById("multiDayPlanBtn"), weeklyPlanBtn = document.getElementById("weeklyPlanBtn"), imageBtn = document.getElementById("imageBtn"), newClientForm = document.getElementById("newClientForm"), newClientName = document.getElementById("newClientName"), saveClientBtn = document.getElementById("saveClientBtn"), cancelClientBtn = document.getElementById("cancelClientBtn"), bigGoalInput = document.getElementById("bigGoalInput"), canvasLinkInput = document.getElementById("canvasLinkInput"), classroomLinkInput = document.getElementById("classroomLinkInput"), saveClientInfoBtn = document.getElementById("saveClientInfoBtn"), bigGoalDisplay = document.getElementById("bigGoalDisplay"), canvasLinkAnchor = document.getElementById("canvasLinkAnchor"), classroomLinkAnchor = document.getElementById("classroomLinkAnchor"), timeSelect = document.getElementById("timeSelect"), durationSelect = document.getElementById("durationSelect"), activityInput = document.getElementById("activityInput"), taskSearch = document.getElementById("taskSearch"), addBtn = document.getElementById("addBtn"), taskTableBody = document.getElementById("taskTable").querySelector("tbody"), dayRatingSelect = document.getElementById("dayRatingSelect"), dayNotesTextarea = document.getElementById("dayNotes"), imageGallery = document.getElementById("imageGallery"), completionRateEl = document.getElementById("completionRate"), completionBarEl = document.getElementById("completionBar"), averageTaskRatingEl = document.getElementById("averageTaskRating"), displayDayRatingEl = document.getElementById("displayDayRating"), avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate"), avgRatingBarEl = document.getElementById("avgRatingBar"), plannerModal = document.getElementById("plannerModal"), plannerClientLabel = document.getElementById("plannerClientLabel"), plannerDays = document.getElementById("plannerDays"), addDayBtn = document.getElementById("addDayBtn"), savePlanBtn = document.getElementById("savePlanBtn"), cancelPlanBtn = document.getElementById("cancelPlanBtn"), weeklyModal = document.getElementById("weeklyModal"), weeklyClientLabel = document.getElementById("weeklyClientLabel"), weeklyContent = document.getElementById("weeklyContent"), saveWeeklyBtn = document.getElementById("saveWeeklyBtn"), cancelWeeklyBtn = document.getElementById("cancelWeeklyBtn"), imageModal = document.getElementById("imageModal"), imageClientLabel = document.getElementById("imageClientLabel"), imageFileInput = document.getElementById("imageFileInput"), imagePreview = document.getElementById("imagePreview"), imageTitleInput = document.getElementById("imageTitle"), saveImageBtn = document.getElementById("saveImageBtn"), cancelImageBtn = document.getElementById("cancelImageBtn");
        const editIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em"> <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /> <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /> </svg>`;
        const deleteIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em"> <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /> </svg>`;

        // --- Initialization & Event Listeners (Copied from previous working version) ---
        window.addEventListener("load", () => { try { const s=localStorage.getItem(STORAGE_KEY); if(s){allData=JSON.parse(s); if(typeof allData !=='object'||allData===null){console.warn("Invalid data");allData={};}}else{allData={};}}catch(e){console.error("Load err:",e);alert("Could not load data.");allData={};} populateClientSelect(); const tS=new Date().toISOString().split("T")[0]; datePicker.value=tS; currentDate=tS; const cN=Object.keys(allData).sort(); if(cN.length>0){currentClient=cN[0]; clientSelect.value=currentClient; loadClientDate(currentClient, currentDate);}else{currentClient=null; bigGoalDisplay.textContent="(Add client)"; taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(Add client/date)</td></tr>'; imageGallery.innerHTML='<p class="no-data text-center">(No images)</p>';} populateTimeDropdown(); setupEventListeners(); });
        function setupEventListeners() { clientSelect.addEventListener("change", onClientOrDateChange); datePicker.addEventListener("change", onClientOrDateChange); addClientBtn.addEventListener("click", showNewClientForm); saveClientBtn.addEventListener("click", saveNewClient); cancelClientBtn.addEventListener("click", hideNewClientForm); saveClientInfoBtn.addEventListener("click", saveClientInfo); addBtn.addEventListener("click", addNewTask); clearTasksBtn.addEventListener("click", clearTasksForClientDate); exportBtn.addEventListener("click", exportData); reportBtn.addEventListener("click", generateReport); dayRatingSelect.addEventListener("change", onDayRatingChange); dayNotesTextarea.addEventListener("input", onDayNotesChange); multiDayPlanBtn.addEventListener("click", openPlannerModal); addDayBtn.addEventListener("click", addPlannerDay); savePlanBtn.addEventListener("click", saveMultiDayPlan); cancelPlanBtn.addEventListener("click", closePlannerModal); weeklyPlanBtn.addEventListener("click", openWeeklyModal); saveWeeklyBtn.addEventListener("click", saveWeeklySchedule); cancelWeeklyBtn.addEventListener("click", closeWeeklyModal); imageBtn.addEventListener("click", openImageModal); cancelImageBtn.addEventListener("click", closeImageModal); saveImageBtn.addEventListener("click", saveImage); imageModal.addEventListener("paste", handlePasteImage); imageFileInput.addEventListener("change", handleFileInputChange); taskSearch.addEventListener("input", filterTaskTable); document.addEventListener("keydown", handleKeyboardShortcuts); }
        function handleKeyboardShortcuts(e){ const aE=document.activeElement; const iF=aE&&(aE.tagName==='INPUT'||aE.tagName==='TEXTAREA'||aE.tagName==='SELECT'); if(e.key==="Escape"){if(plannerModal.style.display==="block")closePlannerModal(); else if(weeklyModal.style.display==="block")closeWeeklyModal(); else if(imageModal.style.display==="block")closeImageModal(); else if(newClientForm.style.display==="flex")hideNewClientForm(); else if(iF)aE.blur(); return;} if(iF&&aE!==taskSearch)return; if(e.altKey&&e.key==="a"){e.preventDefault();if(document.activeElement===activityInput&&activityInput.value.trim()!==''){addNewTask();}else{activityInput.focus();}} if(e.altKey&&e.key==="d"){e.preventDefault();const lR=taskTableBody.querySelector("tr.task-row:last-child");if(lR){const cB=lR.querySelector("input[type='checkbox']");if(cB){cB.checked=!cB.checked;cB.dispatchEvent(new Event("change"));}}} if(e.altKey&&e.key==="s"){e.preventDefault();sortTasksByTime();const tB=document.getElementById('taskTable');tB.style.transition='background-color 0.1s ease-out'; tB.style.backgroundColor='#EBF8FF';setTimeout(()=>{tB.style.backgroundColor='';},200);}} // Use light blue flash

        // --- Client Management ---
        function populateClientSelect(){clientSelect.innerHTML="";const cN=Object.keys(allData).sort();const hC=cN.length>0;clientSelect.disabled=!hC;multiDayPlanBtn.disabled=!hC;weeklyPlanBtn.disabled=!hC;imageBtn.disabled=!hC;reportBtn.disabled=!hC;clearTasksBtn.disabled=!hC;saveClientInfoBtn.disabled=!hC;if(!hC){const o=document.createElement("option");o.textContent="-- No Clients --";o.value="";clientSelect.appendChild(o);}else{cN.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;clientSelect.appendChild(o);});}}
        function showNewClientForm(){newClientForm.style.display="flex";newClientName.value="";newClientName.focus();}
        function hideNewClientForm(){newClientForm.style.display="none";}
        function saveNewClient(){const n=newClientName.value.trim();if(!n){alert("Enter name.");return;}if(allData[n]){alert(`Client "${n}" exists.`);return;}allData[n]={bigGoal:"",links:{canvas:"",classroom:""},weeklyTasks:{monday:[],tuesday:[],wednesday:[],thursday:[],friday:[],saturday:[],sunday:[]},images:[]};saveToLocalStorage();populateClientSelect();clientSelect.value=n;currentClient=n;currentDate=datePicker.value;loadClientDate(currentClient,currentDate);hideNewClientForm();}
        function saveClientInfo(){if(!currentClient){alert("Select client.");return;}const cD=allData[currentClient];if(!cD)return;cD.bigGoal=bigGoalInput.value.trim();if(!cD.links)cD.links={};cD.links.canvas=canvasLinkInput.value.trim();cD.links.classroom=classroomLinkInput.value.trim();saveToLocalStorage();renderClientInfo();const btn=saveClientInfoBtn;const oT=btn.textContent;btn.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="1em" height="1em" style="margin-right: 0.4em;"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg> Saved!`;btn.style.backgroundColor='#10B981';btn.disabled=true;setTimeout(()=>{btn.innerHTML=oT;btn.style.backgroundColor='';btn.disabled=false;},1500);}
        function renderClientInfo(){if(!currentClient||!allData[currentClient]){bigGoalDisplay.textContent="(Select client)";bigGoalInput.value="";canvasLinkInput.value="";classroomLinkInput.value="";canvasLinkAnchor.style.display="none";classroomLinkAnchor.style.display="none";return;}const cD=allData[currentClient];bigGoalDisplay.textContent=cD.bigGoal||"(No Goal Set)";bigGoalInput.value=cD.bigGoal||"";const l=cD.links||{};canvasLinkAnchor.style.display=(l.canvas&&l.canvas.startsWith('http'))?"inline-flex":"none";if(l.canvas)canvasLinkAnchor.href=l.canvas;canvasLinkInput.value=l.canvas||"";classroomLinkAnchor.style.display=(l.classroom&&l.classroom.startsWith('http'))?"inline-flex":"none";if(l.classroom)classroomLinkAnchor.href=l.classroom;classroomLinkInput.value=l.classroom||"";}

        // --- Core Data Loading & Display ---
        function onClientOrDateChange(){currentClient=clientSelect.value;currentDate=datePicker.value;if(currentClient&¤tDate){loadClientDate(currentClient,currentDate);}else{taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(Select client/date)</td></tr>';renderClientInfo();resetReflectionFields();resetProgressDashboard();imageGallery.innerHTML='<p class="no-data text-center">(No images)</p>';}}
        function loadClientDate(cN,dS){if(!cN||!dS)return;if(!allData[cN]){allData[cN]={bigGoal:"",links:{},weeklyTasks:{},images:[]};}if(!allData[cN][dS]){allData[cN][dS]={dayRating:"0",dayNotes:"",tasks:[],weeklyDone:{}};}const cD=allData[cN];const dR=cD[dS];renderClientInfo();dayRatingSelect.value=dR.dayRating||"0";dayNotesTextarea.value=dR.dayNotes||"";renderTaskTable(cD,dR,dS);renderImageGallery();updateProgress();taskSearch.value="";filterTaskTable();}
        function renderTaskTable(cD,dR,dS){taskTableBody.innerHTML="";const dT=dR.tasks||[];const wd=getWeekdayFromDate(dS);const wL=(cD.weeklyTasks&&cD.weeklyTasks[wd])?cD.weeklyTasks[wd]:[];const wDM=dR.weeklyDone||{};const allT=[];dT.forEach(t=>allT.push({...t,taskType:'daily'}));wL.forEach(wT=>allT.push({...wT,completed:!!wDM[wT.id],rating:"0",taskType:'weekly'}));allT.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));if(allT.length===0){taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(No tasks)</td></tr>';}else{allT.forEach(t=>addTaskRow(t,t.taskType));}}
        function resetReflectionFields(){dayRatingSelect.value="0";dayNotesTextarea.value="";}
        function resetProgressDashboard(){completionRateEl.textContent="-";completionBarEl.style.width="0%";averageTaskRatingEl.textContent="-";displayDayRatingEl.textContent="-";avgDayRatingUpToDateEl.textContent="-";avgRatingBarEl.style.width="0%";}

        // --- Reflection ---
        function onDayRatingChange(){if(!currentClient||!currentDate)return;const r=getDayRecord();if(!r)return;r.dayRating=dayRatingSelect.value;saveToLocalStorage();updateProgress();}
        const debounce=(func,wait)=>{let timeout;return(...args)=>{clearTimeout(timeout);timeout=setTimeout(()=>func.apply(this,args),wait);};};
        const debouncedSaveNotes=debounce(()=>{if(!currentClient||!currentDate)return;const r=getDayRecord();if(!r)return;r.dayNotes=dayNotesTextarea.value;saveToLocalStorage();},500);
        function onDayNotesChange(){debouncedSaveNotes();}
        function getDayRecord(){if(!currentClient||!currentDate||!allData[currentClient])return null;if(!allData[currentClient][currentDate]){allData[currentClient][currentDate]={dayRating:"0",dayNotes:"",tasks:[],weeklyDone:{}};}return allData[currentClient][currentDate];}

        // --- Time Dropdown ---
        function populateTimeDropdown(){timeSelect.innerHTML = ""; for (let h=5;h<24;h++){for(let m=0;m<60;m+=15){const d=new Date();d.setHours(h,m);const l=d.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true});const o=document.createElement("option");o.value=l;o.textContent=l;timeSelect.appendChild(o);}}const s=document.createElement("option");s.disabled=true;s.textContent="──────────";timeSelect.appendChild(s);const cT=["Before School","Study Hall","Lunch","After School","Before Dinner","After Dinner","Before Bed"];cT.forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t;timeSelect.appendChild(o);});const dF="3:00 PM";if(Array.from(timeSelect.options).some(o=>o.value===dF))timeSelect.value=dF;}

        // --- Task Management ---
        function addNewTask(){if(!currentClient||!currentDate){alert("Select client/date.");return;}const t=timeSelect.value;const a=activityInput.value.trim();const d=durationSelect.value;if(!a){alert("Enter activity.");activityInput.focus();return;}const rec=getDayRecord();if(!rec)return;if(!rec.tasks)rec.tasks=[];const nT={id:`task_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,time:t,activity:a,completed:false,rating:"0",duration:d};rec.tasks.push(nT);saveToLocalStorage();renderTaskTable(allData[currentClient],rec,currentDate);activityInput.value="";activityInput.focus();updateProgress();}
        function addTaskRow(tO,tT){const r=taskTableBody.insertRow();r.className="task-row";r.dataset.taskId=tO.id;r.dataset.taskType=tT;r.dataset.timeValue=convertTimeToMinutes(tO.time);if(tO.completed)r.classList.add("completed-task");const tD=r.insertCell(0);tD.innerHTML=escapeHtml(tO.time);if(tO.duration)tD.innerHTML+=`<br><span style="font-size:0.8em;color:#6B7280;">${escapeHtml(tO.duration)}</span>`;if(tT==='weekly')tD.innerHTML+=`<span class="weekly-indicator">(Weekly)</span>`;const tA=r.insertCell(1);tA.textContent=tO.activity;const tDn=r.insertCell(2);const cK=document.createElement("input");cK.type="checkbox";cK.checked=tO.completed;cK.title="Mark done/undone";cK.className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500";cK.addEventListener("change",()=>{r.classList.toggle("completed-task",cK.checked);if(tT==='daily'){const dR=getDayRecord();const t=dR?.tasks?.find(t=>t.id===tO.id);if(t)t.completed=cK.checked;}else if(tT==='weekly'){const dR=getDayRecord();if(!dR.weeklyDone)dR.weeklyDone={};dR.weeklyDone[tO.id]=cK.checked;}saveToLocalStorage();updateProgress();});tDn.appendChild(cK);const tR=r.insertCell(3);if(tT==='daily'){const sL=document.createElement("select");sL.title="Rate task (1-5)";for(let i=0;i<=5;i++){const o=document.createElement("option");o.value=i;o.text=i===0?"–":i.toString();sL.appendChild(o);}sL.value=tO.rating||"0";sL.addEventListener("change",()=>{const dR=getDayRecord();const t=dR?.tasks?.find(t=>t.id===tO.id);if(t)t.rating=sL.value;saveToLocalStorage();updateProgress();});tR.appendChild(sL);}else{tR.innerHTML=`<span class="no-data">–</span>`;}const tAc=r.insertCell(4);tAc.style.textAlign='right';if(tT==='daily'){const eB=document.createElement("button");eB.innerHTML=editIconSVG;eB.className="btn btn-icon";eB.title="Edit task";eB.addEventListener("click",(e)=>{e.stopPropagation();makeTaskEditable(r,tO);});tAc.appendChild(eB);const rB=document.createElement("button");rB.innerHTML=deleteIconSVG;rB.className="btn btn-icon btn-icon-delete";rB.title="Delete task";rB.addEventListener("click",(e)=>{e.stopPropagation();if(confirm(`Delete task: "${tO.activity}"?`)){removeTask(tO);r.remove();updateProgress();if(taskTableBody.querySelectorAll('tr.task-row').length===0){taskTableBody.innerHTML='<tr><td colspan="5" class="text-center no-data">(No tasks)</td></tr>';}}});tAc.appendChild(rB);}} // Condensed row add
        function makeTaskEditable(row, taskObj) { const currentlyEditing = taskTableBody.querySelector('.editing-task-row'); if (currentlyEditing && currentlyEditing !== row) { const otherCancelBtn = currentlyEditing.querySelector('.btn-cancel-edit'); if (otherCancelBtn) otherCancelBtn.click(); } row.classList.add('editing-task-row'); const tdTime = row.cells[0]; const tdAct = row.cells[1]; const tdRating = row.cells[3]; const tdActions = row.cells[4]; tdTime.innerHTML = ""; const timeDurContainer = document.createElement('div'); timeDurContainer.style.display = 'flex'; timeDurContainer.style.flexDirection = 'column'; timeDurContainer.style.gap = '4px'; const newTimeSel = document.createElement("select"); newTimeSel.style.marginBottom = '0'; populateTempTimeDropdown(newTimeSel, taskObj.time); timeDurContainer.appendChild(newTimeSel); const newDurSel = document.createElement("select"); newDurSel.style.marginBottom = '0'; ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d => { const opt = document.createElement("option"); opt.value = d; opt.text = d; newDurSel.appendChild(opt); }); newDurSel.value = taskObj.duration || "30 min"; timeDurContainer.appendChild(newDurSel); tdTime.appendChild(timeDurContainer); tdAct.innerHTML = ""; const actInput = document.createElement("input"); actInput.type = "text"; actInput.value = taskObj.activity; actInput.style.width = "100%"; actInput.style.marginBottom = '0'; tdAct.appendChild(actInput); actInput.focus(); actInput.select(); tdRating.innerHTML = ""; tdActions.innerHTML = ""; const saveBtn = document.createElement("button"); saveBtn.textContent = "Save"; saveBtn.className = "btn btn-primary"; saveBtn.style.fontSize = '0.85em'; saveBtn.style.padding = '0.3em 0.6em'; saveBtn.addEventListener("click", (e) => { e.stopPropagation(); const newTime = newTimeSel.value; const newActivity = actInput.value.trim(); const newDuration = newDurSel.value; if (!newActivity) { alert("Activity empty."); actInput.focus(); return; } const dayRec = getDayRecord(); const taskIndex = dayRec?.tasks?.findIndex(t => t.id === taskObj.id); if (taskIndex !== undefined && taskIndex > -1) { dayRec.tasks[taskIndex].time = newTime; dayRec.tasks[taskIndex].activity = newActivity; dayRec.tasks[taskIndex].duration = newDuration; saveToLocalStorage(); taskObj.time = newTime; taskObj.activity = newActivity; taskObj.duration = newDuration; renderTaskTable(allData[currentClient], dayRec, currentDate); updateProgress(); } else { console.error("Failed find task:", taskObj.id); renderTaskTable(allData[currentClient], getDayRecord(), currentDate); } }); tdActions.appendChild(saveBtn); const cancelBtn = document.createElement("button"); cancelBtn.textContent = "Cancel"; cancelBtn.className = "btn btn-secondary btn-cancel-edit"; cancelBtn.style.fontSize = '0.85em'; cancelBtn.style.padding = '0.3em 0.6em'; cancelBtn.addEventListener("click", (e) => { e.stopPropagation(); const currentScroll = window.scrollY; renderTaskTable(allData[currentClient], getDayRecord(), currentDate); window.scrollTo(0, currentScroll); }); tdActions.appendChild(cancelBtn); }
        function populateTempTimeDropdown(sel,cur){const mO=timeSelect.options;for(let i=0;i<mO.length;i++){const c=mO[i].cloneNode(true);sel.appendChild(c);}if(Array.from(sel.options).some(o=>o.value===cur)){sel.value=cur;}}
        function sortTasksByTimeInData(){if(!currentClient||!currentDate)return;const r=getDayRecord();if(!r||!r.tasks||r.tasks.length<2)return;r.tasks.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));saveToLocalStorage();}
        function sortTasksByTime(){sortTasksByTimeInData();if(currentClient&¤tDate){const dR=getDayRecord();renderTaskTable(allData[currentClient],dR,currentDate);}}
        function convertTimeToMinutes(tS){if(!tS)return 9999;const sT={"Before School":360,"Study Hall":600,"Lunch":720,"After School":930,"Before Dinner":1080,"After Dinner":1200,"Before Bed":1320};if(sT[tS]!==undefined)return sT[tS];const m=tS.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);if(m){let h=parseInt(m[1],10);const mn=parseInt(m[2],10);const ampm=m[3].toUpperCase();if(isNaN(h)||isNaN(mn))return 9999;if(ampm==="PM"&&h<12)h+=12;if(ampm==="AM"&&h===12)h=0;return h*60+mn;}return 9999;}
        function removeTask(tO){const r=getDayRecord();if(!r||!r.tasks)return;const i=r.tasks.findIndex(t=>t.id===tO.id);if(i!==-1){r.tasks.splice(i,1);saveToLocalStorage();}else{console.warn("Task not found:",tO.id);}}
        function clearTasksForClientDate(){if(!currentClient||!currentDate){alert("Select client/date.");return;}if(confirm(`DELETE ALL daily tasks for ${currentClient} on ${currentDate}?`)){const r=getDayRecord();if(r){r.tasks=[];saveToLocalStorage();renderTaskTable(allData[currentClient],r,currentDate);updateProgress();}}}
        function filterTaskTable(){const s=taskSearch.value.toLowerCase().trim();const r=taskTableBody.querySelectorAll("tr.task-row");let m=false;r.forEach(row=>{const aT=row.cells[1]?.textContent.toLowerCase()||"";const tT=row.cells[0]?.textContent.toLowerCase()||"";const v=aT.includes(s)||tT.includes(s);row.style.display=v?"":"none";if(v)m=true;});let nR=taskTableBody.querySelector('.no-match-row');if(!m&&s!==''&&r.length>0){if(!nR){nR=taskTableBody.insertRow();nR.className='no-match-row';const c=nR.insertCell(0);c.colSpan=5;c.textContent="No tasks match search.";c.className='text-center no-data';}}else{if(nR)nR.remove();}}

        // --- Export & Report ---
        function exportData(){if(Object.keys(allData).length===0){alert("No data.");return;}try{const dS=JSON.stringify(allData,null,2);const dB=new Blob([dS],{type:"application/json;charset=utf-8"});const fN=`client-tracker-export-${new Date().toISOString().split('T')[0]}.json`;if(window.navigator&&window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(dB,fN);}else{const dU=URL.createObjectURL(dB);const l=document.createElement("a");l.href=dU;l.download=fN;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(dU);}}catch(e){console.error("Export error:",e);alert("Error exporting.");}}
        function generateReport(){if(!currentClient||!allData[currentClient]){alert("Select client.");return;}const cD=allData[currentClient];let rH=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Report - ${escapeHtml(currentClient)}</title><style>body{font-family:'Inter',sans-serif;margin:20px;line-height:1.6;color:#1F2937;}.report-container{max-width:800px;margin:0 auto;}h1,h2,h3{border-bottom:1px solid #E5E7EB;padding-bottom:0.3em;margin-top:1.5em;font-weight:600;}h1{font-size:1.8em;color:#1D4ED8;border-bottom-width:2px;}h2{font-size:1.4em;margin-top:2em;}h3{font-size:1.1em;color:#4B5563;margin-top:1.5em;border-bottom-style:dashed;}table{width:100%;border-collapse:collapse;margin:0.5em 0 1.5em;font-size:0.9em;border:1px solid #E5E7EB;border-radius:0.375rem;overflow:hidden;}th{background-color:#F9FAFB;text-align:left;padding:10px;font-weight:500;text-transform:uppercase;font-size:0.8em;letter-spacing:0.05em;}td{padding:10px;vertical-align:top;border-top:1px solid #F3F4F6;}tbody tr:nth-child(even){background-color:#F9FAFB;}.notes-box{background-color:#F9FAFB;border:1px solid #E5E7EB;padding:10px;margin:10px 0;white-space:pre-wrap;border-radius:0.375rem;font-size:0.95em;}.gallery-item{margin-bottom:15px;border-bottom:1px solid #F3F4F6;padding-bottom:10px;}.gallery-img{max-width:250px;max-height:200px;margin-top:5px;border:1px solid #E5E7EB;display:block;border-radius:0.375rem;}.completed td:not(:last-child){text-decoration:line-through;color:#9CA3AF;opacity:0.8;}.weekly-task-indicator{font-size:0.8em;color:#60A5FA;font-style:italic;display:block;}.rating-value{font-weight:bold;color:#2563EB;}.no-data{color:#6B7280;font-style:italic;}ul{padding-left:20px;margin-top:0.5em;}li{margin-bottom:0.3em;}a{color:#2563EB;text-decoration:none;}a:hover{text-decoration:underline;}</style></head><body><div class="report-container"><h1>Client Report: ${escapeHtml(currentClient)}</h1><p><em>Generated: ${new Date().toLocaleString()}</em></p><h2>Client Info</h2><p><strong>Big Goal:</strong> ${escapeHtml(cD.bigGoal||"(Not Set)")}</p>`;const l=cD.links||{};if(l.canvas||l.classroom){rH+=`<p><strong>Links:</strong> `;if(l.canvas)rH+=`<a href="${escapeHtml(l.canvas)}" target="_blank">Canvas</a> `;if(l.classroom)rH+=` <a href="${escapeHtml(l.classroom)}" target="_blank">Classroom</a>`;rH+=`</p>`;}else{rH+=`<p class="no-data">No links.</p>`;}const wT=cD.weeklyTasks||{};let hWT=false;let wH=`<h2>Weekly Tasks</h2>`;Object.keys(wT).sort((a,b)=>["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(a)-["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].indexOf(b)).forEach(d=>{const dT=wT[d]||[];if(dT.length>0){hWT=true;wH+=`<h3>${escapeHtml(d.charAt(0).toUpperCase()+d.slice(1))}</h3><ul>`;dT.forEach(t=>{wH+=`<li>[${escapeHtml(t.time)}] ${escapeHtml(t.activity)} ${t.duration?'('+escapeHtml(t.duration)+')':''}</li>`;});wH+=`</ul>`;}});if(hWT)rH+=wH;else rH+=`<h2>Weekly Tasks</h2><p class="no-data">No weekly tasks.</p>`;const imgs=cD.images||[];if(imgs.length>0){rH+=`<h2>Images</h2>`;imgs.forEach(i=>{rH+=`<div class="gallery-item"><strong>${escapeHtml(i.title||"(Untitled)")}</strong><br/><a href="${i.dataUrl}" target="_blank"><img src="${i.dataUrl}" alt="${escapeHtml(i.title)}" class="gallery-img"/></a></div>`;});}else{rH+=`<h2>Images</h2><p class="no-data">No images.</p>`;}rH+=`<h2>Daily Records</h2>`;const dK=Object.keys(cD).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();if(dK.length===0){rH+=`<p class="no-data">No daily records.</p>`;}else{dK.forEach(d=>{const r=cD[d];if(!r)return;const fD=formatDateForReport(d);const dR=(r.dayRating&&r.dayRating!=="0")?`<span class="rating-value">${r.dayRating}/5</span>`:"--";rH+=`<h3>${fD}  |  Rating: ${dR}</h3>`;if(r.dayNotes&&r.dayNotes.trim()!==""){rH+=`<div class="notes-box"><strong>Notes:</strong><br/>${escapeHtml(r.dayNotes).replace(/\n/g,"<br/>")}</div>`;}else{rH+=`<p class="no-data">No notes.</p>`;}const dT=r.tasks||[];const wd=getWeekdayFromDate(d);const wL=(cD.weeklyTasks&&cD.weeklyTasks[wd])?cD.weeklyTasks[wd]:[];const wDM=r.weeklyDone||{};const mT=[];dT.forEach(t=>mT.push({...t,_type:'daily'}));wL.forEach(wt=>mT.push({...wt,completed:!!wDM[wt.id],rating:"0",_type:'weekly'}));mT.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));if(mT.length===0){rH+=`<p class="no-data">No tasks.</p>`;}else{rH+=`<table><thead><tr><th>Time</th><th>Activity</th><th>Duration</th><th>Done?</th><th>Rating</th></tr></thead><tbody>`;let cC=0;mT.forEach(t=>{if(t.completed)cC++;const iCC=t.completed?'class="completed"':'';const rS=(t._type==="daily"&&t.rating!=="0")?`<span class="rating-value">${t.rating}/5</span>`:(t._type==="daily"?"--":"<span class='no-data'>(N/A)</span>");const wI=t._type==='weekly'?`<span class="weekly-task-indicator">(Weekly)</span>`:'';rH+=`<tr ${iCC}><td>${escapeHtml(t.time)}${wI}</td><td>${escapeHtml(t.activity)}</td><td>${escapeHtml(t.duration||'--')}</td><td>${t.completed?'Yes':'No'}</td><td>${rS}</td></tr>`;});rH+=`</tbody></table><p><strong>Completion:</strong> ${cC}/${mT.length} tasks</p>`;}});rH+=`<hr style="margin-top:2em;border-color:#E5E7EB;"><p style="text-align:center;font-size:0.8em;color:#6B7280;">End Report</p></div></body></html>`;const rW=window.open("","_blank");if(rW){rW.document.open();rW.document.write(rH);rW.document.close();}else{alert("Could not open report.");}} // Condensed report function
        function formatDateForReport(dS){try{const d=new Date(dS+'T12:00:00Z');return d.toLocaleDateString(undefined,{weekday:'short',year:'numeric',month:'long',day:'numeric'});}catch(e){return dS;}}

        // --- LocalStorage & Utilities ---
        function saveToLocalStorage(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(allData));}catch(e){if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){alert("Error: Storage limit!\nExport/clear data.");}else{alert("Error saving data.");}throw e;}}
        function updateProgress(){if(!currentClient||!currentDate){resetProgressDashboard();return;}const r=getDayRecord();if(!r){resetProgressDashboard();return;}const cD=allData[currentClient];const dT=r.tasks||[];const wd=getWeekdayFromDate(currentDate);const wL=(cD.weeklyTasks&&cD.weeklyTasks[wd])?cD.weeklyTasks[wd]:[];const wDM=r.weeklyDone||{};const dDC=dT.filter(t=>t.completed).length;const wDC=wL.filter(wt=>wDM[wt.id]).length;const tD=dDC+wDC;const tT=dT.length+wL.length;if(tT===0){completionRateEl.textContent="-";completionBarEl.style.width="0%";}else{const p=Math.round((tD/tT)*100);completionRateEl.textContent=`${p}% (${tD}/${tT})`;completionBarEl.style.width=`${p}%`;}const rDT=dT.filter(t=>t.rating&&parseInt(t.rating,10)>0);if(rDT.length>0){const sR=rDT.reduce((a,t)=>a+parseInt(t.rating,10),0);const aR=(sR/rDT.length);averageTaskRatingEl.textContent=`${aR.toFixed(1)}/5 (${rDT.length})`;}else{averageTaskRatingEl.textContent="-";}const dR=r.dayRating||"0";displayDayRatingEl.textContent=(dR!=="0")?`${dR}/5`:"--";const allD=Object.keys(cD).filter(d=>/^\d{4}-\d{2}-\d{2}$/.test(d)&&d<=currentDate).sort();let sDR=0;let cRD=0;allD.forEach(d=>{const dD=cD[d];if(dD&&dD.dayRating&&dD.dayRating!=="0"){sDR+=parseInt(dD.dayRating,10);cRD++;}});if(cRD>0){const aDRO=sDR/cRD;avgDayRatingUpToDateEl.textContent=`${aDRO.toFixed(1)}/5 (${cRD})`;const aP=Math.max(0,Math.min(100,(aDRO/5)*100));avgRatingBarEl.style.width=aP+"%";}else{avgDayRatingUpToDateEl.textContent="-";avgRatingBarEl.style.width="0%";}} // Condensed progress update
        function getWeekdayFromDate(dS){try{const d=new Date(dS+'T12:00:00Z');const wd=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];return wd[d.getUTCDay()];}catch(e){return"";}}
        function escapeHtml(str){if(typeof str!=='string')return"";const map={'&':'&','<':'<','>':'>','"':'"',"'":'''};return str.replace(/[&<>"']/g,(m)=>map[m]);}

        // --- Multi-Day Planner --- (Keeping functions mostly as is, minor adjustments maybe)
        function openPlannerModal(){if(!currentClient){alert("Select client.");return;}plannerClientLabel.textContent=currentClient;plannerDays.innerHTML="";addPlannerDay();plannerModal.style.display="block";}
        function closePlannerModal(){plannerModal.style.display="none";}
        function addPlannerDay(){const dC=plannerDays.querySelectorAll(".day-plan").length;const sD=new Date(currentDate+'T12:00:00Z');sD.setUTCDate(sD.getUTCDate()+dC);const dS=sD.toISOString().split("T")[0];const dDiv=document.createElement("div");dDiv.className="day-plan";dDiv.dataset.date=dS;const dLbl=document.createElement("h4");dLbl.textContent=`Day ${dC+1}: ${formatDateForUI(dS)}`;dDiv.appendChild(dLbl);addPlannerTaskEntry(dDiv);const addTBtn=document.createElement("button");addTBtn.className="btn btn-secondary";addTBtn.textContent="+ Task";addTBtn.title="Add task this day";addTBtn.style.marginTop="0.5rem";addTBtn.style.padding='0.3em 0.8em';addTBtn.addEventListener("click",()=>addPlannerTaskEntry(dDiv,addTBtn));dDiv.appendChild(addTBtn);plannerDays.appendChild(dDiv);}
        function addPlannerTaskEntry(dDiv,iB=null){const tE=document.createElement("div");tE.className="task-entry";const cC=document.createElement('div');cC.className='controls-container';const tG=document.createElement('div');const tL=document.createElement("label");tL.textContent="Time:";tL.style.marginBottom='2px';const tS=document.createElement("select");populateTempTimeDropdown(tS,"3:00 PM");tG.append(tL,tS);cC.appendChild(tG);const dG=document.createElement('div');const dL=document.createElement("label");dL.textContent="Duration:";dL.style.marginBottom='2px';const dS=document.createElement("select");["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{const o=document.createElement("option");o.value=d;o.text=d;dS.appendChild(o);});dS.value="30 min";dG.append(dL,dS);cC.appendChild(dG);const aG=document.createElement('div');const aL=document.createElement("label");aL.textContent="Activity:";aL.style.marginBottom='2px';const aI=document.createElement("input");aI.type="text";aI.placeholder="Task...";aG.append(aL,aI);cC.appendChild(aG);tE.appendChild(cC);if(iB){dDiv.insertBefore(tE,iB);}else{dDiv.appendChild(tE);}}
        function formatDateForUI(dS){try{const d=new Date(dS+'T12:00:00Z');return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});}catch(e){return dS;}}
        function saveMultiDayPlan(){if(!currentClient)return;const dP=plannerDays.querySelectorAll(".day-plan");let tAC=0;dP.forEach(dD=>{const dS=dD.dataset.date;if(!dS)return;if(!allData[currentClient][dS]){allData[currentClient][dS]={dayRating:"0",dayNotes:"",tasks:[],weeklyDone:{}};}const dR=allData[currentClient][dS];if(!dR.tasks)dR.tasks=[];const tE=dD.querySelectorAll(".task-entry");tE.forEach(e=>{const tS=e.querySelector("select:nth-of-type(1)");const dS=e.querySelector("select:nth-of-type(2)");const aI=e.querySelector("input[type='text']");if(tS&&dS&&aI){const a=aI.value.trim();if(a){dR.tasks.push({id:`task_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,time:tS.value,duration:dS.value,activity:a,completed:false,rating:"0"});tAC++;}}});dR.tasks.sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));});saveToLocalStorage();loadClientDate(currentClient,currentDate);closePlannerModal();alert(`${tAC} tasks added.`);}

        // --- Weekly Planner ---
        function openWeeklyModal(){if(!currentClient){alert("Select client.");return;}weeklyClientLabel.textContent=currentClient;buildWeeklyContent();weeklyModal.style.display="block";}
        function closeWeeklyModal(){weeklyModal.style.display="none";}
        function buildWeeklyContent(){weeklyContent.innerHTML="";const wd=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];if(!allData[currentClient].weeklyTasks)allData[currentClient].weeklyTasks={};const cWT=allData[currentClient].weeklyTasks;wd.forEach(day=>{const dS=document.createElement("div");dS.className="weekly-day-section";const h=document.createElement("h4");h.textContent=day.charAt(0).toUpperCase()+day.slice(1);dS.appendChild(h);const tL=document.createElement("div");tL.id=`weekly-tasks-${day}`;if(!cWT[day])cWT[day]=[];const dT=cWT[day];if(dT.length>0){dT.forEach(task=>{const tR=document.createElement("div");tR.className='weekly-task-row';const tT=document.createElement("span");tT.textContent=`[${escapeHtml(task.time)}] ${escapeHtml(task.activity)} (${escapeHtml(task.duration)})`;tR.appendChild(tT);const rB=document.createElement("button");rB.innerHTML=deleteIconSVG;rB.className="btn btn-icon btn-icon-delete";rB.title="Remove";rB.style.marginLeft="auto";rB.addEventListener("click",()=>{if(confirm(`Remove "${task.activity}" for ${day}?`)){const i=dT.findIndex(t=>t.id===task.id);if(i!==-1){dT.splice(i,1);saveToLocalStorage();buildWeeklyContent();}}});tR.appendChild(rB);tL.appendChild(tR);});}else{tL.innerHTML=`<p class="no-data">No tasks.</p>`;}dS.appendChild(tL);const aR=document.createElement("div");aR.className='add-row';const tS=document.createElement("select");populateTempTimeDropdown(tS,"3:00 PM");tS.title="Time";const dS_sel=document.createElement("select");["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{const o=document.createElement("option");o.value=d;o.text=d;dS_sel.appendChild(o);});dS_sel.value="30 min";dS_sel.title="Duration";const aI=document.createElement("input");aI.type="text";aI.placeholder="New weekly activity...";const aB=document.createElement("button");aB.textContent="+ Add";aB.className="btn btn-secondary";aB.title=`Add task for ${day}`;aB.addEventListener("click",()=>{const act=aI.value.trim();if(!act){alert("Enter activity.");aI.focus();return;}const nId=`wt_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;cWT[day].push({id:nId,time:tS.value,duration:dS_sel.value,activity:act});cWT[day].sort((a,b)=>convertTimeToMinutes(a.time)-convertTimeToMinutes(b.time));saveToLocalStorage();buildWeeklyContent();});aR.append(tS,dS_sel,aI,aB);dS.appendChild(aR);weeklyContent.appendChild(dS);});}
        function saveWeeklySchedule(){closeWeeklyModal();loadClientDate(currentClient,currentDate);}

        // --- Image Handling ---
        function openImageModal(){if(!currentClient){alert("Select client.");return;}imageClientLabel.textContent=currentClient;imageFileInput.value="";imagePreview.src="#";imagePreview.style.display="none";imageTitleInput.value="";imageModal.style.display="block";}
        function closeImageModal(){imageModal.style.display="none";}
        function handleFileInputChange(e){const f=e.target.files?e.target.files[0]:null;if(!f)return;if(!f.type.startsWith("image/")){alert("Select image.");e.target.value="";return;}if(f.size>10*1024*1024)alert("Warn: Image > 10MB.");const r=new FileReader();r.onload=(e)=>{imagePreview.src=e.target.result;imagePreview.style.display="block";};r.onerror=(e)=>{alert("Error reading file.");};r.readAsDataURL(f);}
        function handlePasteImage(e){if(imageModal.style.display!=='block')return;const items=(e.clipboardData||window.clipboardData)?.items;if(!items)return;let fI=false;for(let i=0;i<items.length;i++){if(items[i].type.includes("image")){const b=items[i].getAsFile();if(b){if(b.size>10*1024*1024)alert("Warn: Pasted image > 10MB.");fI=true;const r=new FileReader();r.onload=(e)=>{imagePreview.src=e.target.result;imagePreview.style.display="block";};r.onerror=(e)=>{alert("Error reading paste.");};r.readAsDataURL(b);imageFileInput.value="";break;}}}}
        function saveImage(){if(!imagePreview.src||imagePreview.src===window.location.href+"#"||imagePreview.style.display==='none'){alert("No image.");return;}if(!currentClient||!allData[currentClient])return;if(!allData[currentClient].images)allData[currentClient].images=[];const t=imageTitleInput.value.trim()||`Image (${formatDateForUI(currentDate)})`;const iDU=imagePreview.src;if(iDU.length>15*1024*1024){if(!confirm("SAVE WARNING: Large image?"))return;}allData[currentClient].images.push({title:t,dataUrl:iDU});try{saveToLocalStorage();}catch(e){allData[currentClient].images.pop();return;}closeImageModal();renderImageGallery();}
        function renderImageGallery(){imageGallery.innerHTML="";if(!currentClient||!allData[currentClient]||!allData[currentClient].images||allData[currentClient].images.length===0){imageGallery.innerHTML='<h3 style="margin-top:0;">Image Gallery</h3><p class="no-data text-center">(No images)</p>';return;}const imgs=allData[currentClient].images;const h3=document.createElement("h3");h3.textContent="Image Gallery";h3.style.marginTop="0";imageGallery.appendChild(h3);[...imgs].reverse().forEach((imgObj,index)=>{const oI=imgs.length-1-index;const d=document.createElement("div");d.className="gallery-item";const th=document.createElement("img");th.src=imgObj.dataUrl;th.alt=escapeHtml(imgObj.title);th.title="Click view full";th.addEventListener("click",()=>{const iW=window.open("","_blank");iW.document.write(`<title>${escapeHtml(imgObj.title)}</title><style>body{margin:0;background:#333;}img{display:block;max-width:100%;max-height:100vh;margin:auto;}</style><body><img src="${imgObj.dataUrl}" alt="${escapeHtml(imgObj.title)}"></body>`);iW.document.close();});d.appendChild(th);const s=document.createElement("span");s.className="title";s.textContent=escapeHtml(imgObj.title);d.appendChild(s);const rB=document.createElement("button");rB.innerHTML=deleteIconSVG;rB.className="btn btn-icon btn-icon-delete";rB.title="Remove image";rB.addEventListener("click",()=>{if(confirm(`Remove image "${escapeHtml(imgObj.title)}"?`)){imgs.splice(oI,1);saveToLocalStorage();renderImageGallery();}});d.appendChild(rB);imageGallery.appendChild(d);});}

        // === END OF JAVASCRIPT ===
    </script>

</body>
</html>
