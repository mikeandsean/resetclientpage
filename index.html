<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RESET Tracker - Single Page</title>
  <style>
    :root {
      /* Color Palette & Variables */
      --bg-main: #F4F7FC;       /* Soft background */
      --bg-card: #FFFFFF;       /* Card background */
      --border-color: #E2E8F0;  /* Light gray border */
      --text-primary: #2D3748;  /* Dark grayish blue */
      --text-secondary: #4A5568;/* Medium gray */
      --text-light: #718096;    /* Lighter gray */
      --primary-blue: #4A90E2;  /* Accent color for buttons */
      --primary-blue-dark: #357ABD;
      --success-green: #48BB78; /* For progress bars */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
      --radius: 6px;
      --spacing-unit: 1rem;
    }

    /* Basic Resets */
    * { box-sizing: border-box; }
    body {
      margin: 0 auto;
      max-width: 850px;
      background: var(--bg-main);
      font-family: sans-serif;
      color: var(--text-primary);
      padding: var(--spacing-unit);
      line-height: 1.4;
    }

    h1, h2, h3 {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    h1 { margin-top: 1rem; font-size: 1.8rem; }
    h2 {
      font-size: 1.3rem;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.3rem;
    }
    h3 {
      margin-top: 1.2rem;
      margin-bottom: 0.4rem;
      color: var(--primary-blue);
      font-size: 1.15rem;
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 0.45em 0.8em;
      margin: 0.3em 0.3em 0.3em 0;
      border: 1px solid var(--border-color);
      background-color: #fff;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s ease;
      user-select: none; /* Prevent text selection on double click */
    }
    .btn:hover {
      background-color: #f2f2f2;
    }
    .btn:active {
        background-color: #e8e8e8; /* Slight feedback on click */
    }
    .btn-primary {
      background-color: var(--primary-blue);
      color: #fff;
      border-color: var(--primary-blue);
    }
    .btn-primary:hover {
      background-color: var(--primary-blue-dark);
      border-color: var(--primary-blue-dark);
    }
     .btn-primary:active {
        background-color: #2a5a8a;
    }
    /* Disabled button style */
     .btn:disabled, .btn[disabled] {
        cursor: not-allowed;
        opacity: 0.6;
        background-color: #eee;
     }


    /* Controls Bar */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0;
      align-items: center;
    }
    .controls > div {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .controls label {
      font-weight: bold;
      margin-right: 0.2rem;
      color: var(--text-secondary);
    }
    select, input[type="date"], input[type="text"], textarea {
      font-size: 1em;
      padding: 0.3em 0.45em;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background: #fff;
    }
    select:focus, input[type="text"]:focus, textarea:focus {
      outline: 2px solid rgba(74,144,226,0.3);
    }
    input.accountability-input { /* specific style for accountability column */
      width: 98%;
      font-size: 0.9em;
      padding: 0.2em 0.3em;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      background-color: #fff;
      box-shadow: var(--shadow-sm);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    th, td {
      border: none;
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem;
      text-align: left;
      vertical-align: middle;
      font-size: 0.95em;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-size: 0.8em;
    }
    tr:last-child td { border-bottom: none; }
    tr.completed-task td:not(:nth-child(3), :nth-last-child(1), :nth-last-child(2)) { /* Apply to all but Done?, Accountability & Actions */
      text-decoration: line-through;
      color: var(--text-light);
    }
    tr.editing td { /* Highlight row being edited */
        background-color: #fffbea;
    }


    /* Client Info Section */
    .client-info-card {
      margin-bottom:1rem;
      background:#fff;
      padding:0.8rem;
      border:1px solid var(--border-color);
      border-radius:var(--radius);
      box-shadow: var(--shadow-sm);
    }
    .client-info-edit-view, .client-info-display-view {
      margin-bottom: 0.5rem;
    }
    .client-info-display-view .info-label { /* Added class for styling */
        font-weight: 600;
        color: var(--text-secondary);
        min-width: 80px; /* Align labels somewhat */
        display: inline-block;
    }
    .client-info-display-view span.info-value { /* Added class */
      font-weight: bold;
      color: var(--primary-blue);
      margin-right: 1rem;
      display: inline-block; /* Ensure spacing works */
      word-break: break-word; /* Break long goals */
    }
    .client-info-display-view a {
      margin-right: 1rem;
      font-weight: 600;
      text-decoration: none;
       color: var(--primary-blue);
       word-break: break-all; /* Break long URLs */
    }
     .client-info-display-view a:hover {
        text-decoration: underline;
        color: var(--primary-blue-dark);
     }


    /* Reflection Section */
    textarea {
      width: 100%;
      min-height: 60px;
      margin-top: 0.2rem;
    }

    /* Progress Bars */
    .progress-bar-container {
      width: 100%;
      background-color: #eee;
      border-radius: var(--radius);
      overflow: hidden;
      margin: 0.3rem 0 1rem 0;
    }
    .progress-bar {
      height: 20px;
      background: var(--success-green);
      color: #fff;
      text-align: center;
      font-weight: 600;
      line-height: 20px;
      transition: width 0.3s;
      border-radius: var(--radius) 0 0 var(--radius);
    }
    .blue-bar {
      background: var(--primary-blue);
    }

    /* Image Gallery */
    #imageGallery {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }
    #imageGallery h3 { margin-top: 0; }
    .gallery-item {
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.3rem;
    }
    .gallery-item:last-child { border-bottom: none; }
    .gallery-item img {
      max-height: 60px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .gallery-item img:hover { transform: scale(1.05); }
    .gallery-item .title { font-weight: 600; flex-grow: 1; margin-left: 0.5rem; word-break: break-word;} /* Allow title to grow */

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 2rem 1rem;
      overflow-y: auto;
    }
    .modal-content {
      background: var(--bg-card);
      margin: 2rem auto;
      padding: 1.5rem;
      max-width: 700px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    .modal-header { margin-bottom: 1rem; }
    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-weight: 600;
    }
    .modal-close, [data-close] {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      border: none;
      background: var(--accent-red, #E53E3E);
      color: #fff;
      font-weight: bold;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .day-plan, .weekly-day-section {
      margin-bottom: 1rem;
      padding: 0.8rem;
      background: #fdfdfd;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius);
    }
    .day-plan h4, .weekly-day-section h4 {
      margin-top: 0; margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-size: 1em;
    }

    /* Media Queries */
    @media (max-width: 600px) {
      body { margin:0 auto; padding: 0.5rem;}
      h1 { font-size: 1.4rem; }
      .controls { flex-direction: column; align-items: stretch; }
      .controls > div { gap: 0.2rem; margin-bottom: 0.5rem;}
      .controls button { width: 100%; margin-left: 0; margin-right: 0;}
      table, th, td { font-size: 0.85em; }
      .modal-content { margin: 1rem auto; padding: 1rem;}
      .client-info-edit-view input[type="text"] { width: 100%; margin-bottom: 0.5rem; }
      .client-info-display-view .info-label { min-width: 60px; }
      #taskTable td:nth-child(1), #taskTable th:nth-child(1) { width: 20%; } /* Adjust col widths slightly */
      #taskTable td:nth-child(2), #taskTable th:nth-child(2) { width: 35%; }
      #taskTable td:nth-child(4), #taskTable th:nth-child(4) { width: 20%; }
    }
  </style>
</head>
<body>

<h1>RESET Tracker - Single Page</h1>

<div class="controls">
  <div>
    <label>Client:</label>
    <select id="clientSelect"></select>
    <button class="btn" id="addClientBtn">+ Add Client</button>
  </div>
  <div>
    <label>Date:</label>
    <input type="date" id="datePicker" />
  </div>
  <button class="btn" id="clearTasksBtn">Clear Tasks</button>
  <button class="btn" id="reportBtn">View Report</button>
  <button class="btn" id="multiDayBtn">Multi-Day</button>
  <button class="btn" id="weeklyBtn">Weekly</button>
  <button class="btn" id="imageBtn">Images</button>
  <button class="btn" id="exportBtn">Export</button>
</div>

<!-- New Client Form -->
<div id="newClientForm" style="display:none; margin: 0.5rem 0; padding: 0.7rem; background:#f7fcff; border:1px solid var(--border-color); border-radius:var(--radius);">
  <label style="font-weight:600; margin-right:0.5rem;">New Client Name:</label>
  <input type="text" id="newClientName" placeholder="e.g. John" style="width:180px; margin-right:0.5rem;" />
  <button class="btn btn-primary" id="saveClientBtn">Save</button>
  <button class="btn" id="cancelClientBtn">Cancel</button>
</div>

<!-- Big Goal & Links -->
<div class="client-info-card">
  <div class="client-info-edit-view" style="display:none;">
      <div style="margin-bottom:0.5rem;">
        <label style="font-weight:600; margin-right:0.3rem;">Big Goal:</label>
        <input type="text" id="bigGoalInput" placeholder="e.g. Get into Yale" style="width:98%;" />
      </div>
      <div style="margin-bottom:0.5rem;">
        <label style="font-weight:600; margin-right:0.3rem;">Canvas:</label>
        <input type="text" id="canvasLinkInput" placeholder="https://..." style="width:98%;" />
      </div>
      <div style="margin-bottom:0.5rem;">
        <label style="font-weight:600; margin-right:0.3rem;">Classroom:</label>
        <input type="text" id="classroomLinkInput" placeholder="https://..." style="width:98%;" />
      </div>
      <button class="btn btn-primary" id="saveClientInfoBtn">Save Info</button>
      <button class="btn" id="cancelClientInfoEditBtn">Cancel</button>
  </div>
  <div class="client-info-display-view" style="display:none;">
    <div><span class="info-label">Goal:</span> <span class="info-value" id="bigGoalDisplay"></span></div>
    <div><span class="info-label">Links:</span>
        <a href="#" id="canvasLinkAnchor" target="_blank" style="display:none;">Canvas</a>
        <a href="#" id="classroomLinkAnchor" target="_blank" style="display:none;">Classroom</a>
        <span id="noLinksMsg" style="color: var(--text-light); font-style: italic; display: none;">(No links set)</span>
    </div>
    <button class="btn" id="editClientInfoBtn" style="margin-top: 0.5rem; font-size:0.85em; padding:0.3em 0.6em;">Edit Info</button>
  </div>
</div>

<!-- Reflection Section -->
<h2>Daily Reflection</h2>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Day Rating (1–5):</label>
  <select id="dayRatingSelect" style="margin-left:0.5rem;">
    <option value="0">--</option>
    <option value="1">1</option><option value="2">2</option>
    <option value="3">3</option><option value="4">4</option>
    <option value="5">5</option>
  </select>
</div>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Reflection Notes:</label><br/>
  <textarea id="dayNotes" rows="3" placeholder="Notes for the day..."></textarea>
</div>

<!-- Add New Task -->
<h2>Add New Task</h2>
<div style="margin-bottom:0.5rem;">
  <label style="font-weight:600;">Time:</label>
  <select id="timeSelect"></select>
  <label style="font-weight:600; margin-left:1rem;">Duration:</label>
  <select id="durationSelect">
    <option value="5 min">5 min</option>
    <option value="10 min">10 min</option>
    <option value="15 min">15 min</option>
    <option value="30 min" selected>30 min</option>
    <option value="45 min">45 min</option>
    <option value="1 hour">1 hour</option>
    <option value="90 min">90 min</option>
    <option value="2 hours">2 hours</option>
  </select>
</div>
<div style="margin-bottom:0.8rem;">
  <label style="font-weight:600;">Activity:</label>
  <input type="text" id="activityInput" style="width:50%;" placeholder="e.g. Work on math..." />
</div>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Search:</label>
  <input type="text" id="taskSearch" style="width:35%;" placeholder="Filter tasks below..." />
</div>
<button class="btn btn-primary" id="addTaskBtn">Add Task</button>

<!-- Task Table -->
<table style="margin-top:1rem;">
  <thead>
    <tr>
      <th style="width:15%;">Time & Duration</th>
      <th style="width:30%;">Activity</th>
      <th style="width:8%;">Done?</th>
      <th style="width:22%;">Accountability</th>
      <th style="width:25%;">Actions</th>
    </tr>
  </thead>
  <tbody id="taskTable">
    <!-- Placeholder row will be inserted by JS if needed -->
  </tbody>
</table>

<!-- Image Gallery -->
<div id="imageGallery"></div>

<!-- Progress Dashboard -->
<h2>Progress Dashboard</h2>
<p><strong>Task Completion:</strong> <span id="completionRate">-</span></p>
<div class="progress-bar-container">
  <div id="completionBar" class="progress-bar" style="width:0%">0%</div>
</div>

<!-- Removed Average Task Rating -->
<hr style="margin:1.5rem 0; border: none; border-top: 1px solid var(--border-color);"/>

<p><strong>Day Rating (this day):</strong> <span id="displayDayRating">-</span></p>
<p><strong>Avg Day Rating (up to this date):</strong> <span id="avgDayRatingUpToDate">-</span></p>
<div class="progress-bar-container">
  <div id="avgRatingBar" class="progress-bar blue-bar" style="width:0%">0/5</div>
</div>

<!-- FOOTER -->
<div style="margin-top:2rem; color:var(--text-light); font-size:0.9em; border-top:1px solid var(--border-color); padding-top:1rem; text-align:center;">
  <p>Data is stored locally in your browser's <code>localStorage</code>. No server or external DB needed.</p>
</div>

<!-- MODALS -->
<!-- 1) MULTI-DAY PLANNER MODAL -->
<div id="multiDayModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="multiDayModal">X</button>
    <div class="modal-header">
      <h3>Multi-Day Task Planner</h3>
    </div>
    <p>Create tasks for multiple upcoming days at once.</p>
    <div id="multiDaysContainer"></div>
    <button class="btn" id="addAnotherDayBtn">Add Another Day</button>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveMultiDayBtn">Save All</button>
      <button class="btn" data-close="multiDayModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 2) WEEKLY PLANNER MODAL -->
<div id="weeklyModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="weeklyModal">X</button>
    <div class="modal-header">
      <h3>Weekly Planner for <span id="weeklyClientNameLabel"></span></h3>
    </div>
    <p>Set recurring tasks for each weekday.</p>
    <div id="weeklyContainer"></div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveWeeklyBtn">Save Weekly</button>
      <button class="btn" data-close="weeklyModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 3) IMAGES MODAL -->
<div id="imageModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="imageModal">X</button>
    <div class="modal-header">
      <h3>Add Image / Screenshot</h3>
    </div>
    <div>
      <input type="file" id="imageFileInput" accept="image/*" />
      <p style="color:var(--text-light); font-size:0.9em;">Or paste a screenshot (Ctrl+V).</p>
    </div>
    <img id="imagePreview" src="" alt="preview" style="display:none; max-width:100%; max-height:200px; margin:0.5rem 0; border:1px solid #ccc;" />
    <div>
      <label style="font-weight:600;">Title:</label><br/>
      <input type="text" id="imageTitle" style="width:80%;" placeholder="Optional title">
    </div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveImageBtn">Save Image</button>
      <button class="btn" data-close="imageModal">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
/***************************************************************
  SINGLE-PAGE RESET TRACKER (v2.1 - Button Fix Attempt)
***************************************************************/

// --- Global State ---
let allData = {};
const STORAGE_KEY = "multiClientDateData_SinglePage_v2"; // Use v2 key
let currentClient = null;
let currentDate   = null;

// --- DOM Element Cache ---
// Use an object to cache DOM elements for easier access and slight performance gain
const $ = {
    clientSelect: document.getElementById("clientSelect"),
    addClientBtn: document.getElementById("addClientBtn"),
    newClientForm: document.getElementById("newClientForm"),
    newClientName: document.getElementById("newClientName"),
    saveClientBtn: document.getElementById("saveClientBtn"),
    cancelClientBtn: document.getElementById("cancelClientBtn"),
    clientInfoEditView: document.querySelector(".client-info-edit-view"),
    clientInfoDisplayView: document.querySelector(".client-info-display-view"),
    bigGoalInput: document.getElementById("bigGoalInput"),
    canvasLinkInput: document.getElementById("canvasLinkInput"),
    classroomLinkInput: document.getElementById("classroomLinkInput"),
    saveClientInfoBtn: document.getElementById("saveClientInfoBtn"),
    cancelClientInfoEditBtn: document.getElementById("cancelClientInfoEditBtn"),
    editClientInfoBtn: document.getElementById("editClientInfoBtn"),
    bigGoalDisplay: document.getElementById("bigGoalDisplay"),
    canvasLinkAnchor: document.getElementById("canvasLinkAnchor"),
    classroomLinkAnchor: document.getElementById("classroomLinkAnchor"),
    noLinksMsg: document.getElementById("noLinksMsg"),
    datePicker: document.getElementById("datePicker"),
    clearTasksBtn: document.getElementById("clearTasksBtn"),
    reportBtn: document.getElementById("reportBtn"),
    multiDayBtn: document.getElementById("multiDayBtn"),
    weeklyBtn: document.getElementById("weeklyBtn"),
    imageBtn: document.getElementById("imageBtn"),
    exportBtn: document.getElementById("exportBtn"),
    dayRatingSelect: document.getElementById("dayRatingSelect"),
    dayNotes: document.getElementById("dayNotes"), // Changed ID from dayNotesTextarea
    timeSelect: document.getElementById("timeSelect"),
    durationSelect: document.getElementById("durationSelect"),
    activityInput: document.getElementById("activityInput"),
    taskSearch: document.getElementById("taskSearch"),
    addTaskBtn: document.getElementById("addTaskBtn"),
    taskTable: document.getElementById("taskTable").querySelector("tbody"), // Target tbody
    completionRate: document.getElementById("completionRate"),
    completionBar: document.getElementById("completionBar"),
    displayDayRating: document.getElementById("displayDayRating"),
    avgDayRatingUpToDate: document.getElementById("avgDayRatingUpToDate"),
    avgRatingBar: document.getElementById("avgRatingBar"),
    imageGallery: document.getElementById("imageGallery"),
    multiDayModal: document.getElementById("multiDayModal"),
    multiDaysContainer: document.getElementById("multiDaysContainer"),
    addAnotherDayBtn: document.getElementById("addAnotherDayBtn"),
    saveMultiDayBtn: document.getElementById("saveMultiDayBtn"),
    weeklyModal: document.getElementById("weeklyModal"),
    weeklyContainer: document.getElementById("weeklyContainer"),
    weeklyClientNameLabel: document.getElementById("weeklyClientNameLabel"),
    saveWeeklyBtn: document.getElementById("saveWeeklyBtn"),
    imageModal: document.getElementById("imageModal"),
    imageFileInput: document.getElementById("imageFileInput"),
    imagePreview: document.getElementById("imagePreview"),
    imageTitle: document.getElementById("imageTitle"), // Changed ID
    saveImageBtn: document.getElementById("saveImageBtn"),
};

// --- Initialization ---
window.addEventListener("load", initializeApp);

function initializeApp() {
  console.log("Initializing App...");
  try {
      /* Load from localStorage */
      loadFromStorage();

      buildTimeSelect($.timeSelect);
      buildClientDropdown();

      // Default date = today
      const todayStr = new Date().toISOString().split("T")[0];
      $.datePicker.value = todayStr;
      currentDate = todayStr;

      // Select first client if data exists
      if (Object.keys(allData).length > 0) {
          currentClient = Object.keys(allData).sort()[0];
          if (currentClient) {
              $.clientSelect.value = currentClient;
          } else {
              console.warn("Data object exists but no valid client keys found.");
              currentClient = null; // Ensure it's null if no valid client
          }
      } else {
          currentClient = null; // No data, no client
      }

      // Initial UI setup based on state
      updateClientStateUI(); // Enable/disable buttons based on client selection
      if (currentClient && currentDate) {
          loadClientDate(currentClient, currentDate);
      } else {
          // No client selected initially - show appropriate state
          renderClientInfo(null);
           $.taskTable.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;">(Select or add a client)</td></tr>`;
           resetProgressDisplay();
           buildWeeklyContent(); // Build empty weekly section
      }

      /* Attach Event Listeners */
      attachEventListeners();

      console.log("App Initialized Successfully.");

  } catch (error) {
      console.error("CRITICAL ERROR during initialization:", error);
      alert("A critical error occurred loading the tracker. Please check the console (F12) for details. Data might be corrupted or the script failed.");
      document.body.innerHTML = `<div style="padding: 20px; border: 2px solid red; background: #ffebeb; color: #a00;">
          <h2>Error Loading Tracker</h2><p>Could not initialize the application.</p>
          <p>Error: ${escapeHtml(error.message)}</p></div>`;
  }
}

function attachEventListeners() {
    console.log("Attaching event listeners...");

    $.clientSelect.addEventListener("change", onClientOrDateChange);
    $.datePicker.addEventListener("change", onClientOrDateChange);

    $.addClientBtn.addEventListener("click", () => {
        console.log("Add Client Button Clicked!");
        $.newClientForm.style.display = "block";
        $.newClientName.value = "";
        $.newClientName.focus();
    });
    $.cancelClientBtn.addEventListener("click", () => {
        console.log("Cancel Client Button Clicked!");
        $.newClientForm.style.display = "none";
    });
    $.saveClientBtn.addEventListener("click", saveNewClient);

    // Client info events
    $.saveClientInfoBtn.addEventListener("click", saveClientInfo);
    $.editClientInfoBtn.addEventListener("click", handleEditClientInfo);
    $.cancelClientInfoEditBtn.addEventListener("click", handleCancelClientInfoEdit);

    // Task events
    $.addTaskBtn.addEventListener("click", addNewTask);
    $.clearTasksBtn.addEventListener("click", clearDailyTasks);
    $.taskSearch.addEventListener("input", filterTasks);

    // Reflection events
    $.dayRatingSelect.addEventListener("change", onDayRatingChange);
    $.dayNotes.addEventListener("input", onDayNotesChange); // Use 'input' for textarea

    // Main Action Buttons
    $.reportBtn.addEventListener("click", generateReport);
    $.exportBtn.addEventListener("click", exportData);

    // Modal Triggers
    $.multiDayBtn.addEventListener("click", () => openModal("multiDayModal"));
    $.weeklyBtn.addEventListener("click", () => openModal("weeklyModal"));
    $.imageBtn.addEventListener("click", () => openModal("imageModal"));

    // Multi-day Modal Buttons
    $.addAnotherDayBtn.addEventListener("click", addMultiDayBlock);
    $.saveMultiDayBtn.addEventListener("click", saveMultiDayPlan);

    // Weekly Modal Buttons
    $.saveWeeklyBtn.addEventListener("click", saveWeeklyPlan);

    // Image Modal Buttons & Inputs
    $.imageFileInput.addEventListener("change", handleImageFileChange);
    $.imageModal.addEventListener("paste", handleImagePaste); // Attach to modal overlay div
    $.saveImageBtn.addEventListener("click", saveImage);

    // Close Modal Buttons (delegate from document for robustness)
     document.addEventListener('click', (event) => {
        if (event.target.matches('.modal-close') || event.target.closest('[data-close]')) {
            const button = event.target.matches('.modal-close') ? event.target : event.target.closest('[data-close]');
            const modal = button.closest('.modal-overlay');
            if (modal) {
                closeModal(modal.id);
            } else {
                 // If it's a data-close attribute, use its value
                 const modalId = button.getAttribute('data-close');
                 if(modalId) closeModal(modalId);
            }
        }
    });


    // Keyboard Shortcuts
    document.addEventListener("keydown", handleKeyboardShortcuts);

    console.log("Event listeners attached.");
}


// --- Data Handling ---
function loadFromStorage() {
  // (Keep the robust loadFromStorage function from previous version here)
    const str = localStorage.getItem(STORAGE_KEY);
    let parsedData = {};
    if (str) {
        try {
        parsedData = JSON.parse(str);
        } catch (e) {
        console.error("Error parsing localStorage:", e);
        alert("Could not parse stored data. It might be corrupted. Starting fresh or using default.");
        parsedData = {}; // Start fresh
        }
    }
    if (!parsedData || typeof parsedData !== 'object') {
        console.warn("Stored data was not a valid object. Resetting.");
        parsedData = {};
    }
    Object.keys(parsedData).forEach(cli => {
        if (!parsedData[cli] || typeof parsedData[cli] !== 'object') {
            console.warn(`Invalid data for client ${cli}. Resetting client data.`);
            parsedData[cli] = {};
        }
        if (!parsedData[cli].links || typeof parsedData[cli].links !== 'object') parsedData[cli].links = { canvas: "", classroom: "" };
        if (!parsedData[cli].weeklyTasks || typeof parsedData[cli].weeklyTasks !== 'object') parsedData[cli].weeklyTasks = { monday: [], tuesday: [], wednesday: [], thursday: [], friday: [], saturday: [], sunday: [] };
        Object.keys(parsedData[cli].weeklyTasks).forEach(day => {
            if (!Array.isArray(parsedData[cli].weeklyTasks[day])) {
                parsedData[cli].weeklyTasks[day] = [];
            }
        });
        if (!Array.isArray(parsedData[cli].images)) parsedData[cli].images = [];
        if (parsedData[cli].bigGoal === undefined) parsedData[cli].bigGoal = "";
        Object.keys(parsedData[cli]).forEach(dateKey => {
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) {
                const dayData = parsedData[cli][dateKey];
                if (dayData && Array.isArray(dayData.tasks)) {
                    dayData.tasks.forEach(task => {
                        if (task && task.accountability === undefined) {
                            task.accountability = "";
                        }
                         // Remove deprecated rating if present
                         if (task && task.rating !== undefined) {
                             delete task.rating;
                         }
                    });
                }
                 if (dayData && !dayData.weeklyDone) { // Ensure weeklyDone exists
                    dayData.weeklyDone = {};
                 }
            }
        });
    });
    allData = parsedData;
}

function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
  } catch(e){
    if(e.name === "QuotaExceededError" || e.name === 'NS_ERROR_DOM_QUOTA_REACHED'){
      alert("Storage limit exceeded! Please export data or remove old entries/images.");
    } else {
        console.error("Error saving to localStorage:", e);
        alert("Could not save data. Changes might not persist.");
    }
  }
}

// --- UI Update Functions ---
function buildClientDropdown() {
  // (Keep function from previous version)
    $.clientSelect.innerHTML="";
    const names= Object.keys(allData).sort();
    if(!names.length){
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="--No Clients--";
        $.clientSelect.appendChild(opt);
        $.clientSelect.disabled=true;
        return;
    }
    $.clientSelect.disabled=false;
    names.forEach(n=>{
        const opt=document.createElement("option");
        opt.value=n; opt.textContent=n;
        $.clientSelect.appendChild(opt);
    });
}

function buildTimeSelect(sel, defaultVal = "3:00 PM") {
 // (Keep function from previous version)
    sel.innerHTML="";
    let foundDefault = false;
    for(let hour=5; hour<24; hour++){
        for(let min=0; min<60; min+=15){
        const d=new Date();
        d.setHours(hour,min);
        const label= d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12:true});
        const opt= document.createElement("option");
        opt.value=label; opt.textContent=label;
        sel.appendChild(opt);
        if (label === defaultVal) foundDefault = true;
        }
    }
    const sep= document.createElement("option");
    sep.disabled=true; sep.textContent="-----";
    sel.appendChild(sep);
    const cTimes= ["Before School","During Study Hall","During Lunch",
    "Right After School","Before Dinner","After Dinner","Before Bed"];
    cTimes.forEach(t=>{
        const o=document.createElement("option");
        o.value=t; o.textContent=t;
        sel.appendChild(o);
        if (t === defaultVal) foundDefault = true;
    });
    if (foundDefault) {
        sel.value = defaultVal;
    } else if (Array.from(sel.options).some(o => o.value === "3:00 PM")) {
        sel.value = "3:00 PM";
    } else if (sel.options.length > 0) {
        sel.selectedIndex = 0;
    }
}

function populateTempTimeDropdown(selectElem, currentVal) {
 // (Keep function from previous version)
  buildTimeSelect(selectElem, currentVal);
}

function loadClientDate(cli, dt){
  console.log(`Loading data for Client: ${cli}, Date: ${dt}`);
  if (!cli || !dt) {
      console.warn("loadClientDate called with invalid client or date", cli, dt);
       $.taskTable.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;">(Select Client & Date)</td></tr>`;
       renderClientInfo(null);
       renderReflection(null, null);
       renderImageGallery(null);
       resetProgressDisplay(); // Use reset helper
       buildWeeklyContent();
       updateClientStateUI(); // Update button states
      return;
  }

  try { // Wrap specific loading sections
      // Ensure client base object exists
      if(!allData[cli]) {
        console.warn(`Client data for "${cli}" not found during loadClientDate, initializing.`);
        allData[cli] = { bigGoal:"", links:{canvas:"", classroom:""}, weeklyTasks:{ monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[] }, images:[] };
        // Don't save here, let subsequent actions trigger save
      }

      // Ensure date object exists for this client
      if(!allData[cli][dt]) {
         console.log(`Initializing date data for ${cli} on ${dt}`);
        allData[cli][dt] = { dayRating:"0", dayNotes:"", tasks:[], weeklyDone:{} };
      }

      renderClientInfo(cli);
      renderReflection(cli, dt);
      renderTaskTable(cli, dt);
      renderImageGallery(cli);
      updateProgress(cli, dt);
      buildWeeklyContent(); // Rebuild weekly for the current client
      updateClientStateUI(); // Ensure buttons are correctly enabled/disabled

  } catch (error) {
      console.error(`Error loading data for ${cli} on ${dt}:`, error);
      alert(`An error occurred loading data for ${cli} on ${dt}. Check the console.`);
      // Display error state in relevant sections
      $.taskTable.innerHTML = `<tr><td colspan="5" style="text-align:center;color:red;">(Error loading tasks)</td></tr>`;
       renderClientInfo(cli); // Still try to render basic info
       resetProgressDisplay();
  }
}

function renderClientInfo(cli) {
 // (Keep function from previous version, using $ cache)
    if (!cli || !allData[cli]) {
        $.clientInfoEditView.style.display = "block";
        $.clientInfoDisplayView.style.display = "none";
        $.bigGoalInput.value = "";
        $.canvasLinkInput.value = "";
        $.classroomLinkInput.value = "";
        return;
    }
    const cd = allData[cli];
    const goal = cd.bigGoal || "";
    const canvas = cd.links?.canvas || "";
    const classroom = cd.links?.classroom || "";
    const hasInfo = goal || canvas || classroom;

    if (hasInfo) {
        $.clientInfoEditView.style.display = "none";
        $.clientInfoDisplayView.style.display = "block";
        $.bigGoalDisplay.textContent = goal || "(No goal set)";
        let linksExist = false;
        if (canvas) {
            $.canvasLinkAnchor.href = canvas.startsWith("http") ? canvas : "//" + canvas;
            $.canvasLinkAnchor.style.display = "inline";
            linksExist = true;
        } else { $.canvasLinkAnchor.style.display = "none"; }
        if (classroom) {
            $.classroomLinkAnchor.href = classroom.startsWith("http") ? classroom : "//" + classroom;
            $.classroomLinkAnchor.style.display = "inline";
            linksExist = true;
        } else { $.classroomLinkAnchor.style.display = "none"; }
        $.noLinksMsg.style.display = linksExist ? "none" : "inline";
    } else {
        $.clientInfoEditView.style.display = "block";
        $.clientInfoDisplayView.style.display = "none";
        $.bigGoalInput.value = goal;
        $.canvasLinkInput.value = canvas;
        $.classroomLinkInput.value = classroom;
    }
}

function renderReflection(cli, dt) {
  // (Keep function from previous version, using $ cache)
   if (!cli || !dt || !allData[cli]?.[dt]) { // Add check for date object
        $.dayRatingSelect.value = "0";
        $.dayNotes.value = "";
        return;
    }
  const rec= allData[cli][dt];
  $.dayRatingSelect.value= rec.dayRating||"0";
  $.dayNotes.value= rec.dayNotes||"";
}

function renderTaskTable(cli, dt) {
  // (Keep function from previous version, using $ cache)
    $.taskTable.innerHTML="";
    if (!cli || !dt || !allData[cli]?.[dt]) {
        $.taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(Select Client & Date)</td></tr>`;
        return;
    }
    try {
        const rec = allData[cli][dt];
        // Ensure tasks array exists if the record exists
        if (!rec.tasks) rec.tasks = [];
        const daily = rec.tasks;
        const wd = getWeekday(dt);
        const wList = allData[cli].weeklyTasks?.[wd] || [];
        const wDone = rec.weeklyDone || {};
        const merged = [];
        daily.forEach(t => {
             if (t.accountability === undefined) t.accountability = ""; // Ensure field exists
             if (t.rating !== undefined) delete t.rating; // Clean old field
             merged.push({...t, _type: "daily"});
        });
        wList.forEach(wt => {
            merged.push({ ...wt, completed: !!wDone[wt.id], accountability: "(Weekly)", _type: "weekly" });
        });
        merged.sort((a, b) => timeToMin(a.time) - timeToMin(b.time));
        if (!merged.length) {
            $.taskTable.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks yet for this day)</td></tr>`;
            return;
        }
        merged.forEach(t => addTaskRow(t, rec));
    } catch (error) {
        console.error("Error rendering task table:", error);
        $.taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:red;">(Error rendering tasks)</td></tr>`;
    }
}

function addTaskRow(tObj, dayRec) {
 // (Keep function from previous version, using $ cache, removed rating)
    const row= $.taskTable.insertRow();
    if(tObj.completed) row.classList.add("completed-task");

    const cTime=row.insertCell(0);
    cTime.innerHTML = escapeHtml(tObj.time || "No Time");
    if(tObj.duration){ cTime.innerHTML+= `<br><small>(${escapeHtml(tObj.duration)})</small>`; }
    if(tObj._type==="weekly") { cTime.innerHTML+= `<br><small style="color:#09f;font-weight:bold;">(Weekly)</small>`; }

    const cAct=row.insertCell(1);
    cAct.textContent=tObj.activity;

    const cDone=row.insertCell(2);
    const chk=document.createElement("input");
    chk.type="checkbox"; chk.checked= tObj.completed;
    chk.addEventListener("change",()=>{
        row.classList.toggle("completed-task", chk.checked);
        if(tObj._type==="daily"){
            const taskIndex = dayRec.tasks.findIndex(task => task === tObj);
            if (taskIndex > -1) {
                dayRec.tasks[taskIndex].completed = chk.checked;
                saveToStorage(); updateProgress(currentClient, currentDate);
            } else { console.warn("Could not find daily task object by reference to update completion:", tObj); }
        } else {
            if(!dayRec.weeklyDone) dayRec.weeklyDone={};
            dayRec.weeklyDone[tObj.id]= chk.checked;
            saveToStorage(); updateProgress(currentClient, currentDate);
        }
    });
    cDone.appendChild(chk);

    const cAccountability = row.insertCell(3);
    if (tObj._type === "daily") {
        const accInput = document.createElement("input");
        accInput.type = "text"; accInput.placeholder = "How checked?"; accInput.className = "accountability-input";
        accInput.value = tObj.accountability || "";
        accInput.addEventListener("input", () => {
            const taskIndex = dayRec.tasks.findIndex(task => task === tObj);
            if (taskIndex > -1) {
                dayRec.tasks[taskIndex].accountability = accInput.value;
                saveToStorage();
            } else { console.warn("Could not find daily task object by reference to update accountability:", tObj); }
        });
        cAccountability.appendChild(accInput);
    } else { cAccountability.textContent = "--"; cAccountability.style.color = "#999"; }

    const cActn=row.insertCell(4);
    if(tObj._type==="daily") {
        const editBtn = document.createElement("button");
        editBtn.textContent = "✎"; editBtn.title = "Edit Task"; editBtn.classList.add("btn"); editBtn.style.marginRight = "5px";
        editBtn.addEventListener("click", () => { makeTaskEditable(row, tObj); });
        cActn.appendChild(editBtn);

        const rm=document.createElement("button");
        rm.classList.add("btn"); rm.textContent="X"; rm.title = "Remove Task";
        rm.addEventListener("click",()=>{
            if(confirm(`Remove task "${tObj.activity}"?`)){
                const idx = dayRec.tasks.findIndex(task => task === tObj);
                if(idx > -1){
                    dayRec.tasks.splice(idx,1); saveToStorage(); row.remove();
                    updateProgress(currentClient, currentDate);
                    if($.taskTable.rows.length === 0){ $.taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks yet)</td></tr>`; }
                } else { console.warn("Could not find daily task object by reference to remove:", tObj); }
            }
        });
        cActn.appendChild(rm);
    } else { cActn.innerHTML=`<small style="color:#666;">(Edit in Weekly Plan)</small>`; }
}

function renderImageGallery(cli){
 // (Keep function from previous version, using $ cache)
    $.imageGallery.innerHTML="";
    if(!cli || !allData[cli]) { $.imageGallery.innerHTML=`<p style="color: var(--text-light);">(Select a client)</p>`; return; }
    if (!allData[cli].images) allData[cli].images = [];
    const arr= allData[cli].images;
    if(!arr.length){ $.imageGallery.innerHTML=`<p style="color: var(--text-light);">(No images saved)</p>`; return; }
    const h3=document.createElement("h3"); h3.textContent="Image Gallery"; $.imageGallery.appendChild(h3);
    arr.forEach((imgObj, idx)=>{
        const div=document.createElement("div"); div.classList.add("gallery-item");
        const im=document.createElement("img");
        try {
            if (imgObj.dataUrl && imgObj.dataUrl.startsWith('data:image')) { im.src=imgObj.dataUrl; }
            else { throw new Error("Invalid image data URL format"); }
        } catch (e) { console.error("Error loading image data:", e, imgObj); im.alt = `Error loading: ${escapeHtml(imgObj.title || '(Untitled)')}`; im.style.border = "1px solid red"; }
        im.alt = imgObj.title || "Gallery image"; im.title = `Click to view larger: ${escapeHtml(imgObj.title || '(Untitled)')}`;
        im.addEventListener("click",()=>{ /* ... (keep image opening logic) ... */
             if (im.src && !im.src.includes('Error')) { // Only open if src is valid
                 const w = window.open("", "_blank");
                 if (w) {
                     w.document.write(`<title>${escapeHtml(imgObj.title || 'Image')}</title><body style="margin:0; background:#333;"><img src="${im.src}" style="max-width:100%; max-height: 100vh; display: block; margin: auto;"/></body>`);
                     w.document.close();
                 } else { alert("Pop-up blocked."); }
            }
        });
        div.appendChild(im);
        const titleSpan=document.createElement("span"); titleSpan.classList.add("title"); titleSpan.textContent = imgObj.title || "(Untitled)"; div.appendChild(titleSpan);
        const rmBtn=document.createElement("button"); rmBtn.classList.add("btn"); rmBtn.textContent="X"; rmBtn.title = "Remove image"; rmBtn.style.marginLeft = "auto"; rmBtn.style.padding = "0.2em 0.5em"; rmBtn.style.fontSize = "0.9em";
        rmBtn.addEventListener("click",()=>{ if(confirm(`Remove image "${escapeHtml(imgObj.title || '(Untitled)')}"?`)) { arr.splice(idx,1); saveToStorage(); renderImageGallery(cli); } });
        div.appendChild(rmBtn);
        $.imageGallery.appendChild(div);
    });
}

function updateProgress(cli, dt){
 // (Keep function from previous version, using $ cache, no avg task rating)
    if (!cli || !dt || !allData[cli]?.[dt]) { resetProgressDisplay(); return; } // Use reset helper
    const rec= allData[cli][dt]; const daily= rec.tasks||[]; const wd= getWeekday(dt);
    const wList= allData[cli].weeklyTasks?.[wd]||[]; const wDone= rec.weeklyDone||{};
    const dailyDone= daily.filter(t=>t.completed).length; const weeklyDoneCount= wList.filter(w=> wDone[w.id]).length;
    const totalDone= dailyDone + weeklyDoneCount; const total= daily.length + wList.length;
    if(!total){ $.completionRate.textContent="-"; $.completionBar.style.width="0%"; $.completionBar.textContent="0%"; }
    else { const pct= Math.round((totalDone/total)*100); $.completionRate.textContent=`${pct}% (${totalDone}/${total})`; $.completionBar.style.width=`${pct}%`; $.completionBar.textContent=`${pct}%`; }
    if(rec.dayRating && rec.dayRating!=="0") { $.displayDayRating.textContent= rec.dayRating+"/5"; } else { $.displayDayRating.textContent="--"; }
    const allDates= Object.keys(allData[cli]).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k) && k<=dt).sort();
    let sumDR=0, cntDR=0;
    allDates.forEach(dKey => { const dayRec = allData[cli][dKey]; const drValue = dayRec?.dayRating; if(drValue && drValue!=="0"){ const ratingNum = parseInt(drValue, 10); if (!isNaN(ratingNum)) { sumDR += ratingNum; cntDR++; } } });
    if(cntDR>0){ const avgdr= sumDR/cntDR; $.avgDayRatingUpToDate.textContent= avgdr.toFixed(1)+"/5"; const p= Math.max(0, Math.min(100, (avgdr/5)*100)); $.avgRatingBar.style.width=`${p}%`; $.avgRatingBar.textContent= avgdr.toFixed(1)+"/5"; }
    else { $.avgDayRatingUpToDate.textContent="No rated days"; $.avgRatingBar.style.width="0%"; $.avgRatingBar.textContent="0/5"; }
}

function resetProgressDisplay() {
    // Helper to clear progress bars and text
    $.completionRate.textContent="-";
    $.completionBar.style.width="0%";
    $.completionBar.textContent="0%";
    $.displayDayRating.textContent="--";
    $.avgDayRatingUpToDate.textContent="--";
    $.avgRatingBar.style.width="0%";
    $.avgRatingBar.textContent="0/5";
}

function updateClientStateUI() {
    // Enable/disable buttons based on whether a client is selected
    const hasClient = !!currentClient;
    $.addTaskBtn.disabled = !hasClient;
    $.clearTasksBtn.disabled = !hasClient;
    $.reportBtn.disabled = !hasClient;
    $.multiDayBtn.disabled = !hasClient;
    $.weeklyBtn.disabled = !hasClient;
    $.imageBtn.disabled = !hasClient;
    $.editClientInfoBtn.disabled = !hasClient; // Can only edit if a client is selected
     // Reflection elements
    $.dayRatingSelect.disabled = !hasClient;
    $.dayNotes.disabled = !hasClient;
    // Task add inputs
    $.timeSelect.disabled = !hasClient;
    $.durationSelect.disabled = !hasClient;
    $.activityInput.disabled = !hasClient;
    $.taskSearch.disabled = !hasClient;

     // Also update the weekly modal label if possible
     if($.weeklyClientNameLabel) {
        $.weeklyClientNameLabel.textContent = hasClient ? currentClient : 'No Client Selected';
     }
}


// --- Event Handlers ---
function onClientOrDateChange() {
  console.log("Client or Date Changed");
  currentClient = $.clientSelect.value;
  currentDate   = $.datePicker.value;
  loadClientDate(currentClient, currentDate); // Reload data for the new selection
}

function saveNewClient() {
  console.log("Entering saveNewClient...");
  const name = $.newClientName.value.trim();
  if (!name) { alert("Please enter a client name."); return; }
  if (allData[name]) { alert(`Client "${name}" already exists.`); return; }

  allData[name] = { bigGoal:"", links:{canvas:"", classroom:""}, weeklyTasks:{ monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[] }, images:[] };
  saveToStorage();
  buildClientDropdown(); // Update dropdown
  $.clientSelect.value = name; // Select the new client
  currentClient = name; // Update global state
  loadClientDate(currentClient, currentDate); // Load the new client's (empty) data
  $.newClientForm.style.display = "none"; // Hide form
  console.log("New client saved:", name);
}

function saveClientInfo() {
  console.log("Saving client info...");
  if(!currentClient){ alert("No client selected."); return; }
  const cd= allData[currentClient];
  cd.bigGoal = $.bigGoalInput.value.trim();
  if(!cd.links) cd.links={};
  cd.links.canvas = $.canvasLinkInput.value.trim();
  cd.links.classroom = $.classroomLinkInput.value.trim();
  saveToStorage();
  renderClientInfo(currentClient); // Re-render to switch view
  alert("Client info saved!");
}

function handleEditClientInfo() {
    console.log("Edit Client Info Button Clicked!");
    if (!currentClient) return; // Should be disabled, but check anyway
    $.clientInfoEditView.style.display = "block";
    $.clientInfoDisplayView.style.display = "none";
    // Populate edit fields with current values
    $.bigGoalInput.value = allData[currentClient].bigGoal || "";
    $.canvasLinkInput.value = allData[currentClient].links?.canvas || "";
    $.classroomLinkInput.value = allData[currentClient].links?.classroom || "";
}

function handleCancelClientInfoEdit() {
    console.log("Cancel Client Info Edit Clicked!");
    // Re-render display view if data exists, otherwise stay in edit mode
    if (currentClient) renderClientInfo(currentClient);
}


function addNewTask() {
  console.log("Entering addNewTask...");
  if (!currentClient || !currentDate) {
      alert("Please select a client and date before adding tasks.");
      return;
  }
  const timeVal= $.timeSelect.value;
  const durVal= $.durationSelect.value;
  const actVal= $.activityInput.value.trim();
  if(!actVal){ alert("Please enter an activity description."); $.activityInput.focus(); return; }

  // Ensure the record for the date exists
  if (!allData[currentClient][currentDate]) {
      console.warn(`Record for ${currentClient} on ${currentDate} missing. Initializing.`);
      allData[currentClient][currentDate] = { dayRating: "0", dayNotes: "", tasks: [], weeklyDone: {} };
  }
  const rec= allData[currentClient][currentDate];
  if(!rec.tasks) rec.tasks=[]; // Ensure tasks array exists

  const newTask = {
    time: timeVal, duration: durVal, activity: actVal,
    completed: false, accountability: ""
  };

  rec.tasks.push(newTask);
  rec.tasks.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time)); // Sort
  saveToStorage();
  renderTaskTable(currentClient, currentDate); // Re-render
  updateProgress(currentClient, currentDate);
  $.activityInput.value=""; // Clear input
  $.activityInput.focus(); // Focus for next task
  console.log("Task added:", newTask);
}

function clearDailyTasks() {
  console.log("Clear Daily Tasks Button Clicked!");
  if(!currentClient||!currentDate) { alert("Select client and date first."); return;}
  const rec = allData[currentClient]?.[currentDate];
   if (!rec || !rec.tasks || rec.tasks.length === 0) {
       alert("No daily tasks to clear for this date."); return;
   }
  if(confirm(`Clear ALL ${rec.tasks.length} daily task(s) for ${currentDate}?`)){
    rec.tasks=[]; saveToStorage(); renderTaskTable(currentClient, currentDate); updateProgress(currentClient, currentDate);
    console.log("Daily tasks cleared.");
  }
}

function filterTasks() {
 // (Keep function from previous version, using $ cache)
    const txt= $.taskSearch.value.toLowerCase();
    const rows= $.taskTable.querySelectorAll("tr");
    let visibleCount = 0;
    rows.forEach(r=>{
        if(!r.cells || r.cells.length < 5) {
            if (txt) r.style.display = "none"; else r.style.display = "";
            return;
        }
        const timeStr= r.cells[0]?.textContent.toLowerCase() || "";
        const actStr= r.cells[1]?.textContent.toLowerCase() || "";
        const accStr = r.cells[3]?.querySelector('input')?.value?.toLowerCase() || r.cells[3]?.textContent?.toLowerCase() || "";
        const isVisible = (timeStr.includes(txt) || actStr.includes(txt) || accStr.includes(txt));
        r.style.display = isVisible ? "" : "none";
        if (isVisible) visibleCount++;
    });
}

function onDayRatingChange() {
  // (Keep function from previous version, using $ cache)
  if(!currentClient||!currentDate || !allData[currentClient]?.[currentDate]) return;
  const rec= allData[currentClient][currentDate]; rec.dayRating= $.dayRatingSelect.value;
  saveToStorage(); updateProgress(currentClient, currentDate);
}

function onDayNotesChange() {
  // (Keep function from previous version, using $ cache)
  if(!currentClient||!currentDate || !allData[currentClient]?.[currentDate]) return;
  const rec= allData[currentClient][currentDate]; rec.dayNotes= $.dayNotes.value;
  // Add debounce later if needed
  saveToStorage();
}

function generateReport() {
  console.log("Generate Report Button Clicked!");
  // (Keep function from previous version)
    if(!currentClient) {alert("No client selected"); return;}
    const cliData= allData[currentClient]; if (!cliData) { alert("No data found for this client."); return; }
    let html=`<!DOCTYPE html>...`; // Keep the full HTML structure
     html=`
    <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/>
    <title>RESET Tracker - ${escapeHtml(currentClient)}</title>
    <style> body { font-family: sans-serif; margin:20px; line-height:1.5; max-width: 800px;} h1,h2,h3 { margin-bottom:0.4rem; } h1{font-size:1.6rem; color:#4A90E2;} h2 { margin-top: 1.5rem; border-bottom: 1px solid #ccc; padding-bottom: 0.2rem;} h3 { margin-top: 1rem; color: #333; font-size: 1.1em; } table { width:100%; border-collapse:collapse; margin-bottom:1rem; } table,th,td { border:1px solid #aaa; } th,td { padding:6px; text-align:left; vertical-align:top; } th { background:#f2f2f2; font-weight: 600;} .notes { background:#f4f7fc; border: 1px solid #e2e8f0; border-left: 3px solid var(--primary-blue); padding:8px; margin:0.5rem 0; white-space: pre-wrap; font-size: 0.95em;} .weekly {color:#09f; font-style:italic; font-size: 0.9em;} .gallery-img { max-height:150px; margin:0.5rem; border:1px solid #ccc; vertical-align: middle; background: #eee;} .img-container { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed #ccc;} .img-container:last-child { border-bottom: none; } .completed-task td:not(:nth-child(3)) { text-decoration: line-through; color: #888; } .info-block { margin-bottom: 0.5rem; } .info-block strong { min-width: 80px; display: inline-block; color: var(--text-secondary); } </style>
    </head><body> <h1>RESET Tracker Report for ${escapeHtml(currentClient)}</h1> <p><em>Generated on ${new Date().toLocaleString()}</em></p>
    <h2>Client Information</h2> <div class="info-block"><strong>Goal:</strong> ${escapeHtml(cliData.bigGoal||"(Not set)")}</div> <div class="info-block"><strong>Canvas:</strong> ${cliData.links?.canvas ? `<a href="${cliData.links.canvas.startsWith('http') ? '' : '//'}${escapeHtml(cliData.links.canvas)}" target="_blank">${escapeHtml(cliData.links.canvas)}</a>` : "(Not set)"}</div> <div class="info-block"><strong>Classroom:</strong> ${cliData.links?.classroom ? `<a href="${cliData.links.classroom.startsWith('http') ? '' : '//'}${escapeHtml(cliData.links.classroom)}" target="_blank">${escapeHtml(cliData.links.classroom)}</a>` : "(Not set)"}</div>
    <h2>Weekly Tasks</h2> `;
    const wt = cliData.weeklyTasks || {}; const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]; let hasWeekly = false;
    days.forEach(d=>{ const arr= wt[d]||[]; if(arr.length) { hasWeekly = true; html+= `<h3>${escapeHtml(d[0].toUpperCase() + d.slice(1))}</h3><ul>`; arr.forEach(t=>{ html+= `<li>[${escapeHtml(t.time)}] ${escapeHtml(t.activity)} (${escapeHtml(t.duration || 'N/A')})</li>`; }); html+= `</ul>`; } });
    if (!hasWeekly) html += `<p>(No weekly tasks set)</p>`;
    const imgs= cliData.images||[]; html+= `<h2>Images</h2>`;
    if(imgs.length>0){ imgs.forEach(img=>{ html+= `<div class="img-container"><strong>${escapeHtml(img.title || '(Untitled)')}</strong><br/> <img class="gallery-img" src="${img.dataUrl}" alt="${escapeHtml(img.title || '(Untitled)')}"/> </div>`; }); } else { html += `<p>(No images saved)</p>`; }
    const dateKeys= Object.keys(cliData).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort(); html+= `<h2>Daily Records</h2>`;
    if(!dateKeys.length){ html+= `<p>(No daily records found)</p>`; }
    else { dateKeys.forEach(d=>{ const rec= cliData[d]; if(!rec)return; html+= `<h3 style="margin-top:1.5rem; border-top: 1px solid #ccc; padding-top: 0.5rem;">${d} — Day Rating: ${rec.dayRating && rec.dayRating !== '0' ? rec.dayRating+'/5' : '--'}</h3>`; if(rec.dayNotes){ const formattedNotes = escapeHtml(rec.dayNotes).replace(/\n/g, '<br>'); html+= `<div class="notes">${formattedNotes}</div>`; } const dailyT= rec.tasks||[]; const wd= getWeekday(d); const wList= cliData.weeklyTasks?.[wd]||[]; const doneMap= rec.weeklyDone||{}; const merged=[]; dailyT.forEach(t=> merged.push({...t,_type:"daily"})); wList.forEach(wt=> merged.push({...wt,_type:"weekly", completed:!!doneMap[wt.id], accountability:"(Weekly)"}));
    if (merged.length > 0) { merged.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time)); html+= `<table><thead> <tr><th>Time</th><th>Activity</th><th>Done?</th><th>Accountability</th></tr> </thead><tbody>`; let doneCount=0; merged.forEach(t=>{ if(t.completed) doneCount++; html+= `<tr class="${t.completed?'completed-task':''}"> <td>${escapeHtml(t.time || 'N/A')}${t.duration?`<br><small>(${escapeHtml(t.duration)})</small>`:""}${t._type==="weekly"?'<br><span class="weekly">(Weekly)</span>':''}</td> <td>${escapeHtml(t.activity)}</td> <td style="text-align:center;">${t.completed?"✔️":"❌"}</td> <td>${t._type === 'daily' ? escapeHtml(t.accountability || '--') : '(Weekly)'}</td> </tr>`; }); html+= `</tbody></table>`; html+= `<p><strong>Completion for ${d}:</strong> ${doneCount}/${merged.length} task(s)</p>`; } else { html+= `<p>(No tasks recorded for this day)</p>`; } }); }
    html+= `</body></html>`;
    const reportWindow= window.open("","_blank"); if (reportWindow) { reportWindow.document.open(); reportWindow.document.write(html); reportWindow.document.close(); } else { alert("Pop-up blocked."); }
}

function exportData() {
  console.log("Export Data Button Clicked!");
 // (Keep function from previous version)
    if (Object.keys(allData).length === 0) { alert("No data to export."); return; }
    try { const str= JSON.stringify(allData,null,2); const blob= new Blob([str], {type:"application/json"}); const url= URL.createObjectURL(blob); const a= document.createElement("a"); a.href=url; const dateStamp = new Date().toISOString().split('T')[0].replace(/-/g, ''); a.download=`resetTrackerData_${dateStamp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch (e) { console.error("Export failed:", e); alert("Could not generate export file."); }
}


// --- Task Editing ---
function makeTaskEditable(row, taskObj) {
 // (Keep function from previous version, using $ cache)
    if (row.classList.contains('editing') || taskObj._type === 'weekly') return;
    row.classList.add('editing');
    const tdTime = row.cells[0]; const tdAct  = row.cells[1]; const tdActions = row.cells[4];
    const oldTime = taskObj.time; const oldAct  = taskObj.activity; const oldDuration = taskObj.duration || "30 min";
    tdTime.innerHTML = "";
    const newTimeSelect = document.createElement("select"); populateTempTimeDropdown(newTimeSelect, oldTime); newTimeSelect.style.marginBottom = "3px"; tdTime.appendChild(newTimeSelect);
    const newDurationSelect = document.createElement("select"); ["5 min", "10 min", "15 min", "30 min", "45 min", "1 hour", "90 min", "2 hours"].forEach(dur => { const opt = document.createElement("option"); opt.value = dur; opt.text = dur; newDurationSelect.appendChild(opt); }); newDurationSelect.value = oldDuration; tdTime.appendChild(newDurationSelect);
    tdAct.innerHTML = ""; const actField = document.createElement("input"); actField.type = "text"; actField.value = oldAct; actField.style.width = "98%"; tdAct.appendChild(actField);
    const accInput = tdAccountability.querySelector('input'); // Find existing accountability input
    const originalButtonsHTML = tdActions.innerHTML; tdActions.innerHTML = "";
    const saveBtn = document.createElement("button"); saveBtn.textContent = "Save"; saveBtn.classList.add("btn", "btn-primary");
    saveBtn.addEventListener("click", () => {
        const newTime = newTimeSelect.value; const newActivity = actField.value.trim(); const newDuration = newDurationSelect.value;
        const newAccountability = accInput ? accInput.value : taskObj.accountability; // Get current value
        if (!newActivity) { alert("Activity cannot be empty."); actField.focus(); return; }
        const dayRec = allData[currentClient][currentDate]; const taskIndex = dayRec.tasks.findIndex(task => task === taskObj);
         if (taskIndex > -1) {
            dayRec.tasks[taskIndex].time = newTime; dayRec.tasks[taskIndex].activity = newActivity; dayRec.tasks[taskIndex].duration = newDuration; dayRec.tasks[taskIndex].accountability = newAccountability;
            dayRec.tasks.sort((a, b) => timeToMin(a.time) - timeToMin(b.time)); // Sort after update
            saveToStorage(); renderTaskTable(currentClient, currentDate); updateProgress(currentClient, currentDate);
         } else { console.error("SAVE ERROR: Could not find task object", taskObj); alert("Error saving edits."); row.classList.remove('editing'); tdActions.innerHTML = originalButtonsHTML; }
    });
    tdActions.appendChild(saveBtn);
    const cancelBtn = document.createElement("button"); cancelBtn.textContent = "Cancel"; cancelBtn.classList.add("btn");
    cancelBtn.addEventListener("click", () => { renderTaskTable(currentClient, currentDate); }); // Just re-render table
    tdActions.appendChild(cancelBtn);
    actField.focus(); actField.select();
}


// --- Modal Handling ---
function openModal(id){
  // (Keep function from previous version, using $ cache)
    const modal = document.getElementById(id); // Use getElementById here as $ cache might not have modals initially
    if (modal) {
        modal.style.display="block";
        if (id === 'weeklyModal') { $.weeklyClientNameLabel.textContent = currentClient || 'Selected Client'; buildWeeklyContent(); }
        if (id === 'multiDayModal') { $.multiDaysContainer.innerHTML = ''; addMultiDayBlock(); }
        if (id === 'imageModal') { $.imagePreview.src = ''; $.imagePreview.style.display = 'none'; $.imageFileInput.value = ''; $.imageTitle.value = ''; }
    } else { console.error("Modal ID not found:", id); }
}

function closeModal(id){
  // (Keep function from previous version)
  const modal = document.getElementById(id); if (modal) modal.style.display="none";
}

function addMultiDayBlock() {
  // (Keep function from previous version, using $ cache)
    const index= $.multiDaysContainer.querySelectorAll(".day-plan").length;
    const baseDateStr = $.datePicker.value || new Date().toISOString().split("T")[0];
    const baseDate= new Date(baseDateStr+"T12:00:00");
    let targetDate = new Date(baseDate); targetDate.setDate(targetDate.getDate() + index + 1);
    const ds= targetDate.toISOString().split("T")[0];
    const div= document.createElement("div"); div.classList.add("day-plan"); div.dataset.date= ds;
    const h4= document.createElement("h4"); h4.textContent=`Day ${index+1}: ${formatDate(ds)}`; div.appendChild(h4);
    const taskGroupDiv = document.createElement("div");
    const timeSel= document.createElement("select"); buildTimeSelect(timeSel); taskGroupDiv.appendChild(timeSel);
    const durSel= document.createElement("select"); ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(val=>{ const o=document.createElement("option"); o.value=val; o.textContent=val; durSel.appendChild(o); }); durSel.value="30 min"; durSel.style.marginLeft = "5px"; taskGroupDiv.appendChild(durSel);
    const lab= document.createElement("label"); lab.style.display="block"; lab.style.marginTop="0.5rem"; lab.textContent="Activity:"; taskGroupDiv.appendChild(lab);
    const act=document.createElement("input"); act.type="text"; act.style.width="100%"; taskGroupDiv.appendChild(act);
    div.appendChild(taskGroupDiv);
    const addBtn= document.createElement("button"); addBtn.classList.add("btn"); addBtn.style.marginTop="0.5rem"; addBtn.textContent="+ Task for this day";
    addBtn.addEventListener("click",()=>{ const lastTaskGroup = div.querySelector("div:has(input[type='text']):last-of-type"); if (lastTaskGroup) { const newTaskGroup = lastTaskGroup.cloneNode(true); const newActInput = newTaskGroup.querySelector("input[type='text']"); if (newActInput) newActInput.value = ''; const sep = document.createElement("hr"); sep.style.margin = "0.8rem 0"; div.insertBefore(sep, addBtn); div.insertBefore(newTaskGroup, addBtn); if (newActInput) newActInput.focus(); } });
    div.appendChild(addBtn);
    $.multiDaysContainer.appendChild(div);
}

function saveMultiDayPlan() {
 // (Keep function from previous version, using $ cache)
    const blocks= $.multiDaysContainer.querySelectorAll(".day-plan"); let tasksAdded=0; let datesAffected = new Set();
    blocks.forEach(block=>{ const ds= block.dataset.date; if (!ds) return; if(!allData[currentClient][ds]){ allData[currentClient][ds]={dayRating:"0", dayNotes:"", tasks:[], weeklyDone:{}}; } const rec= allData[currentClient][ds]; if (!rec.tasks) rec.tasks = []; const taskGroups = block.querySelectorAll("div:has(input[type='text'])");
    taskGroups.forEach(group => { const timeSel = group.querySelector("select:nth-of-type(1)"); const durSel = group.querySelector("select:nth-of-type(2)"); const actInput = group.querySelector("input[type='text']"); const actVal = actInput ? actInput.value.trim() : ""; if (actVal && timeSel && durSel) { rec.tasks.push({ time: timeSel.value, duration: durSel.value, activity: actVal, completed: false, accountability: "" }); tasksAdded++; datesAffected.add(ds); } else if (actVal) { console.warn(`Missing time/dur select for activity "${actVal}" in multi-day for ${ds}`); } });
    if (rec.tasks.length > 0) { rec.tasks.sort((a, b) => timeToMin(a.time) - timeToMin(b.time)); } });
    if (tasksAdded > 0) { saveToStorage(); alert(`Multi-day plan saved! ${tasksAdded} tasks added across ${datesAffected.size} day(s).`); if (datesAffected.has(currentDate)) { loadClientDate(currentClient, currentDate); } } else { alert("No new tasks entered."); }
    closeModal("multiDayModal");
}

function buildWeeklyContent() {
  // (Keep function from previous version, using $ cache)
     $.weeklyContainer.innerHTML = "";
    if(!currentClient || !allData[currentClient]) { $.weeklyContainer.innerHTML = "<p style='color: var(--text-light);'>(Select a client first)</p>"; return; }
    if (!allData[currentClient].weeklyTasks) { allData[currentClient].weeklyTasks = { monday: [], tuesday: [], wednesday: [], thursday: [], friday: [], saturday: [], sunday: [] }; }
    const wData = allData[currentClient].weeklyTasks; const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
    days.forEach(d => { const sec=document.createElement("div"); sec.classList.add("weekly-day-section"); const hd=document.createElement("h4"); hd.textContent= d[0].toUpperCase()+d.slice(1); sec.appendChild(hd); const tasksDiv= document.createElement("div"); tasksDiv.style.marginBottom = "0.5rem"; const dayTasks = wData[d] || [];
    if (dayTasks.length === 0) { tasksDiv.innerHTML = `<p style="font-size: 0.9em; color: var(--text-light); margin: 0;">(No tasks)</p>`; }
    else { dayTasks.forEach(task=>{ const row=document.createElement("div"); row.style.display="flex"; row.style.gap="0.5rem"; row.style.marginBottom="0.3rem"; row.style.alignItems = "center"; const sp=document.createElement("span"); sp.textContent=`[${escapeHtml(task.time)}] ${escapeHtml(task.activity)} (${escapeHtml(task.duration || 'N/A')})`; sp.style.flexGrow = "1"; row.appendChild(sp); const rm=document.createElement("button"); rm.classList.add("btn"); rm.textContent="X"; rm.title = "Remove task"; rm.style.padding = "0.2em 0.5em"; rm.style.fontSize = "0.9em"; rm.addEventListener("click",()=>{ const idx = dayTasks.findIndex(t => t.id === task.id); if(idx>-1){ dayTasks.splice(idx,1); saveToStorage(); buildWeeklyContent(); } else { console.warn("Could not find weekly task by ID:", task.id); } }); row.appendChild(rm); tasksDiv.appendChild(row); }); } sec.appendChild(tasksDiv);
    const addRow=document.createElement("div"); addRow.style.display="flex"; addRow.style.flexWrap = "wrap"; addRow.style.gap="0.5rem"; addRow.style.marginTop="0.5rem"; addRow.style.borderTop = "1px solid #eee"; addRow.style.paddingTop = "0.5rem";
    const timeSel= document.createElement("select"); buildTimeSelect(timeSel); const durSel= document.createElement("select"); ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(val=>{ const o=document.createElement("option"); o.value=val; o.textContent=val; durSel.appendChild(o); }); durSel.value="30 min"; const inp= document.createElement("input"); inp.type="text"; inp.placeholder="New weekly activity..."; inp.style.flexGrow = "1"; inp.style.minWidth = "150px"; const plus=document.createElement("button"); plus.classList.add("btn","btn-primary"); plus.textContent="+"; plus.title = "Add weekly task";
    const addAction = () => { const v = inp.value.trim(); if (!v) { alert("Enter activity."); inp.focus(); return; } const newId = `wt_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`; if (!wData[d]) wData[d] = []; wData[d].push({ id: newId, time: timeSel.value, duration: durSel.value, activity: v }); wData[d].sort((a, b) => timeToMin(a.time) - timeToMin(b.time)); saveToStorage(); buildWeeklyContent(); const newInp = weeklyContainer.querySelector(`.weekly-day-section input[placeholder='New weekly activity...']`); if (newInp) newInp.focus(); };
    plus.addEventListener("click", addAction); inp.addEventListener("keydown", (e) => { if (e.key === 'Enter') { e.preventDefault(); addAction(); } });
    addRow.appendChild(timeSel); addRow.appendChild(durSel); addRow.appendChild(inp); addRow.appendChild(plus); sec.appendChild(addRow); $.weeklyContainer.appendChild(sec);
    });
}

function saveWeeklyPlan() {
  // (Keep function from previous version)
  closeModal("weeklyModal"); loadClientDate(currentClient, currentDate); alert("Weekly schedule updated!");
}

function handleImageFileChange(e){
 // (Keep function from previous version, using $ cache)
    const file= $.imageFileInput.files[0]; if(!file)return; if (!file.type.startsWith('image/')) { alert("Select image file."); $.imageFileInput.value = ""; return; } if (file.size > 5 * 1024 * 1024) { alert("Image too large (max 5MB)."); $.imageFileInput.value = ""; return; } const r=new FileReader(); r.onload=(evt)=>{ $.imagePreview.src= evt.target.result; $.imagePreview.style.display="block"; }; r.onerror = (err) => { console.error("FileReader error:", err); alert("Could not read file."); $.imageFileInput.value = ""; }; r.readAsDataURL(file);
}

function handleImagePaste(e){
 // (Keep function from previous version, using $ cache)
    const items = (e.clipboardData || window.clipboardData)?.items; if (!items) return;
    for(let i=0; i<items.length; i++){ if(items[i].type.indexOf("image")===0){ const file= items[i].getAsFile(); if(file){ if (file.size > 5 * 1024 * 1024) { alert("Pasted image too large (max 5MB)."); return; } const r=new FileReader(); r.onload=(ev)=>{ $.imagePreview.src= ev.target.result; $.imagePreview.style.display="block"; }; r.onerror = (err) => { console.error("FileReader error on paste:", err); alert("Could not read pasted image."); }; r.readAsDataURL(file); e.preventDefault(); return; } } }
}

function saveImage(){
 // (Keep function from previous version, using $ cache)
    if(!$.imagePreview.src || !$.imagePreview.src.startsWith('data:image')){ alert("No valid image selected/pasted"); return; } if(!currentClient) {alert("No client selected");return;} const title= $.imageTitle.value.trim()||"(Untitled)";
    if (!allData[currentClient].images) { allData[currentClient].images = []; }
    allData[currentClient].images.push({ title, dataUrl:$.imagePreview.src });
    try { saveToStorage(); closeModal("imageModal"); renderImageGallery(currentClient); } catch (e) { console.error("Error saving image:", e); }
}


// --- Keyboard Shortcuts ---
function handleKeyboardShortcuts(e) {
  // (Keep function from previous version, using $ cache)
    const tag=e.target.tagName; const isModalOpen = document.querySelector('.modal-overlay[style*="display: block"]');
    if(["INPUT","TEXTAREA","SELECT"].includes(tag)) { if(e.key==="Escape" && isModalOpen){ closeModal(isModalOpen.id); } if (e.key === 'Enter' && tag === 'INPUT' && !e.target.closest('.client-info-edit-view')) { if (e.target === $.activityInput) { e.preventDefault(); addNewTask(); } else if (e.target.closest('.weekly-day-section')) { const addButton = e.target.closest('.weekly-day-section').querySelector('.btn-primary'); if (addButton) addButton.click(); } } return; }
    if(e.altKey && e.key==="a"){ e.preventDefault(); if($.activityInput.value.trim()!==""){ addNewTask();} else $.activityInput.focus(); }
    if(e.altKey && e.key==="d"){ e.preventDefault(); const lastRow= $.taskTable.querySelector("tr:last-child:not(.editing)"); if(lastRow){ const chk=lastRow.querySelector("input[type='checkbox']"); if(chk){ chk.checked=!chk.checked; chk.dispatchEvent(new Event("change")); } } }
    if(e.altKey && e.key==="s"){ e.preventDefault(); sortDailyTasks(); }
    if(e.key==="Escape" && isModalOpen){ e.preventDefault(); closeModal(isModalOpen.id); }
}


// --- UTILS ---
function timeToMin(str) { /* Keep function */ return !str||typeof str!=='string'?9999:(str=str.trim(),{"Before School":360,"During Study Hall":600,"During Lunch":720,"Right After School":930,"Before Dinner":1080,"After Dinner":1200,"Before Bed":1320}[str]??(()=>{const t=str.match(/(\d{1,2}):(\d{2})\s?(AM|PM)/i);if(t){let e=parseInt(t[1],10),a=parseInt(t[2],10);if(isNaN(e)||isNaN(a))return 9998;let n=t[3]?.toUpperCase();return n?("PM"===n&&e<12&&(e+=12),"AM"===n&&12===e&&(e=0),60*e+a):9997}return 9990})());}
function getWeekday(ds) { /* Keep function */ try{const t=new Date(ds+"T00:00:00Z"),e=t.getUTCDay();return["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][e]}catch(t){return console.error("Error getting weekday for:",ds,t),"sunday"}}
function formatDate(ds) { /* Keep function */ try{const t=new Date(ds+"T00:00:00Z");return t.toLocaleDateString(void 0,{timeZone:"UTC",weekday:"short",month:"short",day:"numeric"})}catch(t){return console.error("Error formatting date:",ds,t),ds}}
function escapeHtml(str) { /* Keep function */ if(!str)return "";const t=document.createElement("div");return t.textContent=str,t.innerHTML}

</script>
</body>
</html>
