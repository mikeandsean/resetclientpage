<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RESET Tracker - Merged Version</title>
  <style>
    :root {
      /* Color Palette & Variables */
      --bg-main: #F4F7FC;       /* Soft background */
      --bg-card: #FFFFFF;       /* Card background */
      --border-color: #E2E8F0;  /* Light gray border */
      --text-primary: #2D3748;  /* Dark grayish blue */
      --text-secondary: #4A5568;/* Medium gray */
      --text-light: #718096;    /* Lighter gray */
      --primary-blue: #4A90E2;  /* Accent color for buttons */
      --primary-blue-dark: #357ABD;
      --success-green: #48BB78; /* For progress bars */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
      --radius: 6px;
      --spacing-unit: 1rem;
    }

    /* Basic Resets */
    * { box-sizing: border-box; }
    body {
      margin: 0 auto;
      max-width: 850px;
      background: var(--bg-main);
      font-family: sans-serif;
      color: var(--text-primary);
      padding: var(--spacing-unit);
      line-height: 1.4;
    }

    h1, h2, h3 {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    h1 { margin-top: 1rem; font-size: 1.8rem; }
    h2 {
      font-size: 1.3rem;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.3rem;
    }
    h3 {
      margin-top: 1.2rem;
      margin-bottom: 0.4rem;
      color: var(--primary-blue);
      font-size: 1.15rem;
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 0.45em 0.8em;
      margin: 0.3em 0.3em 0.3em 0;
      border: 1px solid var(--border-color);
      background-color: #fff;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s ease;
      user-select: none; /* Prevent text selection on double click */
    }
    .btn:hover {
      background-color: #f2f2f2;
    }
    .btn:active {
        background-color: #e8e8e8; /* Slight feedback on click */
    }
    .btn-primary {
      background-color: var(--primary-blue);
      color: #fff;
      border-color: var(--primary-blue);
    }
    .btn-primary:hover {
      background-color: var(--primary-blue-dark);
      border-color: var(--primary-blue-dark);
    }
     .btn-primary:active {
        background-color: #2a5a8a;
    }

    /* Controls Bar */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0;
      align-items: center;
    }
    .controls > div {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .controls label {
      font-weight: bold;
      margin-right: 0.2rem;
      color: var(--text-secondary);
    }
    select, input[type="date"], input[type="text"], textarea {
      font-size: 1em;
      padding: 0.3em 0.45em;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background: #fff;
    }
    select:focus, input[type="text"]:focus, textarea:focus {
      outline: 2px solid rgba(74,144,226,0.3);
    }
    input.accountability-input { /* specific style for accountability column */
      width: 98%;
      font-size: 0.9em;
      padding: 0.2em 0.3em;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      background-color: #fff;
      box-shadow: var(--shadow-sm);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    th, td {
      border: none;
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem;
      text-align: left;
      vertical-align: middle;
      font-size: 0.95em;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-size: 0.8em;
    }
    tr:last-child td { border-bottom: none; }
    tr.completed-task td:not(:nth-last-child(1), :nth-last-child(2)) { /* cross out everything but accountability & actions */
      text-decoration: line-through;
      color: var(--text-light);
    }
    tr.editing td {
        background-color: #fffbea;
    }

    /* Client Info Section */
    .client-info-card {
      margin-bottom:1rem;
      background:#fff;
      padding:0.8rem;
      border:1px solid var(--border-color);
      border-radius:var(--radius);
      box-shadow: var(--shadow-sm);
    }
    .client-info-edit-view, .client-info-display-view {
      margin-bottom: 0.5rem;
    }
    .client-info-display-view .info-label {
        font-weight: 600;
        color: var(--text-secondary);
        min-width: 80px;
        display: inline-block;
    }
    .client-info-display-view span.info-value {
      font-weight: bold;
      color: var(--primary-blue);
      margin-right: 1rem;
      display: inline-block;
    }
    .client-info-display-view a {
      margin-right: 1rem;
      font-weight: 600;
      text-decoration: none;
      color: var(--primary-blue);
    }
     .client-info-display-view a:hover {
        text-decoration: underline;
        color: var(--primary-blue-dark);
     }

    /* Reflection Section */
    textarea {
      width: 100%;
      min-height: 60px;
      margin-top: 0.2rem;
    }

    /* Progress Bars */
    .progress-bar-container {
      width: 100%;
      background-color: #eee;
      border-radius: var(--radius);
      overflow: hidden;
      margin: 0.3rem 0 1rem 0;
    }
    .progress-bar {
      height: 20px;
      background: var(--success-green);
      color: #fff;
      text-align: center;
      font-weight: 600;
      line-height: 20px;
      transition: width 0.3s;
      border-radius: var(--radius) 0 0 var(--radius);
    }
    .blue-bar {
      background: var(--primary-blue);
    }

    /* Image Gallery */
    #imageGallery {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }
    #imageGallery h3 { margin-top: 0; }
    .gallery-item {
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.3rem;
    }
    .gallery-item:last-child { border-bottom: none; }
    .gallery-item img {
      max-height: 60px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .gallery-item img:hover { transform: scale(1.05); }
    .gallery-item .title { font-weight: 600; flex-grow: 1; margin-left: 0.5rem; }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 2rem 1rem;
      overflow-y: auto;
    }
    .modal-content {
      background: var(--bg-card);
      margin: 2rem auto;
      padding: 1.5rem;
      max-width: 700px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    .modal-header { margin-bottom: 1rem; }
    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-weight: 600;
    }
    .modal-close, [data-close] {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      border: none;
      background: #E53E3E;
      color: #fff;
      font-weight: bold;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .day-plan, .weekly-day-section {
      margin-bottom: 1rem;
      padding: 0.8rem;
      background: #fdfdfd;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius);
    }
    .day-plan h4, .weekly-day-section h4 {
      margin-top: 0; margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-size: 1em;
    }

    /* Media Queries */
    @media (max-width: 600px) {
      body { margin:0 auto; padding: 0.5rem;}
      h1 { font-size: 1.4rem; }
      .controls { flex-direction: column; align-items: stretch; }
      .controls > div { gap: 0.2rem; margin-bottom: 0.5rem;}
      .controls button { width: 100%; margin-left: 0; margin-right: 0;}
      table, th, td { font-size: 0.85em; }
      .modal-content { margin: 1rem auto; padding: 1rem;}
      .client-info-edit-view input[type="text"] { width: 100%; margin-bottom: 0.5rem; }
      .client-info-display-view .info-label { min-width: 60px; }
      #taskTable td:nth-child(1), #taskTable th:nth-child(1) { width: 20%; }
      #taskTable td:nth-child(2), #taskTable th:nth-child(2) { width: 35%; }
      #taskTable td:nth-child(4), #taskTable th:nth-child(4) { width: 20%; }
    }
  </style>
</head>
<body>

<h1>RESET Tracker (Merged) - Single Page</h1>

<div class="controls">
  <!-- Client + "Add Client" -->
  <div>
    <label>Client:</label>
    <select id="clientSelect"></select>
    <button class="btn" id="addClientBtn">+ Add Client</button>
  </div>
  <!-- Date picker -->
  <div>
    <label>Date:</label>
    <input type="date" id="datePicker" />
  </div>
  <!-- Other controls -->
  <button class="btn" id="clearTasksBtn">Clear Tasks</button>
  <button class="btn" id="reportBtn">View Report</button>
  <button class="btn" id="multiDayBtn">Multi-Day</button>
  <button class="btn" id="weeklyBtn">Weekly</button>
  <button class="btn" id="imageBtn">Images</button>
  <button class="btn" id="exportBtn">Export</button>
</div>

<!-- New Client Form -->
<div id="newClientForm" style="display:none; margin: 0.5rem 0; padding: 0.7rem; background:#f7fcff; border:1px solid var(--border-color); border-radius:6px;">
  <label style="font-weight:600; margin-right:0.5rem;">New Client Name:</label>
  <input type="text" id="newClientName" placeholder="e.g. John" style="width:180px; margin-right:0.5rem;" />
  <button class="btn btn-primary" id="saveClientBtn">Save</button>
  <button class="btn" id="cancelClientBtn">Cancel</button>
</div>

<!-- Big Goal & Links -->
<div class="client-info-card">
  <div class="client-info-edit-view" style="display:none;">
      <div style="margin-bottom:0.5rem;">
        <label style="font-weight:600; margin-right:0.3rem;">Big Goal:</label>
        <input type="text" id="bigGoalInput" placeholder="e.g. Get into Yale" style="width:98%;" />
      </div>
      <div style="margin-bottom:0.5rem;">
        <label style="font-weight:600; margin-right:0.3rem;">Canvas:</label>
        <input type="text" id="canvasLinkInput" placeholder="https://..." style="width:98%;" />
      </div>
      <div style="margin-bottom:0.5rem;">
        <label style="font-weight:600; margin-right:0.3rem;">Classroom:</label>
        <input type="text" id="classroomLinkInput" placeholder="https://..." style="width:98%;" />
      </div>
      <button class="btn btn-primary" id="saveClientInfoBtn">Save Info</button>
      <button class="btn" id="cancelClientInfoEditBtn">Cancel</button>
  </div>
  <div class="client-info-display-view" style="display:none;">
    <div><span class="info-label">Goal:</span> <span class="info-value" id="bigGoalDisplay"></span></div>
    <div><span class="info-label">Links:</span>
        <a href="#" id="canvasLinkAnchor" target="_blank" style="display:none;">Canvas</a>
        <a href="#" id="classroomLinkAnchor" target="_blank" style="display:none;">Classroom</a>
        <span id="noLinksMsg" style="color: var(--text-light); font-style: italic; display: none;">(No links set)</span>
    </div>
    <button class="btn" id="editClientInfoBtn" style="margin-top: 0.5rem; font-size:0.85em; padding:0.3em 0.6em;">Edit Info</button>
  </div>
</div>

<!-- Reflection Section -->
<h2>Daily Reflection</h2>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Day Rating (1–5):</label>
  <select id="dayRatingSelect" style="margin-left:0.5rem;">
    <option value="0">--</option>
    <option value="1">1</option><option value="2">2</option>
    <option value="3">3</option><option value="4">4</option>
    <option value="5">5</option>
  </select>
</div>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Reflection Notes:</label><br/>
  <textarea id="dayNotes" rows="3" placeholder="Notes for the day..."></textarea>
</div>

<!-- Add New Task -->
<h2>Add New Task</h2>
<div style="margin-bottom:0.5rem;">
  <label style="font-weight:600;">Time:</label>
  <select id="timeSelect"></select>
  <label style="font-weight:600; margin-left:1rem;">Duration:</label>
  <select id="durationSelect">
    <option value="5 min">5 min</option>
    <option value="10 min">10 min</option>
    <option value="15 min">15 min</option>
    <option value="30 min" selected>30 min</option>
    <option value="45 min">45 min</option>
    <option value="1 hour">1 hour</option>
    <option value="90 min">90 min</option>
    <option value="2 hours">2 hours</option>
  </select>
</div>
<div style="margin-bottom:0.8rem;">
  <label style="font-weight:600;">Activity:</label>
  <input type="text" id="activityInput" style="width:50%;" placeholder="e.g. Work on math..." />
</div>
<div style="margin-bottom:1rem;">
  <label style="font-weight:600;">Search:</label>
  <input type="text" id="taskSearch" style="width:35%;" placeholder="Filter tasks below..." />
</div>
<button class="btn btn-primary" id="addTaskBtn">Add Task</button>

<!-- Task Table -->
<table style="margin-top:1rem;">
  <thead>
    <tr>
      <th style="width:15%;">Time & Duration</th>
      <th style="width:30%;">Activity</th>
      <th style="width:8%;">Done?</th>
      <th style="width:22%;">Accountability</th>
      <th style="width:25%;">Actions</th>
    </tr>
  </thead>
  <tbody id="taskTable">
    <tr><td colspan="5" style="text-align:center; color:#666;">(No tasks yet)</td></tr>
  </tbody>
</table>

<!-- Image Gallery -->
<div id="imageGallery"></div>

<!-- Progress Dashboard -->
<h2>Progress Dashboard</h2>
<p><strong>Task Completion:</strong> <span id="completionRate">-</span></p>
<div class="progress-bar-container">
  <div id="completionBar" class="progress-bar" style="width:0%">0%</div>
</div>

<hr style="margin:1.5rem 0; border: none; border-top: 1px solid var(--border-color);"/>

<p><strong>Day Rating (this day):</strong> <span id="displayDayRating">-</span></p>
<p><strong>Avg Day Rating (up to this date):</strong> <span id="avgDayRatingUpToDate">-</span></p>
<div class="progress-bar-container">
  <div id="avgRatingBar" class="progress-bar blue-bar" style="width:0%">0/5</div>
</div>

<!-- FOOTER -->
<div style="margin-top:2rem; color:var(--text-light); font-size:0.9em; border-top:1px solid var(--border-color); padding-top:1rem; text-align:center;">
  <p>Data is stored locally in your browser's <code>localStorage</code>. No server or external DB needed.</p>
</div>

<!-- 1) MULTI-DAY PLANNER MODAL -->
<div id="multiDayModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="multiDayModal">X</button>
    <div class="modal-header">
      <h3>Multi-Day Task Planner</h3>
    </div>
    <p>Create tasks for multiple upcoming days at once.</p>
    <div id="multiDaysContainer"></div>
    <button class="btn" id="addAnotherDayBtn">Add Another Day</button>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveMultiDayBtn">Save All</button>
      <button class="btn" data-close="multiDayModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 2) WEEKLY PLANNER MODAL -->
<div id="weeklyModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="weeklyModal">X</button>
    <div class="modal-header">
      <h3>Weekly Planner for <span id="weeklyClientNameLabel"></span></h3>
    </div>
    <p>Set recurring tasks for each weekday.</p>
    <div id="weeklyContainer"></div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveWeeklyBtn">Save Weekly</button>
      <button class="btn" data-close="weeklyModal">Cancel</button>
    </div>
  </div>
</div>

<!-- 3) IMAGES MODAL -->
<div id="imageModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-close="imageModal">X</button>
    <div class="modal-header">
      <h3>Add Image / Screenshot</h3>
    </div>
    <div>
      <input type="file" id="imageFileInput" accept="image/*" />
      <p style="color:var(--text-light); font-size:0.9em;">Or paste a screenshot (Ctrl+V).</p>
    </div>
    <img id="imagePreview" src="" alt="preview" style="display:none; max-width:100%; max-height:200px; margin:0.5rem 0; border:1px solid #ccc;" />
    <div>
      <label style="font-weight:600;">Title:</label><br/>
      <input type="text" id="imageTitle" style="width:80%;" placeholder="Optional title">
    </div>
    <div style="margin-top:1rem;">
      <button class="btn btn-primary" id="saveImageBtn">Save Image</button>
      <button class="btn" data-close="imageModal">Cancel</button>
    </div>
  </div>
</div>

<script>
/***************************************************************
  SINGLE-PAGE RESET TRACKER (MERGED VERSION)
  - Default clients loaded + Big Goal/Canvas Link
  - Accountability field (no per-task rating)
  - Day rating, reflection, multi-day, weekly tasks, images
***************************************************************/

const STORAGE_KEY = "multiClientDateData_SinglePage_v2";

/* 1) Default clients to preload if not in storage */
const defaultClients = [
  "Giancarlo","Walter","Brendan B","Kai","Rafferty","Bardez",
  "KariBella","Zeb","Griffin","Charlie","Troy","Owen",
  "Sean","Bethany","DannyMike","Zelda","Whoadie"
];

/* MAIN DATA */
let allData = {};
let currentClient = null;
let currentDate = null;

/* DOM references */
const clientSelect       = document.getElementById("clientSelect");
const addClientBtn       = document.getElementById("addClientBtn");
const newClientForm      = document.getElementById("newClientForm");
const newClientName      = document.getElementById("newClientName");
const saveClientBtn      = document.getElementById("saveClientBtn");
const cancelClientBtn    = document.getElementById("cancelClientBtn");

const datePicker         = document.getElementById("datePicker");
const clearTasksBtn      = document.getElementById("clearTasksBtn");
const reportBtn          = document.getElementById("reportBtn");
const multiDayBtn        = document.getElementById("multiDayBtn");
const weeklyBtn          = document.getElementById("weeklyBtn");
const imageBtn           = document.getElementById("imageBtn");
const exportBtn          = document.getElementById("exportBtn");

const dayRatingSelect    = document.getElementById("dayRatingSelect");
const dayNotesTextarea   = document.getElementById("dayNotes");

const timeSelect         = document.getElementById("timeSelect");
const durationSelect     = document.getElementById("durationSelect");
const activityInput      = document.getElementById("activityInput");
const taskSearch         = document.getElementById("taskSearch");
const addTaskBtn         = document.getElementById("addTaskBtn");
const taskTable          = document.getElementById("taskTable").querySelector("tbody");

const completionRateEl   = document.getElementById("completionRate");
const completionBarEl    = document.getElementById("completionBar");
const displayDayRatingEl = document.getElementById("displayDayRating");
const avgDayRatingUpToDateEl = document.getElementById("avgDayRatingUpToDate");
const avgRatingBarEl     = document.getElementById("avgRatingBar");
const imageGallery       = document.getElementById("imageGallery");

/* Client info elements */
const clientInfoEditView = document.querySelector(".client-info-edit-view");
const clientInfoDisplayView = document.querySelector(".client-info-display-view");
const bigGoalInput       = document.getElementById("bigGoalInput");
const canvasLinkInput    = document.getElementById("canvasLinkInput");
const classroomLinkInput = document.getElementById("classroomLinkInput");
const saveClientInfoBtn  = document.getElementById("saveClientInfoBtn");
const cancelClientInfoEditBtn = document.getElementById("cancelClientInfoEditBtn");
const editClientInfoBtn  = document.getElementById("editClientInfoBtn");
const bigGoalDisplay     = document.getElementById("bigGoalDisplay");
const canvasLinkAnchor   = document.getElementById("canvasLinkAnchor");
const classroomLinkAnchor= document.getElementById("classroomLinkAnchor");
const noLinksMsg         = document.getElementById("noLinksMsg");

/* Multi-day modal */
const multiDayModal      = document.getElementById("multiDayModal");
const multiDaysContainer = document.getElementById("multiDaysContainer");
const addAnotherDayBtn   = document.getElementById("addAnotherDayBtn");
const saveMultiDayBtn    = document.getElementById("saveMultiDayBtn");

/* Weekly modal */
const weeklyModal        = document.getElementById("weeklyModal");
const weeklyContainer    = document.getElementById("weeklyContainer");
const weeklyClientNameLabel = document.getElementById("weeklyClientNameLabel");
const saveWeeklyBtn      = document.getElementById("saveWeeklyBtn");

/* Image modal */
const imageModal         = document.getElementById("imageModal");
const imageFileInput     = document.getElementById("imageFileInput");
const imagePreview       = document.getElementById("imagePreview");
const imageTitleInput    = document.getElementById("imageTitle");
const saveImageBtn       = document.getElementById("saveImageBtn");

/***************************************************************
  ON LOAD
***************************************************************/
window.addEventListener("load", () => {
  loadFromStorage();

  // Make sure default clients exist
  defaultClients.forEach(c => {
    if (!allData[c]) {
      allData[c] = {
        bigGoal:"",
        links:{canvas:"", classroom:""},
        weeklyTasks:{ monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[] },
        images:[]
      };
    }
  });

  buildTimeSelect(timeSelect);

  buildClientDropdown();

  // Default date = today
  const todayStr = new Date().toISOString().split("T")[0];
  datePicker.value = todayStr;
  currentDate = todayStr;

  // If we have any clients, pick the first alphabetically
  const allClients = Object.keys(allData).sort();
  if (allClients.length > 0) {
    currentClient = allClients[0];
    clientSelect.value = currentClient;
    loadClientDate(currentClient, currentDate);
  } else {
    // no clients at all => show the client info edit to fill in
    taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No clients - add one!)</td></tr>`;
    clientInfoEditView.style.display = "block";
    clientInfoDisplayView.style.display = "none";
  }

  /* event listeners */
  clientSelect.addEventListener("change", onClientOrDateChange);
  datePicker.addEventListener("change", onClientOrDateChange);

  addClientBtn.addEventListener("click",()=>{
    newClientForm.style.display="block";
    newClientName.value="";
    newClientName.focus();
  });
  cancelClientBtn.addEventListener("click",()=>newClientForm.style.display="none");
  saveClientBtn.addEventListener("click", saveNewClient);

  saveClientInfoBtn.addEventListener("click", saveClientInfo);
  editClientInfoBtn.addEventListener("click", () => {
    clientInfoEditView.style.display = "block";
    clientInfoDisplayView.style.display = "none";
    if (currentClient && allData[currentClient]) {
      bigGoalInput.value = allData[currentClient].bigGoal || "";
      canvasLinkInput.value = allData[currentClient].links?.canvas || "";
      classroomLinkInput.value = allData[currentClient].links?.classroom || "";
    }
  });
  cancelClientInfoEditBtn.addEventListener("click", () => {
    if (currentClient) renderClientInfo(currentClient);
  });

  addTaskBtn.addEventListener("click", addNewTask);
  clearTasksBtn.addEventListener("click", clearDailyTasks);
  reportBtn.addEventListener("click", generateReport);
  multiDayBtn.addEventListener("click", ()=> openModal("multiDayModal"));
  weeklyBtn.addEventListener("click", ()=> openModal("weeklyModal"));
  imageBtn.addEventListener("click", ()=> openModal("imageModal"));

  exportBtn.addEventListener("click", exportData);

  dayRatingSelect.addEventListener("change", onDayRatingChange);
  dayNotesTextarea.addEventListener("input", onDayNotesChange);

  taskSearch.addEventListener("input", filterTasks);

  // multi-day
  addAnotherDayBtn.addEventListener("click", addMultiDayBlock);
  saveMultiDayBtn.addEventListener("click", saveMultiDayPlan);

  // weekly
  saveWeeklyBtn.addEventListener("click", saveWeeklyPlan);

  // images
  imageFileInput.addEventListener("change", handleImageFileChange);
  imageModal.addEventListener("paste", handleImagePaste);
  saveImageBtn.addEventListener("click", saveImage);

  // close modals
  document.querySelectorAll("[data-close], .modal-close").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const modal = btn.closest('.modal-overlay');
      if (modal) {
        modal.style.display="none";
      }
    });
  });

  // Keyboard shortcuts
  document.addEventListener("keydown",(e)=>{
    const tag=e.target.tagName;
    const isModalOpen = document.querySelector('.modal-overlay[style*="display: block"]');
    if(["INPUT","TEXTAREA","SELECT"].includes(tag)) {
      if(e.key==="Escape" && isModalOpen){
        isModalOpen.style.display="none";
      }
      // Press Enter on <input id="activityInput"> => addNewTask
      if (e.key === 'Enter' && tag === 'INPUT' && e.target.id==="activityInput") {
        e.preventDefault();
        addNewTask();
      }
      return;
    }
    // alt+a => add task
    if(e.altKey && e.key==="a"){
      e.preventDefault();
      if(activityInput.value.trim()!==""){ addNewTask();}
      else activityInput.focus();
    }
    // alt+d => toggle last task done
    if(e.altKey && e.key==="d"){
      e.preventDefault();
      const lastRow= taskTable.querySelector("tr:last-child:not(.editing)");
      if(lastRow){
        const chk= lastRow.querySelector("input[type='checkbox']");
        if(chk){
          chk.checked=!chk.checked;
          chk.dispatchEvent(new Event("change"));
        }
      }
    }
    // alt+s => sort tasks
    if(e.altKey && e.key==="s"){
      e.preventDefault();
      sortDailyTasks();
    }
    // escape => close modals
    if(e.key==="Escape" && isModalOpen){
      e.preventDefault();
      isModalOpen.style.display="none";
    }
  });

  // Add default multi-day block (hidden unless they open modal)
  addMultiDayBlock();
});

/***************************************************************
  LOAD / SAVE
***************************************************************/
function loadFromStorage() {
  const str = localStorage.getItem(STORAGE_KEY);
  let parsedData = {};
  if (str) {
    try {
      parsedData = JSON.parse(str);
    } catch (e) {
      console.error("Error parsing localStorage:", e);
      alert("Could not parse stored data. Starting fresh.");
      parsedData = {};
    }
  }
  if (!parsedData || typeof parsedData!=='object') parsedData={};

  // Ensure each client's data structure is valid
  Object.keys(parsedData).forEach(cli => {
    if (!parsedData[cli].weeklyTasks) {
      parsedData[cli].weeklyTasks = {
        monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[]
      };
    }
    if (!parsedData[cli].images) {
      parsedData[cli].images = [];
    }
    if (typeof parsedData[cli].bigGoal==='undefined') parsedData[cli].bigGoal="";
    if (!parsedData[cli].links) parsedData[cli].links={canvas:"", classroom:""};
  });

  allData = parsedData;
}
function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
  } catch(e){
    if(e.name==="QuotaExceededError" || e.name==='NS_ERROR_DOM_QUOTA_REACHED'){
      alert("Storage limit exceeded! Please export data or remove old entries/images.");
    } else {
      console.error("Error saving to localStorage:", e);
      alert("Could not save data. Changes might not persist.");
    }
  }
}

/***************************************************************
  CLIENT DROPDOWN
***************************************************************/
function buildClientDropdown() {
  clientSelect.innerHTML="";
  const names= Object.keys(allData).sort();
  if(!names.length){
    const opt=document.createElement("option");
    opt.value=""; opt.textContent="--No Clients--";
    clientSelect.appendChild(opt);
    clientSelect.disabled=true;
    return;
  }
  clientSelect.disabled=false;
  names.forEach(n=>{
    const opt=document.createElement("option");
    opt.value=n; opt.textContent=n;
    clientSelect.appendChild(opt);
  });
}

/***************************************************************
  ADD CLIENT
***************************************************************/
function saveNewClient() {
  const name= newClientName.value.trim();
  if(!name){ alert("Enter name"); return;}
  if(allData[name]) {
    alert(`Client "${name}" already exists. Showing existing data.`);
    clientSelect.value = name;
    currentClient = name;
    loadClientDate(name, currentDate);
    newClientForm.style.display="none";
    return;
  }
  allData[name]={
    bigGoal:"",
    links:{canvas:"", classroom:""},
    weeklyTasks:{ monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[] },
    images:[]
  };
  saveToStorage();
  buildClientDropdown();
  clientSelect.value=name;
  currentClient=name;
  loadClientDate(name, currentDate);
  newClientForm.style.display="none";
  alert(`New client "${name}" created.`);
}

/***************************************************************
  CLIENT/DATE CHANGE
***************************************************************/
function onClientOrDateChange() {
  currentClient= clientSelect.value;
  currentDate= datePicker.value;
  loadClientDate(currentClient, currentDate);
}

/***************************************************************
  LOAD CLIENT+DATE
***************************************************************/
function loadClientDate(cli, dt){
  if(!cli || !dt) {
    taskTable.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;">(Select Client & Date)</td></tr>`;
    renderClientInfo(null);
    dayRatingSelect.value="0";
    dayNotesTextarea.value="";
    return;
  }
  if(!allData[cli]) {
    allData[cli] = {
      bigGoal:"",
      links:{canvas:"", classroom:""},
      weeklyTasks:{ monday:[], tuesday:[], wednesday:[], thursday:[], friday:[], saturday:[], sunday:[] },
      images:[]
    };
  }
  if(!allData[cli][dt]) {
    allData[cli][dt] = {
      dayRating:"0",
      dayNotes:"",
      tasks:[],
      weeklyDone:{}
    };
  }
  renderClientInfo(cli);
  renderReflection(cli, dt);
  renderTaskTable(cli, dt);
  renderImageGallery(cli);
  updateProgress(cli, dt);
  buildWeeklyContent(); // rebuild weekly modal if opened
}

/***************************************************************
  CLIENT INFO (big goal / links)
***************************************************************/
function renderClientInfo(cli){
  if(!cli || !allData[cli]) {
    clientInfoEditView.style.display="block";
    clientInfoDisplayView.style.display="none";
    bigGoalInput.value="";
    canvasLinkInput.value="";
    classroomLinkInput.value="";
    return;
  }
  const cd= allData[cli];
  const goal = cd.bigGoal || "";
  const canvas = cd.links?.canvas || "";
  const classroom = cd.links?.classroom || "";
  const hasInfo = goal || canvas || classroom;
  if(hasInfo){
    clientInfoEditView.style.display="none";
    clientInfoDisplayView.style.display="block";
    bigGoalDisplay.textContent= goal || "(No goal set)";
    let linksExist = false;
    if(canvas) {
      canvasLinkAnchor.href= canvas.startsWith("http")? canvas : "//"+canvas;
      canvasLinkAnchor.style.display="inline";
      linksExist=true;
    } else {
      canvasLinkAnchor.style.display="none";
    }
    if(classroom) {
      classroomLinkAnchor.href= classroom.startsWith("http")? classroom : "//"+classroom;
      classroomLinkAnchor.style.display="inline";
      linksExist=true;
    } else {
      classroomLinkAnchor.style.display="none";
    }
    noLinksMsg.style.display = linksExist?"none":"inline";
  } else {
    clientInfoEditView.style.display="block";
    clientInfoDisplayView.style.display="none";
    bigGoalInput.value=goal;
    canvasLinkInput.value=canvas;
    classroomLinkInput.value=classroom;
  }
}
function saveClientInfo() {
  if(!currentClient)return;
  const cd= allData[currentClient];
  cd.bigGoal= bigGoalInput.value.trim();
  cd.links.canvas= canvasLinkInput.value.trim();
  cd.links.classroom= classroomLinkInput.value.trim();
  saveToStorage();
  renderClientInfo(currentClient);
  alert("Client info saved!");
}

/***************************************************************
  REFLECTION
***************************************************************/
function renderReflection(cli, dt){
  const rec= allData[cli][dt];
  dayRatingSelect.value= rec.dayRating||"0";
  dayNotesTextarea.value= rec.dayNotes||"";
}
function onDayRatingChange(){
  if(!currentClient || !currentDate) return;
  const rec= allData[currentClient][currentDate];
  rec.dayRating= dayRatingSelect.value;
  saveToStorage();
  updateProgress(currentClient, currentDate);
}
function onDayNotesChange(){
  if(!currentClient || !currentDate) return;
  const rec= allData[currentClient][currentDate];
  rec.dayNotes= dayNotesTextarea.value;
  saveToStorage();
}

/***************************************************************
  BUILD TIME SELECT
***************************************************************/
function buildTimeSelect(sel, defaultVal="3:00 PM"){
  sel.innerHTML="";
  let foundDefault=false;
  for(let hour=5; hour<24; hour++){
    for(let min=0; min<60; min+=15){
      const d=new Date();
      d.setHours(hour,min);
      const label= d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12:true});
      const opt= document.createElement("option");
      opt.value=label; opt.textContent=label;
      sel.appendChild(opt);
      if(label===defaultVal) foundDefault=true;
    }
  }
  const sep= document.createElement("option");
  sep.disabled=true; sep.textContent="-----";
  sel.appendChild(sep);
  const cTimes= ["Before School","During Study Hall","During Lunch",
   "Right After School","Before Dinner","After Dinner","Before Bed"];
  cTimes.forEach(t=>{
    const o=document.createElement("option");
    o.value=t; o.textContent=t;
    sel.appendChild(o);
    if(t===defaultVal) foundDefault=true;
  });
  if(foundDefault) {
    sel.value= defaultVal;
  } else {
    sel.value= "3:00 PM"; // fallback
  }
}

/***************************************************************
  DAILY TASKS
***************************************************************/
function renderTaskTable(cli, dt){
  taskTable.innerHTML="";
  if(!cli||!dt||!allData[cli][dt]) {
    taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks)</td></tr>`;
    return;
  }
  const rec= allData[cli][dt];
  const daily= rec.tasks||[];
  const wd= getWeekday(dt);
  const wList= allData[cli].weeklyTasks?.[wd]||[];
  const wDone= rec.weeklyDone||{};
  const merged=[];
  daily.forEach(t=> merged.push({...t, _type:"daily"}));
  wList.forEach(wt=>{
    merged.push({
      ...wt,
      completed: !!wDone[wt.id],
      accountability:"(Weekly)",
      _type:"weekly"
    });
  });
  merged.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
  if(!merged.length){
    taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks yet)</td></tr>`;
    return;
  }
  merged.forEach(tObj=> addTaskRow(tObj, rec));
}
function addTaskRow(tObj, dayRec){
  const row= taskTable.insertRow();
  if(tObj.completed) row.classList.add("completed-task");
  const cTime= row.insertCell(0);
  cTime.innerHTML= tObj.time || "No Time";
  if(tObj.duration){
    cTime.innerHTML+= `<br><small>(${tObj.duration})</small>`;
  }
  if(tObj._type==="weekly"){
    cTime.innerHTML+= `<br><small style="color:#09f;font-weight:bold;">(Weekly)</small>`;
  }
  const cAct= row.insertCell(1);
  cAct.textContent= tObj.activity;

  const cDone= row.insertCell(2);
  const chk= document.createElement("input");
  chk.type="checkbox";
  chk.checked= tObj.completed;
  chk.addEventListener("change", ()=>{
    row.classList.toggle("completed-task", chk.checked);
    if(tObj._type==="daily"){
      const idx= dayRec.tasks.findIndex(tsk=> tsk===tObj);
      if(idx>-1){
        dayRec.tasks[idx].completed= chk.checked;
        saveToStorage();
        updateProgress(currentClient, currentDate);
      } else {
        // fallback if not found by reference
        console.warn("Couldn't find daily task to update.");
      }
    } else {
      if(!dayRec.weeklyDone) dayRec.weeklyDone={};
      dayRec.weeklyDone[tObj.id]= chk.checked;
      saveToStorage();
      updateProgress(currentClient, currentDate);
    }
  });
  cDone.appendChild(chk);

  // Accountability
  const cAcc= row.insertCell(3);
  if(tObj._type==="daily"){
    const accInput=document.createElement("input");
    accInput.type="text";
    accInput.placeholder="How checked?";
    accInput.className="accountability-input";
    accInput.value= tObj.accountability || "";
    accInput.addEventListener("input", ()=>{
      const idx= dayRec.tasks.findIndex(tsk=> tsk===tObj);
      if(idx>-1){
        dayRec.tasks[idx].accountability= accInput.value;
        saveToStorage();
      }
    });
    cAcc.appendChild(accInput);
  } else {
    cAcc.textContent="--";
    cAcc.style.color="#999";
  }

  const cActn= row.insertCell(4);
  if(tObj._type==="daily"){
    const editBtn= document.createElement("button");
    editBtn.textContent="✎";
    editBtn.classList.add("btn");
    editBtn.style.marginRight="5px";
    editBtn.addEventListener("click", ()=> makeTaskEditable(row, tObj));
    cActn.appendChild(editBtn);

    const rmBtn= document.createElement("button");
    rmBtn.textContent="X";
    rmBtn.classList.add("btn");
    rmBtn.addEventListener("click", ()=>{
      if(confirm(`Remove task "${tObj.activity}"?`)){
        const idx= dayRec.tasks.indexOf(tObj);
        if(idx>-1){
          dayRec.tasks.splice(idx,1);
          saveToStorage();
          row.remove();
          updateProgress(currentClient, currentDate);
          if(!taskTable.rows.length){
            taskTable.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#666;">(No tasks yet)</td></tr>`;
          }
        }
      }
    });
    cActn.appendChild(rmBtn);
  } else {
    cActn.innerHTML=`<small style="color:#666;">(Edit in Weekly Plan)</small>`;
  }
}
function addNewTask(){
  if(!currentClient||!currentDate)return;
  const timeVal=timeSelect.value;
  const durVal= durationSelect.value;
  const actVal= activityInput.value.trim();
  if(!actVal){ alert("Enter an activity"); return;}
  const rec= allData[currentClient][currentDate];
  const newTask={
    time: timeVal,
    duration: durVal,
    activity: actVal,
    completed:false,
    accountability:""
  };
  rec.tasks.push(newTask);
  rec.tasks.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
  saveToStorage();
  renderTaskTable(currentClient, currentDate);
  updateProgress(currentClient, currentDate);
  activityInput.value="";
  activityInput.focus();
}
function sortDailyTasks(){
  if(!currentClient||!currentDate)return;
  const rec= allData[currentClient][currentDate];
  if(!rec||!rec.tasks)return;
  rec.tasks.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
  saveToStorage();
  renderTaskTable(currentClient, currentDate);
}
function filterTasks(){
  const txt= taskSearch.value.toLowerCase();
  const rows= taskTable.querySelectorAll("tr");
  let visibleCount=0;
  rows.forEach(r=>{
    if(r.cells.length<5){
      if(txt) r.style.display="none";
      else r.style.display="";
      return;
    }
    const timeStr= r.cells[0]?.textContent.toLowerCase()||"";
    const actStr= r.cells[1]?.textContent.toLowerCase()||"";
    const accStr= r.cells[3]?.querySelector('input')?.value?.toLowerCase()|| r.cells[3]?.textContent?.toLowerCase()||"";
    const isVisible= timeStr.includes(txt)|| actStr.includes(txt)|| accStr.includes(txt);
    r.style.display= isVisible?"":"none";
    if(isVisible) visibleCount++;
  });
}
function clearDailyTasks(){
  if(!currentClient||!currentDate) return;
  const rec= allData[currentClient][currentDate];
  if(!rec||!rec.tasks||!rec.tasks.length){
    alert("No daily tasks to clear.");
    return;
  }
  if(confirm(`Clear ALL ${rec.tasks.length} daily task(s)? (Weekly tasks remain)`)){
    rec.tasks=[];
    saveToStorage();
    renderTaskTable(currentClient, currentDate);
    updateProgress(currentClient, currentDate);
  }
}

/***************************************************************
  EDIT TASK
***************************************************************/
function makeTaskEditable(row, taskObj){
  if(row.classList.contains("editing")||taskObj._type==="weekly") return;
  row.classList.add("editing");

  const tdTime=row.cells[0];
  const tdAct=row.cells[1];
  const tdAcc=row.cells[3];
  const tdActions=row.cells[4];

  const oldTime= taskObj.time;
  const oldAct= taskObj.activity;
  const oldDur= taskObj.duration||"30 min";
  const oldAcc= taskObj.accountability||"";

  tdTime.innerHTML="";
  const newTimeSel=document.createElement("select");
  buildTimeSelect(newTimeSel, oldTime);
  tdTime.appendChild(newTimeSel);

  const newDurSel= document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(dur=>{
    const opt= document.createElement("option");
    opt.value=dur; opt.textContent=dur;
    newDurSel.appendChild(opt);
  });
  newDurSel.value= oldDur;
  tdTime.appendChild(document.createElement("br"));
  tdTime.appendChild(newDurSel);

  tdAct.innerHTML="";
  const actField=document.createElement("input");
  actField.type="text";
  actField.value= oldAct;
  actField.style.width="98%";
  tdAct.appendChild(actField);

  const accInput= document.createElement("input");
  accInput.type="text";
  accInput.className="accountability-input";
  accInput.placeholder="How checked?";
  accInput.value= oldAcc;
  tdAcc.innerHTML="";
  tdAcc.appendChild(accInput);

  const originalActions= tdActions.innerHTML;
  tdActions.innerHTML="";
  const saveBtn= document.createElement("button");
  saveBtn.textContent="Save";
  saveBtn.classList.add("btn","btn-primary");
  saveBtn.addEventListener("click",()=>{
    const newT= newTimeSel.value;
    const newD= newDurSel.value;
    const newA= actField.value.trim();
    if(!newA){
      alert("Activity cannot be empty");
      return;
    }
    taskObj.time= newT;
    taskObj.duration= newD;
    taskObj.activity= newA;
    taskObj.accountability= accInput.value;
    saveToStorage();
    row.classList.remove("editing");
    // re-sort & reload
    sortDailyTasks();
  });
  tdActions.appendChild(saveBtn);

  const cancelBtn= document.createElement("button");
  cancelBtn.textContent="Cancel";
  cancelBtn.classList.add("btn");
  cancelBtn.addEventListener("click",()=>{
    row.classList.remove("editing");
    renderTaskTable(currentClient, currentDate);
  });
  tdActions.appendChild(cancelBtn);
  actField.focus();
}

/***************************************************************
  PROGRESS
***************************************************************/
function updateProgress(cli, dt){
  if(!cli||!dt||!allData[cli]||!allData[cli][dt]){
    completionRateEl.textContent="-";
    completionBarEl.style.width="0%";
    completionBarEl.textContent="0%";
    displayDayRatingEl.textContent="--";
    avgDayRatingUpToDateEl.textContent="--";
    avgRatingBarEl.style.width="0%";
    avgRatingBarEl.textContent="0/5";
    return;
  }
  const rec= allData[cli][dt];
  const daily= rec.tasks||[];
  const wd= getWeekday(dt);
  const wList= allData[cli].weeklyTasks?.[wd]||[];
  const wDone= rec.weeklyDone||{};
  const dailyDone= daily.filter(t=>t.completed).length;
  const weeklyDoneCount= wList.filter(w=> wDone[w.id]).length;
  const totalDone= dailyDone+weeklyDoneCount;
  const total= daily.length + wList.length;
  if(!total){
    completionRateEl.textContent="-";
    completionBarEl.style.width="0%";
    completionBarEl.textContent="0%";
  } else {
    const pct=Math.round((totalDone/total)*100);
    completionRateEl.textContent=`${pct}% (${totalDone}/${total})`;
    completionBarEl.style.width=`${pct}%`;
    completionBarEl.textContent=`${pct}%`;
  }
  // Day rating
  if(rec.dayRating && rec.dayRating!=="0"){
    displayDayRatingEl.textContent= rec.dayRating+"/5";
  } else {
    displayDayRatingEl.textContent="--";
  }
  // Avg day rating up to date
  const allDates= Object.keys(allData[cli]).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k) && k<=dt).sort();
  let sumDR=0, cntDR=0;
  allDates.forEach(dKey=>{
    const dr= allData[cli][dKey].dayRating;
    if(dr && dr!=="0"){
      sumDR+= parseInt(dr,10);
      cntDR++;
    }
  });
  if(cntDR>0){
    const avg= sumDR/cntDR;
    avgDayRatingUpToDateEl.textContent= avg.toFixed(1)+"/5";
    const p=Math.max(0, Math.min(100,(avg/5)*100));
    avgRatingBarEl.style.width=`${p}%`;
    avgRatingBarEl.textContent=`${avg.toFixed(1)}/5`;
  } else {
    avgDayRatingUpToDateEl.textContent="No rated days";
    avgRatingBarEl.style.width="0%";
    avgRatingBarEl.textContent="0/5";
  }
}

/***************************************************************
  MULTI-DAY PLANNER
***************************************************************/
function openModal(id){
  const modal=document.getElementById(id);
  if(modal) {
    modal.style.display="block";
    if(id==="weeklyModal"){
      weeklyClientNameLabel.textContent=currentClient||"Selected Client";
      buildWeeklyContent();
    }
    if(id==="imageModal"){
      imagePreview.src="";
      imagePreview.style.display="none";
      imageFileInput.value="";
      imageTitleInput.value="";
    }
    if(id==="multiDayModal"){
      multiDaysContainer.innerHTML="";
      addMultiDayBlock();
    }
  }
}
function addMultiDayBlock(){
  const index= multiDaysContainer.querySelectorAll(".day-plan").length;
  const base= new Date(currentDate+"T12:00:00");
  base.setDate(base.getDate()+ index+1);
  const ds= base.toISOString().split("T")[0];
  const div= document.createElement("div");
  div.classList.add("day-plan");
  div.dataset.date= ds;
  const h4= document.createElement("h4");
  h4.textContent=`Day ${index+1}: ${formatDate(ds)}`;
  div.appendChild(h4);

  // time + duration
  const timeSel= document.createElement("select");
  buildTimeSelect(timeSel);
  const durSel= document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(d=>{
    const o=document.createElement("option");
    o.value=d; o.textContent=d;
    durSel.appendChild(o);
  });
  durSel.value="30 min";

  const labelAct= document.createElement("label");
  labelAct.textContent="Activity:";
  labelAct.style.display="block";
  labelAct.style.marginTop="0.5rem";

  const actInp= document.createElement("input");
  actInp.type="text";
  actInp.placeholder="e.g. Complete math...";
  actInp.style.width="100%";

  const container= document.createElement("div");
  container.appendChild(document.createTextNode("Time: "));
  container.appendChild(timeSel);
  container.appendChild(document.createTextNode("  Duration: "));
  container.appendChild(durSel);

  div.appendChild(container);
  div.appendChild(labelAct);
  div.appendChild(actInp);

  // add button for tasks on same day
  const addTaskBtn= document.createElement("button");
  addTaskBtn.classList.add("btn");
  addTaskBtn.textContent="+ Task for this day";
  addTaskBtn.style.marginTop="0.5rem";
  addTaskBtn.addEventListener("click", ()=>{
    // replicate last set
    const newTimeSel= timeSel.cloneNode(true);
    newTimeSel.value= timeSel.value;
    const newDurSel= durSel.cloneNode(true);
    newDurSel.value= durSel.value;
    const newActLabel= labelAct.cloneNode(true);
    const newActInp= actInp.cloneNode(true);
    newActInp.value="";
    div.insertBefore(document.createElement("hr"), addTaskBtn);
    div.insertBefore(newTimeSel, addTaskBtn);
    div.insertBefore(document.createTextNode(" Duration: "), addTaskBtn);
    div.insertBefore(newDurSel, addTaskBtn);
    div.insertBefore(document.createElement("br"), addTaskBtn);
    div.insertBefore(newActLabel, addTaskBtn);
    div.insertBefore(newActInp, addTaskBtn);
  });
  div.appendChild(addTaskBtn);

  multiDaysContainer.appendChild(div);
}
function saveMultiDayPlan(){
  const blocks= multiDaysContainer.querySelectorAll(".day-plan");
  let tasksAdded=0;
  let datesAffected= new Set();
  blocks.forEach(b=>{
    const ds= b.dataset.date;
    if(!allData[currentClient][ds]){
      allData[currentClient][ds]= { dayRating:"0", dayNotes:"", tasks:[], weeklyDone:{} };
    }
    const rec= allData[currentClient][ds];
    const sets= b.querySelectorAll("select");
    const textInputs= b.querySelectorAll("input[type='text']");

    // For each "set" of 2 selects (time/dur) + 1 input
    let selIndex=0;
    textInputs.forEach((inp,i)=>{
      const actVal= inp.value.trim();
      if(actVal){
        const timeVal= sets[selIndex].value;
        const durVal= sets[selIndex+1].value;
        selIndex+=2;
        rec.tasks.push({
          time: timeVal,
          duration: durVal,
          activity: actVal,
          completed:false,
          accountability:""
        });
        tasksAdded++;
        datesAffected.add(ds);
      } else {
        selIndex+=2;
      }
    });
    if(rec.tasks.length>0) {
      rec.tasks.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
    }
  });
  if(tasksAdded>0){
    saveToStorage();
    if(datesAffected.has(currentDate)){
      loadClientDate(currentClient, currentDate);
    }
    alert(`Multi-day plan saved! ${tasksAdded} tasks added total.`);
  } else {
    alert("No new tasks were entered to save.");
  }
  multiDayModal.style.display="none";
}

/***************************************************************
  WEEKLY
***************************************************************/
function buildWeeklyContent(){
  weeklyContainer.innerHTML="";
  if(!currentClient||!allData[currentClient]){
    weeklyContainer.innerHTML=`<p>(Select client first)</p>`;
    return;
  }
  const wData= allData[currentClient].weeklyTasks;
  if(!wData) return;
  const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  days.forEach(d=>{
    const sec=document.createElement("div");
    sec.classList.add("weekly-day-section");
    const hd=document.createElement("h4");
    hd.textContent= d[0].toUpperCase()+d.slice(1);
    sec.appendChild(hd);

    const tasksDiv=document.createElement("div");
    const dayTasks=wData[d]||[];
    if(!dayTasks.length){
      tasksDiv.innerHTML=`<p style="font-size:0.9em;color:#888;">(No tasks for ${hd.textContent})</p>`;
    } else {
      dayTasks.forEach(task=>{
        const row=document.createElement("div");
        row.style.display="flex";
        row.style.gap="0.5rem";
        row.style.alignItems="center";
        row.style.marginBottom="5px";
        const txt=document.createElement("span");
        txt.textContent=`[${task.time}] ${task.activity} (${task.duration||'N/A'})`;
        txt.style.flexGrow="1";
        row.appendChild(txt);
        const rm=document.createElement("button");
        rm.classList.add("btn");
        rm.textContent="X";
        rm.addEventListener("click",()=>{
          if(confirm(`Remove weekly task "${task.activity}"?`)){
            const idx= dayTasks.indexOf(task);
            if(idx>-1){
              dayTasks.splice(idx,1);
              saveToStorage();
              buildWeeklyContent();
            }
          }
        });
        row.appendChild(rm);
        tasksDiv.appendChild(row);
      });
    }
    sec.appendChild(tasksDiv);

    // Add input row
    const addRow=document.createElement("div");
    addRow.style.marginTop="0.5rem";
    addRow.style.display="flex";
    addRow.style.gap="0.5rem";
    // time select
    const timeSel=document.createElement("select");
    buildTimeSelect(timeSel);
    // duration
    const durSel=document.createElement("select");
    ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"].forEach(val=>{
      const o=document.createElement("option");
      o.value=val; o.textContent=val;
      durSel.appendChild(o);
    });
    durSel.value="30 min";
    // activity
    const inp=document.createElement("input");
    inp.type="text";
    inp.placeholder="Weekly activity...";
    inp.style.flexGrow="1";
    const plus=document.createElement("button");
    plus.textContent="+";
    plus.classList.add("btn","btn-primary");
    plus.addEventListener("click",()=>{
      const val= inp.value.trim();
      if(!val){ alert("Enter an activity first."); return;}
      const newId=`wt_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;
      dayTasks.push({
        id:newId,
        time: timeSel.value,
        duration: durSel.value,
        activity: val
      });
      dayTasks.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
      saveToStorage();
      buildWeeklyContent();
    });
    addRow.appendChild(timeSel);
    addRow.appendChild(durSel);
    addRow.appendChild(inp);
    addRow.appendChild(plus);
    sec.appendChild(addRow);

    weeklyContainer.appendChild(sec);
  });
}
function saveWeeklyPlan(){
  weeklyModal.style.display="none";
  loadClientDate(currentClient, currentDate);
  alert("Weekly schedule saved.");
}

/***************************************************************
  IMAGES
***************************************************************/
function renderImageGallery(cli){
  imageGallery.innerHTML="";
  if(!cli||!allData[cli]) {
    imageGallery.innerHTML=`<p>(Select a client to see images)</p>`;
    return;
  }
  const arr= allData[cli].images||[];
  if(!arr.length){
    imageGallery.innerHTML=`<p style="color:#999;">(No images)</p>`;
    return;
  }
  const h3=document.createElement("h3");
  h3.textContent="Image Gallery";
  imageGallery.appendChild(h3);

  arr.forEach((imgObj, idx)=>{
    const div=document.createElement("div");
    div.classList.add("gallery-item");
    const im=document.createElement("img");
    im.src=imgObj.dataUrl;
    im.alt=imgObj.title||"(Untitled)";
    im.addEventListener("click",()=>{
      const w= window.open("","_blank");
      if(w){
        w.document.write(`<title>${escapeHtml(imgObj.title||"Image")}</title><body style="margin:0;background:#333;"><img src="${im.src}" style="max-width:100%;max-height:100vh;display:block;margin:auto;" /></body>`);
        w.document.close();
      }
    });
    div.appendChild(im);

    const ttl=document.createElement("span");
    ttl.classList.add("title");
    ttl.textContent= imgObj.title||"(Untitled)";
    div.appendChild(ttl);

    const rm=document.createElement("button");
    rm.classList.add("btn");
    rm.textContent="X";
    rm.style.marginLeft="auto";
    rm.addEventListener("click",()=>{
      if(confirm(`Remove image "${imgObj.title||'(Untitled)'}"?`)){
        arr.splice(idx,1);
        saveToStorage();
        renderImageGallery(cli);
      }
    });
    div.appendChild(rm);

    imageGallery.appendChild(div);
  });
}
function handleImageFileChange(e){
  const file= e.target.files[0];
  if(!file) return;
  if (!file.type.startsWith('image/')) {
    alert("Please select an image file.");
    return;
  }
  if(file.size>5*1024*1024){
    alert("Image file is too large (max 5MB).");
    return;
  }
  const r=new FileReader();
  r.onload=(evt)=>{
    imagePreview.src= evt.target.result;
    imagePreview.style.display="block";
  };
  r.readAsDataURL(file);
}
function handleImagePaste(e){
  const items = e.clipboardData?.items||[];
  for(let i=0; i<items.length;i++){
    if(items[i].type.indexOf("image")===0){
      const file= items[i].getAsFile();
      if(file){
        if(file.size>5*1024*1024){
          alert("Pasted image too large (max 5MB).");
          return;
        }
        const r=new FileReader();
        r.onload=(ev)=>{
          imagePreview.src= ev.target.result;
          imagePreview.style.display="block";
        };
        r.readAsDataURL(file);
        e.preventDefault();
        return;
      }
    }
  }
}
function saveImage(){
  if(!imagePreview.src||!imagePreview.src.startsWith('data:image')){
    alert("No valid image selected or pasted");
    return;
  }
  if(!currentClient){alert("No client selected");return;}
  const title= imageTitleInput.value.trim()||"(Untitled)";
  allData[currentClient].images.push({ title, dataUrl:imagePreview.src });
  try {
    saveToStorage();
    imageModal.style.display="none";
    renderImageGallery(currentClient);
  } catch(e){
    console.error("Error saving image:", e);
  }
}

/***************************************************************
  REPORT
***************************************************************/
function generateReport(){
  if(!currentClient) {alert("No client selected");return;}
  const cliData= allData[currentClient];
  if(!cliData){alert("No data for this client.");return;}

  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"/><title>RESET Tracker Report - ${escapeHtml(currentClient)}</title>
  <style>
    body { font-family:sans-serif; margin:20px; max-width:800px; }
    h1,h2,h3 { margin-bottom:0.5em; }
    table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
    table, th, td { border:1px solid #ccc; }
    th, td { padding:6px; vertical-align:top; text-align:left; }
    th { background:#f0f0f0; }
    .completed-task td:not(:nth-last-child(1), :nth-last-child(2)){
      text-decoration: line-through;
      color: #999;
    }
    .notes { background:#f7faff; border:1px solid #ddd; padding:8px; margin:0.5rem 0; }
    .gallery-img { max-height:150px; margin:5px; border:1px solid #ccc; }
    .weekly-label { color:#09f; font-weight:bold; font-size:0.9em; }
  </style>
  </head><body>
  <h1>RESET Tracker Report - ${escapeHtml(currentClient)}</h1>
  <p><em>Generated on ${new Date().toLocaleString()}</em></p>`;

  // Big goal / links
  html += `<h2>Client Info</h2>`;
  html += `<p><strong>Big Goal:</strong> ${escapeHtml(cliData.bigGoal||"(Not set)")}</p>`;
  html += `<p><strong>Canvas:</strong> ${cliData.links?.canvas ? `<a href="${escapeHtml(cliData.links.canvas)}" target="_blank">${escapeHtml(cliData.links.canvas)}</a>` : "(Not set)"}</p>`;
  html += `<p><strong>Classroom:</strong> ${cliData.links?.classroom ? `<a href="${escapeHtml(cliData.links.classroom)}" target="_blank">${escapeHtml(cliData.links.classroom)}</a>` : "(Not set)"}</p>`;

  // Weekly tasks
  html += `<h2>Weekly Tasks</h2>`;
  const wks= cliData.weeklyTasks||{};
  const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  let anyWeekly=false;
  days.forEach(d=>{
    const arr= wks[d]||[];
    if(arr.length){
      anyWeekly=true;
      html+= `<h3>${d[0].toUpperCase()+d.slice(1)}</h3><ul>`;
      arr.forEach(wt=>{
        html+= `<li>[${escapeHtml(wt.time)}] ${escapeHtml(wt.activity)} ${wt.duration?`<small>(${escapeHtml(wt.duration)})</small>`:""}</li>`;
      });
      html+=`</ul>`;
    }
  });
  if(!anyWeekly) html+=`<p>(No weekly tasks)</p>`;

  // Images
  const imgs= cliData.images||[];
  if(imgs.length>0){
    html+=`<h2>Images</h2>`;
    imgs.forEach(img=>{
      html+=`<div><strong>${escapeHtml(img.title||"")}</strong><br/><img src="${img.dataUrl}" class="gallery-img" alt="img"/></div>`;
    });
  } else {
    html+= `<h2>Images</h2><p>(No images)</p>`;
  }

  // Daily
  const dateKeys= Object.keys(cliData).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
  if(!dateKeys.length){
    html+= `<h2>Daily Records</h2><p>(No daily records)</p>`;
  } else {
    html+= `<h2>Daily Records</h2>`;
    dateKeys.forEach(d=>{
      const rec= cliData[d];
      if(!rec)return;
      const dr= rec.dayRating&&rec.dayRating!=="0"? `${rec.dayRating}/5` : "--";
      html+= `<h3>${d} (Day Rating: ${dr})</h3>`;
      if(rec.dayNotes){
        html+= `<div class="notes">${escapeHtml(rec.dayNotes).replace(/\n/g,"<br/>")}</div>`;
      }
      // merged tasks
      const daily= rec.tasks||[];
      const wd= getWeekday(d);
      const wList= cliData.weeklyTasks[wd]||[];
      const doneMap= rec.weeklyDone||{};
      const merged=[];
      daily.forEach(t=>{
        merged.push({...t, _type:"daily"});
      });
      wList.forEach(wt=>{
        merged.push({
          time: wt.time,
          duration:wt.duration,
          activity: wt.activity,
          accountability: "(Weekly)",
          completed: !!doneMap[wt.id],
          _type:"weekly"
        });
      });
      if(!merged.length){
        html+= `<p style="color:#999;">(No tasks)</p>`;
      } else {
        merged.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
        html+= `<table><thead><tr><th>Time</th><th>Activity</th><th>Done?</th><th>Accountability</th></tr></thead><tbody>`;
        let doneCount=0;
        merged.forEach(m=>{
          if(m.completed) doneCount++;
          html+= `<tr class="${m.completed?'completed-task':''}">
           <td>${escapeHtml(m.time||'--')}${m.duration?`<br><small>(${escapeHtml(m.duration)})</small>`:""}${m._type==="weekly"?'<br><span class="weekly-label">(Weekly)</span>':''}</td>
           <td>${escapeHtml(m.activity||'')}</td>
           <td>${m.completed?"Yes":"No"}</td>
           <td>${escapeHtml(m.accountability||'--')}</td>
          </tr>`;
        });
        html+= `</tbody></table>`;
        html+= `<p><strong>Completion:</strong> ${doneCount}/${merged.length}</p>`;
      }
    });
  }

  html+=`</body></html>`;

  const reportWin= window.open("","_blank");
  if(reportWin){
    reportWin.document.open();
    reportWin.document.write(html);
    reportWin.document.close();
  } else {
    alert("Pop-up blocked. Please allow pop-ups for this site to view the report.");
  }
}

/***************************************************************
  EXPORT
***************************************************************/
function exportData(){
  if(!Object.keys(allData).length){
    alert("No data to export.");
    return;
  }
  try {
    const str= JSON.stringify(allData,null,2);
    const blob= new Blob([str],{type:"application/json"});
    const url= URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    const dateStamp= new Date().toISOString().split('T')[0].replace(/-/g,'');
    a.download=`resetTrackerData_${dateStamp}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch(e){
    console.error("Export failed:", e);
    alert("Could not generate export file.");
  }
}

/***************************************************************
  UTILS
***************************************************************/
function timeToMin(str){
  const map={
    "Before School":360,
    "During Study Hall":600,
    "During Lunch":720,
    "Right After School":930,
    "Before Dinner":1080,
    "After Dinner":1200,
    "Before Bed":1320
  };
  if(map[str]!==undefined) return map[str];
  const match= str.match(/(\d{1,2}):(\d{2})\s?(AM|PM)/i);
  if(match){
    let hh= parseInt(match[1],10);
    const mm= parseInt(match[2],10);
    if(isNaN(hh)||isNaN(mm)) return 9999;
    let ampm= match[3].toUpperCase();
    if(ampm==="PM"&& hh<12) hh+=12;
    if(ampm==="AM"&& hh===12) hh=0;
    return hh*60+mm;
  }
  return 9990;
}
function getWeekday(ds){
  try {
    const date= new Date(ds+"T00:00:00Z");
    const dayIndex= date.getUTCDay();
    const weekdays=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
    return weekdays[dayIndex];
  } catch(e){
    return "sunday";
  }
}
function formatDate(ds){
  try {
    const date= new Date(ds+"T00:00:00Z");
    return date.toLocaleDateString(undefined, {timeZone:"UTC", weekday:"short", month:"short", day:"numeric"});
  } catch(e){
    return ds;
  }
}
function escapeHtml(str){
  if(!str)return "";
  const div=document.createElement("div");
  div.textContent=str;
  return div.innerHTML;
}
</script>
</body>
</html>
